<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine Learning Project - Data Preparation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../notebooks/03-eda/notebooks/03_eda.html" rel="next">
<link href="../../../notebooks/01-get-data/notebooks/01_get_data.html" rel="prev">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Machine Learning Project</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../notebooks/02-prepare/notebooks/02_prepare.html">Prepare Data</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../../images/lorip_square.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../references/Scope.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scope</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/01-get-data/notebooks/01_get_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Get Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-prepare/notebooks/02_prepare.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Prepare Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/03-eda/notebooks/03_eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Explore Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/04-transform/notebooks/04_transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transform Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/07-create-audience/notebooks/07_create_audience.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create Audience</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about" id="toc-about" class="nav-link active" data-scroll-target="#about">About</a>
  <ul class="collapse">
  <li><a href="#discussion-of-study-period-for-this-project" id="toc-discussion-of-study-period-for-this-project" class="nav-link" data-scroll-target="#discussion-of-study-period-for-this-project">Discussion of Study Period for This Project</a></li>
  <li><a href="#data-selection-for-data-preparation" id="toc-data-selection-for-data-preparation" class="nav-link" data-scroll-target="#data-selection-for-data-preparation">Data Selection for Data Preparation</a></li>
  </ul></li>
  <li><a href="#user-inputs" id="toc-user-inputs" class="nav-link" data-scroll-target="#user-inputs">User Inputs</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data Preparation</a>
  <ul class="collapse">
  <li><a href="#visitors-who-made-a-purchase" id="toc-visitors-who-made-a-purchase" class="nav-link" data-scroll-target="#visitors-who-made-a-purchase">Visitors Who Made a Purchase</a></li>
  <li><a href="#first-visit-attributes" id="toc-first-visit-attributes" class="nav-link" data-scroll-target="#first-visit-attributes">First Visit Attributes</a></li>
  <li><a href="#fraction-of-visitors-with-add-to-cart-on-first-visit" id="toc-fraction-of-visitors-with-add-to-cart-on-first-visit" class="nav-link" data-scroll-target="#fraction-of-visitors-with-add-to-cart-on-first-visit">Fraction of Visitors with Add-to-Cart on First Visit</a></li>
  <li><a href="#reasons-for-and-handling-of-duplicates" id="toc-reasons-for-and-handling-of-duplicates" class="nav-link" data-scroll-target="#reasons-for-and-handling-of-duplicates">Reasons For and Handling of Duplicates</a></li>
  <li><a href="#nested-promotion-column" id="toc-nested-promotion-column" class="nav-link" data-scroll-target="#nested-promotion-column">Nested Promotion Column</a></li>
  <li><a href="#nested-product-column" id="toc-nested-product-column" class="nav-link" data-scroll-target="#nested-product-column">Nested Product Column</a></li>
  <li><a href="#change-data-types-in-prepared-data" id="toc-change-data-types-in-prepared-data" class="nav-link" data-scroll-target="#change-data-types-in-prepared-data">Change Data Types in Prepared Data</a></li>
  <li><a href="#separate-columns-by-type" id="toc-separate-columns-by-type" class="nav-link" data-scroll-target="#separate-columns-by-type">Separate Columns by Type</a></li>
  <li><a href="#handling-categorical-columns" id="toc-handling-categorical-columns" class="nav-link" data-scroll-target="#handling-categorical-columns">Handling Categorical Columns</a></li>
  </ul></li>
  <li><a href="#key-findings" id="toc-key-findings" class="nav-link" data-scroll-target="#key-findings">Key Findings</a>
  <ul class="collapse">
  <li><a href="#nested-attributes-of-first-time-visits" id="toc-nested-attributes-of-first-time-visits" class="nav-link" data-scroll-target="#nested-attributes-of-first-time-visits">Nested Attributes of First-Time Visits</a></li>
  <li><a href="#recommendations-for-data-processing" id="toc-recommendations-for-data-processing" class="nav-link" data-scroll-target="#recommendations-for-data-processing">Recommendations for Data Processing</a></li>
  </ul></li>
  <li><a href="#summary-of-assumptions" id="toc-summary-of-assumptions" class="nav-link" data-scroll-target="#summary-of-assumptions">Summary of Assumptions</a></li>
  <li><a href="#summary-of-tasks-performed" id="toc-summary-of-tasks-performed" class="nav-link" data-scroll-target="#summary-of-tasks-performed">Summary of Tasks Performed</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  <li><a href="#next-step" id="toc-next-step" class="nav-link" data-scroll-target="#next-step">Next Step</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/elsdes3/market/blob/main/notebooks/02-prepare/notebooks/02_prepare.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/elsdes3/market/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Data Preparation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Import Python modules</p>
<div class="cell" data-tags="[]" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytz</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.oauth2 <span class="im">import</span> service_account</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="about" class="level2">
<h2 class="anchored" data-anchor-id="about">About</h2>
<p>This step of the analysis will prepare data for use in exploratory and quantitative data analysis.</p>
<section id="discussion-of-study-period-for-this-project" class="level3">
<h3 class="anchored" data-anchor-id="discussion-of-study-period-for-this-project">Discussion of Study Period for This Project</h3>
<p>We will need to discuss the data that can be used to prepare data without suffering from lookahead bias/data leakage.</p>
<p>Data splits are created in a later step. ML model development will be performed using a training data split, validation (feature selection, hyperparameter tuning, etc.) is performed using the validation data split and, finally, the best ML model is evaluated using the test data split.</p>
<p>So, the validation and test data splits should be treated as unseen data. In order to avoid lookahead bias/data leakage during data preparation, this means that data preparation steps should be determined using the training data and simply applied to the validation and test data splits.</p>
</section>
<section id="data-selection-for-data-preparation" class="level3">
<h3 class="anchored" data-anchor-id="data-selection-for-data-preparation">Data Selection for Data Preparation</h3>
<p>With the above in mind, data preparation will cover the training data.</p>
</section>
</section>
<section id="user-inputs" class="level2">
<h2 class="anchored" data-anchor-id="user-inputs">User Inputs</h2>
<p>Get relative path to project root directory</p>
<div class="cell" data-tags="[]" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>PROJ_ROOT_DIR <span class="op">=</span> os.path.join(os.pardir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the following</p>
<ol type="1">
<li>train data start date</li>
<li>train data end date</li>
<li>test data end date</li>
</ol>
<div class="cell" data-tags="[&quot;parameters&quot;]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>train_start_date <span class="op">=</span> <span class="st">"20160901"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>train_end_date <span class="op">=</span> <span class="st">"20161231"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>test_end_date <span class="op">=</span> <span class="st">"20170228"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Retrieve credentials for <code>bigquery</code> client</p>
<div class="cell" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Google Cloud PROJECT ID</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>gcp_project_id <span class="op">=</span> os.environ[<span class="st">"GCP_PROJECT_ID"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get filepath to Google Cloud Service Account JSON key</p>
<div class="cell" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>raw_data_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"data"</span>, <span class="st">"raw"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>gcp_creds_fpath <span class="op">=</span> glob(os.path.join(raw_data_dir, <span class="st">"*.json"</span>))[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Authenticate <code>bigquery</code> client and get dictionary with credentials</p>
<div class="cell" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>gcp_credentials <span class="op">=</span> service_account.Credentials.from_service_account_file(gcp_creds_fpath)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>gcp_auth_dict <span class="op">=</span> <span class="bu">dict</span>(gcp_project_id<span class="op">=</span>gcp_project_id, gcp_creds<span class="op">=</span>gcp_credentials)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a mapping between action type integer and label, in order to get meaningful names from the action_type column</p>
<div class="cell" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>mapper <span class="op">=</span> {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"Click through of product lists"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"Product detail views"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">"Add product(s) to cart"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span>: <span class="st">"Remove product(s) from cart"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>: <span class="st">"Check out"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">6</span>: <span class="st">"Completed purchase"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="dv">7</span>: <span class="st">"Refund of purchase"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">8</span>: <span class="st">"Checkout options"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>: <span class="st">"Unknown"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define a Python helper function to execute a SQL query using Google BigQuery</p>
<div class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_sql_query(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    query: <span class="bu">str</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    gcp_project_id: <span class="bu">str</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    gcp_creds: os.PathLike,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    show_dtypes: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    show_info: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    show_df: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Run query on BigQuery and return results as pandas.DataFrame."""</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> datetime.now(pytz.timezone(<span class="st">"US/Eastern"</span>))</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    start_time_str <span class="op">=</span> start_time.strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S.</span><span class="sc">%f</span><span class="st">"</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Query execution start time = </span><span class="sc">{</span>start_time_str[:<span class="op">-</span><span class="dv">3</span>]<span class="sc">}</span><span class="ss">..."</span>, end<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_gbq(</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        query,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        project_id<span class="op">=</span>gcp_project_id,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        credentials<span class="op">=</span>gcp_creds,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        dialect<span class="op">=</span><span class="st">"standard"</span>,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># configuration is optional, since default for query caching is True</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        configuration<span class="op">=</span>{<span class="st">"query"</span>: {<span class="st">"useQueryCache"</span>: <span class="va">True</span>}},</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># use_bqstorage_api=True,</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    end_time <span class="op">=</span> datetime.now(pytz.timezone(<span class="st">"US/Eastern"</span>))</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    end_time_str <span class="op">=</span> end_time.strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S.</span><span class="sc">%f</span><span class="st">"</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    duration <span class="op">=</span> end_time <span class="op">-</span> start_time</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    duration <span class="op">=</span> duration.seconds <span class="op">+</span> (duration.microseconds <span class="op">/</span> <span class="dv">1_000_000</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"done at </span><span class="sc">{</span>end_time_str[:<span class="op">-</span><span class="dv">3</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>duration<span class="sc">:.3f}</span><span class="ss"> seconds)."</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Query returned </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> rows"</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_df:</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>            display(df)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_dtypes:</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        display(df.dtypes.rename(<span class="st">"dtype"</span>).to_frame().transpose())</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_info:</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        df.info()</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data Preparation</h2>
<section id="visitors-who-made-a-purchase" class="level3">
<h3 class="anchored" data-anchor-id="visitors-who-made-a-purchase">Visitors Who Made a Purchase</h3>
<p><strong>Question 1. Get visitors with a purchase on a future visit to the Marketplace.</strong></p>
<p>To get these visitors, a similar approach to that from the get-data step will be used. In that step, two criteria were used to identify a purchase on a future visit, namely <code>total.transactions &gt; 0</code> and <code>totals.newVisits IS NULL</code>. Those will be used here as well.</p>
<p>A query with these filters is executed below</p>
<div class="cell" data-tags="[]" data-execution_count="11">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ss">        SELECT fullvisitorid,</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ss">               IF(COUNTIF(totals.transactions &gt; 0 AND totals.newVisits IS NULL) &gt; 0, True, False) AS made_purchase_on_future_visit,</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ss">               IF(</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ss">                   SUM(CASE WHEN totals.transactions &gt; 0 AND totals.newVisits IS NULL THEN 1 ELSE 0 END) &gt; 0, True, False</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ss">               ) AS made_purchase_on_future_visit_v2</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ss">        FROM `data-to-insights.ecommerce.web_analytics`</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ss">        WHERE date BETWEEN '</span><span class="sc">{</span>train_start_date<span class="sc">}</span><span class="ss">' AND '</span><span class="sc">{</span>test_end_date<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="ss">        AND geoNetwork.country = 'United States'</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="ss">        GROUP BY fullvisitorid</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> run_sql_query(query, <span class="op">**</span>gcp_auth_dict, show_df<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># breakdown of returning purchasers using COUNTIF()</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    .value_counts()</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"num_return_purchasers_using_countif"</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    .to_frame()</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># breakdown of returning purchasers using CASE WHEN()</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"made_purchase_on_future_visit_v2"</span>]</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        .value_counts()</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"num_return_purchasers_using_if_sum_casewhen"</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        .to_frame(),</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>            <span class="dv">100</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span> df[<span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>            .value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>            .rename(<span class="st">"frac_made_purchase_on_future_visit"</span>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        ).to_frame(),</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>        right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"made_return_purchase"</span>})</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:03:04.444...done at 2023-04-13 17:03:17.048 (12.604 seconds).
Query returned 137,727 rows</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">num_return_purchasers_using_countif</th>
<th data-quarto-table-cell-role="th">num_return_purchasers_using_if_sum_casewhen</th>
<th data-quarto-table-cell-role="th">frac_made_purchase_on_future_visit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>131734</td>
<td>131734</td>
<td>95.648638</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>5993</td>
<td>5993</td>
<td>4.351362</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><code>COUNTIF()</code> is a BigQuery SQL function (<a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators#countif">1</a>) but it gives the same output as a standard SQL-based approach using <code>IF(SUM(CASE WHEN...))</code>. For the rest of this step, <code>COUNTIF()</code> will be used</li>
<li>Over the selected months, the class imbalance is close to 96% to 4% (or 96:4)
<ul>
<li>this comes from the <code>made_purchase_on_future_visit</code> column</li>
<li>these are the class labels for ML experiments</li>
</ul></li>
</ol>
</div>
</div>
</section>
<section id="first-visit-attributes" class="level3">
<h3 class="anchored" data-anchor-id="first-visit-attributes">First Visit Attributes</h3>
<p><strong>Question 2. Extract attributes from the first visit by visitors that made a purchase on a future visit.</strong></p>
<p>The following are the attributes extracted from the first visit (for the above visitors only) and the high-level categories that they belong to</p>
<ol type="1">
<li>geospatial and temporal
<ul>
<li>country</li>
<li><code>datetime</code> attributes (day of month, hour of day, etc.)</li>
</ul></li>
<li>metadata of each visit and visitor
<ul>
<li>these are <em>id</em> (or equivalent) columns</li>
</ul></li>
<li>traffic sources and channels
<ul>
<li>traffic sources
<ul>
<li>these are search engines, social media networks, and other sources that result in visitors reaching the merchandise store’s website (<a href="https://support.google.com/analytics/answer/6205762?hl=en#understanding&amp;zippy=%2Cin-this-article">link</a>)</li>
</ul></li>
<li>channels
<ul>
<li>these are groups of traffic sources (<a href="https://support.google.com/analytics/answer/6010097?hl=en#zippy=%2Cin-this-article">link</a>)</li>
</ul></li>
</ul></li>
<li>visitor activity on site
<ul>
<li>hits</li>
<li>bounces</li>
<li>page views</li>
<li>time spent on site</li>
<li>number of add-to-cart actions performed</li>
</ul></li>
<li>visitor’s device used to access site
<ul>
<li>browser</li>
<li>device category</li>
<li>operating system</li>
</ul></li>
<li>label for machine learning
<ul>
<li><code>made_purchase_on_future_visit</code>
<ul>
<li>same as in the above query</li>
<li>indicates whether a visitor makes a purchase during their next visit</li>
</ul></li>
</ul></li>
<li>Product
<ul>
<li>products viewed</li>
<li>products clicked</li>
</ul></li>
<li>Promotion
<ul>
<li>promotions viewed (impressions)</li>
<li>promotions clicked</li>
</ul></li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ss">        WITH</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ss">        -- Step 1. get visitors with a purchase on a future visit</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ss">        next_visit_purchasers AS (</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ss">             SELECT fullvisitorid,</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="ss">                    IF(COUNTIF(totals.transactions &gt; 0 AND totals.newVisits IS NULL) &gt; 0, True, False) AS made_purchase_on_future_visit</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="ss">             FROM `data-to-insights.ecommerce.web_analytics`</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ss">             WHERE date BETWEEN '</span><span class="sc">{</span>train_start_date<span class="sc">}</span><span class="ss">' AND '</span><span class="sc">{</span>test_end_date<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="ss">             AND geoNetwork.country = 'United States'</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="ss">             GROUP BY fullvisitorid</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="ss">        ),</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="ss">        -- Steps 2. and 3. get attributes of the first visit</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="ss">        first_visit_attributes AS (</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="ss">            SELECT -- =========== GEOSPATIAL AND TEMPORAL ATTRIBUTES OF VISIT ===========</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="ss">                   geoNetwork.country,</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(QUARTER FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS quarter,</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(MONTH FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS month,</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(DAY FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS day_of_month,</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(DAYOFWEEK FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS day_of_week,</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(HOUR FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS hour,</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(MINUTE FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS minute,</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(SECOND FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS second,</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== VISIT AND VISITOR METADATA ===========</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="ss">                   fullvisitorid,</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitId,</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitNumber,</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="ss">                   DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific') AS visitStartTime,</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== SOURCE OF SITE TRAFFIC ===========</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- source of the traffic from which the visit was initiated</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="ss">                   trafficSource.source,</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- medium of the traffic from which the visit was initiated</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="ss">                   trafficSource.medium,</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- referring channel connected to visit</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="ss">                   channelGrouping,</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== VISITOR ACTIVITY ===========</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- total number of hits</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="ss">                   (CASE WHEN totals.hits &gt; 0 THEN totals.hits ELSE 0 END) AS hits,</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- number of bounces</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="ss">                   (CASE WHEN totals.bounces &gt; 0 THEN totals.bounces ELSE 0 END) AS bounces,</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- action performed during first visit</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="ss">                   CAST(h.eCommerceAction.action_type AS INT64) AS action_type,</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- page views</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="ss">                   IFNULL(totals.pageviews, 0) AS pageviews,</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- total revenue</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a><span class="ss">                   totals.totalTransactionRevenue / 1000000 AS transact_revenue,</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- time on the website</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="ss">                   IFNULL(totals.timeOnSite, 0) AS time_on_site,</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- whether add-to-cart was performed during visit</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="ss">                   (CASE WHEN CAST(h.eCommerceAction.action_type AS INT64) = 3 THEN 1 ELSE 0 END) AS added_to_cart,</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a><span class="ss">                   (CASE WHEN CAST(h.eCommerceAction.action_type AS INT64) = 2 THEN 1 ELSE 0 END) AS product_details_viewed,</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== VISITOR DEVICES ===========</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- user's browser</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.browser,</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- user's operating system</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.operatingSystem AS os,</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- user's type of device</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.deviceCategory,</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== PROMOTION ===========</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a><span class="ss">                   h.promotion,</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a><span class="ss">                   h.promotionActionInfo AS pa_info,</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== PRODUCT ===========</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a><span class="ss">                   h.product,</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== ML LABEL (DEPENDENT VARIABLE) ===========</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a><span class="ss">                   made_purchase_on_future_visit</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="ss">            FROM `data-to-insights.ecommerce.web_analytics`,</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a><span class="ss">            UNNEST(hits) AS h</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="ss">            INNER JOIN next_visit_purchasers USING (fullvisitorid)</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a><span class="ss">            WHERE date BETWEEN '</span><span class="sc">{</span>train_start_date<span class="sc">}</span><span class="ss">' AND '</span><span class="sc">{</span>train_end_date<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a><span class="ss">            AND geoNetwork.country = 'United States'</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a><span class="ss">            AND totals.newVisits = 1</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a><span class="ss">        ),</span></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a><span class="ss">        -- Step 4. get aggregated features (attributes) per visit</span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a><span class="ss">        visit_attributes AS (</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a><span class="ss">            SELECT fullvisitorid,</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitId,</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitNumber,</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitStartTime,</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a><span class="ss">                   country,</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a><span class="ss">                   quarter,</span></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a><span class="ss">                   month,</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a><span class="ss">                   day_of_month,</span></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a><span class="ss">                   day_of_week,</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a><span class="ss">                   hour,</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a><span class="ss">                   minute,</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a><span class="ss">                   second,</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a><span class="ss">                   source,</span></span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a><span class="ss">                   medium,</span></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a><span class="ss">                   channelGrouping,</span></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a><span class="ss">                   hits,</span></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a><span class="ss">                   bounces,</span></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- get the last action performed during the first visit</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- (this indicates where the visitor left off at the end of their visit)</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a><span class="ss">                   MAX(action_type) AS last_action,</span></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- get number of products whose details were viewed</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a><span class="ss">                   SUM(product_details_viewed) AS product_detail_views,</span></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- get number of promotions displayed and clicked during the first visit</span></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a><span class="ss">                   COUNT(CASE WHEN pa_info IS NOT NULL THEN pa_info.promoIsView ELSE NULL END) AS promos_displayed,</span></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a><span class="ss">                   COUNT(CASE WHEN pa_info IS NOT NULL THEN pa_info.promoIsClick ELSE NULL END) AS promos_clicked,</span></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- get number of products displayed and clicked during the first visit</span></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a><span class="ss">                   COUNT(CASE WHEN pu.isImpression IS NULL THEN NULL ELSE 1 END) AS product_views,</span></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a><span class="ss">                   COUNT(CASE WHEN pu.isClick IS NULL THEN NULL ELSE 1 END) AS product_clicks,</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a><span class="ss">                   pageviews,</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a><span class="ss">                   transact_revenue,</span></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a><span class="ss">                   time_on_site,</span></span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a><span class="ss">                   browser,</span></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a><span class="ss">                   os,</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a><span class="ss">                   deviceCategory,</span></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a><span class="ss">                   SUM(added_to_cart) AS added_to_cart,</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a><span class="ss">                   made_purchase_on_future_visit,</span></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a><span class="ss">            FROM first_visit_attributes</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a><span class="ss">            LEFT JOIN UNNEST(promotion) as p</span></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a><span class="ss">            LEFT JOIN UNNEST(product) as pu</span></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a><span class="ss">            GROUP BY fullvisitorid,</span></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a><span class="ss">                     visitId,</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a><span class="ss">                     visitNumber,</span></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a><span class="ss">                     visitStartTime,</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a><span class="ss">                     country,</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a><span class="ss">                     quarter,</span></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a><span class="ss">                     month,</span></span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a><span class="ss">                     day_of_month,</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a><span class="ss">                     day_of_week,</span></span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a><span class="ss">                     hour,</span></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a><span class="ss">                     minute,</span></span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a><span class="ss">                     second,</span></span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a><span class="ss">                     source,</span></span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a><span class="ss">                     medium,</span></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a><span class="ss">                     channelGrouping,</span></span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a><span class="ss">                     hits,</span></span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a><span class="ss">                     bounces,</span></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a><span class="ss">                     pageviews,</span></span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a><span class="ss">                     transact_revenue,</span></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a><span class="ss">                     time_on_site,</span></span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a><span class="ss">                     browser,</span></span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a><span class="ss">                     os,</span></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a><span class="ss">                     deviceCategory,</span></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a><span class="ss">                     made_purchase_on_future_visit</span></span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a><span class="ss">        )</span></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a><span class="ss">        SELECT *</span></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a><span class="ss">        FROM visit_attributes</span></span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> run_sql_query(query, <span class="op">**</span>gcp_auth_dict, show_df<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>    display(df.head())</span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>    display(df.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:03:44.045...done at 2023-04-13 17:04:06.815 (22.770 seconds).
Query returned 92,859 rows</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">product_detail_views</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">transact_revenue</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>8163735676529750721</td>
<td>1481176805</td>
<td>1</td>
<td>2016-12-07 22:00:05</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>7</td>
<td>4</td>
<td>22</td>
<td>0</td>
<td>5</td>
<td>google</td>
<td>cpc</td>
<td>Paid Search</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5</td>
<td>NaN</td>
<td>109</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0897634596694862660</td>
<td>1475199828</td>
<td>1</td>
<td>2016-09-29 18:43:48</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>29</td>
<td>5</td>
<td>18</td>
<td>43</td>
<td>48</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>21</td>
<td>0</td>
<td>2</td>
<td>2</td>
<td>9</td>
<td>0</td>
<td>90</td>
<td>2</td>
<td>19</td>
<td>NaN</td>
<td>467</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3891893273235584028</td>
<td>1478844153</td>
<td>1</td>
<td>2016-11-10 22:02:33</td>
<td>United States</td>
<td>4</td>
<td>11</td>
<td>10</td>
<td>5</td>
<td>22</td>
<td>2</td>
<td>33</td>
<td>youtube.com</td>
<td>referral</td>
<td>Social</td>
<td>11</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>18</td>
<td>0</td>
<td>36</td>
<td>1</td>
<td>10</td>
<td>NaN</td>
<td>1003</td>
<td>Safari (in-app)</td>
<td>iOS</td>
<td>tablet</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6952706734234495703</td>
<td>1480581075</td>
<td>1</td>
<td>2016-12-01 00:31:15</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>1</td>
<td>5</td>
<td>0</td>
<td>31</td>
<td>15</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>27</td>
<td>1</td>
<td>24</td>
<td>0</td>
<td>8</td>
<td>NaN</td>
<td>141</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3008949133172215443</td>
<td>1475213353</td>
<td>1</td>
<td>2016-09-29 22:29:13</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>29</td>
<td>5</td>
<td>22</td>
<td>29</td>
<td>13</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>14</td>
<td>0</td>
<td>2</td>
<td>3</td>
<td>9</td>
<td>0</td>
<td>24</td>
<td>3</td>
<td>11</td>
<td>NaN</td>
<td>229</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">product_detail_views</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">transact_revenue</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">92854</td>
<td>1446285229092173706</td>
<td>1478190491</td>
<td>1</td>
<td>2016-11-03 09:28:11</td>
<td>United States</td>
<td>4</td>
<td>11</td>
<td>3</td>
<td>5</td>
<td>9</td>
<td>28</td>
<td>11</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>29</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>224</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>0</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">92855</td>
<td>927804845306410814</td>
<td>1482181118</td>
<td>1</td>
<td>2016-12-19 12:58:38</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>19</td>
<td>2</td>
<td>12</td>
<td>58</td>
<td>38</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>32</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>83</td>
<td>Chrome</td>
<td>Linux</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92856</td>
<td>8969674851394509099</td>
<td>1482941116</td>
<td>1</td>
<td>2016-12-28 08:05:16</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>28</td>
<td>4</td>
<td>8</td>
<td>5</td>
<td>16</td>
<td>youtube.com</td>
<td>referral</td>
<td>Social</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>28</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>85</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">92857</td>
<td>0486118040507415508</td>
<td>1477164641</td>
<td>1</td>
<td>2016-10-22 12:30:41</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>22</td>
<td>7</td>
<td>12</td>
<td>30</td>
<td>41</td>
<td>t.co</td>
<td>referral</td>
<td>Social</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>28</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>78</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92858</td>
<td>9088496055778533168</td>
<td>1482668980</td>
<td>1</td>
<td>2016-12-25 04:29:40</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>25</td>
<td>1</td>
<td>4</td>
<td>29</td>
<td>40</td>
<td>youtube.com</td>
<td>referral</td>
<td>Social</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>36</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>69</td>
<td>Chrome</td>
<td>Linux</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Below is a brief overview of the CTEs used here
<ul>
<li><code>next_visit_purchasers</code>
<ul>
<li>gets visitors who made a purchase on a return visit to the merchandise store on the Google Marketplace</li>
</ul></li>
<li><code>first_visit_attributes</code>
<ul>
<li>gets attributes of first visit</li>
<li>the statement <code>INNER JOIN next_visit_purchasers USING (fullvisitorid)</code> is used to only select the visitors that made a purchase on a return visit to the store (these <code>fullvisitorid</code>s are stored in the <code>next_visit_purchasers</code> CTE)</li>
</ul></li>
<li><code>visit_attributes</code>
<ul>
<li>aggregates values from nested columns to get views and clicks for promotions and products</li>
</ul></li>
</ul></li>
<li>The BigQuery SQL function <code>UNNEST</code> was used to flatten nested columns.</li>
<li>The start and end dates of the ML training, validation and test data splits were defined. The training dates have been used to filter the <code>first_visit_attributes</code> CTE in order since EDA in this step will only be performed using the training data in order to avoid data leakage (or lookahead bias).</li>
<li>The SQL required to extract most of these columns was determined from (a) the documentation for the dataset and (b) examining the first few rows of the dataset in these columns. For brevity, we won’t discuss these columns in further detail. These column categories are listed below
<ul>
<li>geospatial and temporal</li>
<li>metadata of each visit and visitor</li>
<li>traffic sources and channels</li>
<li>visitor activity on merchandise store website</li>
<li>visitor’s device</li>
<li>label for machine learning (discussed in <em>Data Preparation Question 2. above</em>)</li>
</ul></li>
<li>These columns were extracted based on intuition about the attributes of each visit that will help to predict the probability of a visitor making a purchase on a future (return) visit to the merchandise store.</li>
</ol>
</div>
</div>
</section>
<section id="fraction-of-visitors-with-add-to-cart-on-first-visit" class="level3">
<h3 class="anchored" data-anchor-id="fraction-of-visitors-with-add-to-cart-on-first-visit">Fraction of Visitors with Add-to-Cart on First Visit</h3>
<p><strong>Question 3. What fraction of visitors added one or more items to their shopping cart during their first visit?</strong></p>
<div class="cell" data-tags="[]" data-execution_count="13">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"added_to_cart"</span>]:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    display(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">100</span> <span class="op">*</span> df[c].value_counts(dropna<span class="op">=</span><span class="va">False</span>, normalize<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"number"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"added_to_cart"</span>})</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">number</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>89.336521</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>6.335412</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>2.073035</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3</td>
<td>0.915366</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>4</td>
<td>0.479221</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>5</td>
<td>0.273533</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>6</td>
<td>0.176612</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>7</td>
<td>0.102306</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>8</td>
<td>0.078614</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>9</td>
<td>0.041999</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>10</td>
<td>0.034461</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>12</td>
<td>0.033384</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>11</td>
<td>0.029076</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>14</td>
<td>0.014</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>13</td>
<td>0.012923</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>15</td>
<td>0.010769</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>17</td>
<td>0.009692</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>16</td>
<td>0.006461</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>18</td>
<td>0.004308</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>20</td>
<td>0.004308</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>19</td>
<td>0.004308</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>21</td>
<td>0.003231</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>25</td>
<td>0.003231</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>22</td>
<td>0.002154</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>34</td>
<td>0.002154</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>40</td>
<td>0.002154</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>36</td>
<td>0.001077</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>26</td>
<td>0.001077</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>28</td>
<td>0.001077</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>32</td>
<td>0.001077</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>24</td>
<td>0.001077</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>113</td>
<td>0.001077</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">32</td>
<td>45</td>
<td>0.001077</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">33</td>
<td>39</td>
<td>0.001077</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">34</td>
<td>27</td>
<td>0.001077</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">35</td>
<td>30</td>
<td>0.001077</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36</td>
<td>&lt;NA&gt;</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>During the months covered by the training data, nearly 90% of visitors did not add an item to their shopping cart during their first visit to the merchandise store (<code>added_to_cart = 0</code>). Only 10% of such visitors added an item to their shopping cart during this time.</li>
</ol>
</div>
</div>
</section>
<section id="reasons-for-and-handling-of-duplicates" class="level3">
<h3 class="anchored" data-anchor-id="reasons-for-and-handling-of-duplicates">Reasons For and Handling of Duplicates</h3>
<p><strong>Question 4. Comment on duplicates present in the data prepared above. What are some possible reasons for the presence of duplicates in the above prepared data? How should these be handled?</strong></p>
<p>Below we show that there are duplicates within the <code>fullvisitorid</code> column</p>
<div class="cell" data-tags="[]" data-execution_count="14">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Number of rows = </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ch">\n</span><span class="ss">Number of unique visitor IDs = "</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'fullvisitorid'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Largest visitNumber = </span><span class="sc">{</span>df[<span class="st">'visitNumber'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Number of rows = 92,859
Number of unique visitor IDs = 92,551
Largest visitNumber = 1</code></pre>
</div>
</div>
<p>These duplicates are retrieved below, showing that multiple <code>visitId</code>s are present for the same <code>visitorid</code></p>
<div class="cell" data-tags="[]" data-execution_count="15">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_num_dups <span class="op">=</span> (</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">"fullvisitorid"</span>])</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    .agg({<span class="st">"visitId"</span>: <span class="st">"count"</span>, <span class="st">"visitNumber"</span>: <span class="st">"max"</span>})</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"visitId"</span>: <span class="st">"num_visitIds"</span>})</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"num_visitIds &gt; 1"</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>display(df_num_dups.head())</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>display(df_num_dups.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">num_visitIds</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">124</td>
<td>0014997413479849928</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1186</td>
<td>012569301201854368</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1400</td>
<td>0153393931967124172</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1831</td>
<td>0196238382136996118</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2163</td>
<td>0233922069260074966</td>
<td>2</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">num_visitIds</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">91561</td>
<td>9897914422695841426</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">91653</td>
<td>9906208132011345120</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">91749</td>
<td>9915457192772678365</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">92054</td>
<td>9949751653823311987</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92079</td>
<td>9952616174324085427</td>
<td>2</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Duplicates can occur by
<ul>
<li><code>fullvisitorid</code></li>
<li><code>visitId</code></li>
</ul>
so, we should explore both cases separately.</li>
</ol>
</div>
</div>
<p>Duplicated <code>visitId</code>s are shown below</p>
<div class="cell" data-tags="[]" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dup_visit_ids <span class="op">=</span> df[df.duplicated(subset<span class="op">=</span>[<span class="st">"visitId"</span>], keep<span class="op">=</span><span class="va">False</span>)]</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>num_dups <span class="op">=</span> <span class="bu">len</span>(df[df.duplicated(subset<span class="op">=</span>[<span class="st">"visitId"</span>], keep<span class="op">=</span><span class="st">"first"</span>)])</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Found </span><span class="sc">{</span>num_dups<span class="sc">:,}</span><span class="ss"> duplicated visitIds out of "</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span>num_dups<span class="op">/</span><span class="bu">len</span>(df)<span class="sc">:.3f}</span><span class="ss">%)"</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    display(dup_visit_ids.sort_values(by<span class="op">=</span>[<span class="st">"visitId"</span>]).head(<span class="dv">25</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 742 duplicated visitIds out of 92,859 (0.799%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">product_detail_views</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">transact_revenue</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">28174</td>
<td>7673928089571501866</td>
<td>1472751431</td>
<td>1</td>
<td>2016-09-01 10:37:11</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>1</td>
<td>5</td>
<td>10</td>
<td>37</td>
<td>11</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>27</td>
<td>0</td>
<td>2</td>
<td>6</td>
<td>0</td>
<td>0</td>
<td>293</td>
<td>8</td>
<td>19</td>
<td>NaN</td>
<td>845</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">47204</td>
<td>6028120763017470092</td>
<td>1472751431</td>
<td>1</td>
<td>2016-09-01 10:37:11</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>1</td>
<td>5</td>
<td>10</td>
<td>37</td>
<td>11</td>
<td>dfa</td>
<td>cpm</td>
<td>Display</td>
<td>7</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>147</td>
<td>0</td>
<td>7</td>
<td>NaN</td>
<td>153</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">66489</td>
<td>4654710059786315542</td>
<td>1472752926</td>
<td>1</td>
<td>2016-09-01 11:02:06</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>1</td>
<td>5</td>
<td>11</td>
<td>2</td>
<td>6</td>
<td>youtube.com</td>
<td>referral</td>
<td>Social</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>18</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>50</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">14790</td>
<td>0622219713224273207</td>
<td>1472752926</td>
<td>1</td>
<td>2016-09-01 11:02:06</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>1</td>
<td>5</td>
<td>11</td>
<td>2</td>
<td>6</td>
<td>mall.googleplex.com</td>
<td>referral</td>
<td>Referral</td>
<td>7</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>167</td>
<td>0</td>
<td>7</td>
<td>NaN</td>
<td>178</td>
<td>Chrome</td>
<td>Linux</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">79228</td>
<td>0983194581450463928</td>
<td>1472771118</td>
<td>1</td>
<td>2016-09-01 16:05:18</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>1</td>
<td>5</td>
<td>16</td>
<td>5</td>
<td>18</td>
<td>reddit.com</td>
<td>referral</td>
<td>Social</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>34</td>
<td>0</td>
<td>2</td>
<td>NaN</td>
<td>15</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">64049</td>
<td>8679833862264857329</td>
<td>1472771118</td>
<td>1</td>
<td>2016-09-01 16:05:18</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>1</td>
<td>5</td>
<td>16</td>
<td>5</td>
<td>18</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Safari</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">62058</td>
<td>5501176514964856126</td>
<td>1472799309</td>
<td>1</td>
<td>2016-09-01 23:55:09</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>1</td>
<td>5</td>
<td>23</td>
<td>55</td>
<td>9</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>12</td>
<td>0</td>
<td>2</td>
<td>4</td>
<td>0</td>
<td>0</td>
<td>108</td>
<td>4</td>
<td>8</td>
<td>NaN</td>
<td>288</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">83797</td>
<td>5501176514964856126</td>
<td>1472799309</td>
<td>1</td>
<td>2016-09-02 00:00:01</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>143</td>
<td>0</td>
<td>5</td>
<td>NaN</td>
<td>75</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5052</td>
<td>3718403740052363161</td>
<td>1472826491</td>
<td>1</td>
<td>2016-09-02 07:28:11</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>7</td>
<td>28</td>
<td>11</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>27</td>
<td>0</td>
<td>2</td>
<td>9</td>
<td>36</td>
<td>2</td>
<td>70</td>
<td>9</td>
<td>16</td>
<td>NaN</td>
<td>196</td>
<td>Safari</td>
<td>iOS</td>
<td>tablet</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25190</td>
<td>0841953213802800334</td>
<td>1472826491</td>
<td>1</td>
<td>2016-09-02 07:28:11</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>7</td>
<td>28</td>
<td>11</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>83</td>
<td>0</td>
<td>3</td>
<td>15</td>
<td>45</td>
<td>0</td>
<td>361</td>
<td>20</td>
<td>59</td>
<td>NaN</td>
<td>873</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>4</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">41174</td>
<td>8072421534192464916</td>
<td>1472827968</td>
<td>1</td>
<td>2016-09-02 07:52:48</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>7</td>
<td>52</td>
<td>48</td>
<td>youtube.com</td>
<td>referral</td>
<td>Social</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Edge</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17780</td>
<td>3379865943266894087</td>
<td>1472827968</td>
<td>1</td>
<td>2016-09-02 07:52:48</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>7</td>
<td>52</td>
<td>48</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">78548</td>
<td>1755792970575692332</td>
<td>1472830743</td>
<td>1</td>
<td>2016-09-02 08:39:03</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>8</td>
<td>39</td>
<td>3</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>1</td>
<td>34</td>
<td>0</td>
<td>2</td>
<td>NaN</td>
<td>23</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">71863</td>
<td>7256457379544446924</td>
<td>1472830743</td>
<td>1</td>
<td>2016-09-02 08:39:03</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>8</td>
<td>39</td>
<td>3</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>4</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>1</td>
<td>17</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>31</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8965</td>
<td>0632675186889921612</td>
<td>1472837248</td>
<td>1</td>
<td>2016-09-02 10:27:28</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>10</td>
<td>27</td>
<td>28</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>1</td>
<td>26</td>
<td>0</td>
<td>2</td>
<td>NaN</td>
<td>8</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">28879</td>
<td>3083609601584075244</td>
<td>1472837248</td>
<td>1</td>
<td>2016-09-02 10:27:28</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>10</td>
<td>27</td>
<td>28</td>
<td>dfa</td>
<td>cpm</td>
<td>Display</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Safari</td>
<td>iOS</td>
<td>mobile</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4095</td>
<td>921700488150606409</td>
<td>1472840651</td>
<td>1</td>
<td>2016-09-02 11:24:11</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>11</td>
<td>24</td>
<td>11</td>
<td>analytics.google.com</td>
<td>referral</td>
<td>Referral</td>
<td>12</td>
<td>0</td>
<td>3</td>
<td>1</td>
<td>9</td>
<td>1</td>
<td>62</td>
<td>1</td>
<td>9</td>
<td>NaN</td>
<td>71</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>1</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">70680</td>
<td>0519598949480129245</td>
<td>1472840651</td>
<td>1</td>
<td>2016-09-02 11:24:11</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>11</td>
<td>24</td>
<td>11</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>18</td>
<td>0</td>
<td>108</td>
<td>0</td>
<td>9</td>
<td>NaN</td>
<td>1906</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10460</td>
<td>7005010567253535201</td>
<td>1472845470</td>
<td>1</td>
<td>2016-09-02 12:44:30</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>12</td>
<td>44</td>
<td>30</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>10</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">18462</td>
<td>837289177119980105</td>
<td>1472845470</td>
<td>1</td>
<td>2016-09-02 12:44:30</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>2</td>
<td>6</td>
<td>12</td>
<td>44</td>
<td>30</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">48661</td>
<td>0634421561835257232</td>
<td>1472930237</td>
<td>1</td>
<td>2016-09-03 12:17:17</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>3</td>
<td>7</td>
<td>12</td>
<td>17</td>
<td>17</td>
<td>youtube.com</td>
<td>referral</td>
<td>Social</td>
<td>4</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>9</td>
<td>0</td>
<td>31</td>
<td>1</td>
<td>3</td>
<td>NaN</td>
<td>119</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">88669</td>
<td>8889451242449489132</td>
<td>1472930237</td>
<td>1</td>
<td>2016-09-03 12:17:17</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>3</td>
<td>7</td>
<td>12</td>
<td>17</td>
<td>17</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Safari</td>
<td>iOS</td>
<td>mobile</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38741</td>
<td>1935680082667534577</td>
<td>1472972244</td>
<td>1</td>
<td>2016-09-04 00:00:42</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>4</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>42</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>12</td>
<td>0</td>
<td>2</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>115</td>
<td>3</td>
<td>9</td>
<td>NaN</td>
<td>203</td>
<td>Chrome</td>
<td>iOS</td>
<td>mobile</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12240</td>
<td>1935680082667534577</td>
<td>1472972244</td>
<td>1</td>
<td>2016-09-03 23:57:24</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>3</td>
<td>7</td>
<td>23</td>
<td>57</td>
<td>24</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>6</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>106</td>
<td>0</td>
<td>6</td>
<td>NaN</td>
<td>144</td>
<td>Chrome</td>
<td>iOS</td>
<td>mobile</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9641</td>
<td>1007310562563797720</td>
<td>1473058799</td>
<td>1</td>
<td>2016-09-05 00:00:01</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>5</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>1</td>
<td>34</td>
<td>0</td>
<td>2</td>
<td>NaN</td>
<td>52</td>
<td>Safari (in-app)</td>
<td>iOS</td>
<td>mobile</td>
<td>0</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>For the same <code>visitId</code>, different traffic sources (<code>source</code>, <code>medium</code>, <code>channelGrouping</code>) bring the same or different visitors (<code>fullvisitorid</code>) to the website at the same <code>datetime</code> (<code>visitStartTime</code>). Google Analytics assigns the same <code>visitId</code> to such visitors. There are two types of nested duplicates here
<ul>
<li>the same visitor accessing the merchandise store from
<ul>
<li>multiple devices at the same time
<ul>
<li>this cross-device tracking appears to be <a href="https://blog.google/products/marketingplatform/360/cross-device-capabilities/">allowed by Google Analytics</a></li>
</ul></li>
<li>the same device and same browser (using separate browser windows after clearing cookies) at the same time
<ul>
<li>this is also <a href="https://www.quora.com/In-Google-Analytics-why-do-I-have-more-unique-visitors-than-visits">allowed by Google Analytics</a></li>
</ul></li>
</ul></li>
<li>different visitors are accessing the merchandise store from multiple devices at the same time
<ul>
<li>this is not a duplicated occurrence</li>
<li>most likely this corresponds to two distinct visitors who happened to navigate to the site at the same time</li>
</ul></li>
</ul></li>
<li>There are a negligible number of such duplicates in the dataset.</li>
</ol>
</div>
</div>
<p>Duplicated <code>fullvisitorId</code>s are shown below</p>
<div class="cell" data-tags="[]" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>dup_visitor_ids <span class="op">=</span> df[df.duplicated(subset<span class="op">=</span>[<span class="st">"fullvisitorid"</span>], keep<span class="op">=</span><span class="va">False</span>)]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>num_dups <span class="op">=</span> <span class="bu">len</span>(df[df.duplicated(subset<span class="op">=</span>[<span class="st">"fullvisitorid"</span>], keep<span class="op">=</span><span class="st">"first"</span>)])</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Found </span><span class="sc">{</span>num_dups<span class="sc">:,}</span><span class="ss"> duplicated fullvisitorid out of "</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span>num_dups<span class="op">/</span><span class="bu">len</span>(df)<span class="sc">:.3f}</span><span class="ss">%)"</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    display(dup_visitor_ids.sort_values(by<span class="op">=</span>[<span class="st">"fullvisitorid"</span>]).head(<span class="dv">25</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 308 duplicated fullvisitorid out of 92,859 (0.332%)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">product_detail_views</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">transact_revenue</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">50597</td>
<td>0014997413479849928</td>
<td>1477513747</td>
<td>1</td>
<td>2016-10-26 13:29:07</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>26</td>
<td>4</td>
<td>13</td>
<td>29</td>
<td>7</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>14</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>18</td>
<td>0</td>
<td>38</td>
<td>4</td>
<td>10</td>
<td>NaN</td>
<td>77</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">62473</td>
<td>0014997413479849928</td>
<td>1474324872</td>
<td>1</td>
<td>2016-09-19 15:41:12</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>19</td>
<td>2</td>
<td>15</td>
<td>41</td>
<td>12</td>
<td>mall.googleplex.com</td>
<td>referral</td>
<td>Referral</td>
<td>17</td>
<td>0</td>
<td>2</td>
<td>3</td>
<td>9</td>
<td>0</td>
<td>168</td>
<td>5</td>
<td>12</td>
<td>NaN</td>
<td>349</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6720</td>
<td>012569301201854368</td>
<td>1477496472</td>
<td>1</td>
<td>2016-10-26 08:41:12</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>26</td>
<td>4</td>
<td>8</td>
<td>41</td>
<td>12</td>
<td>analytics.google.com</td>
<td>referral</td>
<td>Referral</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">32410</td>
<td>012569301201854368</td>
<td>1477339547</td>
<td>1</td>
<td>2016-10-24 13:05:52</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>24</td>
<td>2</td>
<td>13</td>
<td>5</td>
<td>52</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>10</td>
<td>0</td>
<td>2</td>
<td>NaN</td>
<td>12</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">11900</td>
<td>0153393931967124172</td>
<td>1481528488</td>
<td>1</td>
<td>2016-12-11 23:41:28</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>11</td>
<td>1</td>
<td>23</td>
<td>41</td>
<td>28</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>15</td>
<td>0</td>
<td>5</td>
<td>NaN</td>
<td>1105</td>
<td>Safari</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">62110</td>
<td>0153393931967124172</td>
<td>1481528488</td>
<td>1</td>
<td>2016-12-12 00:00:03</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>12</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>3</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>13</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>9</td>
<td>0</td>
<td>92</td>
<td>2</td>
<td>11</td>
<td>NaN</td>
<td>614</td>
<td>Safari</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">11590</td>
<td>0196238382136996118</td>
<td>1482220536</td>
<td>1</td>
<td>2016-12-20 00:00:19</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>20</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>19</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>4</td>
<td>0</td>
<td>6</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>4</td>
<td>165.0</td>
<td>61</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15516</td>
<td>0196238382136996118</td>
<td>1482220536</td>
<td>1</td>
<td>2016-12-19 23:55:36</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>19</td>
<td>2</td>
<td>23</td>
<td>55</td>
<td>36</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>11</td>
<td>0</td>
<td>5</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>7</td>
<td>1</td>
<td>9</td>
<td>NaN</td>
<td>99</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>1</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">72238</td>
<td>0233922069260074966</td>
<td>1474926165</td>
<td>1</td>
<td>2016-09-26 14:42:45</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>26</td>
<td>2</td>
<td>14</td>
<td>42</td>
<td>45</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>18</td>
<td>0</td>
<td>5</td>
<td>NaN</td>
<td>869</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">91048</td>
<td>0233922069260074966</td>
<td>1477516633</td>
<td>1</td>
<td>2016-10-26 14:17:13</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>26</td>
<td>4</td>
<td>14</td>
<td>17</td>
<td>13</td>
<td>mall.googleplex.com</td>
<td>referral</td>
<td>Referral</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>14</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>46</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">79391</td>
<td>023880134273808115</td>
<td>1473836398</td>
<td>1</td>
<td>2016-09-14 00:01:08</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>14</td>
<td>4</td>
<td>0</td>
<td>1</td>
<td>8</td>
<td>mall.googleplex.com</td>
<td>referral</td>
<td>Referral</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>68</td>
<td>0</td>
<td>2</td>
<td>NaN</td>
<td>9</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29785</td>
<td>023880134273808115</td>
<td>1473836398</td>
<td>1</td>
<td>2016-09-13 23:59:58</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>13</td>
<td>3</td>
<td>23</td>
<td>59</td>
<td>58</td>
<td>mall.googleplex.com</td>
<td>referral</td>
<td>Referral</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">71200</td>
<td>0253256708649119169</td>
<td>1475866302</td>
<td>1</td>
<td>2016-10-07 11:51:42</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>7</td>
<td>6</td>
<td>11</td>
<td>51</td>
<td>42</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>17</td>
<td>0</td>
<td>4</td>
<td>2</td>
<td>9</td>
<td>0</td>
<td>60</td>
<td>2</td>
<td>12</td>
<td>NaN</td>
<td>185</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>2</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29788</td>
<td>0253256708649119169</td>
<td>1477495482</td>
<td>1</td>
<td>2016-10-26 08:24:42</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>26</td>
<td>4</td>
<td>8</td>
<td>24</td>
<td>42</td>
<td>mall.googleplex.com</td>
<td>referral</td>
<td>Referral</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14576</td>
<td>0273626426804732878</td>
<td>1477523531</td>
<td>1</td>
<td>2016-10-26 16:12:11</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>26</td>
<td>4</td>
<td>16</td>
<td>12</td>
<td>11</td>
<td>mall.googleplex.com</td>
<td>referral</td>
<td>Referral</td>
<td>6</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>32</td>
<td>0</td>
<td>6</td>
<td>NaN</td>
<td>71</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27661</td>
<td>0273626426804732878</td>
<td>1475625049</td>
<td>1</td>
<td>2016-10-04 16:50:49</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>4</td>
<td>3</td>
<td>16</td>
<td>50</td>
<td>49</td>
<td>mall.googleplex.com</td>
<td>referral</td>
<td>Referral</td>
<td>17</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>27</td>
<td>1</td>
<td>101</td>
<td>0</td>
<td>16</td>
<td>NaN</td>
<td>279</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">68152</td>
<td>0495389417785084319</td>
<td>1477460221</td>
<td>1</td>
<td>2016-10-25 22:37:01</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>25</td>
<td>3</td>
<td>22</td>
<td>37</td>
<td>1</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>12</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">16918</td>
<td>0495389417785084319</td>
<td>1476424324</td>
<td>1</td>
<td>2016-10-13 22:52:04</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>13</td>
<td>5</td>
<td>22</td>
<td>52</td>
<td>4</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>45</td>
<td>0</td>
<td>3</td>
<td>2</td>
<td>54</td>
<td>4</td>
<td>108</td>
<td>3</td>
<td>34</td>
<td>NaN</td>
<td>2644</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>4</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">44564</td>
<td>0510616407042133197</td>
<td>1477499309</td>
<td>1</td>
<td>2016-10-26 09:28:29</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>26</td>
<td>4</td>
<td>9</td>
<td>28</td>
<td>29</td>
<td>sites.google.com</td>
<td>referral</td>
<td>Referral</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>15</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>20</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">16656</td>
<td>0510616407042133197</td>
<td>1473965199</td>
<td>1</td>
<td>2016-09-15 11:46:39</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>15</td>
<td>5</td>
<td>11</td>
<td>46</td>
<td>39</td>
<td>mall.googleplex.com</td>
<td>referral</td>
<td>Referral</td>
<td>28</td>
<td>0</td>
<td>3</td>
<td>3</td>
<td>36</td>
<td>0</td>
<td>36</td>
<td>3</td>
<td>23</td>
<td>NaN</td>
<td>1183</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>2</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">84961</td>
<td>0567348342496807208</td>
<td>1480060521</td>
<td>1</td>
<td>2016-11-25 00:08:08</td>
<td>United States</td>
<td>4</td>
<td>11</td>
<td>25</td>
<td>6</td>
<td>0</td>
<td>8</td>
<td>8</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>9</td>
<td>0</td>
<td>2</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>21</td>
<td>3</td>
<td>6</td>
<td>NaN</td>
<td>103</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">92691</td>
<td>0567348342496807208</td>
<td>1480060521</td>
<td>1</td>
<td>2016-11-24 23:55:21</td>
<td>United States</td>
<td>4</td>
<td>11</td>
<td>24</td>
<td>5</td>
<td>23</td>
<td>55</td>
<td>21</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>24</td>
<td>0</td>
<td>2</td>
<td>NaN</td>
<td>66</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">32159</td>
<td>0611144195339874223</td>
<td>1477810729</td>
<td>1</td>
<td>2016-10-30 00:00:13</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>30</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>13</td>
<td>mall.googleplex.com</td>
<td>referral</td>
<td>Referral</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>18</td>
<td>0</td>
<td>10</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>65</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">83274</td>
<td>0611144195339874223</td>
<td>1477810729</td>
<td>1</td>
<td>2016-10-29 23:58:49</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>29</td>
<td>7</td>
<td>23</td>
<td>58</td>
<td>49</td>
<td>mall.googleplex.com</td>
<td>referral</td>
<td>Referral</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>18</td>
<td>0</td>
<td>10</td>
<td>0</td>
<td>3</td>
<td>NaN</td>
<td>33</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">33391</td>
<td>0707913578847667979</td>
<td>1480233588</td>
<td>1</td>
<td>2016-11-26 23:59:48</td>
<td>United States</td>
<td>4</td>
<td>11</td>
<td>26</td>
<td>7</td>
<td>23</td>
<td>59</td>
<td>48</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>12</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>0</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>For the same <code>fullvisitorid</code>, different traffic sources (<code>source</code>, <code>medium</code>, <code>channelGrouping</code>) bring the same visitor (<code>fullvisitorid</code>) to the website at the different <code>datetime</code>s (<code>visitStartTime</code>s) from the same device (<code>browser</code>, <code>os</code>, <code>deviceCategory</code>). There are two types of nested duplicates here
<ul>
<li>the same visit by the same visitor with a &lt;30 minute period of inactivity between duplicates
<ul>
<li>(by default) <a href="https://support.google.com/analytics/answer/2731565?hl=en#time-based-expiration&amp;zippy=%2Cin-this-article">Google Analytics allows up to 30 minutes of inactivity before starting a new visit</a>, so it is not clear why such a short period of inactivity should start a new <em>instance</em> of the same visit instead of just accumulating stats into the same <em>instance</em></li>
</ul></li>
<li>a different visit by the same visitor with a &gt;30 minute period of inactivity between duplicates
<ul>
<li>it is also not clear why these duplicates are present in the data</li>
</ul></li>
</ul></li>
<li>Since
<ul>
<li>the use-case for this project requires attributes of <strong>only</strong> the first visit (per visitor) to be used to predict the probability of a purchase during a future visit by the same visitor</li>
<li>it is not clear why this type of duplicated record is present in the prepared data</li>
</ul>
we will want to drop this type of duplicate from the training, validation and test splits of the prepared data (we’re assuming that the same type of problem can occur throughout the dataset and not just in the training data).</li>
<li>There are a negligible number of such duplicates in the dataset.</li>
</ol>
</div>
</div>
<p>With this in mind, columns with duplicates in the <code>fullvisitorid</code> column are dropped. This will be done using Python</p>
<div class="cell" data-tags="[]" data-execution_count="18">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>[<span class="st">"fullvisitorid"</span>], keep<span class="op">=</span><span class="st">"first"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="nested-promotion-column" class="level3">
<h3 class="anchored" data-anchor-id="nested-promotion-column">Nested Promotion Column</h3>
<p><strong>Question 5. Show and comment on unique values in the nested promotion column.</strong></p>
<p>The number of promotions and products displayed (impressions) and clicked are shown below</p>
<div class="cell" data-tags="[]" data-execution_count="19">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_displayed"</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_clicked"</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_views"</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_clicks"</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_detail_views"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    df_num_visitor_counts <span class="op">=</span> (</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        df[c]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        .value_counts(dropna<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"num_visitors"</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="ss">f"num_</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>})</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> (</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">type</span>(df_num_visitor_counts.query(<span class="st">"num_visitors == 0"</span>)[c].squeeze()).<span class="va">__name__</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">==</span> <span class="st">"NAType"</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    display(df_num_visitor_counts.query(<span class="st">"num_visitors &gt; 0"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">num_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>9</td>
<td>42840</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>28655</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>18</td>
<td>12938</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>27</td>
<td>4079</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>36</td>
<td>1729</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>45</td>
<td>875</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>54</td>
<td>426</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>13</td>
<td>251</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>63</td>
<td>242</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>72</td>
<td>144</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>81</td>
<td>74</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>90</td>
<td>58</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>26</td>
<td>54</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>99</td>
<td>30</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>117</td>
<td>28</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>108</td>
<td>22</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>39</td>
<td>17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>135</td>
<td>14</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>126</td>
<td>13</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>153</td>
<td>9</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>198</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>65</td>
<td>6</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>52</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>144</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>171</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>180</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>162</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>252</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>342</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>216</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>765</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>432</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">32</td>
<td>12</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">33</td>
<td>711</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">34</td>
<td>31</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">35</td>
<td>143</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36</td>
<td>189</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">37</td>
<td>50</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>130</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">39</td>
<td>279</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">40</td>
<td>22</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">41</td>
<td>225</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42</td>
<td>207</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">43</td>
<td>297</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">44</td>
<td>234</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">45</td>
<td>522</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">46</td>
<td>315</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">47</td>
<td>49</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">num_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>78328</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>10802</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>2019</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3</td>
<td>752</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>4</td>
<td>318</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>5</td>
<td>145</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>6</td>
<td>76</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>7</td>
<td>47</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>8</td>
<td>20</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>9</td>
<td>13</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>10</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>11</td>
<td>6</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>14</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>12</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>16</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>17</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>34</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>30</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>21</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>23</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>19</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>13</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>15</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">num_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>26848</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>12</td>
<td>14273</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>24</td>
<td>4663</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>36</td>
<td>2343</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>7</td>
<td>2271</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">602</td>
<td>366</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">603</td>
<td>685</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">604</td>
<td>647</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">605</td>
<td>719</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">606</td>
<td>577</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>607 rows × 2 columns</p>
</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">num_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>68175</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>8680</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>5455</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3</td>
<td>3056</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>4</td>
<td>2036</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">62</td>
<td>42</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">63</td>
<td>125</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">64</td>
<td>71</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">65</td>
<td>48</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">66</td>
<td>61</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>67 rows × 2 columns</p>
</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">product_detail_views</th>
<th data-quarto-table-cell-role="th">num_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>68220</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>10547</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>5197</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3</td>
<td>2928</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>4</td>
<td>1734</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">56</td>
<td>41</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">57</td>
<td>82</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">58</td>
<td>31</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">59</td>
<td>122</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">60</td>
<td>71</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>61 rows × 2 columns</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Product views are the number of times a product was seen while in a list of other products (eg. on a product listing page or in a product category page).</li>
<li>Product clicks are the number of times a product was clicked on after being viewed.</li>
<li>Product detail views are the number of times a visitor has visited a product’s page (not just viewed its details as part of a product listing).
<ul>
<li>a visitor might have viewed product details page for products that are
<ul>
<li>part of a product listing</li>
<li>not part of a product listing</li>
</ul></li>
</ul></li>
<li>Similar logic applies to promotions (eg. banners) views and clicks.</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Products and promotions on the merchandise store’s website on the Google Marketplace are not being
<ul>
<li>viewed (as part of a listing or in detail)</li>
<li>clicked</li>
</ul>
often.</li>
</ol>
</div>
</div>
<p>Promotion-related columns are flattened and shown (see <code>promotionActionInfo</code>) for a single visit</p>
<div class="cell" data-tags="[]" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ss">        WITH visit_promotion_attrs AS (</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="ss">            SELECT fullvisitorid,</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitId,</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitNumber,</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="ss">                   DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific') AS visitStartTime,</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="ss">                   CAST(h.ecommerceaction.action_type AS INT64) AS action_type,</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="ss">                   h.promotion,</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="ss">                   h.promotionActionInfo AS pa_info,</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="ss">                   trafficSource.source,</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="ss">                   trafficSource.medium,</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="ss">                   channelGrouping,</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.browser,</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.operatingSystem,</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.deviceCategory</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="ss">            FROM `data-to-insights.ecommerce.web_analytics`,</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="ss">            UNNEST(hits) AS h</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="ss">            WHERE visitId = 1476880065  -- 1476880065, 1478579523, 1474972357, 1478844153</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="ss">            AND geoNetwork.country = 'United States'</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="ss">        )</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="ss">        SELECT * EXCEPT(promotion, promoId, pa_info, visitStartTime),</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="ss">               pa_info,</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="ss">               CASE WHEN pa_info IS NOT NULL THEN pa_info.promoIsView ELSE NULL END AS view_promo,</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="ss">               CASE WHEN pa_info IS NOT NULL THEN pa_info.promoIsClick ELSE NULL END AS click_promo</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="ss">        FROM visit_promotion_attrs</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="ss">        LEFT JOIN UNNEST(promotion) as p</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>df_raw <span class="op">=</span> run_sql_query(query, <span class="op">**</span>gcp_auth_dict, show_df<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>df_raw[<span class="st">"action_type"</span>] <span class="op">=</span> df_raw[<span class="st">"action_type"</span>].<span class="bu">map</span>(mapper)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_colwidth"</span>, <span class="va">None</span>, <span class="st">"display.max_rows"</span>, <span class="va">None</span>):</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    display(df_raw.head(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:07:00.571...done at 2023-04-13 17:07:02.254 (1.683 seconds).
Query returned 42 rows</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">action_type</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">operatingSystem</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">promoName</th>
<th data-quarto-table-cell-role="th">promoCreative</th>
<th data-quarto-table-cell-role="th">promoPosition</th>
<th data-quarto-table-cell-role="th">pa_info</th>
<th data-quarto-table-cell-role="th">view_promo</th>
<th data-quarto-table-cell-role="th">click_promo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>Unknown</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>Unknown</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>Unknown</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>Unknown</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>Unknown</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>Apparel</td>
<td>home_main_link_apparel.jpg</td>
<td>Row 1</td>
<td>{'promoIsView': True, 'promoIsClick': None}</td>
<td>True</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>Unknown</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>Backpacks</td>
<td>home_bags_google_2.jpg</td>
<td>Row 2 Combo</td>
<td>{'promoIsView': True, 'promoIsClick': None}</td>
<td>True</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>Unknown</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>Mens T-Shirts</td>
<td>mens-tshirts.jpg</td>
<td>Row 3-1</td>
<td>{'promoIsView': True, 'promoIsClick': None}</td>
<td>True</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>Unknown</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>Womens T-Shirts</td>
<td>womens-tshirts.jpg</td>
<td>Row 3-2</td>
<td>{'promoIsView': True, 'promoIsClick': None}</td>
<td>True</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>Unknown</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>Office</td>
<td>green_row_link_to_office.jpg</td>
<td>Row 5 Color Combo</td>
<td>{'promoIsView': True, 'promoIsClick': None}</td>
<td>True</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>Unknown</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>Drinkware</td>
<td>red_row_hydrate.jpg</td>
<td>Row 4 Color Combo</td>
<td>{'promoIsView': True, 'promoIsClick': None}</td>
<td>True</td>
<td>&lt;NA&gt;</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><code>promotionActionInfo</code> contains information about visitor views and clicks.</li>
<li>The <code>CASE WHEN</code> was constructed for both <code>view_promo</code> and <code>click_promo</code> columns based on the nested <code>promotionActionInfo</code> (mapped to <code>pa_info</code>) column.</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>When <code>view_promo = True</code>, a visitor has viewed a promotion. If it is not viewed, then it is <code>NULL</code>.</li>
<li>When a visitor clicks a promotion after viewing it
<ul>
<li><code>click_promo = True</code></li>
<li><code>view_promo</code> is <code>NULL</code>
<ul>
<li>this prevents double-counting a promotion that is both viewed and clicked</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>
</section>
<section id="nested-product-column" class="level3">
<h3 class="anchored" data-anchor-id="nested-product-column">Nested Product Column</h3>
<p><strong>Question 6. Show and comment on unique values in the nested product column.</strong></p>
<p>Product-related columns are flattened and shown for a single visit</p>
<div class="cell" data-tags="[]" data-execution_count="21">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ss">        WITH visit_product_attrs AS (</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="ss">            SELECT fullvisitorid,</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="ss">               visitId,</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="ss">               visitNumber,</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="ss">               DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific') AS visitStartTime,</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="ss">               CAST(h.ecommerceaction.action_type AS INT64) AS action_type,</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="ss">               h.product,</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="ss">               (CASE WHEN ARRAY_LENGTH(h.product) = 0 THEN 0 ELSE ARRAY_LENGTH(h.product) END) AS product_count,</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="ss">               (CASE WHEN CAST(h.eCommerceAction.action_type AS INT64) = 2 THEN 1 ELSE 0 END) AS product_details_viewed,</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="ss">               trafficSource.source,</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="ss">               trafficSource.medium,</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="ss">               channelGrouping,</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="ss">               device.browser,</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="ss">               device.operatingSystem,</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="ss">               device.deviceCategory</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="ss">            FROM `data-to-insights.ecommerce.web_analytics`,</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="ss">            UNNEST(hits) AS h</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="ss">            WHERE visitId = 1478579523  -- 1478579523, 1474972357</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="ss">            AND geoNetwork.country = 'United States'</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="ss">        )</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="ss">        SELECT *,</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="ss">               p.isImpression AS viewed_product,</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="ss">               p.isClick AS clicked_product</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="ss">        FROM visit_product_attrs</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="ss">        LEFT JOIN UNNEST(product) as p</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>df_raw <span class="op">=</span> run_sql_query(query, <span class="op">**</span>gcp_auth_dict, show_df<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>df_raw[<span class="st">"action_type"</span>] <span class="op">=</span> df_raw[<span class="st">"action_type"</span>].<span class="bu">map</span>(mapper)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    display(df_raw.head())</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    display(df_raw.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:07:08.966...done at 2023-04-13 17:07:11.872 (2.906 seconds).
Query returned 266 rows</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">action_type</th>
<th data-quarto-table-cell-role="th">product</th>
<th data-quarto-table-cell-role="th">product_count</th>
<th data-quarto-table-cell-role="th">product_details_viewed</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">operatingSystem</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">productSKU</th>
<th data-quarto-table-cell-role="th">v2ProductName</th>
<th data-quarto-table-cell-role="th">v2ProductCategory</th>
<th data-quarto-table-cell-role="th">productVariant</th>
<th data-quarto-table-cell-role="th">productBrand</th>
<th data-quarto-table-cell-role="th">productRevenue</th>
<th data-quarto-table-cell-role="th">localProductRevenue</th>
<th data-quarto-table-cell-role="th">productPrice</th>
<th data-quarto-table-cell-role="th">localProductPrice</th>
<th data-quarto-table-cell-role="th">productQuantity</th>
<th data-quarto-table-cell-role="th">productRefundAmount</th>
<th data-quarto-table-cell-role="th">localProductRefundAmount</th>
<th data-quarto-table-cell-role="th">isImpression</th>
<th data-quarto-table-cell-role="th">isClick</th>
<th data-quarto-table-cell-role="th">customDimensions</th>
<th data-quarto-table-cell-role="th">customMetrics</th>
<th data-quarto-table-cell-role="th">productListName</th>
<th data-quarto-table-cell-role="th">productListPosition</th>
<th data-quarto-table-cell-role="th">viewed_product</th>
<th data-quarto-table-cell-role="th">clicked_product</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>7270403007208566857</td>
<td>1478579523</td>
<td>1</td>
<td>2016-11-07 20:32:03</td>
<td>Unknown</td>
<td>[]</td>
<td>0</td>
<td>0</td>
<td>siliconvalley.about.com</td>
<td>referral</td>
<td>Referral</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>[]</td>
<td>[]</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>7270403007208566857</td>
<td>1478579523</td>
<td>1</td>
<td>2016-11-07 20:32:03</td>
<td>Unknown</td>
<td>[]</td>
<td>0</td>
<td>0</td>
<td>siliconvalley.about.com</td>
<td>referral</td>
<td>Referral</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>[]</td>
<td>[]</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>7270403007208566857</td>
<td>1478579523</td>
<td>1</td>
<td>2016-11-07 20:32:03</td>
<td>Unknown</td>
<td>[]</td>
<td>0</td>
<td>0</td>
<td>siliconvalley.about.com</td>
<td>referral</td>
<td>Referral</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>[]</td>
<td>[]</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>7270403007208566857</td>
<td>1478579523</td>
<td>1</td>
<td>2016-11-07 20:32:03</td>
<td>Unknown</td>
<td>[]</td>
<td>0</td>
<td>0</td>
<td>siliconvalley.about.com</td>
<td>referral</td>
<td>Referral</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>[]</td>
<td>[]</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>7270403007208566857</td>
<td>1478579523</td>
<td>1</td>
<td>2016-11-07 20:32:03</td>
<td>Unknown</td>
<td>[]</td>
<td>0</td>
<td>0</td>
<td>siliconvalley.about.com</td>
<td>referral</td>
<td>Referral</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>[]</td>
<td>[]</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">action_type</th>
<th data-quarto-table-cell-role="th">product</th>
<th data-quarto-table-cell-role="th">product_count</th>
<th data-quarto-table-cell-role="th">product_details_viewed</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">operatingSystem</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">productSKU</th>
<th data-quarto-table-cell-role="th">v2ProductName</th>
<th data-quarto-table-cell-role="th">v2ProductCategory</th>
<th data-quarto-table-cell-role="th">productVariant</th>
<th data-quarto-table-cell-role="th">productBrand</th>
<th data-quarto-table-cell-role="th">productRevenue</th>
<th data-quarto-table-cell-role="th">localProductRevenue</th>
<th data-quarto-table-cell-role="th">productPrice</th>
<th data-quarto-table-cell-role="th">localProductPrice</th>
<th data-quarto-table-cell-role="th">productQuantity</th>
<th data-quarto-table-cell-role="th">productRefundAmount</th>
<th data-quarto-table-cell-role="th">localProductRefundAmount</th>
<th data-quarto-table-cell-role="th">isImpression</th>
<th data-quarto-table-cell-role="th">isClick</th>
<th data-quarto-table-cell-role="th">customDimensions</th>
<th data-quarto-table-cell-role="th">customMetrics</th>
<th data-quarto-table-cell-role="th">productListName</th>
<th data-quarto-table-cell-role="th">productListPosition</th>
<th data-quarto-table-cell-role="th">viewed_product</th>
<th data-quarto-table-cell-role="th">clicked_product</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">261</td>
<td>7270403007208566857</td>
<td>1478579523</td>
<td>1</td>
<td>2016-11-07 20:32:03</td>
<td>Unknown</td>
<td>[{'productSKU': 'GGOEGAAX0318', 'v2ProductName...</td>
<td>12</td>
<td>0</td>
<td>siliconvalley.about.com</td>
<td>referral</td>
<td>Referral</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>GGOEGAAX0686</td>
<td>YouTube Youth Short Sleeve Tee Red</td>
<td>Home/Shop by Brand/YouTube/</td>
<td>(not set)</td>
<td>(not set)</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>18990000</td>
<td>18990000</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>True</td>
<td>&lt;NA&gt;</td>
<td>[]</td>
<td>[]</td>
<td>Category</td>
<td>9</td>
<td>True</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">262</td>
<td>7270403007208566857</td>
<td>1478579523</td>
<td>1</td>
<td>2016-11-07 20:32:03</td>
<td>Unknown</td>
<td>[{'productSKU': 'GGOEGAAX0318', 'v2ProductName...</td>
<td>12</td>
<td>0</td>
<td>siliconvalley.about.com</td>
<td>referral</td>
<td>Referral</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>GGOEYHPA003510</td>
<td>YouTube Trucker Hat</td>
<td>Home/Shop by Brand/YouTube/</td>
<td>(not set)</td>
<td>(not set)</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>21990000</td>
<td>21990000</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>True</td>
<td>&lt;NA&gt;</td>
<td>[]</td>
<td>[]</td>
<td>Category</td>
<td>10</td>
<td>True</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">263</td>
<td>7270403007208566857</td>
<td>1478579523</td>
<td>1</td>
<td>2016-11-07 20:32:03</td>
<td>Unknown</td>
<td>[{'productSKU': 'GGOEGAAX0318', 'v2ProductName...</td>
<td>12</td>
<td>0</td>
<td>siliconvalley.about.com</td>
<td>referral</td>
<td>Referral</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>GGOEGAAX0330</td>
<td>YouTube Men's Skater Tee Charcoal</td>
<td>Home/Shop by Brand/YouTube/</td>
<td>(not set)</td>
<td>(not set)</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>19990000</td>
<td>19990000</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>True</td>
<td>&lt;NA&gt;</td>
<td>[]</td>
<td>[]</td>
<td>Category</td>
<td>11</td>
<td>True</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">264</td>
<td>7270403007208566857</td>
<td>1478579523</td>
<td>1</td>
<td>2016-11-07 20:32:03</td>
<td>Unknown</td>
<td>[{'productSKU': 'GGOEGAAX0318', 'v2ProductName...</td>
<td>12</td>
<td>0</td>
<td>siliconvalley.about.com</td>
<td>referral</td>
<td>Referral</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>GGOEYDHJ056099</td>
<td>22 oz YouTube Bottle Infuser</td>
<td>Home/Shop by Brand/YouTube/</td>
<td>(not set)</td>
<td>(not set)</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>4990000</td>
<td>4990000</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>True</td>
<td>&lt;NA&gt;</td>
<td>[]</td>
<td>[]</td>
<td>Category</td>
<td>12</td>
<td>True</td>
<td>&lt;NA&gt;</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">265</td>
<td>7270403007208566857</td>
<td>1478579523</td>
<td>1</td>
<td>2016-11-07 20:32:03</td>
<td>Unknown</td>
<td>[]</td>
<td>0</td>
<td>0</td>
<td>siliconvalley.about.com</td>
<td>referral</td>
<td>Referral</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>[]</td>
<td>[]</td>
<td>None</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
<td>&lt;NA&gt;</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The <code>product</code> column is a nested column with a multi-element array. Each element (dictionary) of the array corresponds to a different product in a listing or category of products. With the BigQuery <code>UNNEST()</code> function, this column is exploded into the following standalone columns
<ul>
<li><code>productSKU</code></li>
<li><code>v2ProductName</code></li>
<li><code>v2ProductCategory</code></li>
<li><code>productVariant</code></li>
<li><code>productBrand</code></li>
<li><code>productRevenue</code></li>
<li><code>localProductRevenue</code></li>
<li><code>productPrice</code></li>
<li><code>localProductPrice</code></li>
<li><code>productQuantity</code></li>
<li><code>productRefundAmount</code></li>
<li><code>localProductRefundAmount</code></li>
<li><code>isImpression</code></li>
<li><code>isClick</code></li>
<li><code>customDimensions</code></li>
<li><code>customMetrics</code></li>
<li><code>productListName</code></li>
<li><code>productListPosition</code></li>
<li><code>viewed_product</code></li>
<li><code>clicked_product</code></li>
</ul></li>
<li><code>viewed_product</code> is <code>True</code> for every product in the product listing that was viewed.</li>
</ol>
</div>
</div>
<p>If a product is viewed in a listing (<code>product_count &gt; 0</code>) during a visit, then there are only two possible values for <code>clicked_product</code> and <code>viewed_product</code>, as shown below</p>
<div class="cell" data-tags="[]" data-execution_count="22">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"viewed_product"</span>, <span class="st">"clicked_product"</span>]:</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># show unique values</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    display(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>        df_raw.query(<span class="st">"product_count &gt; 0"</span>)[c].value_counts(dropna<span class="op">=</span><span class="va">False</span>).reset_index()</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># verify that False is not a unique value</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> df_raw.query(<span class="st">"product_count &gt; 0"</span>).query(<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss"> == False"</span>).empty</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">viewed_product</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>True</td>
<td>189</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>&lt;NA&gt;</td>
<td>41</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">clicked_product</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>&lt;NA&gt;</td>
<td>213</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>17</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>If a product is not viewed in a listing, then the only value in these same two columns is <code>NULL</code> since they come from a nested column <code>product</code> which contains an empty array <code>[]</code> if a product is such a scenario.</p>
<p>This is shown below</p>
<div class="cell" data-tags="[]" data-execution_count="23">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"viewed_product"</span>, <span class="st">"clicked_product"</span>]:</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    display(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>        df_raw.query(<span class="st">"product_count == 0"</span>)[c].value_counts(dropna<span class="op">=</span><span class="va">False</span>).reset_index()</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">viewed_product</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>&lt;NA&gt;</td>
<td>36</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">clicked_product</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>&lt;NA&gt;</td>
<td>36</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>For every product in the product listing that was viewed and clicked</p>
<ul>
<li><code>clicked_product</code> is <code>True</code></li>
<li><code>viewed_product</code> is <code>NULL</code></li>
</ul>
<p>which prevents double-counting products that are both viewed and clicked (similar to for promotions), as shown below</p>
<div class="cell" data-tags="[]" data-execution_count="24">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>display(df_raw.query(<span class="st">"clicked_product == True"</span>)[[<span class="st">"viewed_product"</span>, <span class="st">"clicked_product"</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">viewed_product</th>
<th data-quarto-table-cell-role="th">clicked_product</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">44</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">140</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">149</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">152</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">155</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">158</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">161</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">173</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">176</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">187</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">190</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">223</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">224</td>
<td>&lt;NA&gt;</td>
<td>True</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Product detail views and clicking of products that were viewed in a product or product category listing can also be retrieved from the <code>action_type</code> column, which tracks each action performed by a visitor during a visit. Its unique values are shown below</p>
<div class="cell" data-tags="[]" data-execution_count="25">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df_raw[<span class="st">"action_type"</span>].value_counts(dropna<span class="op">=</span><span class="va">False</span>).reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">action_type</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Unknown</td>
<td>225</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Product detail views</td>
<td>22</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Click through of product lists</td>
<td>17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Add product(s) to cart</td>
<td>2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Below, we verify that the products that were clicked can be equivalently determined using separated nested columns</p>
<ul>
<li><code>clicked_product</code> (extracted from nested column <code>product</code>)
<ul>
<li><code>clicked_product == True</code></li>
</ul></li>
<li><code>action_type</code> (extracted from nested column <code>hits</code>)
<ul>
<li><code>action_type == 'Click through of product lists'</code></li>
</ul></li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="26">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>visit_prodict_view_click_cols <span class="op">=</span> [</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fullvisitorid"</span>,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitStartTime"</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"action_type"</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_details_viewed"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"isImpression"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"isClick"</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"viewed_product"</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"clicked_product"</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df_raw.query(<span class="st">"clicked_product == True"</span>)[visit_prodict_view_click_cols].equals(</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    df_raw.query(<span class="st">"action_type == 'Click through of product lists'"</span>)[</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        visit_prodict_view_click_cols</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When a product is viewed in a listing (<code>viewed_product</code>), during a visit, the product count for those visits is greater than zero</p>
<div class="cell" data-tags="[]" data-execution_count="27">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df_raw.query(<span class="st">"viewed_product == True"</span>)[<span class="st">"product_count"</span>].<span class="bu">min</span>() <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>display(df_raw.query(<span class="st">"viewed_product == True"</span>)[<span class="st">"product_count"</span>].describe().to_frame())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">product_count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>189.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>9.719577</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>3.355004</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>2.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>6.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>12.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>12.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>12.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>For informational purposes, the raw dataset without unnesting the products and promotions columns is shown below for a small number of visits</p>
<div class="cell" data-tags="[]" data-execution_count="28">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>visit_ids_dict <span class="op">=</span> {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1478844153</span>: <span class="st">"papayawhip"</span>,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1476880065</span>: <span class="st">"mistyrose"</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1478579523</span>: <span class="st">"lavender"</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1474972357</span>: <span class="st">"lightcyan"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>visit_ids_str <span class="op">=</span> <span class="st">"("</span> <span class="op">+</span> <span class="st">", "</span>.join([<span class="bu">str</span>(v) <span class="cf">for</span> v <span class="kw">in</span> <span class="bu">list</span>(visit_ids_dict)]) <span class="op">+</span> <span class="st">")"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Attributes for these visits are retrieved below without unnesting <code>product</code> and <code>promotion</code></p>
<div class="cell" data-tags="[]" data-execution_count="29">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="ss">        WITH visit_promotion_attrs AS (</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="ss">            SELECT fullvisitorid,</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitId,</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitNumber,</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="ss">                   DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific') AS visitStartTime,</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="ss">                   CAST(h.ecommerceaction.action_type AS INT64) AS action_type,</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="ss">                   (CASE WHEN CAST(h.eCommerceAction.action_type AS INT64) = 2 THEN 1 ELSE 0 END) AS product_details_viewed,</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="ss">                   trafficSource.source,</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="ss">                   trafficSource.medium,</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="ss">                   channelGrouping,</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.browser,</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.operatingSystem,</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.deviceCategory,</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- visit</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="ss">                   totals.timeOnSite,</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="ss">                   totals.timeOnScreen,</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="ss">                   totals.visits,</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="ss">                   totals.totalTransactionRevenue / 1000000 AS transact_revenue,</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- nested columns</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="ss">                   h.product,</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="ss">                   h.promotion,</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- experimental columns that were not used</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="ss">                   h.isInteraction,</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="ss">                   trafficSource.campaign,</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="ss">                   trafficSource.isTrueDirect,</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a><span class="ss">            FROM `data-to-insights.ecommerce.web_analytics`,</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a><span class="ss">            UNNEST(hits) AS h</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="ss">            WHERE visitId IN </span><span class="sc">{</span>visit_ids_str<span class="sc">}</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="ss">        )</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a><span class="ss">        SELECT * EXCEPT(visitStartTime)</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a><span class="ss">        FROM visit_promotion_attrs</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>df_raw <span class="op">=</span> run_sql_query(query, <span class="op">**</span>gcp_auth_dict, show_df<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>df_raw[<span class="st">"action_type"</span>] <span class="op">=</span> df_raw[<span class="st">"action_type"</span>].<span class="bu">map</span>(mapper)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:07:43.363...done at 2023-04-13 17:07:46.085 (2.722 seconds).
Query returned 143 rows</code></pre>
</div>
</div>
<p>These attributes can be shown per <code>visitId</code> using</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> visit_id <span class="kw">in</span> <span class="bu">list</span>(visit_ids_dict):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>, <span class="st">"display.max_rows"</span>, <span class="va">None</span>):</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>        display(df_raw.query(<span class="ss">f"visitId == </span><span class="sc">{</span>visit_id<span class="sc">}</span><span class="ss">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="change-data-types-in-prepared-data" class="level3">
<h3 class="anchored" data-anchor-id="change-data-types-in-prepared-data">Change Data Types in Prepared Data</h3>
<div class="cell" data-tags="[]" data-execution_count="30">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>dtypes_dict <span class="op">=</span> {</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fullvisitorid"</span>: pd.StringDtype(),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitId"</span>: pd.StringDtype(),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitNumber"</span>: pd.Int8Dtype(),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"country"</span>: pd.StringDtype(),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quarter"</span>: pd.Int8Dtype(),</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month"</span>: pd.Int8Dtype(),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_month"</span>: pd.Int8Dtype(),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_week"</span>: pd.Int8Dtype(),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour"</span>: pd.Int8Dtype(),</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minute"</span>: pd.Int8Dtype(),</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"second"</span>: pd.Int8Dtype(),</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span>: pd.StringDtype(),</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"medium"</span>: pd.StringDtype(),</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"channelGrouping"</span>: pd.StringDtype(),</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hits"</span>: pd.Int16Dtype(),</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bounces"</span>: pd.Int16Dtype(),</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_action"</span>: pd.Int8Dtype(),</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_detail_views"</span>: pd.Int16Dtype(),</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_displayed"</span>: pd.Int16Dtype(),</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_clicked"</span>: pd.Int16Dtype(),</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_views"</span>: pd.Int16Dtype(),</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_clicks"</span>: pd.Int16Dtype(),</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pageviews"</span>: pd.Int16Dtype(),</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"transact_revenue"</span>: pd.Float32Dtype(),</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"time_on_site"</span>: pd.Int16Dtype(),</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"browser"</span>: pd.StringDtype(),</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os"</span>: pd.StringDtype(),</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"added_to_cart"</span>: pd.Int16Dtype(),</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deviceCategory"</span>: pd.StringDtype(),</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="31">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.astype(dtypes_dict)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 92551 entries, 0 to 92858
Data columns (total 31 columns):
 #   Column                         Non-Null Count  Dtype         
---  ------                         --------------  -----         
 0   fullvisitorid                  92551 non-null  string        
 1   visitId                        92551 non-null  string        
 2   visitNumber                    92551 non-null  Int8          
 3   visitStartTime                 92551 non-null  datetime64[ns]
 4   country                        92551 non-null  string        
 5   quarter                        92551 non-null  Int8          
 6   month                          92551 non-null  Int8          
 7   day_of_month                   92551 non-null  Int8          
 8   day_of_week                    92551 non-null  Int8          
 9   hour                           92551 non-null  Int8          
 10  minute                         92551 non-null  Int8          
 11  second                         92551 non-null  Int8          
 12  source                         92551 non-null  string        
 13  medium                         92551 non-null  string        
 14  channelGrouping                92551 non-null  string        
 15  hits                           92551 non-null  Int16         
 16  bounces                        92551 non-null  Int16         
 17  last_action                    92551 non-null  Int8          
 18  product_detail_views           92551 non-null  Int16         
 19  promos_displayed               92551 non-null  Int16         
 20  promos_clicked                 92551 non-null  Int16         
 21  product_views                  92551 non-null  Int16         
 22  product_clicks                 92551 non-null  Int16         
 23  pageviews                      92551 non-null  Int16         
 24  transact_revenue               3094 non-null   Float32       
 25  time_on_site                   92551 non-null  Int16         
 26  browser                        92551 non-null  string        
 27  os                             92551 non-null  string        
 28  deviceCategory                 92551 non-null  string        
 29  added_to_cart                  92551 non-null  Int16         
 30  made_purchase_on_future_visit  92551 non-null  boolean       
dtypes: Float32(1), Int16(10), Int8(9), boolean(1), datetime64[ns](1), string(9)
memory usage: 12.6 MB</code></pre>
</div>
</div>
</section>
<section id="separate-columns-by-type" class="level3">
<h3 class="anchored" data-anchor-id="separate-columns-by-type">Separate Columns by Type</h3>
<p>The first three rows of the prepared data are shown below</p>
<div class="cell" data-tags="[]" data-execution_count="32">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"display.max_colwidth"</span>, <span class="va">None</span>, <span class="st">"display.max_rows"</span>, <span class="va">None</span>, <span class="st">"display.max_columns"</span>, <span class="va">None</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    display(df.head(<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">product_detail_views</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">transact_revenue</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>8163735676529750721</td>
<td>1481176805</td>
<td>1</td>
<td>2016-12-07 22:00:05</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>7</td>
<td>4</td>
<td>22</td>
<td>0</td>
<td>5</td>
<td>google</td>
<td>cpc</td>
<td>Paid Search</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5</td>
<td>&lt;NA&gt;</td>
<td>109</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0897634596694862660</td>
<td>1475199828</td>
<td>1</td>
<td>2016-09-29 18:43:48</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>29</td>
<td>5</td>
<td>18</td>
<td>43</td>
<td>48</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>21</td>
<td>0</td>
<td>2</td>
<td>2</td>
<td>9</td>
<td>0</td>
<td>90</td>
<td>2</td>
<td>19</td>
<td>&lt;NA&gt;</td>
<td>467</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3891893273235584028</td>
<td>1478844153</td>
<td>1</td>
<td>2016-11-10 22:02:33</td>
<td>United States</td>
<td>4</td>
<td>11</td>
<td>10</td>
<td>5</td>
<td>22</td>
<td>2</td>
<td>33</td>
<td>youtube.com</td>
<td>referral</td>
<td>Social</td>
<td>11</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>18</td>
<td>0</td>
<td>36</td>
<td>1</td>
<td>10</td>
<td>&lt;NA&gt;</td>
<td>1003</td>
<td>Safari (in-app)</td>
<td>iOS</td>
<td>tablet</td>
<td>0</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Create lists of columns based on their type. Three such lists are shown below</p>
<ul>
<li><code>datetime</code></li>
<li>categorical</li>
<li>numerical</li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="33">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>datetime_columns <span class="op">=</span> [</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quarter"</span>,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month"</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_month"</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_week"</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour"</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>categorical_columns <span class="op">=</span> [</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bounces"</span>,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_action"</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span>,</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"medium"</span>,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"channelGrouping"</span>,</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"browser"</span>,</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os"</span>,</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deviceCategory"</span>,</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>numerical_columns <span class="op">=</span> [</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hits"</span>,</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_detail_views"</span>,</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_displayed"</span>,</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_clicked"</span>,</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_views"</span>,</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_clicks"</span>,</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pageviews"</span>,</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"time_on_site"</span>,</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"added_to_cart"</span>,</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="handling-categorical-columns" class="level3">
<h3 class="anchored" data-anchor-id="handling-categorical-columns">Handling Categorical Columns</h3>
<p>High-cardinality categorical features are a problem for machine learning models as they create a large number of dummy variables (after dummy encoding), or a sparse matrix (<a href="https://blog.knoldus.com/sparse-matrices-what-makes-them-important-for-machine-learning/">1</a>, <a href="https://www.aiplusinfo.com/blog/what-is-a-sparse-matrix-how-is-it-used-in-machine-learning/">2</a>) that slows ML model training. So, it is frequently necessary to reduce this cardinality before training a ML model.</p>
<p>Two of the well-known apprroaches to reduce dimensionality of such features are (<a href="https://arxiv.org/abs/2301.12710">1</a>, <a href="https://www.linkedin.com/advice/0/how-do-you-deal-categorical-features-high-cardinality">2</a>)</p>
<ol type="1">
<li><a href="https://towardsdatascience.com/dealing-with-features-that-have-high-cardinality-1c9212d7ff1b">frequency endoding</a>
<ul>
<li>only keep the <code>N</code> most common values for each feature and replace all the other (infrequently occurring) values with a placeholder value such as <code>other</code></li>
<li>this will be the approach used for the current project</li>
</ul></li>
<li>class label or target encoding
<ul>
<li>group categorical features by the class labels (the dependent variable, or <code>y</code>)</li>
</ul></li>
</ol>
<p>Reducing the cardinality of such features is performed during the data transformation step of a ML workflow. Here, we will demonstrate this before exploratory data analysis (this step) and then apply it during data transformation (next step).</p>
<p>Show the number of unique values in all categorical columns</p>
<div class="cell" data-tags="[]" data-execution_count="34">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df_nunique <span class="op">=</span> pd.DataFrame.from_records(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    [{<span class="st">"column"</span>: c, <span class="st">"num_unique_values"</span>: df[c].nunique()} <span class="cf">for</span> c <span class="kw">in</span> categorical_columns]</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>df_nunique</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column</th>
<th data-quarto-table-cell-role="th">num_unique_values</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>bounces</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>last_action</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>source</td>
<td>116</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>medium</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>channelGrouping</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>browser</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>os</td>
<td>15</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>deviceCategory</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>High-cardinality categorical columns are present in the training data.</li>
<li>The following categorical columns are high-cardinality columns with the largest number of unique values
<ul>
<li><code>source</code> (source of visitor traffic reaching the merchandise store’s website)</li>
<li><code>browser</code></li>
<li><code>os</code> (visitor’s operating system used to access merchandise store’s website)</li>
</ul>
and will likely need to be binned or grouped</li>
<li>Infrequently occurring values in the following medium-cardinality columns related the source of website visitor traffic will also be grouped
<ul>
<li><code>channelGrouping</code></li>
<li><code>medium</code></li>
</ul></li>
<li><code>last_action</code> will be left unchanged
<ul>
<li>it is likely that the last action performed by a visitor during their first visit to the merchandise store will have some influence on their probability (propensity) to make a purchase during a future visit</li>
</ul></li>
</ol>
</div>
</div>
<p>The category distributions (frequencies) after grouping are shown below for all categorical columns (including those that were grouped)</p>
<div class="cell" data-tags="[]" data-execution_count="35">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dfs_cats_groups <span class="op">=</span> []</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> categorical_columns:</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get fraction of unique values</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    df_frequencies <span class="op">=</span> (</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        df[c]</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        .value_counts()</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"number_of_visitors"</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        .merge(</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>                df[c].value_counts(normalize<span class="op">=</span><span class="va">True</span>).rename(<span class="st">"fraction_of_visitors"</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>            ).to_frame(),</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>            left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>            right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># map unique values for last_action and bounces to get meaningful names</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="op">==</span> <span class="st">"last_action"</span>:</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        df_frequencies.index <span class="op">=</span> df_frequencies.index.<span class="bu">map</span>(mapper)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="op">==</span> <span class="st">"bounces"</span>:</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>        df_frequencies.index <span class="op">=</span> df_frequencies.index.<span class="bu">map</span>({<span class="dv">0</span>: <span class="va">False</span>, <span class="dv">1</span>: <span class="va">True</span>})</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get running total of fraction (cumulative sum)</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    df_frequencies <span class="op">=</span> (</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>        df_frequencies.sort_values(by<span class="op">=</span>[<span class="st">"fraction_of_visitors"</span>])</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>            cumulative_fraction_of_visitors<span class="op">=</span><span class="kw">lambda</span> df: df[</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fraction_of_visitors"</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>            ].cumsum(),</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>            column_name<span class="op">=</span>c,</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>        .sort_values(by<span class="op">=</span>[<span class="st">"fraction_of_visitors"</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename columns</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    df_frequencies <span class="op">=</span> df_frequencies.reset_index().rename(columns<span class="op">=</span>{c: <span class="st">"column_value"</span>})</span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    dfs_cats_groups.append(df_frequencies)</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>df_frequencies_raw <span class="op">=</span> pd.concat(dfs_cats_groups, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>col <span class="op">=</span> df_frequencies_raw.pop(<span class="st">"column_name"</span>)</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>df_frequencies_raw.insert(<span class="dv">0</span>, col.name, col)</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_rows"</span>, <span class="va">None</span>):</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    display(df_frequencies_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column_name</th>
<th data-quarto-table-cell-role="th">column_value</th>
<th data-quarto-table-cell-role="th">number_of_visitors</th>
<th data-quarto-table-cell-role="th">fraction_of_visitors</th>
<th data-quarto-table-cell-role="th">cumulative_fraction_of_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>bounces</td>
<td>False</td>
<td>65505</td>
<td>70.777193</td>
<td>100.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>bounces</td>
<td>True</td>
<td>27046</td>
<td>29.222807</td>
<td>29.222807</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>last_action</td>
<td>Unknown</td>
<td>67511</td>
<td>72.944647</td>
<td>100.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>last_action</td>
<td>Product detail views</td>
<td>14731</td>
<td>15.91663</td>
<td>27.055353</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>last_action</td>
<td>Add product(s) to cart</td>
<td>4655</td>
<td>5.029659</td>
<td>11.138724</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>last_action</td>
<td>Completed purchase</td>
<td>3097</td>
<td>3.346263</td>
<td>6.109064</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>last_action</td>
<td>Check out</td>
<td>1635</td>
<td>1.766594</td>
<td>2.762801</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>last_action</td>
<td>Remove product(s) from cart</td>
<td>881</td>
<td>0.951908</td>
<td>0.996207</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>last_action</td>
<td>Click through of product lists</td>
<td>41</td>
<td>0.0443</td>
<td>0.0443</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>source</td>
<td>google</td>
<td>43484</td>
<td>46.983825</td>
<td>100.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>source</td>
<td>(direct)</td>
<td>21532</td>
<td>23.265011</td>
<td>53.016175</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>source</td>
<td>mall.googleplex.com</td>
<td>11777</td>
<td>12.724876</td>
<td>29.751164</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>source</td>
<td>youtube.com</td>
<td>8021</td>
<td>8.666573</td>
<td>17.026288</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>source</td>
<td>sites.google.com</td>
<td>1098</td>
<td>1.186373</td>
<td>8.359715</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>source</td>
<td>moma.corp.google.com</td>
<td>1040</td>
<td>1.123705</td>
<td>7.173342</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>source</td>
<td>Partners</td>
<td>899</td>
<td>0.971356</td>
<td>6.049637</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>source</td>
<td>dfa</td>
<td>841</td>
<td>0.908688</td>
<td>5.078281</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>source</td>
<td>siliconvalley.about.com</td>
<td>593</td>
<td>0.640728</td>
<td>4.169593</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>source</td>
<td>analytics.google.com</td>
<td>486</td>
<td>0.525116</td>
<td>3.528865</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>source</td>
<td>google.com</td>
<td>413</td>
<td>0.44624</td>
<td>3.003749</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>source</td>
<td>baidu</td>
<td>314</td>
<td>0.339272</td>
<td>2.557509</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>source</td>
<td>m.facebook.com</td>
<td>190</td>
<td>0.205292</td>
<td>2.218236</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>source</td>
<td>yahoo</td>
<td>178</td>
<td>0.192326</td>
<td>2.012944</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>source</td>
<td>bing</td>
<td>161</td>
<td>0.173958</td>
<td>1.820618</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>source</td>
<td>reddit.com</td>
<td>131</td>
<td>0.141544</td>
<td>1.64666</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>source</td>
<td>l.facebook.com</td>
<td>127</td>
<td>0.137222</td>
<td>1.505116</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>source</td>
<td>groups.google.com</td>
<td>120</td>
<td>0.129658</td>
<td>1.367894</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>source</td>
<td>facebook.com</td>
<td>112</td>
<td>0.121014</td>
<td>1.238236</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>source</td>
<td>mail.google.com</td>
<td>110</td>
<td>0.118853</td>
<td>1.117222</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>source</td>
<td>googleux.perksplus.com</td>
<td>95</td>
<td>0.102646</td>
<td>0.998368</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>source</td>
<td>quora.com</td>
<td>86</td>
<td>0.092922</td>
<td>0.895722</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>source</td>
<td>blog.golang.org</td>
<td>82</td>
<td>0.0886</td>
<td>0.802801</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">32</td>
<td>source</td>
<td>t.co</td>
<td>80</td>
<td>0.086439</td>
<td>0.714201</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">33</td>
<td>source</td>
<td>dealspotr.com</td>
<td>75</td>
<td>0.081036</td>
<td>0.627762</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">34</td>
<td>source</td>
<td>ask</td>
<td>48</td>
<td>0.051863</td>
<td>0.546726</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">35</td>
<td>source</td>
<td>docs.google.com</td>
<td>39</td>
<td>0.042139</td>
<td>0.494862</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36</td>
<td>source</td>
<td>connect.googleforwork.com</td>
<td>33</td>
<td>0.035656</td>
<td>0.452723</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">37</td>
<td>source</td>
<td>plus.google.com</td>
<td>21</td>
<td>0.02269</td>
<td>0.417067</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">38</td>
<td>source</td>
<td>outlook.live.com</td>
<td>20</td>
<td>0.02161</td>
<td>0.394377</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">39</td>
<td>source</td>
<td>tpc.googlesyndication.com</td>
<td>19</td>
<td>0.020529</td>
<td>0.372767</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">40</td>
<td>source</td>
<td>m.reddit.com</td>
<td>18</td>
<td>0.019449</td>
<td>0.352238</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">41</td>
<td>source</td>
<td>phandroid.com</td>
<td>17</td>
<td>0.018368</td>
<td>0.332789</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42</td>
<td>source</td>
<td>search.xfinity.com</td>
<td>17</td>
<td>0.018368</td>
<td>0.314421</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">43</td>
<td>source</td>
<td>learn.colorado.edu</td>
<td>13</td>
<td>0.014046</td>
<td>0.296053</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">44</td>
<td>source</td>
<td>googleads.g.doubleclick.net</td>
<td>12</td>
<td>0.012966</td>
<td>0.282007</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">45</td>
<td>source</td>
<td>m.baidu.com</td>
<td>12</td>
<td>0.012966</td>
<td>0.269041</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">46</td>
<td>source</td>
<td>lunametrics.com</td>
<td>11</td>
<td>0.011885</td>
<td>0.256075</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">47</td>
<td>source</td>
<td>productforums.google.com</td>
<td>11</td>
<td>0.011885</td>
<td>0.24419</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">48</td>
<td>source</td>
<td>pinterest.com</td>
<td>10</td>
<td>0.010805</td>
<td>0.210695</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">49</td>
<td>source</td>
<td>arstechnica.com</td>
<td>10</td>
<td>0.010805</td>
<td>0.221499</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50</td>
<td>source</td>
<td>duckduckgo.com</td>
<td>10</td>
<td>0.010805</td>
<td>0.232304</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">51</td>
<td>source</td>
<td>search.tb.ask.com</td>
<td>9</td>
<td>0.009724</td>
<td>0.19989</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">52</td>
<td>source</td>
<td>us.search.yahoo.com</td>
<td>9</td>
<td>0.009724</td>
<td>0.190165</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">53</td>
<td>source</td>
<td>plus.sandbox.google.com</td>
<td>8</td>
<td>0.008644</td>
<td>0.180441</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">54</td>
<td>source</td>
<td>uweoconnect.extn.washington.edu</td>
<td>7</td>
<td>0.007563</td>
<td>0.171797</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">55</td>
<td>source</td>
<td>luyaochen.mtv.corp.google.com:8080</td>
<td>6</td>
<td>0.006483</td>
<td>0.164234</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">56</td>
<td>source</td>
<td>course.fso.fullsail.edu</td>
<td>6</td>
<td>0.006483</td>
<td>0.157751</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">57</td>
<td>source</td>
<td>mg.mail.yahoo.com</td>
<td>6</td>
<td>0.006483</td>
<td>0.151268</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">58</td>
<td>source</td>
<td>gophergala.com</td>
<td>5</td>
<td>0.005402</td>
<td>0.144785</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">59</td>
<td>source</td>
<td>wap.sogou.com</td>
<td>5</td>
<td>0.005402</td>
<td>0.139383</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">60</td>
<td>source</td>
<td>plus.url.google.com</td>
<td>5</td>
<td>0.005402</td>
<td>0.13398</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">61</td>
<td>source</td>
<td>trainup.withgoogle.com</td>
<td>5</td>
<td>0.005402</td>
<td>0.128578</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">62</td>
<td>source</td>
<td>feedly.com</td>
<td>4</td>
<td>0.004322</td>
<td>0.118853</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">63</td>
<td>source</td>
<td>amazon.com</td>
<td>4</td>
<td>0.004322</td>
<td>0.11021</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">64</td>
<td>source</td>
<td>drawnames.com</td>
<td>4</td>
<td>0.004322</td>
<td>0.123175</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">65</td>
<td>source</td>
<td>keep.google.com</td>
<td>4</td>
<td>0.004322</td>
<td>0.114531</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">66</td>
<td>source</td>
<td>search.earthlink.net</td>
<td>4</td>
<td>0.004322</td>
<td>0.105888</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">67</td>
<td>source</td>
<td>github.com</td>
<td>4</td>
<td>0.004322</td>
<td>0.097244</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">68</td>
<td>source</td>
<td>hangouts.google.com</td>
<td>4</td>
<td>0.004322</td>
<td>0.092922</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">69</td>
<td>source</td>
<td>csfirst.withgoogle.com</td>
<td>4</td>
<td>0.004322</td>
<td>0.0886</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">70</td>
<td>source</td>
<td>m.sogou.com</td>
<td>4</td>
<td>0.004322</td>
<td>0.084278</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">71</td>
<td>source</td>
<td>dynamite.sandbox.google.com</td>
<td>4</td>
<td>0.004322</td>
<td>0.079956</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">72</td>
<td>source</td>
<td>aol</td>
<td>4</td>
<td>0.004322</td>
<td>0.101566</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">73</td>
<td>source</td>
<td>qiita.com</td>
<td>3</td>
<td>0.003241</td>
<td>0.056185</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">74</td>
<td>source</td>
<td>ics-devel-west.qa.adz.google.com</td>
<td>3</td>
<td>0.003241</td>
<td>0.062668</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75</td>
<td>source</td>
<td>us-mg5.mail.yahoo.com</td>
<td>3</td>
<td>0.003241</td>
<td>0.059427</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">76</td>
<td>source</td>
<td>messenger.com</td>
<td>3</td>
<td>0.003241</td>
<td>0.06591</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">77</td>
<td>source</td>
<td>web.mail.comcast.net</td>
<td>3</td>
<td>0.003241</td>
<td>0.069151</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">78</td>
<td>source</td>
<td>optimize.google.com</td>
<td>3</td>
<td>0.003241</td>
<td>0.072393</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">79</td>
<td>source</td>
<td>s0.2mdn.net</td>
<td>3</td>
<td>0.003241</td>
<td>0.075634</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">80</td>
<td>source</td>
<td>(not set)</td>
<td>2</td>
<td>0.002161</td>
<td>0.052944</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">81</td>
<td>source</td>
<td>so.com</td>
<td>2</td>
<td>0.002161</td>
<td>0.050783</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">82</td>
<td>source</td>
<td>awics.corp.google.com</td>
<td>2</td>
<td>0.002161</td>
<td>0.048622</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">83</td>
<td>source</td>
<td>m.mg.mail.yahoo.com</td>
<td>2</td>
<td>0.002161</td>
<td>0.046461</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">84</td>
<td>source</td>
<td>searchlock.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.017288</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">85</td>
<td>source</td>
<td>0.shared.bow.cat2.ads-bow.lf.borg.google.com:9860</td>
<td>1</td>
<td>0.00108</td>
<td>0.015127</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">86</td>
<td>source</td>
<td>0.shared.bow.cat2.ads-bow.qk.borg.google.com:9848</td>
<td>1</td>
<td>0.00108</td>
<td>0.016207</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">87</td>
<td>source</td>
<td>g3doc.corp.google.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.002161</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">88</td>
<td>source</td>
<td>businessinsider.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.018368</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">89</td>
<td>source</td>
<td>wheretoget.it</td>
<td>1</td>
<td>0.00108</td>
<td>0.019449</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">90</td>
<td>source</td>
<td>blackboard.neu.edu</td>
<td>1</td>
<td>0.00108</td>
<td>0.020529</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">91</td>
<td>source</td>
<td>goto.google.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.012966</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92</td>
<td>source</td>
<td>mail.aol.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.014046</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">93</td>
<td>source</td>
<td>0.shared.bow.cat2.ads-bow.yw.borg.google.com:9885</td>
<td>1</td>
<td>0.00108</td>
<td>0.003241</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">94</td>
<td>source</td>
<td>prod.facebook.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.011885</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">95</td>
<td>source</td>
<td>login.corp.google.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.010805</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">96</td>
<td>source</td>
<td>m.sp.sm.cn</td>
<td>1</td>
<td>0.00108</td>
<td>0.009724</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">97</td>
<td>source</td>
<td>getpocket.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.008644</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">98</td>
<td>source</td>
<td>us.reddit.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.007563</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">99</td>
<td>source</td>
<td>pinpoint.corp.google.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.006483</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">100</td>
<td>source</td>
<td>wanelo.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.005402</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">101</td>
<td>source</td>
<td>mail.verizon.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.004322</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">102</td>
<td>source</td>
<td>inbox.google.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.02269</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">103</td>
<td>source</td>
<td>0.shared.bow.cat2.ads-bow.qk.borg.google.com:9830</td>
<td>1</td>
<td>0.00108</td>
<td>0.02161</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">104</td>
<td>source</td>
<td>0.shared.bow.cat2.ads-bow.yw.borg.google.com:9849</td>
<td>1</td>
<td>0.00108</td>
<td>0.032415</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">105</td>
<td>source</td>
<td>9to5google.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.023771</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">106</td>
<td>source</td>
<td>adwords.google.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.024851</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">107</td>
<td>source</td>
<td>cl-cards.googleplex.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.0443</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">108</td>
<td>source</td>
<td>newclasses.nyu.edu</td>
<td>1</td>
<td>0.00108</td>
<td>0.043219</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">109</td>
<td>source</td>
<td>myactivity.google.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.042139</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">110</td>
<td>source</td>
<td>seroundtable.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.041058</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">111</td>
<td>source</td>
<td>0.shared.bow.cat2.ads-bow.yw.borg.google.com:9850</td>
<td>1</td>
<td>0.00108</td>
<td>0.039978</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">112</td>
<td>source</td>
<td>lm.facebook.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.038897</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">113</td>
<td>source</td>
<td>cases.corp.google.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.037817</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">114</td>
<td>source</td>
<td>google.co.jp</td>
<td>1</td>
<td>0.00108</td>
<td>0.036737</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">115</td>
<td>source</td>
<td>adwords-displayads.googleusercontent.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.035656</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">116</td>
<td>source</td>
<td>xbidprodmirror.corp.google.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.034576</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">117</td>
<td>source</td>
<td>evernote.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.033495</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">118</td>
<td>source</td>
<td>online-metrics.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.031334</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">119</td>
<td>source</td>
<td>0.shared.bow.cat2.ads-bow.yw.borg.google.com:9813</td>
<td>1</td>
<td>0.00108</td>
<td>0.030254</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">120</td>
<td>source</td>
<td>kik.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.029173</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">121</td>
<td>source</td>
<td>baidu.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.028093</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">122</td>
<td>source</td>
<td>dailydot.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.027012</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">123</td>
<td>source</td>
<td>digg.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.025932</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">124</td>
<td>source</td>
<td>spaces.google.com</td>
<td>1</td>
<td>0.00108</td>
<td>0.00108</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">125</td>
<td>medium</td>
<td>organic</td>
<td>38584</td>
<td>41.689447</td>
<td>100.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">126</td>
<td>medium</td>
<td>referral</td>
<td>25086</td>
<td>27.105056</td>
<td>58.310553</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">127</td>
<td>medium</td>
<td>(none)</td>
<td>21532</td>
<td>23.265011</td>
<td>31.205498</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">128</td>
<td>medium</td>
<td>cpc</td>
<td>5607</td>
<td>6.058281</td>
<td>7.940487</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">129</td>
<td>medium</td>
<td>affiliate</td>
<td>899</td>
<td>0.971356</td>
<td>1.882205</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">130</td>
<td>medium</td>
<td>cpm</td>
<td>841</td>
<td>0.908688</td>
<td>0.910849</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">131</td>
<td>medium</td>
<td>(not set)</td>
<td>2</td>
<td>0.002161</td>
<td>0.002161</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">132</td>
<td>channelGrouping</td>
<td>Organic Search</td>
<td>38584</td>
<td>41.689447</td>
<td>100.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">133</td>
<td>channelGrouping</td>
<td>Direct</td>
<td>21532</td>
<td>23.265011</td>
<td>58.310553</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">134</td>
<td>channelGrouping</td>
<td>Referral</td>
<td>16160</td>
<td>17.460643</td>
<td>35.045542</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">135</td>
<td>channelGrouping</td>
<td>Social</td>
<td>8926</td>
<td>9.644412</td>
<td>17.584899</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">136</td>
<td>channelGrouping</td>
<td>Paid Search</td>
<td>5607</td>
<td>6.058281</td>
<td>7.940487</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">137</td>
<td>channelGrouping</td>
<td>Affiliates</td>
<td>899</td>
<td>0.971356</td>
<td>1.882205</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">138</td>
<td>channelGrouping</td>
<td>Display</td>
<td>841</td>
<td>0.908688</td>
<td>0.910849</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">139</td>
<td>channelGrouping</td>
<td>(Other)</td>
<td>2</td>
<td>0.002161</td>
<td>0.002161</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">140</td>
<td>browser</td>
<td>Chrome</td>
<td>69002</td>
<td>74.55565</td>
<td>100.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">141</td>
<td>browser</td>
<td>Safari</td>
<td>15294</td>
<td>16.524943</td>
<td>25.44435</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">142</td>
<td>browser</td>
<td>Firefox</td>
<td>2594</td>
<td>2.802779</td>
<td>8.919407</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">143</td>
<td>browser</td>
<td>Internet Explorer</td>
<td>2214</td>
<td>2.392195</td>
<td>6.116628</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">144</td>
<td>browser</td>
<td>Opera</td>
<td>1119</td>
<td>1.209063</td>
<td>3.724433</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">145</td>
<td>browser</td>
<td>Edge</td>
<td>989</td>
<td>1.0686</td>
<td>2.51537</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">146</td>
<td>browser</td>
<td>Safari (in-app)</td>
<td>799</td>
<td>0.863308</td>
<td>1.44677</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">147</td>
<td>browser</td>
<td>Android Webview</td>
<td>165</td>
<td>0.17828</td>
<td>0.583462</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">148</td>
<td>browser</td>
<td>YaBrowser</td>
<td>107</td>
<td>0.115612</td>
<td>0.405182</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">149</td>
<td>browser</td>
<td>Amazon Silk</td>
<td>93</td>
<td>0.100485</td>
<td>0.28957</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">150</td>
<td>browser</td>
<td>Mozilla Compatible Agent</td>
<td>31</td>
<td>0.033495</td>
<td>0.189085</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">151</td>
<td>browser</td>
<td>UC Browser</td>
<td>28</td>
<td>0.030254</td>
<td>0.15559</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">152</td>
<td>browser</td>
<td>Opera Mini</td>
<td>19</td>
<td>0.020529</td>
<td>0.125336</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">153</td>
<td>browser</td>
<td>Android Browser</td>
<td>16</td>
<td>0.017288</td>
<td>0.104807</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">154</td>
<td>browser</td>
<td>Iron</td>
<td>15</td>
<td>0.016207</td>
<td>0.087519</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">155</td>
<td>browser</td>
<td>Coc Coc</td>
<td>13</td>
<td>0.014046</td>
<td>0.071312</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">156</td>
<td>browser</td>
<td>Nintendo Browser</td>
<td>13</td>
<td>0.014046</td>
<td>0.057266</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">157</td>
<td>browser</td>
<td>BlackBerry</td>
<td>10</td>
<td>0.010805</td>
<td>0.043219</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">158</td>
<td>browser</td>
<td>Maxthon</td>
<td>10</td>
<td>0.010805</td>
<td>0.032415</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">159</td>
<td>browser</td>
<td>MRCHROME</td>
<td>7</td>
<td>0.007563</td>
<td>0.02161</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">160</td>
<td>browser</td>
<td>Nichrome</td>
<td>5</td>
<td>0.005402</td>
<td>0.014046</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">161</td>
<td>browser</td>
<td>Apple-iPhone7C2</td>
<td>3</td>
<td>0.003241</td>
<td>0.008644</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">162</td>
<td>browser</td>
<td>Mozilla</td>
<td>2</td>
<td>0.002161</td>
<td>0.005402</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">163</td>
<td>browser</td>
<td>NokiaE52-1</td>
<td>1</td>
<td>0.00108</td>
<td>0.002161</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">164</td>
<td>browser</td>
<td>no-ua</td>
<td>1</td>
<td>0.00108</td>
<td>0.003241</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">165</td>
<td>browser</td>
<td>SeaMonkey</td>
<td>1</td>
<td>0.00108</td>
<td>0.00108</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">166</td>
<td>os</td>
<td>Macintosh</td>
<td>30610</td>
<td>33.073657</td>
<td>100.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">167</td>
<td>os</td>
<td>Windows</td>
<td>25588</td>
<td>27.647459</td>
<td>66.926343</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">168</td>
<td>os</td>
<td>iOS</td>
<td>13500</td>
<td>14.586552</td>
<td>39.278884</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">169</td>
<td>os</td>
<td>Android</td>
<td>11486</td>
<td>12.410455</td>
<td>24.692332</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">170</td>
<td>os</td>
<td>Linux</td>
<td>6500</td>
<td>7.023155</td>
<td>12.281877</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">171</td>
<td>os</td>
<td>Chrome OS</td>
<td>4741</td>
<td>5.122581</td>
<td>5.258722</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">172</td>
<td>os</td>
<td>(not set)</td>
<td>53</td>
<td>0.057266</td>
<td>0.136141</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">173</td>
<td>os</td>
<td>Windows Phone</td>
<td>39</td>
<td>0.042139</td>
<td>0.078875</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">174</td>
<td>os</td>
<td>Nintendo Wii</td>
<td>11</td>
<td>0.011885</td>
<td>0.036737</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">175</td>
<td>os</td>
<td>BlackBerry</td>
<td>10</td>
<td>0.010805</td>
<td>0.024851</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">176</td>
<td>os</td>
<td>Xbox</td>
<td>9</td>
<td>0.009724</td>
<td>0.014046</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">177</td>
<td>os</td>
<td>Samsung</td>
<td>1</td>
<td>0.00108</td>
<td>0.00108</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">178</td>
<td>os</td>
<td>FreeBSD</td>
<td>1</td>
<td>0.00108</td>
<td>0.002161</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">179</td>
<td>os</td>
<td>Nokia</td>
<td>1</td>
<td>0.00108</td>
<td>0.003241</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">180</td>
<td>os</td>
<td>SunOS</td>
<td>1</td>
<td>0.00108</td>
<td>0.004322</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">181</td>
<td>deviceCategory</td>
<td>desktop</td>
<td>67355</td>
<td>72.776091</td>
<td>100.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">182</td>
<td>deviceCategory</td>
<td>mobile</td>
<td>21790</td>
<td>23.543776</td>
<td>27.223909</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">183</td>
<td>deviceCategory</td>
<td>tablet</td>
<td>3406</td>
<td>3.680133</td>
<td>3.680133</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>We’ll create frequency groupings as follows
<ul>
<li><code>source</code> and <code>browser</code>
<ul>
<li>all categories which occur with a frequency of less than 5% will be grouped into a single value <code>other</code></li>
</ul></li>
<li><code>os</code>, <code>channelGrouping</code> and <code>medium</code>
<ul>
<li>all categories which occur with a frequency of less than 10% will be grouped into a single value <code>other</code></li>
</ul></li>
</ul>
These thresholds were determined by examining the output of <code>df_frequencies_raw</code>, which shows the freqencies of all categories for all categorical columns.</li>
</ol>
</div>
</div>
<p>Below are lists of categorical columns to be grouped based on this threshold (5% or 10%)</p>
<div class="cell" data-tags="[]" data-execution_count="36">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>cols_to_group_5_pct <span class="op">=</span> [<span class="st">"source"</span>, <span class="st">"browser"</span>]</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>cols_to_group_10_pct <span class="op">=</span> [<span class="st">"os"</span>, <span class="st">"channelGrouping"</span>, <span class="st">"medium"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll get names for the columns after grouping, by adding a <code>_grouped</code> suffix</p>
<div class="cell" data-tags="[]" data-execution_count="37">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>grouped_cols_5_pct <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_grouped"</span> <span class="cf">for</span> c <span class="kw">in</span> cols_to_group_5_pct]</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>grouped_cols_10_pct <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_grouped"</span> <span class="cf">for</span> c <span class="kw">in</span> cols_to_group_10_pct]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, create lists of categorical columns that will and will not be grouped and then combine them into a single list</p>
<div class="cell" data-tags="[]" data-execution_count="38">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>categorical_columns_mapped <span class="op">=</span> (</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># columns that will not be grouped</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">set</span>(categorical_columns) <span class="op">-</span> <span class="bu">set</span>(cols_to_group_5_pct) <span class="op">-</span> <span class="bu">set</span>(cols_to_group_10_pct)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># columns that will be grouped</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> grouped_cols_5_pct</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> grouped_cols_10_pct</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a duplicate of the columns that will be grouped and add a <code>_grouped</code> suffix to their column name</p>
<div class="cell" data-tags="[]" data-execution_count="39">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> cols_to_group_5_pct <span class="op">+</span> cols_to_group_10_pct:</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_grouped"</span>] <span class="op">=</span> df[c]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, perform the grouping using</p>
<ol type="1">
<li><code>pandas.value_counts(normalize=True) &lt; 0.05</code> (5% threshold)</li>
<li><code>pandas.value_counts(normalize=True) &lt; 0.10</code> (10% threshold)</li>
</ol>
<p>where all infrequently occurring values that satisfy these filters will have their values replaced by <code>other</code></p>
<div class="cell" data-tags="[]" data-execution_count="40">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>df[grouped_cols_5_pct] <span class="op">=</span> df[grouped_cols_5_pct].<span class="bu">apply</span>(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: x.mask(x.<span class="bu">map</span>(x.value_counts(normalize<span class="op">=</span><span class="va">True</span>)) <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="st">"other"</span>), axis<span class="op">=</span><span class="dv">0</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>df[grouped_cols_10_pct] <span class="op">=</span> df[grouped_cols_10_pct].<span class="bu">apply</span>(</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: x.mask(x.<span class="bu">map</span>(x.value_counts(normalize<span class="op">=</span><span class="va">True</span>)) <span class="op">&lt;</span> <span class="fl">0.10</span>, <span class="st">"other"</span>), axis<span class="op">=</span><span class="dv">0</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The cardinality of the columns before and after grouping is shown below</p>
<div class="cell" data-tags="[]" data-execution_count="41">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>df_nunique.merge(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame.from_records(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">"column"</span>: c.replace(<span class="st">"_grouped"</span>, <span class="st">""</span>),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">"column_grouped"</span>: c,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>                <span class="st">"num_unique_values_after_grouping"</span>: df[c].nunique(),</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> c <span class="kw">in</span> categorical_columns_mapped</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    ).assign(column_grouped<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"column_grouped"</span>] <span class="op">!=</span> df[<span class="st">"column"</span>]),</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"column"</span>],</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column</th>
<th data-quarto-table-cell-role="th">num_unique_values</th>
<th data-quarto-table-cell-role="th">column_grouped</th>
<th data-quarto-table-cell-role="th">num_unique_values_after_grouping</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>bounces</td>
<td>2</td>
<td>False</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>last_action</td>
<td>7</td>
<td>False</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>source</td>
<td>116</td>
<td>True</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>medium</td>
<td>7</td>
<td>True</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>channelGrouping</td>
<td>8</td>
<td>True</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>browser</td>
<td>26</td>
<td>True</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>os</td>
<td>15</td>
<td>True</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>deviceCategory</td>
<td>3</td>
<td>False</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The cardinality has been significantly reduced for the columns where the infrequently occurring values were grouped (<code>column_grouped == True</code>).</li>
<li>The cardinality is unchanged for the columns where the infrequently occurring values were not grouped (<code>column_grouped == False</code>).</li>
</ol>
</div>
</div>
<p>The category distributions (frequencies) after grouping are shown below for all categorical columns (including those that were grouped)</p>
<div class="cell" data-tags="[]" data-execution_count="42">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>dfs_cats_groups <span class="op">=</span> []</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> categorical_columns_mapped:</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get fraction of unique values</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    df_frequencies <span class="op">=</span> (</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>        df[c]</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>        .value_counts()</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"number_of_visitors"</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>        .merge(</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>                df[c].value_counts(normalize<span class="op">=</span><span class="va">True</span>).rename(<span class="st">"fraction_of_visitors"</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>            ).to_frame(),</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>            left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>            right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># map unique values for last_action and bounces to get meaningful names</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="op">==</span> <span class="st">"last_action"</span>:</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>        df_frequencies.index <span class="op">=</span> df_frequencies.index.<span class="bu">map</span>(mapper)</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="op">==</span> <span class="st">"bounces"</span>:</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>        df_frequencies.index <span class="op">=</span> df_frequencies.index.<span class="bu">map</span>({<span class="dv">0</span>: <span class="va">False</span>, <span class="dv">1</span>: <span class="va">True</span>})</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get running total of fraction (cumulative sum)</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>    df_frequencies <span class="op">=</span> (</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>        df_frequencies.sort_values(by<span class="op">=</span>[<span class="st">"fraction_of_visitors"</span>])</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>            cumulative_fraction_of_visitors<span class="op">=</span><span class="kw">lambda</span> df: df[</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fraction_of_visitors"</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>            ].cumsum(),</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>            column_name<span class="op">=</span>c,</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>        .sort_values(by<span class="op">=</span>[<span class="st">"fraction_of_visitors"</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename columns</span></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>    df_frequencies <span class="op">=</span> df_frequencies.reset_index().rename(columns<span class="op">=</span>{c: <span class="st">"column_value"</span>})</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>    dfs_cats_groups.append(df_frequencies)</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>df_frequencies_grouped <span class="op">=</span> pd.concat(dfs_cats_groups, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>col <span class="op">=</span> df_frequencies_grouped.pop(<span class="st">"column_name"</span>)</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>df_frequencies_grouped.insert(<span class="dv">0</span>, col.name, col)</span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_rows"</span>, <span class="va">None</span>):</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>    display(df_frequencies_grouped)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column_name</th>
<th data-quarto-table-cell-role="th">column_value</th>
<th data-quarto-table-cell-role="th">number_of_visitors</th>
<th data-quarto-table-cell-role="th">fraction_of_visitors</th>
<th data-quarto-table-cell-role="th">cumulative_fraction_of_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>deviceCategory</td>
<td>desktop</td>
<td>67355</td>
<td>72.776091</td>
<td>100.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>deviceCategory</td>
<td>mobile</td>
<td>21790</td>
<td>23.543776</td>
<td>27.223909</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>deviceCategory</td>
<td>tablet</td>
<td>3406</td>
<td>3.680133</td>
<td>3.680133</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>bounces</td>
<td>False</td>
<td>65505</td>
<td>70.777193</td>
<td>100.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>bounces</td>
<td>True</td>
<td>27046</td>
<td>29.222807</td>
<td>29.222807</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>last_action</td>
<td>Unknown</td>
<td>67511</td>
<td>72.944647</td>
<td>100.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>last_action</td>
<td>Product detail views</td>
<td>14731</td>
<td>15.91663</td>
<td>27.055353</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>last_action</td>
<td>Add product(s) to cart</td>
<td>4655</td>
<td>5.029659</td>
<td>11.138724</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>last_action</td>
<td>Completed purchase</td>
<td>3097</td>
<td>3.346263</td>
<td>6.109064</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>last_action</td>
<td>Check out</td>
<td>1635</td>
<td>1.766594</td>
<td>2.762801</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>last_action</td>
<td>Remove product(s) from cart</td>
<td>881</td>
<td>0.951908</td>
<td>0.996207</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>last_action</td>
<td>Click through of product lists</td>
<td>41</td>
<td>0.0443</td>
<td>0.0443</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>source_grouped</td>
<td>google</td>
<td>43484</td>
<td>46.983825</td>
<td>100.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>source_grouped</td>
<td>(direct)</td>
<td>21532</td>
<td>23.265011</td>
<td>53.016175</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>source_grouped</td>
<td>mall.googleplex.com</td>
<td>11777</td>
<td>12.724876</td>
<td>29.751164</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>source_grouped</td>
<td>youtube.com</td>
<td>8021</td>
<td>8.666573</td>
<td>17.026288</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>source_grouped</td>
<td>other</td>
<td>7737</td>
<td>8.359715</td>
<td>8.359715</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>browser_grouped</td>
<td>Chrome</td>
<td>69002</td>
<td>74.55565</td>
<td>100.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>browser_grouped</td>
<td>Safari</td>
<td>15294</td>
<td>16.524943</td>
<td>25.44435</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>browser_grouped</td>
<td>other</td>
<td>8255</td>
<td>8.919407</td>
<td>8.919407</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>os_grouped</td>
<td>Macintosh</td>
<td>30610</td>
<td>33.073657</td>
<td>100.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>os_grouped</td>
<td>Windows</td>
<td>25588</td>
<td>27.647459</td>
<td>66.926343</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>os_grouped</td>
<td>iOS</td>
<td>13500</td>
<td>14.586552</td>
<td>39.278884</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>os_grouped</td>
<td>Android</td>
<td>11486</td>
<td>12.410455</td>
<td>24.692332</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>os_grouped</td>
<td>other</td>
<td>11367</td>
<td>12.281877</td>
<td>12.281877</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>channelGrouping_grouped</td>
<td>Organic Search</td>
<td>38584</td>
<td>41.689447</td>
<td>100.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>channelGrouping_grouped</td>
<td>Direct</td>
<td>21532</td>
<td>23.265011</td>
<td>58.310553</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>channelGrouping_grouped</td>
<td>other</td>
<td>16275</td>
<td>17.584899</td>
<td>35.045542</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>channelGrouping_grouped</td>
<td>Referral</td>
<td>16160</td>
<td>17.460643</td>
<td>17.460643</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>medium_grouped</td>
<td>organic</td>
<td>38584</td>
<td>41.689447</td>
<td>100.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>medium_grouped</td>
<td>referral</td>
<td>25086</td>
<td>27.105056</td>
<td>58.310553</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>medium_grouped</td>
<td>(none)</td>
<td>21532</td>
<td>23.265011</td>
<td>31.205498</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">32</td>
<td>medium_grouped</td>
<td>other</td>
<td>7349</td>
<td>7.940487</td>
<td>7.940487</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>These distributions are shown here after frequency encoding (grouping) the high-cardinality columns in order to determine the thresholds (5% and 10%) for replacing infrequently occurring values in these columns. Earlier, the same was shown in the raw categorical columns. In that <code>DataFrame</code>, there were 184 unique categories across all categorical columns (length of <code>df_frequencies_raw</code>). After dummy encoding (where we will drop duplicate categories in each raw categorical column - <a href="https://towardsdatascience.com/encoding-categorical-variables-one-hot-vs-dummy-encoding-6d5b9c46e2db">1</a>), there would be 184 - <code>&lt;number-of-categorical-columns&gt;</code> = 184 - 8 = 176 features.</li>
<li>After frequency grouping (where we will drop duplicate categories in each grouped categorical column), there are 33 unique categories. After dummy encoding, the number of dummy variables will be 33 - <code>&lt;number-of-categorical-columns&gt;</code> = 33 - 8 = 26 features. This frequency encoding approach has reduced the cardinality by (176 - 26) / 176 = 0.86 (or 86%).</li>
</ol>
</div>
</div>
<p>The reduction in cardinality of the categorical feaures, after frequency grouping, is calculated below</p>
<div class="cell" data-tags="[]" data-execution_count="43">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>frac_reduction_in_cats_cardinality <span class="op">=</span> (</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">100</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> (</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>        (<span class="bu">len</span>(df_frequencies_raw) <span class="op">-</span> <span class="bu">len</span>(categorical_columns))</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> (<span class="bu">len</span>(df_frequencies_grouped) <span class="op">-</span> <span class="bu">len</span>(categorical_columns))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> (<span class="bu">len</span>(df_frequencies_raw) <span class="op">-</span> <span class="bu">len</span>(categorical_columns))</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Frequency encoding (grouping) has reduced cardinality of categorical features by "</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>frac_reduction_in_cats_cardinality<span class="sc">:,</span><span class="fl">.3</span><span class="er">f</span><span class="sc">}</span><span class="ss">%"</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Frequency encoding (grouping) has reduced cardinality of categorical features by 85.795%</code></pre>
</div>
</div>
<p>The groupings above have been learnt from the training data. We now need to create a lookup table for columns that were grouped so that we can apply the same groupings to unseen data (validation and test data splits). This means when we encounter the same infrequently occurring values in the validation and test data splits, they will be replaced by <code>other</code>.</p>
<p>This lookup table is defined below</p>
<div class="cell" data-tags="[]" data-execution_count="44">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>df_groupings <span class="op">=</span> pd.DataFrame.from_dict(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>        c: df[c]</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>        .value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"fraction"</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        .query(<span class="ss">f"fraction &lt; </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>        .index.tolist()</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> cols, threshold <span class="kw">in</span> <span class="bu">zip</span>(</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>            [cols_to_group_5_pct, cols_to_group_10_pct], [<span class="fl">0.05</span>, <span class="fl">0.10</span>]</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> cols</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    orient<span class="op">=</span><span class="st">"index"</span>,</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>).transpose()</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>display(df_groupings.head())</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>display(df_groupings.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">medium</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>sites.google.com</td>
<td>Firefox</td>
<td>Linux</td>
<td>Social</td>
<td>cpc</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>moma.corp.google.com</td>
<td>Internet Explorer</td>
<td>Chrome OS</td>
<td>Paid Search</td>
<td>affiliate</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Partners</td>
<td>Opera</td>
<td>(not set)</td>
<td>Affiliates</td>
<td>cpm</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>dfa</td>
<td>Edge</td>
<td>Windows Phone</td>
<td>Display</td>
<td>(not set)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>siliconvalley.about.com</td>
<td>Safari (in-app)</td>
<td>Nintendo Wii</td>
<td>(Other)</td>
<td>None</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">medium</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">107</td>
<td>dailydot.com</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">108</td>
<td>digg.com</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">109</td>
<td>xbidprodmirror.corp.google.com</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">110</td>
<td>seroundtable.com</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">111</td>
<td>spaces.google.com</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We’ll also create a lookup table of unique values in the categorical columns that were not grouped. When we encounter these values in the validation or test data splits, they will remain unchanged.</p>
<p>This lookup table is defined below</p>
<div class="cell" data-tags="[]" data-execution_count="45">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>df_ungrouped <span class="op">=</span> pd.DataFrame.from_dict(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>        c: df[c]</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>        .value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"fraction"</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>        .query(<span class="ss">f"fraction &gt;= </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>        .index.tolist()</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> cols, threshold <span class="kw">in</span> <span class="bu">zip</span>(</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>            [cols_to_group_5_pct, cols_to_group_10_pct], [<span class="fl">0.05</span>, <span class="fl">0.10</span>]</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> cols</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    orient<span class="op">=</span><span class="st">"index"</span>,</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>).transpose()</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>df_ungrouped</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">medium</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>google</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>Organic Search</td>
<td>organic</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>(direct)</td>
<td>Safari</td>
<td>Windows</td>
<td>Direct</td>
<td>referral</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>mall.googleplex.com</td>
<td>None</td>
<td>iOS</td>
<td>Referral</td>
<td>(none)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>youtube.com</td>
<td>None</td>
<td>Android</td>
<td>None</td>
<td>None</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>For a quick demonstration of using these two lookup tables, we’ll create a dummy validation data <code>DataFrame</code> below with two categorical features</p>
<div class="cell" data-tags="[]" data-execution_count="46">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>df_val <span class="op">=</span> pd.DataFrame.from_records(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"source"</span>: <span class="st">"Partners"</span>, <span class="st">"browser"</span>: <span class="st">"Internet Explorer"</span>},</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"source"</span>: <span class="st">"dfa"</span>, <span class="st">"browser"</span>: <span class="st">"new-browser"</span>},</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"source"</span>: <span class="st">"new-source-value"</span>, <span class="st">"browser"</span>: <span class="st">"Chrome"</span>},</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>df_val</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">browser</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Partners</td>
<td>Internet Explorer</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>dfa</td>
<td>new-browser</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>new-source-value</td>
<td>Chrome</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We’ll now apply both the lookup tables defined above using the following approach</p>
<ol type="1">
<li>for all columns that were grouped, create columns with a suffix <code>_grouped</code> which contains the value <code>other</code> for infrequently occurring values</li>
<li>for all columns that were not grouped, create columns with a suffix <code>_ungrouped</code> which contains the same values with no changes</li>
<li>combine columns with the <code>_ungrouped</code> and <code>_grouped</code> suffixes into a single column column
<ul>
<li>to do this, fill missing values in the <code>_grouped</code> column with those in the <code>_ungrouped</code> column</li>
</ul></li>
<li>drop original columns and rename the combined columns appropriately</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="47">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>categorical_columns_validation_data <span class="op">=</span> [<span class="st">"source"</span>, <span class="st">"browser"</span>]</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> categorical_columns_validation_data:</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. replace infrequent values in columns that were grouped (add suffix _grouped)</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    df_val[<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_grouped"</span>] <span class="op">=</span> df_val[c].<span class="bu">map</span>(</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>        {c_grouped: <span class="st">"other"</span> <span class="cf">for</span> c_grouped <span class="kw">in</span> df_groupings[c].tolist()}</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. keep all values in columns that were not grouped (add suffix _ungrouped)</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    df_val[<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_ungrouped"</span>] <span class="op">=</span> df_val[c].<span class="bu">map</span>(</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>        {c_ungrouped: c_ungrouped <span class="cf">for</span> c_ungrouped <span class="kw">in</span> df_ungrouped[c].tolist()}</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. combine columns that were replaced (_grouped) and those that were not replaced (_ungrouped)</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    df_val[<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_grouped"</span>] <span class="op">=</span> df_val[<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_grouped"</span>].fillna(df_val[<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_ungrouped"</span>])</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. drop unwanted columns and rename</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>df_val <span class="op">=</span> df_val.drop(</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"browser_ungrouped"</span>, <span class="st">"source_ungrouped"</span>]</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> categorical_columns_validation_data</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>).rename(columns<span class="op">=</span>{<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_grouped"</span>: c <span class="cf">for</span> c <span class="kw">in</span> categorical_columns_validation_data})</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>df_val</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">browser</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>other</td>
<td>other</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>other</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>NaN</td>
<td>Chrome</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>In both features of the validation data, there are new categories that were not seen in the training data. After applying the two lookup tables above, these values are replaced by <code>None</code>s. We can fill these missing values using
<ul>
<li><code>new</code> (or keep it as <code>None</code>) to indicate this is a new category
<ul>
<li>the ML model has not seen this value in the appropriate feature during training, so the predictive power of such a feature in the unseen (validation) data will likely be reduced or minimal (the model won’t know its relationship to the label <code>y</code>)</li>
</ul></li>
<li><code>other</code> to group this into the infrequently occurring categories that were identified from the training data
<ul>
<li>the disadvantage is that these new categories might have a different relationship to the label label (<code>y</code>) than the grouped (<code>other</code>) category</li>
<li>in such a scenario
<ul>
<li>the ML model might not able to leverage the full predictive power of such new categories in the validation (unseen) data when it makes predictions since it was not trained to learn this relationship in the training data</li>
<li>the model will make predictions based on the relationship learnt between the grouped (<code>other</code>) category and the label (<code>y</code>)</li>
</ul></li>
</ul></li>
</ul></li>
</ol>
</div>
</div>
<p>During data processing (after this EDA step), we will create the training, validation and test data splits for ML development and the same workflow will be used to handle categorical features during data processing.</p>
</section>
</section>
<section id="key-findings" class="level2">
<h2 class="anchored" data-anchor-id="key-findings">Key Findings</h2>
<section id="nested-attributes-of-first-time-visits" class="level3">
<h3 class="anchored" data-anchor-id="nested-attributes-of-first-time-visits">Nested Attributes of First-Time Visits</h3>
<ol type="1">
<li>Promotion nested column
<ul>
<li>When <code>view_promo = True</code>, a visitor has viewed a promotion. If it is not viewed, then it is <code>None</code></li>
<li>When a visitor clicks a promotion after viewing it
<ul>
<li><code>click_promo = True</code></li>
<li><code>view_promo is NULL</code></li>
</ul></li>
</ul></li>
<li>Product nested column
<ul>
<li>if a product is viewed in a listing (<code>product_count &gt; 0</code>) during a visit, then there are only two possible values for <code>clicked_product</code> and <code>viewed_product</code>, namely <code>True</code> and <code>None</code></li>
<li>a product is not viewed in a listing, then the only value in these same two columns is <code>None</code></li>
</ul></li>
</ol>
</section>
<section id="recommendations-for-data-processing" class="level3">
<h3 class="anchored" data-anchor-id="recommendations-for-data-processing">Recommendations for Data Processing</h3>
<ol type="1">
<li>Negligible duplicates exist for
<ul>
<li><code>visitId</code>
<ul>
<li>the reason for this duplication is known</li>
<li>such duplicates are kept in the data</li>
</ul></li>
<li><code>fullvisitorid</code>
<ul>
<li>the reason for this duplication is not known</li>
<li>all but the first of such duplicates should be dropped</li>
</ul></li>
</ul></li>
<li>The cardinality across the combination of all categorical columns extracted from visitors’ first visit to the store can be significantly reduced by replacing infrequently occuring values by the category <code>other</code>
<ul>
<li><code>source</code> and <code>browser</code> columns
<ul>
<li>all categories which occur with a frequency of less than 5% should be grouped into a single value <code>other</code></li>
</ul></li>
<li><code>os</code>, <code>channelGrouping</code> and <code>medium</code> columns
<ul>
<li>all categories which occur with a frequency of less than 10% should be grouped into a single value <code>other</code></li>
</ul></li>
</ul></li>
</ol>
</section>
</section>
<section id="summary-of-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-assumptions">Summary of Assumptions</h2>
<ol type="1">
<li>Negligible duplicates in <code>fullvisitorid</code> are found and are not well understood and so they should be dropped in the training, validation and test data splits during data transformation.</li>
</ol>
</section>
<section id="summary-of-tasks-performed" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-tasks-performed">Summary of Tasks Performed</h2>
<p>This step has performed the following</p>
<ol type="1">
<li>extracted attributes from dataset to create a <em>prepared dataset</em> for use in EDA
<ul>
<li>flattened nested columns for products and promotions</li>
<li>extracted columns that should intuitively help predict probability of making a purchase on a return (future) visit</li>
</ul></li>
<li>addressed duplicated visits</li>
<li>handled high-cardinality categorical columns</li>
</ol>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<p>None.</p>
</section>
<section id="next-step" class="level2">
<h2 class="anchored" data-anchor-id="next-step">Next Step</h2>
<p>The next step will be to perform exploratory data analysis using data prepared using the findings from this data preparation step.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.quarto\.org\/custom");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="../../../notebooks/01-get-data/notebooks/01_get_data.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Get Data</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../notebooks/03-eda/notebooks/03_eda.html" class="pagination-link">
        <span class="nav-page-text">Explore Data</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<script src="../../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>