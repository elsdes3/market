<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine Learning Project - Create Marketing Audience Cohorts</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../notebooks/04-transform/notebooks/04_transform.html" rel="prev">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Machine Learning Project</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../notebooks/07-create-audience/notebooks/07_create_audience.html">Create Audience</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../../images/lorip_square.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../references/Scope.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scope</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/01-get-data/notebooks/01_get_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Get Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-prepare/notebooks/02_prepare.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prepare Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/03-eda/notebooks/03_eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Explore Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/04-transform/notebooks/04_transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transform Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/07-create-audience/notebooks/07_create_audience.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Create Audience</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about" id="toc-about" class="nav-link active" data-scroll-target="#about">About</a>
  <ul class="collapse">
  <li><a href="#objective" id="toc-objective" class="nav-link" data-scroll-target="#objective">Objective</a></li>
  <li><a href="#audience-propensity-groups" id="toc-audience-propensity-groups" class="nav-link" data-scroll-target="#audience-propensity-groups">Audience Propensity Groups</a></li>
  <li><a href="#test-or-treatment-and-control-cohorts" id="toc-test-or-treatment-and-control-cohorts" class="nav-link" data-scroll-target="#test-or-treatment-and-control-cohorts">Test (or Treatment) and Control Cohorts</a></li>
  <li><a href="#summary-of-analysis-in-this-step" id="toc-summary-of-analysis-in-this-step" class="nav-link" data-scroll-target="#summary-of-analysis-in-this-step">Summary of Analysis in This Step</a></li>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions">Assumptions</a></li>
  </ul></li>
  <li><a href="#user-inputs" id="toc-user-inputs" class="nav-link" data-scroll-target="#user-inputs">User Inputs</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data">Load Data</a></li>
  <li><a href="#process-data" id="toc-process-data" class="nav-link" data-scroll-target="#process-data">Process Data</a>
  <ul class="collapse">
  <li><a href="#get-audience-groups-based-on-propensity-to-make-purchase-on-return-visit" id="toc-get-audience-groups-based-on-propensity-to-make-purchase-on-return-visit" class="nav-link" data-scroll-target="#get-audience-groups-based-on-propensity-to-make-purchase-on-return-visit">Get Audience Groups Based on Propensity to Make Purchase on Return Visit</a></li>
  <li><a href="#create-test-and-control-cohorts" id="toc-create-test-and-control-cohorts" class="nav-link" data-scroll-target="#create-test-and-control-cohorts">Create Test and Control Cohorts</a></li>
  </ul></li>
  <li><a href="#export-to-disk" id="toc-export-to-disk" class="nav-link" data-scroll-target="#export-to-disk">Export to Disk</a></li>
  <li><a href="#summary-of-tasks-performed" id="toc-summary-of-tasks-performed" class="nav-link" data-scroll-target="#summary-of-tasks-performed">Summary of Tasks Performed</a></li>
  <li><a href="#summary-of-assumptions" id="toc-summary-of-assumptions" class="nav-link" data-scroll-target="#summary-of-assumptions">Summary of Assumptions</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/elsdes3/market/blob/main/notebooks/07-create-audience/notebooks/07_create_audience.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/elsdes3/market/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Create Marketing Audience Cohorts</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Import Python libraries</p>
<div class="cell" data-tags="[]" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="about" class="level2">
<h2 class="anchored" data-anchor-id="about">About</h2>
<section id="objective" class="level3">
<h3 class="anchored" data-anchor-id="objective">Objective</h3>
<p>The final step in the workflow for this project is to generate the marketing audience test (or treatment) and control cohorts. Generating the marketing audience cohorts is the deliverable that is required at the end of this project. This step will create this deliverable.</p>
</section>
<section id="audience-propensity-groups" class="level3">
<h3 class="anchored" data-anchor-id="audience-propensity-groups">Audience Propensity Groups</h3>
<p>Three marketing audience propensity groups were chosen in the previous step (post-processing)</p>
<ol type="1">
<li><code>low</code>
<ul>
<li>visitors in this audience group are predicted to have a low propensity (or likelihood) to make a purchase on a return visit to the store</li>
</ul></li>
<li><code>medium</code></li>
<li><code>high</code></li>
</ol>
<p>Predictions of propensity (probabilities) come from the ML model’s predicted probabilities for visitors in the unseen data split. The unseen data covers March 1 - 31, 2017 and represents the production period for this project.</p>
</section>
<section id="test-or-treatment-and-control-cohorts" class="level3">
<h3 class="anchored" data-anchor-id="test-or-treatment-and-control-cohorts">Test (or Treatment) and Control Cohorts</h3>
<p>The test and control cohorts are randomly selected from each audience propensity group (low, medium and high). The size of each cohort is chosen based on the output of the previous analysis step (the media experiment design, or post-processing).</p>
<p>In the current step</p>
<ol type="1">
<li>the control cohort is randomly chosen from each audience propensity group (low, medium and high)</li>
<li>a random sampling from all visitors that do not belong to the control group is drawn and these visitors are placed in the test (or treatment) group
<ul>
<li>all other visitors do not belong to a cohort</li>
</ul></li>
</ol>
</section>
<section id="summary-of-analysis-in-this-step" class="level3">
<h3 class="anchored" data-anchor-id="summary-of-analysis-in-this-step">Summary of Analysis in This Step</h3>
<p>In summary, the final output of this step is to append two new columns to the propensity predictions for the unseen data</p>
<ol type="1">
<li><code>audience_group</code></li>
<li><code>cohort</code></li>
</ol>
</section>
<section id="assumptions" class="level3">
<h3 class="anchored" data-anchor-id="assumptions">Assumptions</h3>
<p>As was the case with the preceding (post-processing, or media design) step, the current step can only be be run on March 31, 2017 after</p>
<ol type="1">
<li>all the unseen data has been collected</li>
<li>propensity (probabilities) have been predicted for this data</li>
</ol>
<p>So, we will assume that</p>
<ol type="1">
<li>the current date is April 1, 2017</li>
<li>the unseen data has been
<ul>
<li>collected</li>
<li>processed (drop duplicates, bin categorical features, etc. as was done during ML model development)</li>
</ul></li>
<li>we have used the trained ML model to make predictions of the probability (likelihood or propenisty) of making a purchase on a future visit for all visitors in the unseen data</li>
</ol>
</section>
</section>
<section id="user-inputs" class="level2">
<h2 class="anchored" data-anchor-id="user-inputs">User Inputs</h2>
<div class="cell" data-tags="[]" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>PROJ_ROOT_DIR <span class="op">=</span> os.path.join(os.pardir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Define the following</p>
<ol type="1">
<li><code>audience_groups</code>
<ul>
<li>desired audience groups into which the first-time visitors propensities will be placed
<ul>
<li><code>num_propens_groups</code> specifies the number of groups</li>
<li><code>propens_group_labels</code> specifies names of the groups</li>
</ul></li>
<li>this is a Python dictionary with the following key-value pairs
<ul>
<li><code>num_propens_groupsnum_propens_groups</code> represents the number of desired audience propensity groups (low, medium and high)</li>
</ul></li>
<li><code>propens_group_labels</code> gives the desired audience propensity group labels</li>
</ul></li>
<li><code>min_control_group_sample_sizes</code>
<ul>
<li>the least number of samples (first-time visitors) to be included in both the control and test cohorts of each audience group</li>
<li>these should come from the output of the previous step (<a href="https://blog.hubspot.com/blog/tabid/6307/bid/31634/a-b-testing-in-action-3-real-life-marketing-experiments.aspxhttps://blog.hubspot.com/blog/tabid/6307/bid/31634/a-b-testing-in-action-3-real-life-marketing-experiments.aspx">designing a media or marketing experiment</a>)</li>
<li>this is a Python list with integers that represent the desired minimum size of the control and test cohort</li>
</ul></li>
</ol>
<div class="cell" data-tags="[&quot;parameters&quot;]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>audience_groups <span class="op">=</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_propens_groups"</span>: <span class="dv">3</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"propens_group_labels"</span>: [<span class="st">"High"</span>, <span class="st">"Medium"</span>, <span class="st">"Low"</span>],</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>min_control_group_sizes <span class="op">=</span> [<span class="dv">1000</span>, <span class="dv">2000</span>, <span class="dv">3000</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define filepath to data directory where the unseen data, with predictions, is stored</p>
<div class="cell" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>model_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"models"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ml_preds_fpath <span class="op">=</span> os.path.join(model_dir, <span class="st">"unseen_data_predictions.parquet.gzip"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define filepath to data directory where the created audience cohorts will be stored</p>
<div class="cell" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"data"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>processed_data_dir <span class="op">=</span> os.path.join(data_dir, <span class="st">"processed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a mapping between audience group number (0, 1, 2) and name (high, medium, low), where</p>
<ul>
<li>0 is mapped to high</li>
<li>1 is mapped to medium</li>
<li>2 is mapped to low</li>
</ul>
<p>since it is <a href="https://stackoverflow.com/a/26502255/4057186https://stackoverflow.com/a/26502255/4057186">standard to</a> assign a label the top percentile (highest propensity) with the smallest number (0)</p>
<div class="cell" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>mapper_dict_audience <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">zip</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">range</span>(audience_groups[<span class="st">"num_propens_groups"</span>]),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        audience_groups[<span class="st">"propens_group_labels"</span>],</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define a helper function to show datatypes and number of missing values in a <code>DataFrame</code></p>
<div class="cell" data-tags="[]" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize_df(df: pd.DataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Show datatypes and count missing values in columns of DataFrame."""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    display(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        df.dtypes.rename(<span class="st">"dtype"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        .merge(</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>            df.isna().<span class="bu">sum</span>().rename(<span class="st">"missing"</span>).to_frame(),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>            left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>            right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="load-data" class="level2">
<h2 class="anchored" data-anchor-id="load-data">Load Data</h2>
<p>Load the predictions of propensity to make a purchase on a return visit for all first-time visitors in the unseen data split</p>
<div class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_parquet(ml_preds_fpath, engine<span class="op">=</span><span class="st">"pyarrow"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>display(df.head())</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>display(df.tail())</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>summarize_df(df)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">predicted_score_label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>9568</td>
<td>False</td>
<td>0.008079</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>18180</td>
<td>False</td>
<td>0.030055</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>154</td>
<td>False</td>
<td>0.0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1718</td>
<td>False</td>
<td>0.000253</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>413</td>
<td>False</td>
<td>0.065967</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">predicted_score_label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">23995</td>
<td>19834</td>
<td>False</td>
<td>0.000077</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23996</td>
<td>3875</td>
<td>False</td>
<td>0.000001</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">23997</td>
<td>20780</td>
<td>False</td>
<td>0.00001</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23998</td>
<td>11178</td>
<td>True</td>
<td>0.278035</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">23999</td>
<td>12921</td>
<td>False</td>
<td>0.003235</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dtype</th>
<th data-quarto-table-cell-role="th">missing</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">fullvisitorid</td>
<td>string[python]</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">label</td>
<td>bool</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">score</td>
<td>Float32</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">predicted_score_label</td>
<td>boolean</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 24000 entries, 0 to 23999
Data columns (total 4 columns):
 #   Column                 Non-Null Count  Dtype  
---  ------                 --------------  -----  
 0   fullvisitorid          24000 non-null  string 
 1   label                  24000 non-null  bool   
 2   score                  24000 non-null  Float32
 3   predicted_score_label  24000 non-null  boolean
dtypes: Float32(1), bool(1), boolean(1), string(1)
memory usage: 375.1 KB</code></pre>
</div>
</div>
<p><strong>Notes</strong></p>
<ol type="1">
<li>The <code>fullvisitorid</code> column is the ID of each visitor who
<ul>
<li>made a purchase on a return visit to the store</li>
<li>made their first visit to the store during the dates covered by the test data split</li>
</ul></li>
<li>The true ML label (<code>y_true</code>) will not be known until a later date, after March 31, 2017 (see the project scope for details)</li>
<li>The <code>predicted_score_label</code> column is the predicted label using ML (<code>y_pred</code>).</li>
<li>The <code>score</code> column is the predicted probability (using <code>.pred_proba()</code>), which is the propensity of a visitor to make a purchase on a return visit.</li>
<li>Any other columns are either
<ul>
<li>used in ML as features (<code>X</code>), or</li>
<li>not used in ML</li>
</ul></li>
</ol>
</section>
<section id="process-data" class="level2">
<h2 class="anchored" data-anchor-id="process-data">Process Data</h2>
<p>Labels for the audience and cohort groups will now be assigned to all visitors in the test data.</p>
<p>For the audience, all visitors will be placed in one of three groups based on their predicted propensity to make a purchase on a return visit to the store. Groups are created using <code>pandas.qcut()</code>. There will be three such groups - low, medium and high propensity.</p>
<p>To do this, a separate column <code>audience_group</code> will be assigned and will contain integers (2, 1, 0). These integers are in descending order since</p>
<ol type="1">
<li>the scores (predicted probabilities) have been sorted in descending order</li>
<li><code>pandas.qcut()</code> assigns bin numbers starting at 0, which is a standard practice (see the explanation for <code>mapper_dict_audience</code> earlier in this step)</li>
</ol>
<p>Later, labels (<code>Low</code>, <code>Medium</code> or <code>High</code>) will be mapped to the integers using the mapping dictionary created above (<code>mapper_dict_audience</code>).</p>
<p>The the cohort, a subset of visitors will be placed in one of two cohorts - test (or treatment) and control. All other visitors will be assigned a choort of <code>None</code>. To do this, a separate column <code>audience_group</code> will be assigned and will contain <code>Control</code>, <code>Test</code> or <code>None</code>.</p>
<section id="get-audience-groups-based-on-propensity-to-make-purchase-on-return-visit" class="level3">
<h3 class="anchored" data-anchor-id="get-audience-groups-based-on-propensity-to-make-purchase-on-return-visit">Get Audience Groups Based on Propensity to Make Purchase on Return Visit</h3>
<p>To create the audience for the marketing campaign, we’ll first</p>
<ol type="1">
<li>(optionally) sort the predicted probabilities in the unseen (or inference) data, in descending order</li>
<li>assign a row number to each observation (i.e.&nbsp;to each row or visitor) in this unseen data</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="11">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> (</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    df</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    .sort_values(by<span class="op">=</span><span class="st">"score"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    .assign(row_number<span class="op">=</span><span class="kw">lambda</span> df: <span class="bu">range</span>(<span class="bu">len</span>(df)))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 3.09 ms, sys: 2.87 ms, total: 5.96 ms
Wall time: 5.35 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">predicted_score_label</th>
<th data-quarto-table-cell-role="th">row_number</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">5277</td>
<td>6539</td>
<td>False</td>
<td>0.957472</td>
<td>True</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">997</td>
<td>15317</td>
<td>False</td>
<td>0.929886</td>
<td>True</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12343</td>
<td>4313</td>
<td>False</td>
<td>0.918627</td>
<td>True</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1644</td>
<td>9806</td>
<td>False</td>
<td>0.908974</td>
<td>True</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22156</td>
<td>4375</td>
<td>False</td>
<td>0.906313</td>
<td>True</td>
<td>4</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Next, we’ll bin the predicted probabilities using their quantiles with <code>pandas.qcut</code>, where the visitors are binned based on visit row number in order to avoid duplication of bin boundaries (three bins are created since earlier we specified we wanted. Three audience groups, namely low, medium and high propensity to purchase.</p>
<p>This is done below</p>
<div class="cell" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"audience_group"</span>] <span class="op">=</span> pd.qcut(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>df[<span class="st">"row_number"</span>], q<span class="op">=</span>audience_groups[<span class="st">"num_propens_groups"</span>], labels<span class="op">=</span><span class="va">False</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>display(df.head())</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>display(df.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">predicted_score_label</th>
<th data-quarto-table-cell-role="th">row_number</th>
<th data-quarto-table-cell-role="th">audience_group</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">5277</td>
<td>6539</td>
<td>False</td>
<td>0.957472</td>
<td>True</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">997</td>
<td>15317</td>
<td>False</td>
<td>0.929886</td>
<td>True</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12343</td>
<td>4313</td>
<td>False</td>
<td>0.918627</td>
<td>True</td>
<td>2</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1644</td>
<td>9806</td>
<td>False</td>
<td>0.908974</td>
<td>True</td>
<td>3</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22156</td>
<td>4375</td>
<td>False</td>
<td>0.906313</td>
<td>True</td>
<td>4</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">predicted_score_label</th>
<th data-quarto-table-cell-role="th">row_number</th>
<th data-quarto-table-cell-role="th">audience_group</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">21391</td>
<td>11855</td>
<td>False</td>
<td>0.0</td>
<td>False</td>
<td>23995</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12926</td>
<td>1147</td>
<td>False</td>
<td>0.0</td>
<td>False</td>
<td>23996</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1387</td>
<td>10329</td>
<td>False</td>
<td>0.0</td>
<td>False</td>
<td>23997</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20790</td>
<td>14354</td>
<td>False</td>
<td>0.0</td>
<td>False</td>
<td>23998</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">575</td>
<td>610</td>
<td>False</td>
<td>0.0</td>
<td>False</td>
<td>23999</td>
<td>2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="create-test-and-control-cohorts" class="level3">
<h3 class="anchored" data-anchor-id="create-test-and-control-cohorts">Create Test and Control Cohorts</h3>
<p>With the three audience propensity groups now assigned, we can create the test and control cohorts within each audience group.</p>
<p>Test and control group cohorts should be randomly selected without replacement. This means the same visitor should not be randomly selected multiple times from the audience group and placed in each cohort. The two cohorts need to be independent and so the same visitor cannot be assigned to both cohorts.</p>
<p>In Python, there are two options to make such random selections without duplication</p>
<ol type="1">
<li><code>random.sample()</code> <a href="https://www.educative.io/answers/what-is-randomsample-in-python">in the Python standard library</a></li>
<li><a href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.choice.html#numpy.random.choice"><code>numpy.random.choice()</code> with <code>replacement=False</code> in the <code>numpy</code> library</a></li>
</ol>
<p>Here, the <code>numpy</code> approach is used.</p>
<p>To create these groups, we’ll iterate over each of the desired minimum test and control visitor cohort sizes that were recommended by the previous step about experiment design (post-processing) and then draw a <a href="https://www.optimove.com/resources/learning-center/control-groups-in-marketing">random sample</a> from each propensity audience group to be chosen as control and test.</p>
<p>The approach will consist of the following steps for each audience group (low, medium or high propensity)</p>
<ol type="1">
<li>draw random sample of visitors, without replacement, as the control group</li>
<li>get all non-selected visitors</li>
<li>from non-selected visitors, draw random sample of visitors, without replacement, as the treatment (test) group</li>
<li>(optional) get all visitors that are not part of either control or test group</li>
<li>extract the following
<ul>
<li>all features (<code>X</code>)</li>
<li>metadata columns not used in ML</li>
<li>predicted ML label (<code>y_pred</code>)</li>
<li>predicted propensities (probabilities, in the <code>score</code> column)</li>
</ul>
and store the results in
<ul>
<li><code>df_test</code> (test or treatment cohort of visitors)</li>
<li><code>df_control</code> (control cohort of visitors)</li>
<li>(optional) <code>df_excluded</code> (cohort of visitors that are not selected in either test or control group)</li>
</ul></li>
</ol>
<p>This approach is shown below</p>
<div class="cell" data-tags="[]" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>groups <span class="op">=</span> []</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k, group_size <span class="kw">in</span> <span class="bu">enumerate</span>(min_control_group_sizes):</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    df_audience <span class="op">=</span> df.query(<span class="ss">f"audience_group == </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    audience_array <span class="op">=</span> df_audience[<span class="st">'fullvisitorid'</span>].to_numpy()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. get control </span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(<span class="dv">88</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    control_group_visitors <span class="op">=</span> rng.choice(audience_array, group_size, replace<span class="op">=</span><span class="va">False</span>).tolist()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. get all remaining visitors</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    other_array <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(audience_array) <span class="op">-</span> <span class="bu">set</span>(control_group_visitors))</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. get test group visitors by randomly sampling from remaining visitors</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    test_group_visitors <span class="op">=</span> rng.choice(other_array, group_size, replace<span class="op">=</span><span class="va">False</span>).tolist()</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. get combined control and test cohorts of visitors</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    combined_cohort_visitors <span class="op">=</span> control_group_visitors <span class="op">+</span> test_group_visitors</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get all excluded visitors (not part of test or control cohort)</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    excluded_visitors <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(audience_array) <span class="op">-</span> <span class="bu">set</span>(combined_cohort_visitors))</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # get audience scores</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># audience_scores = df_audience.query(</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     "fullvisitorid.isin(@combined_cohort_visitors)"</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># )['score'].to_numpy()</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"audience=</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>mapper_dict_audience[k]<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"size=</span><span class="sc">{</span><span class="bu">len</span>(audience_array)<span class="sc">:,}</span><span class="ss">, "</span>,</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"excluded=</span><span class="sc">{</span><span class="bu">len</span>(other_array)<span class="sc">:,}</span><span class="ss">, "</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"wanted=</span><span class="sc">{</span>group_size<span class="sc">:,}</span><span class="ss">, "</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"control=</span><span class="sc">{</span><span class="bu">len</span>(control_group_visitors)<span class="sc">:,}</span><span class="ss">, "</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"test=</span><span class="sc">{</span><span class="bu">len</span>(test_group_visitors)<span class="sc">:,}</span><span class="ss">"</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. get extract attributes for each cohort per audience group</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    df_test <span class="op">=</span> (</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>        df_audience.drop(columns<span class="op">=</span>[<span class="st">'row_number'</span>])</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">"fullvisitorid.isin(@test_group_visitors)"</span>)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        .assign(audience_group<span class="op">=</span>k)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>        .assign(cohort<span class="op">=</span><span class="st">'Test'</span>)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    df_control <span class="op">=</span> (</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>        df_audience.drop(columns<span class="op">=</span>[<span class="st">'row_number'</span>])</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">"fullvisitorid.isin(@control_group_visitors)"</span>)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>        .assign(audience_group<span class="op">=</span>k)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>        .assign(cohort<span class="op">=</span><span class="st">'Control'</span>)</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    df_excluded <span class="op">=</span> (</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>        df_audience.drop(columns<span class="op">=</span>[<span class="st">'row_number'</span>])</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">"fullvisitorid.isin(@excluded_visitors)"</span>)</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>        .assign(audience_group<span class="op">=</span>k)</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>        .assign(cohort<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    df_coh <span class="op">=</span> pd.concat([df_control, df_test, df_excluded], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    groups.append(df_coh)</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>df_test_audience_groups <span class="op">=</span> (</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    pd.concat(groups, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    .assign(audience_group<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">'audience_group'</span>].<span class="bu">map</span>(mapper_dict_audience))</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    .astype({<span class="st">'audience_group'</span>: pd.StringDtype(), <span class="st">'cohort'</span>: pd.StringDtype()})</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>display(df_test_audience_groups.head())</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>display(df_test_audience_groups.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>audience=0: High, size=8,000,  excluded=7,000, wanted=1,000, control=1,000, test=1,000
audience=1: Medium, size=8,000,  excluded=6,000, wanted=2,000, control=2,000, test=2,000
audience=2: Low, size=8,000,  excluded=5,000, wanted=3,000, control=3,000, test=3,000
CPU times: user 61.1 ms, sys: 5.16 ms, total: 66.3 ms
Wall time: 65.6 ms</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">predicted_score_label</th>
<th data-quarto-table-cell-role="th">audience_group</th>
<th data-quarto-table-cell-role="th">cohort</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>11635</td>
<td>False</td>
<td>0.805879</td>
<td>True</td>
<td>High</td>
<td>Control</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>9652</td>
<td>False</td>
<td>0.783223</td>
<td>True</td>
<td>High</td>
<td>Control</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>15041</td>
<td>False</td>
<td>0.769196</td>
<td>True</td>
<td>High</td>
<td>Control</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6620</td>
<td>False</td>
<td>0.765363</td>
<td>True</td>
<td>High</td>
<td>Control</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3295</td>
<td>False</td>
<td>0.736128</td>
<td>True</td>
<td>High</td>
<td>Control</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">predicted_score_label</th>
<th data-quarto-table-cell-role="th">audience_group</th>
<th data-quarto-table-cell-role="th">cohort</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>11635</td>
<td>False</td>
<td>0.805879</td>
<td>True</td>
<td>High</td>
<td>Control</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>9652</td>
<td>False</td>
<td>0.783223</td>
<td>True</td>
<td>High</td>
<td>Control</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>15041</td>
<td>False</td>
<td>0.769196</td>
<td>True</td>
<td>High</td>
<td>Control</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6620</td>
<td>False</td>
<td>0.765363</td>
<td>True</td>
<td>High</td>
<td>Control</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3295</td>
<td>False</td>
<td>0.736128</td>
<td>True</td>
<td>High</td>
<td>Control</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Earlier, we mentioned that the treatment (or test) and control groups should be similar to each other for the property to be tested. This is a <a href="https://www.mobileapps.com/blog/test-group#Similarities_Between_Test_and_Control_Groups">fundamental requirement of test and control groups</a>. In this case, the probability (<code>score</code> column) is the property of interest.</p>
<p>With this in mind, we now show selected descriptive statistics for both the test (treatment) and control cohorts within each desired audience group (low, medium and high propensity)</p>
<div class="cell" data-tags="[]" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df_aud_stats <span class="op">=</span> df_test_audience_groups.groupby(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"audience_group"</span>, <span class="st">"cohort"</span>], dropna<span class="op">=</span><span class="va">False</span>, as_index<span class="op">=</span><span class="va">False</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>).agg({<span class="st">"score"</span>: [<span class="st">"count"</span>, <span class="st">"min"</span>, <span class="st">"mean"</span>, <span class="st">"median"</span>, <span class="st">"max"</span>]})</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>df_aud_stats.columns <span class="op">=</span> [</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"_"</span>.join(c).rstrip(<span class="st">"_"</span>) <span class="cf">for</span> c <span class="kw">in</span> df_aud_stats.columns.to_flat_index()</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>df_aud_stats <span class="op">=</span> df_aud_stats.astype(</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    {<span class="ss">f"score_</span><span class="sc">{</span>stat<span class="sc">}</span><span class="ss">"</span>: pd.Float32Dtype() <span class="cf">for</span> stat <span class="kw">in</span> [<span class="st">"min"</span>, <span class="st">"mean"</span>, <span class="st">"median"</span>, <span class="st">"max"</span>]}</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>).sort_values(by<span class="op">=</span>[<span class="st">"audience_group"</span>])</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>df_aud_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">audience_group</th>
<th data-quarto-table-cell-role="th">cohort</th>
<th data-quarto-table-cell-role="th">score_count</th>
<th data-quarto-table-cell-role="th">score_min</th>
<th data-quarto-table-cell-role="th">score_mean</th>
<th data-quarto-table-cell-role="th">score_median</th>
<th data-quarto-table-cell-role="th">score_max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>High</td>
<td>Control</td>
<td>1000</td>
<td>0.011979</td>
<td>0.137127</td>
<td>0.073412</td>
<td>0.805879</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>High</td>
<td>Test</td>
<td>1000</td>
<td>0.011967</td>
<td>0.145986</td>
<td>0.083493</td>
<td>0.918627</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>High</td>
<td>&lt;NA&gt;</td>
<td>6000</td>
<td>0.011962</td>
<td>0.143285</td>
<td>0.077881</td>
<td>0.957472</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Low</td>
<td>Control</td>
<td>3000</td>
<td>0.0</td>
<td>0.000006</td>
<td>0.0</td>
<td>0.000052</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Low</td>
<td>Test</td>
<td>3000</td>
<td>0.0</td>
<td>0.000006</td>
<td>0.0</td>
<td>0.000052</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Low</td>
<td>&lt;NA&gt;</td>
<td>2000</td>
<td>0.0</td>
<td>0.000006</td>
<td>0.0</td>
<td>0.000052</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Medium</td>
<td>Control</td>
<td>2000</td>
<td>0.000053</td>
<td>0.002735</td>
<td>0.001312</td>
<td>0.011958</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Medium</td>
<td>Test</td>
<td>2000</td>
<td>0.000053</td>
<td>0.002649</td>
<td>0.00122</td>
<td>0.011951</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Medium</td>
<td>&lt;NA&gt;</td>
<td>4000</td>
<td>0.000053</td>
<td>0.002617</td>
<td>0.001202</td>
<td>0.011958</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong>Observations</strong></p>
<ol type="1">
<li>With the exception of outliers in the <em>High</em> propensity audience group, we see good agreement in the statistics for the probabilities per Test-Control cohort within the same audience group.</li>
</ol>
</section>
</section>
<section id="export-to-disk" class="level2">
<h2 class="anchored" data-anchor-id="export-to-disk">Export to Disk</h2>
<p>Finally, the unseen data with the</p>
<ol type="1">
<li>audience (<code>audience_group</code>)</li>
<li>cohorts (<code>cohort</code>)</li>
</ol>
<p>columns assigned will now be exported to disk for use by the marketing team.</p>
<p>Show the datatypes</p>
<div class="cell" data-tags="[]" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>summarize_df(df_test_audience_groups)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dtype</th>
<th data-quarto-table-cell-role="th">missing</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">fullvisitorid</td>
<td>string[python]</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">label</td>
<td>bool</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">score</td>
<td>Float32</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">predicted_score_label</td>
<td>boolean</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">audience_group</td>
<td>string[python]</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">cohort</td>
<td>string[python]</td>
<td>12000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><strong>Notes</strong> 1. The <code>cohort</code> has missing values for visitors who were not assigned to either the test or control groups. This is expected.</p>
<p>Save to disk</p>
<div class="cell" data-tags="[]" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>audience_cohorts_fpath <span class="op">=</span> os.path.join(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    processed_data_dir, <span class="st">"marketing_audience_cohort_groups__unseen_data.parquet.gzip"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>df_test_audience_groups.to_parquet(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    audience_cohorts_fpath, index<span class="op">=</span><span class="va">False</span>, engine<span class="op">=</span><span class="st">"pyarrow"</span>, compression<span class="op">=</span><span class="st">"gzip"</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="summary-of-tasks-performed" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-tasks-performed">Summary of Tasks Performed</h2>
<p>This step in the project’s overall workflow has performed the following</p>
<ol type="1">
<li>created marketing audience propensity groups</li>
<li>created test (or treatment) and control cohorts</li>
<li>demonstrated similarity between test and control cohorts, in terms of propensity to make a purchase, as required</li>
</ol>
</section>
<section id="summary-of-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-assumptions">Summary of Assumptions</h2>
<ol type="1">
<li><p>As was the case with the preceding (post-processing, or media design) step, the current step can only be be run on March 31, 2017 after</p>
<ul>
<li>all the unseen data has been collected</li>
<li>propensity (probabilities) have been predicted for this data</li>
</ul>
<p>So, we will assume that</p>
<ul>
<li>the current date is April 1, 2017</li>
<li>the unseen data has been
<ul>
<li>collected</li>
<li>processed (drop duplicates, bin categorical features, etc. as was done during ML model development)</li>
</ul></li>
<li>we have used the trained ML model to make predictions of the probability (likelihood or propenisty) of making a purchase on a future visit for all visitors in the unseen data1. As was the case with the preceding (post-processing, or media design) step, the current step can only be be run on March 31, 2017 after</li>
<li>all the unseen data has been collected</li>
<li>propensity (probabilities) have been predicted for this data</li>
</ul>
<p>So, we have assumed that</p>
<ul>
<li>the current date is April 1, 2017</li>
<li>the unseen data has been
<ul>
<li>collected</li>
<li>processed (drop duplicates, bin categorical features, etc. as was done during ML model development)</li>
</ul></li>
<li>we have used the trained ML model to make predictions of the probability (likelihood or propenisty) of making a purchase on a future visit for all visitors in the unseen data</li>
</ul></li>
</ol>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<ol type="1">
<li><p>In practice, we may want to perform a brief profiling of the cohorts (get the main attributes using some of the columns with ML features such as browser, number of pageviews, etc.) within each audience propensity group and append this profile as a new column as this might help the marketing team devise an appropriate strategy/promotion.</p>
<p>Profiling of the test and control cohorts within each of the audience propensity groups could provide helpful context to the marketing team when they are devising a marketing promotion/strategy. This cohort profiling step was not performed here.</p></li>
</ol>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.quarto\.org\/custom");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="../../../notebooks/04-transform/notebooks/04_transform.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Transform Data</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->



<script src="../../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>