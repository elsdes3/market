<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine Learning Project - Post-Processing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../notebooks/02-train/notebooks/07_get_audience_cohorts.html" rel="next">
<link href="../../../notebooks/02-train/notebooks/05_get_best_model.html" rel="prev">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Machine Learning Project</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../notebooks/02-train/notebooks/06_design_experiment.html">Sample Sizes</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../../images/lorip_square.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-train/notebooks/04_train.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Train Model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-train/notebooks/05_get_best_model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Register Model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-train/notebooks/06_design_experiment.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Sample Sizes</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-train/notebooks/07_get_audience_cohorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Get Audience</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/03-explore/notebooks/08_explore_best_model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vital Features</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/04-upload/notebooks/09_upload.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Upload Audience</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/05-dash/notebooks/10_dash.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dashboard</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-train/notebooks/11_analyze_campaign_outputs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Post-Campaign</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-train/notebooks/12_cleanup_mlflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Clean MLFlow</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/06-cleanup/notebooks/13_cleanup_gcloud.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Clean GCloud</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about" id="toc-about" class="nav-link active" data-scroll-target="#about">About</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#candidate-strategies" id="toc-candidate-strategies" class="nav-link" data-scroll-target="#candidate-strategies">Candidate Strategies</a></li>
  <li><a href="#how-quantiles-are-used-in-each-strategy" id="toc-how-quantiles-are-used-in-each-strategy" class="nav-link" data-scroll-target="#how-quantiles-are-used-in-each-strategy">How Quantiles are Used in Each Strategy</a></li>
  <li><a href="#estimating-sample-size" id="toc-estimating-sample-size" class="nav-link" data-scroll-target="#estimating-sample-size">Estimating Sample Size</a></li>
  </ul></li>
  <li><a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation">Implementation</a></li>
  <li><a href="#user-inputs" id="toc-user-inputs" class="nav-link" data-scroll-target="#user-inputs">User Inputs</a></li>
  <li><a href="#get-best-mlflow-model-from-model-registry" id="toc-get-best-mlflow-model-from-model-registry" class="nav-link" data-scroll-target="#get-best-mlflow-model-from-model-registry">Get Best MLFlow Model from Model Registry</a>
  <ul class="collapse">
  <li><a href="#fetch-latest-version-of-best-deployment-candidate-model" id="toc-fetch-latest-version-of-best-deployment-candidate-model" class="nav-link" data-scroll-target="#fetch-latest-version-of-best-deployment-candidate-model">Fetch Latest Version of Best Deployment Candidate Model</a></li>
  <li><a href="#get-data-used-to-develop-best-deployment-candidate-model" id="toc-get-data-used-to-develop-best-deployment-candidate-model" class="nav-link" data-scroll-target="#get-data-used-to-develop-best-deployment-candidate-model">Get Data Used to Develop Best Deployment Candidate Model</a></li>
  <li><a href="#load-best-deployment-candidate-model-from-model-registry" id="toc-load-best-deployment-candidate-model-from-model-registry" class="nav-link" data-scroll-target="#load-best-deployment-candidate-model-from-model-registry">Load Best Deployment Candidate Model from Model Registry</a></li>
  </ul></li>
  <li><a href="#explore-best-model-performance" id="toc-explore-best-model-performance" class="nav-link" data-scroll-target="#explore-best-model-performance">Explore Best Model Performance</a>
  <ul class="collapse">
  <li><a href="#optimal-discrimination-threshold-tuning" id="toc-optimal-discrimination-threshold-tuning" class="nav-link" data-scroll-target="#optimal-discrimination-threshold-tuning">Optimal Discrimination Threshold Tuning</a></li>
  </ul></li>
  <li><a href="#get-size-of-marketing-audience-for-campaign" id="toc-get-size-of-marketing-audience-for-campaign" class="nav-link" data-scroll-target="#get-size-of-marketing-audience-for-campaign">Get Size of Marketing Audience For Campaign</a>
  <ul class="collapse">
  <li><a href="#get-marketing-audience-using-all-propensity-groups-strategy-1" id="toc-get-marketing-audience-using-all-propensity-groups-strategy-1" class="nav-link" data-scroll-target="#get-marketing-audience-using-all-propensity-groups-strategy-1">Get Marketing Audience Using All Propensity Groups (Strategy 1)</a></li>
  <li><a href="#get-marketing-audience-using-top-propensity-group-strategy-2" id="toc-get-marketing-audience-using-top-propensity-group-strategy-2" class="nav-link" data-scroll-target="#get-marketing-audience-using-top-propensity-group-strategy-2">Get Marketing Audience Using Top Propensity Group (Strategy 2)</a></li>
  </ul></li>
  <li><a href="#export-audience-sample-sizes-to-disk" id="toc-export-audience-sample-sizes-to-disk" class="nav-link" data-scroll-target="#export-audience-sample-sizes-to-disk">Export Audience Sample Sizes to Disk</a></li>
  <li><a href="#ml-experiment-tracking" id="toc-ml-experiment-tracking" class="nav-link" data-scroll-target="#ml-experiment-tracking">ML Experiment Tracking</a></li>
  <li><a href="#next-step" id="toc-next-step" class="nav-link" data-scroll-target="#next-step">Next Step</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/elsdes3/market/blob/main/notebooks/02-train/notebooks/06_design_experiment.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/elsdes3/market/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Post-Processing</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="about" class="level2">
<h2 class="anchored" data-anchor-id="about">About</h2>
<section id="overview" class="level3">
<h3 class="anchored" data-anchor-id="overview">Overview</h3>
<p>As discussed for the overall use-case, a marketing strategy is to be developed based on first-time visitors’ propenisty to make a purchase during a future (return) visit to the merchandise store website. The aim of the strategy is to convert these first time visitors into customers (if they did not make a purchase during their first visit), or repeat customers (if they did make a purchase during their first visit). This covers steps 2. and 3. from a <a href="https://www.datacamp.com/blog/data-demystified-what-is-a-b-testing">typical A/B Testing workflow</a>.</p>
<p>This step can be run during ML model development since it requires</p>
<ol type="1">
<li>combined training+validation</li>
<li>test</li>
</ol>
<p>data splits to be created.</p>
</section>
<section id="candidate-strategies" class="level3">
<h3 class="anchored" data-anchor-id="candidate-strategies">Candidate Strategies</h3>
<p>Two marketing strategies to consider for first-time visitors to the store during the inference period are</p>
<ol type="1">
<li>when conducting the marketing campaign, use all first-time visitors, grouped by their predicted propensity to make a purchase during a future visit, where the strategy is modified based on the group</li>
<li>when conducting the marketing campaign, use the group of first-time visitors with the highest predicted propensity to make a purchase during a future visit, where a single strategy can be used for all visitors in the group</li>
</ol>
<p>Each group will be referred to as a marketing audience group. For the multi-group strategy (strategy 1), the groups of visitors are created based on predicted propensities. If three such groups are preferred, then the group with the visitors who are predicted to have the highest propensity to make a purchase on a return visit would be named as the <em>High</em> propensity group. Similarly, the other two groups would be named the <em>Medium</em> and <em>Low</em> propensity groups. The size of each group would be as equal as possible. For 15,000 first-time visitors, each group would consist of 5,000 visitors. Similarly, if 10 such groups are preferred then each group would consist of 1,500 visitors. The groups are created by binning the predicted propensities using their quantiles.</p>
<p>For the single-group strategy (strategy 2), a single group is required. Again, the quantiles are used to create the groups (or bins or segments or buckets) of visitors based on their predicted propensity. However, only the visitors in the top group will be chosen for the marketing campaign. For the case where 10 groups (quantiles) are preferred, then only the top group is chosen.</p>
</section>
<section id="how-quantiles-are-used-in-each-strategy" class="level3">
<h3 class="anchored" data-anchor-id="how-quantiles-are-used-in-each-strategy">How Quantiles are Used in Each Strategy</h3>
<p>Regardless of the number of groups used in this strategy, a rank is assigned to each group where the lowest rank corresponds to the group with the highest predicted propensities to make a purchase on a future (return) visit. For the case where 10 groups (quantiles) are preferred, then the top group would be the one consisting of visitors with a propensity <a href="https://soflotutors.com/blog/what-is-a-99th-percentile-sat-score/">higher than 90% of all</a> first-time visitors to the store during the inference data period. Similarly, the bottom group would be the one consisting of visitors with a propensity higher than 10% of all such visitors. If three groups are preferred, then the top group captures visitors with a predicted propensity higher than 66.667% of all first-time visitors, while the visitors in the bottom group are predicted to have a propensity to make a purchase on a return visit that is higher than 33.333% of all visitors.</p>
</section>
<section id="estimating-sample-size" class="level3">
<h3 class="anchored" data-anchor-id="estimating-sample-size">Estimating Sample Size</h3>
<p>Visitors placed in each group will then be randomly placed into test and control cohorts to run an A/B test for quantifying the impact of the marketing campaign. So, the sample size required for the test and control cohort must also be determined for both these strategies. The KPI to be maximized is the future conversion rate since we want visitors to become customers during a future (return) visit to the store. The required sample sizes will be estimated for a combinations of conversion rate, uplift, power and confidence level (<a href="https://towardsdatascience.com/understanding-power-analysis-in-ab-testing-14808e8a1554">1</a>, <a href="https://www.abtasty.com/sample-size-calculator/">2</a>).</p>
</section>
</section>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">Implementation</h2>
<p>This step will used the best ML model to estimate the size of the group, for both such strategies. The model will be used with the test data split (last month of data that was used during ML model development) to estimate the required size of marketing audience (test and control) cohorts for both strategies. In the next step, the same ML model will be used to predict the propensity for first-time visitors to the store during the inference period, assign these visitors to one or more audience groups based on the type of strategy (single group or multiple groups) and finally select random test and control cohorts from each group. The cohort (sample) sizes estimated in this step will be used to create the test and control cohorts in the next step.</p>
</section>
<section id="user-inputs" class="level2">
<h2 class="anchored" data-anchor-id="user-inputs">User Inputs</h2>
<p>Define the following</p>
<ol type="1">
<li>name of column containing label (outcome)</li>
<li>primary ML scoring metric</li>
<li><code>audience_groups_strategy_n</code>
<ul>
<li>desired audience groups into which the first-time visitors propensities will be placed
<ul>
<li><code>num_propens_groups</code> specifies the number of desired audience propensity groups</li>
<li><code>propens_group_labels</code> specifies names of the desired audience propensity groups (low, medium and high, etc.)</li>
</ul></li>
</ul></li>
<li>grid of inputs for which sample sizes are required (uplift, power, confidence level)</li>
</ol>
<div class="cell" data-tags="[&quot;parameters&quot;]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. label column</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>label <span class="op">=</span> <span class="st">"made_purchase_on_future_visit"</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. scoring metric</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>primary_metric <span class="op">=</span> <span class="st">"fbeta2"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. mapping dictionaries</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>audience_groups_strategy_1 <span class="op">=</span> {</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_propens_groups"</span>: <span class="dv">3</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"propens_group_labels"</span>: [<span class="st">"High"</span>, <span class="st">"Medium"</span>, <span class="st">"Low"</span>],</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>audience_groups_strategy_2 <span class="op">=</span> {</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_propens_groups"</span>: <span class="dv">3</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"propens_group_labels"</span>: [<span class="st">"High"</span>, <span class="st">"High-Medium"</span>, <span class="st">"High-Medium-Low"</span>],</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. grid of inputs for estimating sample sizes</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>uplift_ranges <span class="op">=</span> (<span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">15</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>power_ranges <span class="op">=</span> (<span class="dv">55</span>, <span class="dv">57</span>, <span class="dv">60</span>, <span class="dv">63</span>, <span class="dv">65</span>, <span class="dv">66</span>, <span class="dv">67</span>, <span class="dv">68</span>, <span class="dv">69</span>, <span class="dv">70</span>, <span class="dv">80</span>, <span class="dv">90</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>ci_level_ranges <span class="op">=</span> (<span class="dv">55</span>, <span class="dv">57</span>, <span class="dv">60</span>, <span class="dv">63</span>, <span class="dv">65</span>, <span class="dv">66</span>, <span class="dv">67</span>, <span class="dv">68</span>, <span class="dv">69</span>, <span class="dv">70</span>, <span class="dv">75</span>, <span class="dv">85</span>, <span class="dv">90</span>, <span class="dv">95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a mapping between audience group number (0, 1, 2) and name (high, medium, low), where</p>
<ul>
<li>0 is mapped to high</li>
<li>1 is mapped to medium</li>
<li>2 is mapped to low</li>
</ul>
<p>since it is <a href="https://stackoverflow.com/a/26502255/4057186https://stackoverflow.com/a/26502255/4057186">standard to</a> assign a label the top percentile (highest propensity) with the smallest number (0)</p>
<div class="cell" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mapper_dict_audience_strategy_1 <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">zip</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">range</span>(audience_groups_strategy_1[<span class="st">"num_propens_groups"</span>]),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        audience_groups_strategy_1[<span class="st">"propens_group_labels"</span>],</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>mapper_dict_audience_strategy_2 <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">zip</span>(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">range</span>(audience_groups_strategy_1[<span class="st">"num_propens_groups"</span>]),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        audience_groups_strategy_2[<span class="st">"propens_group_labels"</span>],</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mapper_dict_audience_strategy_1)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mapper_dict_audience_strategy_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{0: 'High', 1: 'Medium', 2: 'Low'}
{0: 'High', 1: 'High-Medium', 2: 'High-Medium-Low'}</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The group integer-to-name mapping dictionary contains keys that start at the lowest group number (0) for the High propensity audience group. For this audience strategy, a single group is used, so 0 is the only key in this dictionary.</li>
</ol>
</div>
</div>
</section>
<section id="get-best-mlflow-model-from-model-registry" class="level2">
<h2 class="anchored" data-anchor-id="get-best-mlflow-model-from-model-registry">Get Best MLFlow Model from Model Registry</h2>
<section id="fetch-latest-version-of-best-deployment-candidate-model" class="level3">
<h3 class="anchored" data-anchor-id="fetch-latest-version-of-best-deployment-candidate-model">Fetch Latest Version of Best Deployment Candidate Model</h3>
<p>Get all MLFlow deployment candidate models from MLFlow model registry</p>
<div class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df_deployment_candidate_mlflow_models <span class="op">=</span> modh.get_all_deployment_candidate_models()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>These are registered models that have been assigned a tag (<code>tags={deployment-candidate: 'yes'}</code>), as opposed to models that are not deployment candidates and do not have any tag (<code>tags={}</code>).</li>
</ol>
</div>
</div>
<p>Get name of best deployment candidate model</p>
<div class="cell" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>best_run_model_name <span class="op">=</span> modh.get_best_deployment_candidate_model(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    df_deployment_candidate_mlflow_models</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-data-used-to-develop-best-deployment-candidate-model" class="level3">
<h3 class="anchored" data-anchor-id="get-data-used-to-develop-best-deployment-candidate-model">Get Data Used to Develop Best Deployment Candidate Model</h3>
<p>Get all available data used during model development of the best deployment candidate model</p>
<div class="cell" data-tags="[]" data-execution_count="13">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_all <span class="op">=</span> modh.get_data_for_run_id(df_deployment_candidate_mlflow_models, <span class="st">'processed_data'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Separate features and label</p>
<div class="cell" data-tags="[]" data-execution_count="14">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> [df_all.drop(columns<span class="op">=</span>[label, <span class="st">'split_type'</span>]), df_all[label]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get test split from the data used during development of the best deployment candidate model</p>
<div class="cell" data-tags="[]" data-execution_count="15">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df_prediction_best_run <span class="op">=</span> (</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    df_all</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"split_type == 'test'"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{label: <span class="st">'label'</span>})</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    .drop(columns<span class="op">=</span>[<span class="st">'split_type'</span>])</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The <code>fullvisitorid</code> column is the ID of each visitor who
<ul>
<li>made a purchase on a return visit to the store</li>
<li>made their first visit to the store during the dates covered by the test data split</li>
</ul></li>
<li>The <code>score</code> column is the predicted probability (using <code>.pred_proba()</code>), which is the propensity of a visitor to make a purchase on a return visit.</li>
<li>The <code>predicted_score_label</code> column is the predicted label using ML. A discrmination threshold of 0.5 is used to convert the predicted score (probability) into a label. The true ML label will not be known until a later date. As of the current date, only the predicted ML label can be known. See the project scope for details.</li>
</ol>
</div>
</div>
</section>
<section id="load-best-deployment-candidate-model-from-model-registry" class="level3">
<h3 class="anchored" data-anchor-id="load-best-deployment-candidate-model-from-model-registry">Load Best Deployment Candidate Model from Model Registry</h3>
<div class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>best_model_uri <span class="op">=</span> <span class="ss">f"models:/</span><span class="sc">{</span>best_run_model_name<span class="sc">}</span><span class="ss">/latest"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> mlflow.sklearn.load_model(model_uri<span class="op">=</span>best_model_uri)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="explore-best-model-performance" class="level2">
<h2 class="anchored" data-anchor-id="explore-best-model-performance">Explore Best Model Performance</h2>
<p>Make predictions on same data that best model was trained on</p>
<div class="cell" data-tags="[]" data-execution_count="18">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>y_pred, y_pred_proba <span class="op">=</span> modh.make_inference(model, X, y.name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get evaluation metrics on same data that best model was trained on</p>
<div class="cell" data-tags="[]" data-execution_count="20">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df_metrics_all <span class="op">=</span> mh.calculate_metrics(y, y_pred, y_pred_proba, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, [<span class="st">"all"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="optimal-discrimination-threshold-tuning" class="level3">
<h3 class="anchored" data-anchor-id="optimal-discrimination-threshold-tuning">Optimal Discrimination Threshold Tuning</h3>
<p>Show a visualization of evaluation metrics relative to the discrimination threshold</p>
<div class="cell" data-tags="[]" data-execution_count="24">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>vh.plot_multi_line_threshold_chart(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    df_thresholds_best_run.set_index(<span class="st">"t"</span>),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    ptitle_str<span class="op">=</span><span class="st">"Threshold Plot"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Threshold (t)"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Score"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    title_fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    axis_label_fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="06_design_experiment_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>To be completed.</li>
</ol>
</div>
</div>
</section>
</section>
<section id="get-size-of-marketing-audience-for-campaign" class="level2">
<h2 class="anchored" data-anchor-id="get-size-of-marketing-audience-for-campaign">Get Size of Marketing Audience For Campaign</h2>
<section id="get-marketing-audience-using-all-propensity-groups-strategy-1" class="level3">
<h3 class="anchored" data-anchor-id="get-marketing-audience-using-all-propensity-groups-strategy-1">Get Marketing Audience Using All Propensity Groups (Strategy 1)</h3>
<p>Perform the following to get the sample size estimates for each audience propensity group, using this approach</p>
<ol type="1">
<li>Sort predictions in ascending order of the predicted probability (propensity) (<code>score</code>)
<ul>
<li>when predictions are then assigned to groups (bins), this order of sorting means the lowest group number will be assigned to samples (predictions) with the lowest probability, so this ordering is <a href="https://stackoverflow.com/questions/26496356/how-to-create-a-decile-and-quintile-columns-to-rank-another-variable-based-on-si/26502255#26502255">non-standard</a></li>
<li>the group integer-to-name mapping dictionary contains keys that start at the lowest group number (0) for the High propensity audience group</li>
</ul></li>
<li>Separate the predictions into group, using the predicted probability, based on the required number of groups</li>
<li>Get conversion rates (KPI) per group</li>
<li>get sample sizes per group, based on
<ul>
<li>KPI per group</li>
<li>desired magnitude of the input (uplift, power, confidence level)</li>
</ul></li>
<li>reverse order of groups and sort by group number</li>
<li>assign meaningful names to groups</li>
<li>set datatypes for columns</li>
<li>(optional) move column with meaningful names to second from front (for display purposes only)</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="25">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df_sample_sizes_strategy_1 <span class="op">=</span> (</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    df_prediction_best_run.copy()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    .pipe(ash.sort_scores, <span class="va">True</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    .pipe(ash.get_audience_groups_by_propensity, audience_groups_strategy_1[<span class="st">"num_propens_groups"</span>])</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    .pipe(ash.get_kpi_per_audience_group)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    .pipe(</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        ash.calculate_multi_group_sample_sizes,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        uplift_ranges,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        power_ranges,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        ci_level_ranges,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    .pipe(ash.invert_group_numbers, audience_groups_strategy_1[<span class="st">"num_propens_groups"</span>])</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    .pipe(ash.map_audience_group_number_to_name, mapper_dict_audience_strategy_1)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    .pipe(</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        ash.set_datatypes,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"group_number"</span>: pd.Int8Dtype(),</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"maudience"</span>: pd.StringDtype(),</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"group_size"</span>: pd.Int16Dtype(),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"group_min_propensity"</span>: pd.Float32Dtype(),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"group_conv_rate"</span>: pd.Float32Dtype(),</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"uplift"</span>: pd.Int8Dtype(),</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"power"</span>: pd.Int8Dtype(),</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ci_level"</span>: pd.Int8Dtype(),</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"required_sample_size"</span>: pd.Int32Dtype(),</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    ).pipe(ash.move_cols_to_front, [<span class="st">"group_number"</span>, <span class="st">"maudience"</span>])</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>df_sample_sizes_strategy_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Set all specified datatypes.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">group_number</th>
<th data-quarto-table-cell-role="th">maudience</th>
<th data-quarto-table-cell-role="th">group_size</th>
<th data-quarto-table-cell-role="th">group_min_propensity</th>
<th data-quarto-table-cell-role="th">group_conv_rate</th>
<th data-quarto-table-cell-role="th">uplift</th>
<th data-quarto-table-cell-role="th">power</th>
<th data-quarto-table-cell-role="th">ci_level</th>
<th data-quarto-table-cell-role="th">required_sample_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>High</td>
<td>6721</td>
<td>0.092311</td>
<td>2.157417</td>
<td>15</td>
<td>90</td>
<td>95</td>
<td>21180</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>High</td>
<td>6721</td>
<td>0.092311</td>
<td>2.157417</td>
<td>10</td>
<td>90</td>
<td>66</td>
<td>22586</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>High</td>
<td>6721</td>
<td>0.092311</td>
<td>2.157417</td>
<td>10</td>
<td>90</td>
<td>67</td>
<td>23003</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>High</td>
<td>6721</td>
<td>0.092311</td>
<td>2.157417</td>
<td>10</td>
<td>90</td>
<td>68</td>
<td>23430</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>High</td>
<td>6721</td>
<td>0.092311</td>
<td>2.157417</td>
<td>10</td>
<td>90</td>
<td>69</td>
<td>23869</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1507</td>
<td>2</td>
<td>Low</td>
<td>6722</td>
<td>0.0</td>
<td>2.261232</td>
<td>15</td>
<td>55</td>
<td>67</td>
<td>2098</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1508</td>
<td>2</td>
<td>Low</td>
<td>6722</td>
<td>0.0</td>
<td>2.261232</td>
<td>15</td>
<td>55</td>
<td>68</td>
<td>2205</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1509</td>
<td>2</td>
<td>Low</td>
<td>6722</td>
<td>0.0</td>
<td>2.261232</td>
<td>15</td>
<td>55</td>
<td>69</td>
<td>2313</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1510</td>
<td>2</td>
<td>Low</td>
<td>6722</td>
<td>0.0</td>
<td>2.261232</td>
<td>12</td>
<td>90</td>
<td>70</td>
<td>16097</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1511</td>
<td>2</td>
<td>Low</td>
<td>6722</td>
<td>0.0</td>
<td>2.261232</td>
<td>10</td>
<td>55</td>
<td>55</td>
<td>2103</td>
</tr>
</tbody>
</table>

<p>1512 rows × 9 columns</p>
</div>
</div>
</div>
</section>
<section id="get-marketing-audience-using-top-propensity-group-strategy-2" class="level3">
<h3 class="anchored" data-anchor-id="get-marketing-audience-using-top-propensity-group-strategy-2">Get Marketing Audience Using Top Propensity Group (Strategy 2)</h3>
<p>Perform the following to get the sample size estimates for the top audience propensity group, using this approach</p>
<ol type="1">
<li>Sort predictions in descending order of the predicted probability (propensity) (<code>score</code>)</li>
<li>get group (bin) size that separates the predictions into groups (bins) of equal size, using the predicted probability, based on the required number of groups</li>
<li>separate the predictions into groups, using the predicted probability, based on the
<ul>
<li>required number of groups</li>
<li>calculated group size from above step</li>
</ul></li>
<li>get conversion rates (KPI) per group</li>
<li>get sample sizes per group, based on
<ul>
<li>KPI per group</li>
<li>desired magnitude of the input (uplift, power, confidence level)</li>
</ul></li>
<li>subtract one from group number</li>
<li>assign meaningful names to groups</li>
<li>set datatypes for columns</li>
<li>(optional) move column with meaningful names to second from front (for display purposes only)</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="26">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df_sample_sizes_strategy_2 <span class="op">=</span> (</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    df_prediction_best_run.copy()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    .pipe(ash.sort_scores, <span class="va">False</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    .pipe(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        ash.calculate_single_group_sample_sizes,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        audience_groups_strategy_2[<span class="st">"num_propens_groups"</span>],</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        ash.get_group_size(df_prediction_best_run, audience_groups_strategy_2[<span class="st">"num_propens_groups"</span>]),</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        uplift_ranges,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        power_ranges,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        ci_level_ranges,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    .pipe(ash.subtract_one_from_group_numbers, <span class="st">"group_number"</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    .pipe(</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>        ash.map_audience_group_number_to_name,</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        mapper_dict_audience_strategy_2,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"group_number"</span>,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    .pipe(</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        ash.set_datatypes,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"group_number"</span>: pd.Int8Dtype(),</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"maudience"</span>: pd.StringDtype(),</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"group_size"</span>: pd.Int16Dtype(),</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"group_size_proportion"</span>: pd.Float32Dtype(),</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"group_min_propensity"</span>: pd.Float32Dtype(),</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"group_conv_rate"</span>: pd.Float32Dtype(),</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"uplift"</span>: pd.Int8Dtype(),</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"power"</span>: pd.Int8Dtype(),</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ci_level"</span>: pd.Int8Dtype(),</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"required_sample_size"</span>: pd.Int32Dtype(),</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    .pipe(ash.move_cols_to_front, [<span class="st">"group_number"</span>, <span class="st">"maudience"</span>])</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>display(df_sample_sizes_strategy_2.dtypes.rename(<span class="st">"dtype"</span>).to_frame().transpose())</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>df_sample_sizes_strategy_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Set all specified datatypes.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">group_number</th>
<th data-quarto-table-cell-role="th">maudience</th>
<th data-quarto-table-cell-role="th">group_size</th>
<th data-quarto-table-cell-role="th">group_size_proportion</th>
<th data-quarto-table-cell-role="th">group_min_propensity</th>
<th data-quarto-table-cell-role="th">group_conv_rate</th>
<th data-quarto-table-cell-role="th">uplift</th>
<th data-quarto-table-cell-role="th">power</th>
<th data-quarto-table-cell-role="th">ci_level</th>
<th data-quarto-table-cell-role="th">required_sample_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">dtype</td>
<td>Int8</td>
<td>string[python]</td>
<td>Int16</td>
<td>Float32</td>
<td>Float32</td>
<td>Float32</td>
<td>Int8</td>
<td>Int8</td>
<td>Int8</td>
<td>Int32</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">group_number</th>
<th data-quarto-table-cell-role="th">maudience</th>
<th data-quarto-table-cell-role="th">group_size</th>
<th data-quarto-table-cell-role="th">group_size_proportion</th>
<th data-quarto-table-cell-role="th">group_min_propensity</th>
<th data-quarto-table-cell-role="th">group_conv_rate</th>
<th data-quarto-table-cell-role="th">uplift</th>
<th data-quarto-table-cell-role="th">power</th>
<th data-quarto-table-cell-role="th">ci_level</th>
<th data-quarto-table-cell-role="th">required_sample_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>High</td>
<td>6721</td>
<td>33.33168</td>
<td>0.092205</td>
<td>2.157417</td>
<td>10</td>
<td>55</td>
<td>55</td>
<td>2206</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>High</td>
<td>6721</td>
<td>33.33168</td>
<td>0.092205</td>
<td>2.157417</td>
<td>10</td>
<td>55</td>
<td>57</td>
<td>2644</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>High</td>
<td>6721</td>
<td>33.33168</td>
<td>0.092205</td>
<td>2.157417</td>
<td>10</td>
<td>55</td>
<td>60</td>
<td>3310</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>High</td>
<td>6721</td>
<td>33.33168</td>
<td>0.092205</td>
<td>2.157417</td>
<td>10</td>
<td>55</td>
<td>63</td>
<td>3995</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>High</td>
<td>6721</td>
<td>33.33168</td>
<td>0.092205</td>
<td>2.157417</td>
<td>10</td>
<td>55</td>
<td>65</td>
<td>4466</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1507</td>
<td>2</td>
<td>High-Medium-Low</td>
<td>20163</td>
<td>99.995041</td>
<td>0.0</td>
<td>2.306204</td>
<td>15</td>
<td>90</td>
<td>70</td>
<td>10097</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1508</td>
<td>2</td>
<td>High-Medium-Low</td>
<td>20163</td>
<td>99.995041</td>
<td>0.0</td>
<td>2.306204</td>
<td>15</td>
<td>90</td>
<td>75</td>
<td>11126</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1509</td>
<td>2</td>
<td>High-Medium-Low</td>
<td>20163</td>
<td>99.995041</td>
<td>0.0</td>
<td>2.306204</td>
<td>15</td>
<td>90</td>
<td>85</td>
<td>13940</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1510</td>
<td>2</td>
<td>High-Medium-Low</td>
<td>20163</td>
<td>99.995041</td>
<td>0.0</td>
<td>2.306204</td>
<td>15</td>
<td>90</td>
<td>90</td>
<td>16124</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1511</td>
<td>2</td>
<td>High-Medium-Low</td>
<td>20163</td>
<td>99.995041</td>
<td>0.0</td>
<td>2.306204</td>
<td>15</td>
<td>90</td>
<td>95</td>
<td>19783</td>
</tr>
</tbody>
</table>

<p>1512 rows × 10 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="export-audience-sample-sizes-to-disk" class="level2">
<h2 class="anchored" data-anchor-id="export-audience-sample-sizes-to-disk">Export Audience Sample Sizes to Disk</h2>
<p>Concatenate the two <code>DataFrame</code>s with the required sample sizes to acheive a KPI using different combinations of inputs (uplift, confidence level and power) and then export to disk</p>
<div class="cell" data-tags="[]" data-execution_count="27">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    df_combined_sample_sizes,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    aud_sizes_fpath,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">=</span> ash.combine_and_export_sample_size_estimates(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    df_sample_sizes_strategy_1,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    df_sample_sizes_strategy_2,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    df_deployment_candidate_mlflow_models,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    processed_data_dir,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ml-experiment-tracking" class="level2">
<h2 class="anchored" data-anchor-id="ml-experiment-tracking">ML Experiment Tracking</h2>
<p>Get best run ID</p>
<div class="cell" data-tags="[]" data-execution_count="29">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>best_run_id <span class="op">=</span> df_deployment_candidate_mlflow_models.squeeze()[<span class="st">"run_id"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Log audience sample sizes file as MLFlow artifact</p>
<div class="cell" data-tags="[]" data-execution_count="30">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_id<span class="op">=</span>best_run_id) <span class="im">as</span> run:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(aud_sizes_fpath)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Logged required audience sizes as artifact in file "</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>os<span class="sc">.</span>path<span class="sc">.</span>basename(aud_sizes_fpath)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="next-step" class="level2">
<h2 class="anchored" data-anchor-id="next-step">Next Step</h2>
<p>Next, test and control cohorts will be created using the inference data at the end of the production period (one month). The size of each cohort will be chosen based on the required sizes that were found in this step.</p>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.quarto\.org\/custom");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="../../../notebooks/02-train/notebooks/05_get_best_model.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Register Model</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../notebooks/02-train/notebooks/07_get_audience_cohorts.html" class="pagination-link">
        <span class="nav-page-text">Get Audience</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<script src="../../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>