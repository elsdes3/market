<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine Learning Project - Data Transformation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../notebooks/05-development/notebooks/05_development.html" rel="next">
<link href="../../../notebooks/03-eda/notebooks/03_eda.html" rel="prev">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Machine Learning Project</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../notebooks/04-transform/notebooks/04_transform.html">Transform Data</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../../images/lorip_square.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../references/Scope.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scope</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/01-get-data/notebooks/01_get_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Get Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-prepare/notebooks/02_prepare.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prepare Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/03-eda/notebooks/03_eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Explore Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/04-transform/notebooks/04_transform.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Transform Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/05-development/notebooks/05_development.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Baseline</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/07-create-audience/notebooks/07_create_audience.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create Audience</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about" id="toc-about" class="nav-link active" data-scroll-target="#about">About</a>
  <ul class="collapse">
  <li><a href="#objective" id="toc-objective" class="nav-link" data-scroll-target="#objective">Objective</a></li>
  <li><a href="#overview-of-data-transformation" id="toc-overview-of-data-transformation" class="nav-link" data-scroll-target="#overview-of-data-transformation">Overview of Data Transformation</a></li>
  <li><a href="#feature-selection" id="toc-feature-selection" class="nav-link" data-scroll-target="#feature-selection">Feature Selection</a></li>
  <li><a href="#feature-processing" id="toc-feature-processing" class="nav-link" data-scroll-target="#feature-processing">Feature Processing</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#timeframe-for-study" id="toc-timeframe-for-study" class="nav-link" data-scroll-target="#timeframe-for-study">Timeframe for Study</a></li>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions">Assumptions</a></li>
  <li><a href="#output" id="toc-output" class="nav-link" data-scroll-target="#output">Output</a></li>
  </ul></li>
  <li><a href="#user-inputs" id="toc-user-inputs" class="nav-link" data-scroll-target="#user-inputs">User Inputs</a></li>
  <li><a href="#get-data" id="toc-get-data" class="nav-link" data-scroll-target="#get-data">Get Data</a>
  <ul class="collapse">
  <li><a href="#create-training-data" id="toc-create-training-data" class="nav-link" data-scroll-target="#create-training-data">Create Training Data</a></li>
  <li><a href="#create-validation-data" id="toc-create-validation-data" class="nav-link" data-scroll-target="#create-validation-data">Create Validation Data</a></li>
  <li><a href="#create-test-data" id="toc-create-test-data" class="nav-link" data-scroll-target="#create-test-data">Create Test Data</a></li>
  </ul></li>
  <li><a href="#discussion-of-duplicates-during-data-preparation" id="toc-discussion-of-duplicates-during-data-preparation" class="nav-link" data-scroll-target="#discussion-of-duplicates-during-data-preparation">Discussion of Duplicates During Data Preparation</a></li>
  <li><a href="#export-to-disk" id="toc-export-to-disk" class="nav-link" data-scroll-target="#export-to-disk">Export to Disk</a></li>
  <li><a href="#etl-workflow-to-transform-data" id="toc-etl-workflow-to-transform-data" class="nav-link" data-scroll-target="#etl-workflow-to-transform-data">ETL Workflow to Transform Data</a></li>
  <li><a href="#summary-of-tasks-performed" id="toc-summary-of-tasks-performed" class="nav-link" data-scroll-target="#summary-of-tasks-performed">Summary of Tasks Performed</a></li>
  <li><a href="#summary-of-assumptions" id="toc-summary-of-assumptions" class="nav-link" data-scroll-target="#summary-of-assumptions">Summary of Assumptions</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  <li><a href="#next-step" id="toc-next-step" class="nav-link" data-scroll-target="#next-step">Next Step</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/elsdes3/market/blob/main/notebooks/04-transform/notebooks/04_transform.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/elsdes3/market/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Data Transformation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Import Python modules</p>
<div class="cell" data-tags="[]" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Union</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytz</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> feature_engine.encoding <span class="im">import</span> RareLabelEncoder</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.oauth2 <span class="im">import</span> service_account</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> FunctionTransformer</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="about" class="level2">
<h2 class="anchored" data-anchor-id="about">About</h2>
<section id="objective" class="level3">
<h3 class="anchored" data-anchor-id="objective">Objective</h3>
<p>This step of the analysis prepares data for ML model training. Training, validation and test data splits are created in order to support training a ML model to predict the propensity of new visitors to the Google Merchandise store on the Google Marketplace to make a purchase on a future visit.</p>
</section>
<section id="overview-of-data-transformation" class="level3">
<h3 class="anchored" data-anchor-id="overview-of-data-transformation">Overview of Data Transformation</h3>
<p>The raw data in the dataset is provided per visit. The ML model needs to be trained to make predictions at the visit level for each visitor who made a purchase on a return visit to the store. However, useful features might exist based on</p>
<ol type="1">
<li>actions performed by a visitor within each visit
<ul>
<li>number of items that were added to a shopping cart during the first visit</li>
<li>whether a purchase was completed on the first visit</li>
<li>etc.</li>
</ul></li>
<li>device used by the visitor during the visit</li>
</ol>
<p>All actions performed per visit are found in a nested column <code>hits</code> for each visit so the raw data for this column must be exploded from one row per visit to one row per action in order to extract these action-based features. Exploding a nested row is similar to the <code>.explode()</code> <code>DataFrame</code> in <code>pandas</code> (<a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.explode.html#pandas.DataFrame.explode">link</a>). Then, the data is aggregated again by visit.</p>
<p>Exploding the <code>hits</code> column results in multiple rows where the sequence of actions is important. Features can be created based on this sequence. As an example, if a visit ended in an item(s) being added to the shopping cart, then the last action performed in the visit is a add-to-cart (encoded as an integer <code>3</code>). So, a feature will be created to indicate that last action of each visit and this requires exploding the <code>hits</code> column, which is a nested column. Similarly, to get the browser used during a visit, a nested value <code>device.browser</code> needs to be extracted from the <code>device</code> column. Exploding the <code>device</code> column is not necessary for this purpose, since the there is only one browser used per visit (per the definition of a visit) so, when exploded, all rows for the visit contain the same browser. <code>hits</code> is a nested column in the data since it contains a list of dictionaries, while <code>device</code> is a dictionary. We can just directly access <code>device.browser</code> from the nested <code>device</code> column, which is <a href="https://cloud.google.com/bigquery/docs/nested-repeated#define_nested_and_repeated_columns">supported by <code>BigQuery</code></a>. For this reason, only the <code>hits</code> column in the raw data needs to be exploded.</p>
<p>Nested columns are exploded are</p>
<ol type="1">
<li><code>hits</code></li>
</ol>
<p>Nested columns that are used without exploding are</p>
<ol type="1">
<li><code>totals</code></li>
<li><code>trafficSource</code></li>
<li><code>device</code></li>
</ol>
</section>
<section id="feature-selection" class="level3">
<h3 class="anchored" data-anchor-id="feature-selection">Feature Selection</h3>
<p>Features are selected based on</p>
<ol type="1">
<li>EDA performed in previous step</li>
<li>intuition about features that might be predictive of a new visitor making a purchase on a future visit to the Merchandise store</li>
</ol>
<p>The following are the types of features that are selected 1. User-Facing Features - name of browser - type of operating system (one of Windows, Mac, Linux) - <a href="https://www.jellyfish.com/en-us/training/blog/google-analytics-channels-explained">referring channel</a> - type of device 2. General Features - hits - bounces - page views - time spent on the Marketplace website</p>
<p>As a reminder, in order to get these columns, we have developed the following approach in previous steps and the same will be used here</p>
<ol type="1">
<li>get visitors who made a purchase on their return visit (this comes from the query immediately above)</li>
<li>Get all features for the first visit (<code>totals.newVisits = 1</code>) for all visitors</li>
<li><code>INNER JOIN</code> features with the visitors who made a purchase on their return visit
<ul>
<li>this provides the features for only the visitors who made a purchase on their return visit, since we are not interested in using data for visitors who did not make a purchase on their return visit</li>
</ul></li>
<li><code>GROUP BY</code> visit and get the last action that was performed in that visit
<ul>
<li><p>ML modeling will be performed against data at the visit level since we need to predict propensity to make a purchase during a future visit</p></li>
<li><p>the <code>UNNEST</code> function has exploded nested actions per visit on separate rows, so the exploded data in the <code>first_visit_attributes</code> CTE is per action</p></li>
<li><p>since the ML model will be trained on visits, a <code>GROUP BY</code> is required to convert actions into visits</p></li>
<li><p>since we are only retrieving the first visit for reach visitor (from 2. above), getting the last action that was performed in that visit indicates how far the visitor advanced in the purchase process during their first visit to the marketplace</p>
<ul>
<li>intuitively, this seems like it could be an indicator of whether the visitor will make a purchase on a return visit to the Google Merchandise store</li>
</ul></li>
<li><p>a unique visit is defined by the combination of the following columns</p>
<ul>
<li><code>fullvisitorid</code></li>
<li><code>visitId</code></li>
<li><code>visitNumber</code></li>
<li><code>visitStartTime</code></li>
</ul>
<p>and so a <code>GROUP BY</code> must be performed over these columns. The following columns are included as part of the definition of a visit</p>
<ul>
<li>columns of aggregated stats per visit
<ul>
<li><code>hits</code></li>
<li><code>bounces</code></li>
<li><code>pageviews</code></li>
<li><code>time_on_site</code></li>
</ul></li>
<li>columns showing features of the traffic source that initiated a visitor’s visit
<ul>
<li><code>source</code></li>
<li><code>medium</code></li>
<li><code>channelGrouping</code></li>
</ul></li>
<li>columns with features of the visitor’s device used during a visit
<ul>
<li><code>browser</code></li>
<li><code>os</code> (operating system)</li>
<li><code>deviceCategory</code> (Windows, Mac or Linux)</li>
</ul></li>
<li>(as mentioned above) the label column is reported per visit
<ul>
<li><code>made_purchase_on_future_visit</code></li>
</ul></li>
</ul>
<p>These are columns that only change at the visit level, so we have grouped over these columns. See the two previous steps (data preparation and EDA) for more details about the structure of this SQL query to retrieve these features from the raw data.</p></li>
</ul></li>
</ol>
</section>
<section id="feature-processing" class="level3">
<h3 class="anchored" data-anchor-id="feature-processing">Feature Processing</h3>
<p>Without any reduction in cardinality, the <code>source</code> and <code>os</code> (operating system) columns present the biggest problem due to their large number of unique sub-categories. If one-hot encoding is used to transform the categorical features in the training data, then tree-based models will perform poorly since the one-hot encoded data will be sparse. Bucketing to reduce the cardinality will help the performance of tree-based models. <code>XGBoost</code> has specific guidance to handle categorical data (<a href="https://xgboost.readthedocs.io/en/stable/tutorials/categorical.html#categorical-data">1</a>, <a href="https://machinelearningmastery.com/data-preparation-gradient-boosting-xgboost-python/">2</a>).</p>
<p>In order to avoid categorical features with a high cardinality, we have only kept the most common categories for each categorical feature. A generic category of <code>Other</code> was assigned to all other (less commonly occurring) categories. A bucketing strategy, where all categories accounting for less than 5% or 10% of all observations per categorical have been grouped into the same bucket strongly reduced the cardinality in the training data and will again be used in this step. In the data preparation step, this approach was called frequency encoding and its main disadvantage is that the predictive power of such a feature might be reduced by such a bucketing approach.</p>
</section>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>The raw data from the <code>BigQuery</code> table, that was used in the preceding (EDA) step, is again used here.</p>
</section>
<section id="timeframe-for-study" class="level3">
<h3 class="anchored" data-anchor-id="timeframe-for-study">Timeframe for Study</h3>
<p>For the entire project, we have assumed that the current date is March 1, 2017. The data splits to be created are</p>
<ol type="1">
<li>training
<ul>
<li>September 1, 2016 to December 31, 2016</li>
</ul></li>
<li>validation
<ul>
<li>January 1, 2017 to January 31, 2017</li>
</ul></li>
<li>test
<ul>
<li>February 1, 2017 to February 28, 2017</li>
</ul></li>
</ol>
<p>As we mentioned in the data preparation step, during ML model development, we are only choosing first-time visitors who made a purchase on a return visit to the store between September 1, 2016 and February 31, 2017. This means each selected visitor initially visited the store starting on September 1, 2016. During this first visit, they may or may not have made a purchase. The same visitor also made a return visit to the store during which they made a purchase. This return visit is allowed to occur no later than February 28, 2017.</p>
<p>With this in mind, in the</p>
<ol type="1">
<li>training data
<ul>
<li>each visitor made their first visit as early as September 1, 2016
<ul>
<li>this first visit gives us the ML features (<code>X</code>)</li>
</ul></li>
<li>each such visitor could have made a return visit, in which they made a purchase, as late as February 28, 2017
<ul>
<li>the outcome of this future visit (purchase or no purchase) gives us the ML label (<code>y</code>)</li>
<li>since today is March 1, 2017, we know the label (<code>y</code>) for all these visitors
<ul>
<li>for this reason, when we prepare our data for ML development, our data preparation does not suffer from data leakage/lookahead bias (this was also discussed in the preceding two steps - data preparation and EDA)</li>
</ul></li>
<li>note that each such visitor only needs to make a purchase on one or more future visits before February 28, 2017</li>
</ul></li>
</ul></li>
<li>validation data
<ul>
<li>each visitor made their first visit as early as January 1, 2017</li>
<li>each such visitor could have made a return visit, in which they made a purchase, as late as February 28, 2017</li>
</ul></li>
<li>test data
<ul>
<li>each visitor made their first visit as early as February 1, 2017</li>
<li>each such visitor could have made a return visit, in which they made a purchase, as late as February 28, 2017</li>
</ul></li>
</ol>
</section>
<section id="assumptions" class="level3">
<h3 class="anchored" data-anchor-id="assumptions">Assumptions</h3>
<p>None.</p>
</section>
<section id="output" class="level3">
<h3 class="anchored" data-anchor-id="output">Output</h3>
<p>A file containing the features and labels will be exported for the</p>
<ol type="1">
<li>training</li>
<li>validation</li>
<li>test</li>
</ol>
<p>data splits.</p>
</section>
</section>
<section id="user-inputs" class="level2">
<h2 class="anchored" data-anchor-id="user-inputs">User Inputs</h2>
<p>Get relative path to project root directory</p>
<div class="cell" data-tags="[]" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>PROJ_ROOT_DIR <span class="op">=</span> os.path.join(os.pardir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the following</p>
<ol type="1">
<li>train data start date</li>
<li>train data end date</li>
<li>validation data start date</li>
<li>validation data end date</li>
<li>test data start date</li>
<li>test data end date</li>
<li>list of categorical features to be used</li>
<li>dictionary of columns to be frequency-encoded and minimum frequency thresholds to be used
<ul>
<li>thresholds are 5% or 10%, based on our findings from the data preparation step</li>
</ul></li>
</ol>
<div class="cell" data-tags="[&quot;parameters&quot;]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># start and end dates</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>train_start_date <span class="op">=</span> <span class="st">"20160901"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>train_end_date <span class="op">=</span> <span class="st">"20161231"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>val_start_date <span class="op">=</span> <span class="st">"20170101"</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>val_end_date <span class="op">=</span> <span class="st">"20170131"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>test_start_date <span class="op">=</span> <span class="st">"20170201"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>test_end_date <span class="op">=</span> <span class="st">"20170228"</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># categorical column names</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>categorical_columns <span class="op">=</span> [</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bounces"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_action"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"medium"</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"channelGrouping"</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"browser"</span>,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os"</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deviceCategory"</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># categorical columns to be grouped</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>cols_to_group <span class="op">=</span> {</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5_pct"</span>: [<span class="st">"source"</span>, <span class="st">"browser"</span>],</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"10_pct"</span>: [<span class="st">"os"</span>, <span class="st">"channelGrouping"</span>, <span class="st">"medium"</span>],</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get path to <code>data/processed</code> in which the transformed data splits (training, validation and test) produced by this step will be exported</p>
<div class="cell" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>processed_data_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"data"</span>, <span class="st">"processed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Retrieve credentials for <code>bigquery</code> client</p>
<div class="cell" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Google Cloud PROJECT ID</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>gcp_project_id <span class="op">=</span> os.environ[<span class="st">"GCP_PROJECT_ID"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get filepath to Google Cloud Service Account JSON key</p>
<div class="cell" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>raw_data_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"data"</span>, <span class="st">"raw"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>gcp_creds_fpath <span class="op">=</span> glob(os.path.join(raw_data_dir, <span class="st">"*.json"</span>))[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Authenticate <code>bigquery</code> client and get dictionary with credentials</p>
<div class="cell" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>gcp_credentials <span class="op">=</span> service_account.Credentials.from_service_account_file(gcp_creds_fpath)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>gcp_auth_dict <span class="op">=</span> <span class="bu">dict</span>(gcp_project_id<span class="op">=</span>gcp_project_id, gcp_creds<span class="op">=</span>gcp_credentials)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a mapping between action type integer and label, in order to get meaningful names from the <code>action_type</code> column</p>
<div class="cell" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>mapper <span class="op">=</span> {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"Click through of product lists"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"Product detail views"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">"Add product(s) to cart"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span>: <span class="st">"Remove product(s) from cart"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>: <span class="st">"Check out"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">6</span>: <span class="st">"Completed purchase"</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="dv">7</span>: <span class="st">"Refund of purchase"</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">8</span>: <span class="st">"Checkout options"</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>: <span class="st">"Unknown"</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define a dictionary to change datatypes of prepared data (this was originally developed in the data preparation step)</p>
<div class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dtypes_dict <span class="op">=</span> {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fullvisitorid"</span>: pd.StringDtype(),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitId"</span>: pd.StringDtype(),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitNumber"</span>: pd.Int8Dtype(),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"country"</span>: pd.StringDtype(),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quarter"</span>: pd.Int8Dtype(),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month"</span>: pd.Int8Dtype(),</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_month"</span>: pd.Int8Dtype(),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_week"</span>: pd.Int8Dtype(),</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour"</span>: pd.Int8Dtype(),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minute"</span>: pd.Int8Dtype(),</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"second"</span>: pd.Int8Dtype(),</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"medium"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"channelGrouping"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hits"</span>: pd.Int16Dtype(),</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bounces"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_action"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_displayed"</span>: pd.Int16Dtype(),</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_clicked"</span>: pd.Int16Dtype(),</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_views"</span>: pd.Int16Dtype(),</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_clicks"</span>: pd.Int16Dtype(),</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pageviews"</span>: pd.Int16Dtype(),</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"time_on_site"</span>: pd.Int16Dtype(),</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"browser"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"added_to_cart"</span>: pd.Int16Dtype(),</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deviceCategory"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"made_purchase_on_future_visit"</span>: pd.BooleanDtype(),</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define a Python helper function to perform the following</p>
<ol type="1">
<li>execute a SQL query using Google BigQuery</li>
<li>set column datatypes of a <code>pandas.DataFrame</code></li>
<li>drop duplicates based on a list of columns in a <code>pandas.DataFrame</code></li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="11">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_sql_query(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    query: <span class="bu">str</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    gcp_project_id: <span class="bu">str</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    gcp_creds: os.PathLike,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    show_dtypes: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    show_info: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    show_df: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Run query on BigQuery and return results as pandas.DataFrame."""</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> datetime.now(pytz.timezone(<span class="st">"US/Eastern"</span>))</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    start_time_str <span class="op">=</span> start_time.strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S.</span><span class="sc">%f</span><span class="st">"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Query execution start time = </span><span class="sc">{</span>start_time_str[:<span class="op">-</span><span class="dv">3</span>]<span class="sc">}</span><span class="ss">..."</span>, end<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_gbq(</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        query,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        project_id<span class="op">=</span>gcp_project_id,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        credentials<span class="op">=</span>gcp_creds,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        dialect<span class="op">=</span><span class="st">"standard"</span>,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># configuration is optional, since default for query caching is True</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        configuration<span class="op">=</span>{<span class="st">"query"</span>: {<span class="st">"useQueryCache"</span>: <span class="va">True</span>}},</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># use_bqstorage_api=True,</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    end_time <span class="op">=</span> datetime.now(pytz.timezone(<span class="st">"US/Eastern"</span>))</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    end_time_str <span class="op">=</span> end_time.strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S.</span><span class="sc">%f</span><span class="st">"</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    duration <span class="op">=</span> end_time <span class="op">-</span> start_time</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    duration <span class="op">=</span> duration.seconds <span class="op">+</span> (duration.microseconds <span class="op">/</span> <span class="dv">1_000_000</span>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"done at </span><span class="sc">{</span>end_time_str[:<span class="op">-</span><span class="dv">3</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>duration<span class="sc">:.3f}</span><span class="ss"> seconds)."</span>)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Query returned </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> rows"</span>)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_df:</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>            display(df)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_dtypes:</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        display(df.dtypes.rename(<span class="st">"dtype"</span>).to_frame().transpose())</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_info:</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        df.info()</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_datatypes(df: pd.DataFrame, dtypes: Dict) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Set DataFrame datatypes using dictionary."""</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.astype(dtypes)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> drop_duplicates(df: pd.DataFrame, subset: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Drop duplicates."""</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>subset, keep<span class="op">=</span><span class="st">"first"</span>)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-data" class="level2">
<h2 class="anchored" data-anchor-id="get-data">Get Data</h2>
<p>Define the same custom data transformation pipeline to handle the categorical columns that was developed in the data preparation step and used in the EDA step</p>
<div class="cell" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>encoder_05 <span class="op">=</span> RareLabelEncoder(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    tol<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    n_categories<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    variables<span class="op">=</span>[v <span class="cf">for</span> k, v <span class="kw">in</span> cols_to_group.items() <span class="cf">if</span> <span class="st">"5"</span> <span class="kw">in</span> k][<span class="dv">0</span>],</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    replace_with<span class="op">=</span><span class="st">"other"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>encoder_10 <span class="op">=</span> RareLabelEncoder(</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    tol<span class="op">=</span><span class="fl">0.10</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    n_categories<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    variables<span class="op">=</span>[v <span class="cf">for</span> k, v <span class="kw">in</span> cols_to_group.items() <span class="cf">if</span> <span class="st">"10"</span> <span class="kw">in</span> k][<span class="dv">0</span>],</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    replace_with<span class="op">=</span><span class="st">"other"</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>categorical_transformer <span class="op">=</span> Pipeline(</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[(<span class="st">"enc_05"</span>, encoder_05), (<span class="st">"enc_10"</span>, encoder_10)]</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[(<span class="st">"cat"</span>, categorical_transformer, categorical_columns)],</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    remainder<span class="op">=</span><span class="st">"passthrough"</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>pipe_trans <span class="op">=</span> Pipeline(steps<span class="op">=</span>[(<span class="st">"preprocessor"</span>, preprocessor)])</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>pipe_trans</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<style>#sk-container-id-1 {color: black;background-color: white;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[('preprocessor',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('cat',
                                                  Pipeline(steps=[('enc_05',
                                                                   RareLabelEncoder(n_categories=2,
                                                                                    replace_with='other',
                                                                                    variables=['source',
                                                                                               'browser'])),
                                                                  ('enc_10',
                                                                   RareLabelEncoder(n_categories=2,
                                                                                    replace_with='other',
                                                                                    tol=0.1,
                                                                                    variables=['os',
                                                                                               'channelGrouping',
                                                                                               'medium']))]),
                                                  ['bounces', 'last_action',
                                                   'source', 'medium',
                                                   'channelGrouping', 'browser',
                                                   'os',
                                                   'deviceCategory'])]))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox"><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[('preprocessor',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('cat',
                                                  Pipeline(steps=[('enc_05',
                                                                   RareLabelEncoder(n_categories=2,
                                                                                    replace_with='other',
                                                                                    variables=['source',
                                                                                               'browser'])),
                                                                  ('enc_10',
                                                                   RareLabelEncoder(n_categories=2,
                                                                                    replace_with='other',
                                                                                    tol=0.1,
                                                                                    variables=['os',
                                                                                               'channelGrouping',
                                                                                               'medium']))]),
                                                  ['bounces', 'last_action',
                                                   'source', 'medium',
                                                   'channelGrouping', 'browser',
                                                   'os',
                                                   'deviceCategory'])]))])</pre></div></div></div><div class="sk-serial"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox"><label for="sk-estimator-id-2" class="sk-toggleable__label sk-toggleable__label-arrow">preprocessor: ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(remainder='passthrough',
                  transformers=[('cat',
                                 Pipeline(steps=[('enc_05',
                                                  RareLabelEncoder(n_categories=2,
                                                                   replace_with='other',
                                                                   variables=['source',
                                                                              'browser'])),
                                                 ('enc_10',
                                                  RareLabelEncoder(n_categories=2,
                                                                   replace_with='other',
                                                                   tol=0.1,
                                                                   variables=['os',
                                                                              'channelGrouping',
                                                                              'medium']))]),
                                 ['bounces', 'last_action', 'source', 'medium',
                                  'channelGrouping', 'browser', 'os',
                                  'deviceCategory'])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox"><label for="sk-estimator-id-3" class="sk-toggleable__label sk-toggleable__label-arrow">cat</label><div class="sk-toggleable__content"><pre>['bounces', 'last_action', 'source', 'medium', 'channelGrouping', 'browser', 'os', 'deviceCategory']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-4" type="checkbox"><label for="sk-estimator-id-4" class="sk-toggleable__label sk-toggleable__label-arrow">RareLabelEncoder</label><div class="sk-toggleable__content"><pre>RareLabelEncoder(n_categories=2, replace_with='other',
                 variables=['source', 'browser'])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-5" type="checkbox"><label for="sk-estimator-id-5" class="sk-toggleable__label sk-toggleable__label-arrow">RareLabelEncoder</label><div class="sk-toggleable__content"><pre>RareLabelEncoder(n_categories=2, replace_with='other', tol=0.1,
                 variables=['os', 'channelGrouping', 'medium'])</pre></div></div></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-6" type="checkbox"><label for="sk-estimator-id-6" class="sk-toggleable__label sk-toggleable__label-arrow">remainder</label><div class="sk-toggleable__content"><pre></pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-7" type="checkbox"><label for="sk-estimator-id-7" class="sk-toggleable__label sk-toggleable__label-arrow">passthrough</label><div class="sk-toggleable__content"><pre>passthrough</pre></div></div></div></div></div></div></div></div></div></div></div></div>
</div>
</div>
<p>A helper function will be created to programmatically load data from BigQuery based on the desired start and end dates. The function accepts the following</p>
<ol type="1">
<li>start and end dates for which data is to be retrieved
<ul>
<li>these dates will be different for the training, validation and test splits</li>
</ul></li>
<li>start date for the training data and end date for the test data
<ul>
<li>these two dates define the period over which ML model development will occur</li>
<li>these are used to retrieve visitors who made a purchase on a return (future) visit to the store during this period</li>
</ul></li>
</ol>
<p>The function is defined below</p>
<div class="cell" data-tags="[]" data-execution_count="13">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_sql_query(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    split_start_date: <span class="bu">str</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    split_end_date: <span class="bu">str</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    train_split_start_date: <span class="bu">str</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    test_split_end_date: <span class="bu">str</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Assemble query to retrieve attributes about first visits."""</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    query_str <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="ss">            WITH</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="ss">            -- Step 1. get visitors with a purchase on a future visit</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="ss">            next_visit_purchasers AS (</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="ss">                 SELECT fullvisitorid,</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="ss">                        IF(COUNTIF(totals.transactions &gt; 0 AND totals.newVisits IS NULL) &gt; 0, True, False) AS made_purchase_on_future_visit</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="ss">                 FROM `data-to-insights.ecommerce.web_analytics`</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="ss">                 WHERE date BETWEEN '</span><span class="sc">{</span>train_split_start_date<span class="sc">}</span><span class="ss">' AND '</span><span class="sc">{</span>test_split_end_date<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="ss">                 AND geoNetwork.country = 'United States'</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="ss">                 GROUP BY fullvisitorid</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="ss">            ),</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="ss">            -- Steps 2. and 3. get attributes of the first visit</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="ss">            first_visit_attributes AS (</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="ss">                SELECT -- =========== GEOSPATIAL AND TEMPORAL ATTRIBUTES OF VISIT ===========</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="ss">                       geoNetwork.country,</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="ss">                       EXTRACT(QUARTER FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS quarter,</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="ss">                       EXTRACT(MONTH FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS month,</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="ss">                       EXTRACT(DAY FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS day_of_month,</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="ss">                       EXTRACT(DAYOFWEEK FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS day_of_week,</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="ss">                       EXTRACT(HOUR FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS hour,</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="ss">                       EXTRACT(MINUTE FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS minute,</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="ss">                       EXTRACT(SECOND FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS second,</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- =========== VISIT AND VISITOR METADATA ===========</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="ss">                       fullvisitorid,</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="ss">                       visitId,</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="ss">                       visitNumber,</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="ss">                       DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific') AS visitStartTime,</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- =========== SOURCE OF SITE TRAFFIC ===========</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- source of the traffic from which the visit was initiated</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="ss">                       trafficSource.source,</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- medium of the traffic from which the visit was initiated</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="ss">                       trafficSource.medium,</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- referring channel connected to visit</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="ss">                       channelGrouping,</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- =========== VISITOR ACTIVITY ===========</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- total number of hits</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="ss">                       (CASE WHEN totals.hits &gt; 0 THEN totals.hits ELSE 0 END) AS hits,</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- number of bounces</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="ss">                       (CASE WHEN totals.bounces &gt; 0 THEN totals.bounces ELSE 0 END) AS bounces,</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- action performed during first visit</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a><span class="ss">                       CAST(h.eCommerceAction.action_type AS INT64) AS action_type,</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- page views</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="ss">                       IFNULL(totals.pageviews, 0) AS pageviews,</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- time on the website</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a><span class="ss">                       IFNULL(totals.timeOnSite, 0) AS time_on_site,</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- whether add-to-cart was performed during visit</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a><span class="ss">                       (CASE WHEN CAST(h.eCommerceAction.action_type AS INT64) = 3 THEN 1 ELSE 0 END) AS added_to_cart,</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- =========== VISITOR DEVICES ===========</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- user's browser</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a><span class="ss">                       device.browser,</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- user's operating system</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a><span class="ss">                       device.operatingSystem AS os,</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- user's type of device</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a><span class="ss">                       device.deviceCategory,</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- =========== PROMOTION ===========</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a><span class="ss">                       h.promotion,</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a><span class="ss">                       h.promotionActionInfo AS pa_info,</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- =========== PRODUCT ===========</span></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="ss">                       h.product,</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- =========== ML LABEL (DEPENDENT VARIABLE) ===========</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a><span class="ss">                       made_purchase_on_future_visit</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a><span class="ss">                FROM `data-to-insights.ecommerce.web_analytics`,</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a><span class="ss">                UNNEST(hits) AS h</span></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a><span class="ss">                INNER JOIN next_visit_purchasers USING (fullvisitorid)</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a><span class="ss">                WHERE date BETWEEN '</span><span class="sc">{</span>split_start_date<span class="sc">}</span><span class="ss">' AND '</span><span class="sc">{</span>split_end_date<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a><span class="ss">                AND geoNetwork.country = 'United States'</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a><span class="ss">                AND totals.newVisits = 1</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a><span class="ss">            ),</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a><span class="ss">            -- Step 4. get aggregated features (attributes) per visit</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a><span class="ss">            visit_attributes AS (</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a><span class="ss">                SELECT fullvisitorid,</span></span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a><span class="ss">                       visitId,</span></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a><span class="ss">                       visitNumber,</span></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a><span class="ss">                       visitStartTime,</span></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a><span class="ss">                       country,</span></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a><span class="ss">                       quarter,</span></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a><span class="ss">                       month,</span></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a><span class="ss">                       day_of_month,</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a><span class="ss">                       day_of_week,</span></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a><span class="ss">                       hour,</span></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a><span class="ss">                       minute,</span></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a><span class="ss">                       second,</span></span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a><span class="ss">                       source,</span></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a><span class="ss">                       medium,</span></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a><span class="ss">                       channelGrouping,</span></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a><span class="ss">                       hits,</span></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a><span class="ss">                       bounces,</span></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- get the last action performed during the first visit</span></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- (this indicates where the visitor left off at the end of their visit)</span></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a><span class="ss">                       MAX(action_type) AS last_action,</span></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- get number of promotions displayed and clicked during the first visit</span></span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a><span class="ss">                       COUNT(CASE WHEN pa_info IS NOT NULL THEN pa_info.promoIsView ELSE NULL END) AS promos_displayed,</span></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a><span class="ss">                       COUNT(CASE WHEN pa_info IS NOT NULL THEN pa_info.promoIsClick ELSE NULL END) AS promos_clicked,</span></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a><span class="ss">                       -- get number of products displayed and clicked during the first visit</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a><span class="ss">                       COUNT(CASE WHEN pu.isImpression IS NULL THEN NULL ELSE 1 END) AS product_views,</span></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a><span class="ss">                       COUNT(CASE WHEN pu.isClick IS NULL THEN NULL ELSE 1 END) AS product_clicks,</span></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a><span class="ss">                       pageviews,</span></span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a><span class="ss">                       time_on_site,</span></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a><span class="ss">                       browser,</span></span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a><span class="ss">                       os,</span></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a><span class="ss">                       deviceCategory,</span></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a><span class="ss">                       SUM(added_to_cart) AS added_to_cart,</span></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a><span class="ss">                       made_purchase_on_future_visit,</span></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a><span class="ss">                FROM first_visit_attributes</span></span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a><span class="ss">                LEFT JOIN UNNEST(promotion) as p</span></span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a><span class="ss">                LEFT JOIN UNNEST(product) as pu</span></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a><span class="ss">                GROUP BY fullvisitorid,</span></span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a><span class="ss">                         visitId,</span></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a><span class="ss">                         visitNumber,</span></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a><span class="ss">                         visitStartTime,</span></span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a><span class="ss">                         country,</span></span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a><span class="ss">                         quarter,</span></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a><span class="ss">                         month,</span></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a><span class="ss">                         day_of_month,</span></span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a><span class="ss">                         day_of_week,</span></span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a><span class="ss">                         hour,</span></span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a><span class="ss">                         minute,</span></span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a><span class="ss">                         second,</span></span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a><span class="ss">                         source,</span></span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a><span class="ss">                         medium,</span></span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a><span class="ss">                         channelGrouping,</span></span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a><span class="ss">                         hits,</span></span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a><span class="ss">                         bounces,</span></span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a><span class="ss">                         pageviews,</span></span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a><span class="ss">                         time_on_site,</span></span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a><span class="ss">                         browser,</span></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a><span class="ss">                         os,</span></span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a><span class="ss">                         deviceCategory,</span></span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a><span class="ss">                         made_purchase_on_future_visit</span></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a><span class="ss">            )</span></span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a><span class="ss">            SELECT *</span></span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a><span class="ss">            FROM visit_attributes</span></span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a><span class="ss">            """</span></span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> query_str</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="create-training-data" class="level3">
<h3 class="anchored" data-anchor-id="create-training-data">Create Training Data</h3>
<p>The training data will be prepared following the identical approach used in the EDA step, namely</p>
<ol type="1">
<li>load data from Google BigQuery dataset using the Python <code>bigquery</code> client</li>
<li>set datatypes to support frequency encoding of categorical features
<ul>
<li>all categorical features must have the datatype <code>pd.CategoricalDtype()</code></li>
</ul></li>
<li>drop duplicates by <code>fullvisitorid</code></li>
<li>perform frequency-encoding on categorical features to reduce cardinality</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="14">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data from BigQuery dataset, set datatypes and drop duplicates</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> get_sql_query(train_start_date, train_end_date, train_start_date, test_end_date)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> (</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    run_sql_query(query, <span class="op">**</span>gcp_auth_dict, show_df<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    .pipe(set_datatypes, dtypes<span class="op">=</span>dtypes_dict)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    .pipe(drop_duplicates, subset<span class="op">=</span>[<span class="st">"fullvisitorid"</span>])</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Got </span><span class="sc">{</span><span class="bu">len</span>(df_train)<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>df_train<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns "</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"after dropping duplicates"</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># perform frequency-encoding on categorical features</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># # Get a list of the non-categorical columns</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>non_categorical_columns <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">list</span>(df_train) <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> categorical_columns]</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co"># # Apply the custom data transformation pipeline to prepare the training data split</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> pipe_trans.fit(df_train)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> pd.DataFrame(</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    pipe_trans.transform(df_train),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>categorical_columns <span class="op">+</span> non_categorical_columns,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>)[non_categorical_columns <span class="op">+</span> categorical_columns].pipe(set_datatypes, dtypes<span class="op">=</span>dtypes_dict)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Got </span><span class="sc">{</span><span class="bu">len</span>(df_train)<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>df_train<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns after "</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"frequency-encoding categorical features"</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    display(df_train.head())</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    display(df_train.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:38:11.057...done at 2023-04-13 17:38:31.166 (20.109 seconds).
Query returned 92,859 rows
Got 92,551 rows and 29 columns after dropping duplicates
Got 92,551 rows and 29 columns after frequency-encoding categorical features</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>4180680121446408775</td>
<td>1476943855</td>
<td>1</td>
<td>2016-10-19 23:10:55</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>19</td>
<td>4</td>
<td>23</td>
<td>10</td>
<td>55</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5</td>
<td>292</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>2016-10-19 05:27:45</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>19</td>
<td>4</td>
<td>5</td>
<td>27</td>
<td>45</td>
<td>18</td>
<td>27</td>
<td>1</td>
<td>36</td>
<td>0</td>
<td>9</td>
<td>317</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1687301606877489412</td>
<td>1477794145</td>
<td>1</td>
<td>2016-10-29 19:22:25</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>29</td>
<td>7</td>
<td>19</td>
<td>22</td>
<td>25</td>
<td>5</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5</td>
<td>54</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>youtube.com</td>
<td>referral</td>
<td>other</td>
<td>other</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>796191439564725883</td>
<td>1473279331</td>
<td>1</td>
<td>2016-09-07 13:15:31</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>7</td>
<td>4</td>
<td>13</td>
<td>15</td>
<td>31</td>
<td>7</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>7</td>
<td>2494</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>9194147359170837949</td>
<td>1478035636</td>
<td>1</td>
<td>2016-11-01 14:27:16</td>
<td>United States</td>
<td>4</td>
<td>11</td>
<td>1</td>
<td>3</td>
<td>14</td>
<td>27</td>
<td>16</td>
<td>7</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>4</td>
<td>174</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>youtube.com</td>
<td>referral</td>
<td>other</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">92546</td>
<td>6912704476581951344</td>
<td>1481395682</td>
<td>1</td>
<td>2016-12-10 10:48:02</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>10</td>
<td>7</td>
<td>10</td>
<td>48</td>
<td>2</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>30</td>
<td>0</td>
<td>3</td>
<td>70</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">92547</td>
<td>253693082293291936</td>
<td>1475785004</td>
<td>1</td>
<td>2016-10-06 13:16:44</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>6</td>
<td>5</td>
<td>13</td>
<td>16</td>
<td>44</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>27</td>
<td>0</td>
<td>3</td>
<td>30</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Safari</td>
<td>iOS</td>
<td>mobile</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92548</td>
<td>0745341923593722891</td>
<td>1481152121</td>
<td>1</td>
<td>2016-12-07 15:08:41</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>7</td>
<td>4</td>
<td>15</td>
<td>8</td>
<td>41</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>36</td>
<td>0</td>
<td>3</td>
<td>182</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">92549</td>
<td>3099760389535632682</td>
<td>1475112188</td>
<td>1</td>
<td>2016-09-28 18:23:08</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>28</td>
<td>4</td>
<td>18</td>
<td>23</td>
<td>8</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>9</td>
<td>0</td>
<td>3</td>
<td>40</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>other</td>
<td>referral</td>
<td>other</td>
<td>other</td>
<td>iOS</td>
<td>mobile</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92550</td>
<td>7973052081416467006</td>
<td>1482541637</td>
<td>1</td>
<td>2016-12-23 17:07:17</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>23</td>
<td>6</td>
<td>17</td>
<td>7</td>
<td>17</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>33</td>
<td>0</td>
<td>3</td>
<td>64</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>youtube.com</td>
<td>referral</td>
<td>other</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Google Analytics uses visits and sessions interchangeably (<a href="https://www.blyp.ai/a/question-hub/google-analytics/sessions-vs-visits-are-they-the-same-in-google-analytics">1</a>, <a href="https://databox.com/sessions-users-pageviews-in-google-analytics#head2">2</a>)
<ul>
<li>a visit identifies a user reaching the marketplace website
<ul>
<li>a visitor can have multiple visits since they can visit the marketplace website multiple times</li>
</ul></li>
<li>a session captures a visitor’s interactions on the site during a visit
<ul>
<li>a session begins at the start of the visit and ends after 30 minutes of inactivity by the visitor</li>
</ul></li>
</ul></li>
<li>Each row here corresponds to a single action performed by a single visitor during a visit.</li>
<li>The <code>made_purchase_on_future_visit</code> is the label for ML training. However, this column is currently shown at the user action level (since the visits were exploded using the <code>UNNEST</code> function on the <code>hits</code> column). The label value only changes at the visit level since we only know if a visitor will make a purchase on their return (or future) visit after that visit has ended and that applies to the entire visit. So, we can aggregate over this column (include this column in the <code>GROUP BY</code>) in order to get it at the visit level
<ul>
<li>this column indicates if a visitor makes a purchase during their <em>next</em> visit</li>
<li>a ML model will be trained to predict this probability (propensity) of making a purchase during the return visit to the Merchandise store</li>
<li>the ML model will be trained on features of the same visitor’s <em>first</em> visit</li>
<li>this is a <a href="https://docs.aws.amazon.com/whitepapers/latest/time-series-forecasting-principles-with-amazon-forecast/step-2-prepare-data.html#concepts-of-featurization-and-related-time-series">forward-looking</a> label (<code>y</code>)</li>
</ul></li>
<li>We had to select <code>totals.newVisits = 1</code> since we only wanted ML features from the first visit. We can’t use features from the return visit since we want to predict the outcome of the return visit <em>before of that visit has occurred</em>. Earlier, we selected visitors who made a purchase on a future visit. So, for these visitors, the ML features (<code>X</code>) will be extracted from these visitors’ first visit only.**</li>
</ol>
</div>
</div>
<p>The start and end <code>visitStartTime</code>s match those specified by the required start (<code>train_start_date</code>) and end (<code>train_end_date</code>) dates of the training data split</p>
<div class="cell" data-tags="[]" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df_train[<span class="st">"visitStartTime"</span>].<span class="bu">min</span>().month <span class="op">==</span> <span class="bu">int</span>(train_start_date[<span class="dv">4</span>:<span class="dv">6</span>])</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df_train[<span class="st">"visitStartTime"</span>].<span class="bu">max</span>().month <span class="op">==</span> <span class="bu">int</span>(train_end_date[<span class="dv">4</span>:<span class="dv">6</span>])</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Visit Start Times: </span><span class="sc">{</span>df_train[<span class="st">'visitStartTime'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss"> - "</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>df_train[<span class="st">'visitStartTime'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Visit Start Times: 2016-09-01 00:07:35 - 2016-12-31 23:56:56</code></pre>
</div>
</div>
<p>Below is the class imbalance in the ML labels (<code>y_train</code>) from the training data and the number of unique values in all categorical columns</p>
<div class="cell" data-tags="[]" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>        <span class="dv">100</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span> df_train[<span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        .value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"fraction"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        df_train[<span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        .value_counts()</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"number"</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        .to_frame(),</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame.from_records(</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"column"</span>: c,</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"num_unique_values"</span>: df_train[c].nunique(),</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> c <span class="kw">in</span> categorical_columns</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">fraction</th>
<th data-quarto-table-cell-role="th">number</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>95.407937</td>
<td>88301</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>4.592063</td>
<td>4250</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column</th>
<th data-quarto-table-cell-role="th">num_unique_values</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>bounces</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>last_action</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>source</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>medium</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>channelGrouping</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>browser</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>os</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>deviceCategory</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Class Imbalance
<ul>
<li>we will want to consider random <a href="https://machinelearningmastery.com/random-oversampling-and-undersampling-for-imbalanced-classification/">undersampling, or downsampling</a> to improve the imbalance ratio from approximately 20:1 in favor of the majority class to a ratio such as 10:1 or 5:1. This will help the ML model in two ways
<ul>
<li>reducing the degree of imbalance will learn from a relatively larger number of positive examples (visitor did make a purchase on a future visit - we are interested in these visitors) than in the raw data which will have a larger number negative examples (visitor did not make a purchase on a future visit - we are not interested in these visitors for the current business use-case)</li>
<li>keeping the true class imbalance is also inefficient in terms of training time since the model spends most of its time learning from uninteresting examples
<ul>
<li>reducing the class imbalance results in shorter model training times</li>
</ul></li>
</ul>
Other approaches to handle the class imbalance are
<ul>
<li>do nothing
<ul>
<li>train the model using the true distribution of the classes</li>
<li>if a model trained on the true imbalanced distribution can generalize to to unseen data then no undersampling is required</li>
<li>the disadvantage of this approach is that longer training time will be required</li>
</ul></li>
<li>use a data-augmentation technique such as <a href="https://bmcbioinformatics.biomedcentral.com/articles/10.1186/1471-2105-14-106">SMOTE</a></li>
</ul></li>
</ul></li>
</ol>
</div>
</div>
<p>Show a count of missing values in all the columns</p>
<div class="cell" data-tags="[]" data-execution_count="17">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df_train.isna().<span class="bu">sum</span>().rename(<span class="st">"missing"</span>).reset_index().rename(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"column"</span>}</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column</th>
<th data-quarto-table-cell-role="th">missing</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>fullvisitorid</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>visitId</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>visitNumber</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>visitStartTime</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>country</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>quarter</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>month</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>day_of_month</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>day_of_week</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>hour</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>minute</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>second</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>hits</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>promos_displayed</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>promos_clicked</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>product_views</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>product_clicks</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>pageviews</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>time_on_site</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>added_to_cart</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>made_purchase_on_future_visit</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>bounces</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>last_action</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>source</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>medium</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>channelGrouping</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>browser</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>os</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>deviceCategory</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Since the Google Analytics data is reported by visit, missing values in the General features columns
<ul>
<li><code>hits</code></li>
<li><code>bounces</code></li>
<li><code>pageviews</code></li>
<li><code>time_on_site</code></li>
</ul>
would indicate zeros. Zeros were already present in the raw data so there were no missing values in these columns that had to be filled as part of the data preparation SQL query used here.</li>
<li>The manually chosen set of User-Facing features (all of which are categoricals) don’t have missing values.</li>
<li>For both types of features, other choices than the ones made here could have missing values. In that case, feature imputation would be necessary without data leakage/lookahead bias. For the choices in this step, imputing missing values is not necessary in the features aggregated at the visit level.</li>
</ol>
</div>
</div>
<p>We’ll now assessing zeros in the General Features Columns</p>
<ol type="1">
<li><code>hits</code>
<ul>
<li><code>hits</code> are users’ interactions on the merchandise store’s website that sends data to the Google Analytics server (<a href="https://www.digishuffle.com/blogs/google-analytics-hits/#hitdefinition">1</a>, <a href="https://whatagraph.com/blog/articles/which-kinds-of-hits-does-google-analytics-track/#toc_0">2</a>)</li>
<li>a visit is a group of hits (<a href="https://www.optimizesmart.com/why-google-analytics-show-zero-sessions/">1</a>)</li>
<li><a href="https://whatagraph.com/blog/articles/which-kinds-of-hits-does-google-analytics-track/">examples include</a>
<ul>
<li>viewing a page</li>
<li>social media interactions, like sharing or liking content using <em>share on social media</em> buttons</li>
<li>e-commerce interactions (add to cart, remove from cart, make purchase, etc.)</li>
<li>user timings (loading a page, loading an image, clicking a button)</li>
<li>etc.</li>
</ul></li>
<li>there is no occurrence of zero hits in the Merchandise Store’s Google Analytics dataset, so the minimum number of hits is 1, likely since viewing a page (which always occurs) is considered a hit</li>
</ul></li>
<li><code>time_on_site</code> (total duration of a single visit)
<ul>
<li>reaching the site triggers the start of a visit</li>
<li>time on site <a href="https://roirevolution.com/blog/time-on-page-and-time-on-site-how-confident-are-you/">is calculated as</a> the difference between the timestamp of the last and first pages of a visit</li>
<li>a zero indicates the user did not navigate to further pages or trigger events on the site after reaching the site (<a href="https://support.google.com/google-ads/thread/1455669?hl=en&amp;msgid=1455678">1</a>)</li>
</ul></li>
<li><code>bounces</code>
<ul>
<li>a bounce is when a single request is submitted from scripts embedded in the merchandise store’s website to the <a href="https://www.analyticsmania.com/post/introduction-to-google-tag-manager-server-side-tagging/">Google Analytics server</a> (<a href="https://support.google.com/analytics/answer/1009409?hl=en">1</a>)
<ul>
<li>if a bounce occurs, then time spent on the site is zero and a single page has most likely been viewed (<code>pageviews</code>)</li>
<li>a zero indicates the absence of a bounced visit, while <code>1</code> indicates a bounce was present</li>
</ul></li>
</ul></li>
</ol>
<p>If a bounce occurs then, by definition, the following are true</p>
<ol type="1">
<li>zero time on site</li>
<li>a single hit is registered</li>
<li>(predominantly) a single page gets viewed</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="18">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># time on site versus bounces</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>            <span class="dv">100</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span> df_train.query(<span class="st">"bounces == 1"</span>)[<span class="st">"time_on_site"</span>].value_counts(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>                normalize<span class="op">=</span><span class="va">True</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"frequency"</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"time_on_site"</span>})</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    .assign(split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    .assign(time_on_site<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    .iloc[[<span class="dv">0</span>]]</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co"># number of pages viewed versus bounces</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">100</span> <span class="op">*</span> df_train.query(<span class="st">"bounces == 1"</span>)[<span class="st">"pageviews"</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"frequency"</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"pageviews"</span>})</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    .assign(split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    .assign(time_on_site<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    .iloc[[<span class="dv">0</span>]]</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="co"># hits versus bounces</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">100</span> <span class="op">*</span> df_train.query(<span class="st">"bounces == 1"</span>)[<span class="st">"hits"</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"frequency"</span>)</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"hits"</span>})</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    .assign(split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    .assign(time_on_site<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    .iloc[[<span class="dv">0</span>]]</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">split</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>100.0</td>
<td>train</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">split</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>100.0</td>
<td>train</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">split</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>99.167869</td>
<td>train</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Similarly, if zero time is spent on the site then this is almost always associated with</p>
<ul>
<li>a bounce occurs</li>
<li>single page view</li>
<li>single hit</li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="19">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># bounce</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>            <span class="dv">100</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span> df_train.query(<span class="st">"time_on_site == 0"</span>)[<span class="st">"bounces"</span>].value_counts(</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                normalize<span class="op">=</span><span class="va">True</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"frequency"</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"bounces"</span>})</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    .assign(split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    .assign(time_on_site<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    .iloc[[<span class="dv">0</span>]]</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co"># single page view</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>                <span class="dv">100</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>                <span class="op">*</span> df_train.query(<span class="st">"time_on_site == 0"</span>)[<span class="st">"pageviews"</span>].value_counts(</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>                    normalize<span class="op">=</span><span class="va">True</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>            .rename(<span class="st">"frequency"</span>)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>            .to_frame()</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>            .reset_index()</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>            .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"pageviews"</span>})</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    .assign(split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    .assign(time_on_site<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    .iloc[[<span class="dv">0</span>]]</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a><span class="co"># hits</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">100</span> <span class="op">*</span> df_train.query(<span class="st">"time_on_site == 0"</span>)[<span class="st">"hits"</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"frequency"</span>)</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"hits"</span>})</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    .assign(split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    .assign(time_on_site<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    .iloc[[<span class="dv">0</span>]]</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">split</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>99.830164</td>
<td>train</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">split</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>99.863393</td>
<td>train</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">split</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>99.010522</td>
<td>train</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Similarly, if a single hit occurs on the e-commerce site then this is almost always associated with</p>
<ul>
<li>a bounce occurs</li>
<li>single page view</li>
<li>zero time on site</li>
</ul>
<div class="cell" data-tags="[]" data-execution_count="20">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hits versus bounces</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">100</span> <span class="op">*</span> df_train.query(<span class="st">"hits == 1"</span>)[<span class="st">"bounces"</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"frequency"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"bounces"</span>})</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    .assign(split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    .assign(hits<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    .iloc[[<span class="dv">0</span>]]</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co"># hits versus number of pages viewed</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">100</span> <span class="op">*</span> df_train.query(<span class="st">"hits == 1"</span>)[<span class="st">"pageviews"</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"frequency"</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"pageviews"</span>})</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    .assign(split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    .assign(hits<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    .iloc[[<span class="dv">0</span>]]</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="co"># hits versus time on site</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">100</span> <span class="op">*</span> df_train.query(<span class="st">"hits == 1"</span>)[<span class="st">"time_on_site"</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"frequency"</span>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"time_on_site"</span>})</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    .assign(split<span class="op">=</span><span class="st">"train"</span>)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    .assign(hits<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    .iloc[[<span class="dv">0</span>]]</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">split</th>
<th data-quarto-table-cell-role="th">hits</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>99.988813</td>
<td>train</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">split</th>
<th data-quarto-table-cell-role="th">hits</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>99.988813</td>
<td>train</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">split</th>
<th data-quarto-table-cell-role="th">hits</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>100.0</td>
<td>train</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Based on the above, it might be worth training a ML model with only one of these General Features (<code>hits</code>, <code>time_on_site</code>, <code>pageviews</code>).</li>
<li><code>bounces</code> is a binary column and should be treated as a categorical ML feature and not as a numerical feature.</li>
</ol>
</div>
</div>
</section>
<section id="create-validation-data" class="level3">
<h3 class="anchored" data-anchor-id="create-validation-data">Create Validation Data</h3>
<p>Using the same approach, the validation data split is now created by only changing</p>
<ol type="1">
<li><code>train_start_date</code> to <code>val_start_date</code></li>
<li><code>train_end_date</code> to <code>val_end_date</code></li>
</ol>
<p>in the <code>first_visit_attributes</code> CTE in order to capture the validation data and categorical features are encoded using the custom pipeline that was trained using the training data</p>
<div class="cell" data-tags="[]" data-execution_count="21">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data from BigQuery dataset, set datatypes and drop duplicates</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> get_sql_query(val_start_date, val_end_date, train_start_date, test_end_date)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>df_val <span class="op">=</span> (</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    run_sql_query(query, <span class="op">**</span>gcp_auth_dict, show_df<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    .pipe(set_datatypes, dtypes<span class="op">=</span>dtypes_dict)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    .pipe(drop_duplicates, subset<span class="op">=</span>[<span class="st">"fullvisitorid"</span>])</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Got </span><span class="sc">{</span><span class="bu">len</span>(df_val)<span class="sc">:,}</span><span class="ss"> rows  and </span><span class="sc">{</span>df_train<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns"</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"after dropping duplicates"</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co"># perform frequency-encoding on categorical features</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co"># # Apply the custom data transformation pipeline to prepare the training data split</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>df_val <span class="op">=</span> pd.DataFrame(</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    pipe_trans.transform(df_val), columns<span class="op">=</span>categorical_columns <span class="op">+</span> non_categorical_columns</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>)[non_categorical_columns <span class="op">+</span> categorical_columns].pipe(set_datatypes, dtypes<span class="op">=</span>dtypes_dict)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Got </span><span class="sc">{</span><span class="bu">len</span>(df_val)<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>df_val<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns after "</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"frequency-encoding categorical features"</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    display(df_val.head())</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    display(df_val.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:38:37.871...done at 2023-04-13 17:38:43.515 (5.644 seconds).
Query returned 21,208 rows
Got 21,177 rows  and 29 columnsafter dropping duplicates
Got 21,177 rows and 29 columns after frequency-encoding categorical features</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>7443659111332807488</td>
<td>1484063672</td>
<td>1</td>
<td>2017-01-10 07:54:32</td>
<td>United States</td>
<td>1</td>
<td>1</td>
<td>10</td>
<td>3</td>
<td>7</td>
<td>54</td>
<td>32</td>
<td>11</td>
<td>9</td>
<td>0</td>
<td>66</td>
<td>0</td>
<td>11</td>
<td>151</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>other</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>5597527133395896902</td>
<td>1485228391</td>
<td>1</td>
<td>2017-01-23 19:26:31</td>
<td>United States</td>
<td>1</td>
<td>1</td>
<td>23</td>
<td>2</td>
<td>19</td>
<td>26</td>
<td>31</td>
<td>4</td>
<td>9</td>
<td>0</td>
<td>12</td>
<td>0</td>
<td>4</td>
<td>68</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Safari</td>
<td>iOS</td>
<td>tablet</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>9166144922111078017</td>
<td>1483730457</td>
<td>1</td>
<td>2017-01-06 11:20:57</td>
<td>United States</td>
<td>1</td>
<td>1</td>
<td>6</td>
<td>6</td>
<td>11</td>
<td>20</td>
<td>57</td>
<td>6</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>3</td>
<td>27</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4913593613905335447</td>
<td>1485720519</td>
<td>1</td>
<td>2017-01-29 12:08:39</td>
<td>United States</td>
<td>1</td>
<td>1</td>
<td>29</td>
<td>1</td>
<td>12</td>
<td>8</td>
<td>39</td>
<td>5</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5</td>
<td>122</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3123113931923419625</td>
<td>1485363986</td>
<td>1</td>
<td>2017-01-25 09:06:26</td>
<td>United States</td>
<td>1</td>
<td>1</td>
<td>25</td>
<td>4</td>
<td>9</td>
<td>6</td>
<td>26</td>
<td>20</td>
<td>54</td>
<td>0</td>
<td>39</td>
<td>0</td>
<td>20</td>
<td>494</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>5</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">21172</td>
<td>7261133747877726873</td>
<td>1485301932</td>
<td>1</td>
<td>2017-01-24 15:52:12</td>
<td>United States</td>
<td>1</td>
<td>1</td>
<td>24</td>
<td>3</td>
<td>15</td>
<td>52</td>
<td>12</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>32</td>
<td>0</td>
<td>3</td>
<td>28</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21173</td>
<td>1814053538655247996</td>
<td>1483319025</td>
<td>1</td>
<td>2017-01-01 17:03:45</td>
<td>United States</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>17</td>
<td>3</td>
<td>45</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>28</td>
<td>0</td>
<td>3</td>
<td>49</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">21174</td>
<td>6632475970380148823</td>
<td>1485256352</td>
<td>1</td>
<td>2017-01-24 03:12:32</td>
<td>United States</td>
<td>1</td>
<td>1</td>
<td>24</td>
<td>3</td>
<td>3</td>
<td>12</td>
<td>32</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>36</td>
<td>0</td>
<td>1</td>
<td>29</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>youtube.com</td>
<td>referral</td>
<td>other</td>
<td>Safari</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21175</td>
<td>5357307819206012105</td>
<td>1483378607</td>
<td>1</td>
<td>2017-01-02 09:36:47</td>
<td>United States</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>9</td>
<td>36</td>
<td>47</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>18</td>
<td>0</td>
<td>3</td>
<td>66</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>other</td>
<td>referral</td>
<td>other</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">21176</td>
<td>2767207647504105236</td>
<td>1483984592</td>
<td>1</td>
<td>2017-01-09 09:56:32</td>
<td>United States</td>
<td>1</td>
<td>1</td>
<td>9</td>
<td>2</td>
<td>9</td>
<td>56</td>
<td>32</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>31</td>
<td>0</td>
<td>3</td>
<td>132</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>youtube.com</td>
<td>referral</td>
<td>other</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Earlier, it was mentioned that <code>totals.newVisits = 1</code> gives the first visit while <code>totals.newVisits = NULL</code> gives the future visit. In the training data, the first visit was picked up using this filter condition as a SQL filter. This allowed features from the first visit to be extracted. The label was whether the visitor made a purchase during their return visit. Here, the validation data uses the same approach. Per the business use-case, we want to predict new visitor’s propensity of making a purchase during their return (or future) visit.</p>
<p>The ML model will be trained using training data which only captures the first visit and this first visit occurs during the months covered by the training data only. The model will be validated using validation data that similarly covers the first visit that occurs during the months covered by the validation data only. The label of the validation data is analogous to that from the training data in that it indicates whether these new visitors (in the validation data split) made a purchase during a future visit.</p>
<p>With this in mind, similar to the training data, we can get that first visit of visitors in the validation data using <code>totals.newVisits = 1</code> in the validation data SQL query above. For this reason, we will not use <code>totals.newVisits = NULL</code> in the SQL query to build the validation or test data splits.</p></li>
<li><p>The visitors in the training data do not need to be the same as those in the validation (or testing) data splits. Visitor ID will not be used as a feature during training, validation or evaluation (test data). Only the attributes of their first visit will be used since we are not interested in training a ML model for specific visitors who are identified by their ID.</p></li>
</ol>
</div>
</div>
<p>The start and end <code>visitStartTime</code>s match those specified by the required start (<code>val_start_date</code>) and end (<code>val_end_date</code>) dates of the validation data split</p>
<div class="cell" data-tags="[]" data-execution_count="22">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df_val[<span class="st">"visitStartTime"</span>].<span class="bu">min</span>().month <span class="op">==</span> <span class="bu">int</span>(val_start_date[<span class="dv">4</span>:<span class="dv">6</span>])</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df_val[<span class="st">"visitStartTime"</span>].<span class="bu">max</span>().month <span class="op">==</span> <span class="bu">int</span>(val_end_date[<span class="dv">4</span>:<span class="dv">6</span>])</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Visit Start Times: </span><span class="sc">{</span>df_val[<span class="st">'visitStartTime'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss"> - "</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>df_val[<span class="st">'visitStartTime'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Visit Start Times: 2017-01-01 00:04:32 - 2017-01-31 23:57:51</code></pre>
</div>
</div>
</section>
<section id="create-test-data" class="level3">
<h3 class="anchored" data-anchor-id="create-test-data">Create Test Data</h3>
<p>Finally, the test data split is created using a similar approach to the validation data split (only the dates in the <code>first_visit_attributes</code> CTE are changed in order to capture the test data)</p>
<div class="cell" data-tags="[]" data-execution_count="23">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data from BigQuery dataset, set datatypes and drop duplicates</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> get_sql_query(test_start_date, test_end_date, train_start_date, test_end_date)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> (</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    run_sql_query(query, <span class="op">**</span>gcp_auth_dict, show_df<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    .pipe(set_datatypes, dtypes<span class="op">=</span>dtypes_dict)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    .pipe(drop_duplicates, subset<span class="op">=</span>[<span class="st">"fullvisitorid"</span>])</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Got </span><span class="sc">{</span><span class="bu">len</span>(df_test)<span class="sc">:,}</span><span class="ss"> rows  and </span><span class="sc">{</span>df_test<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns"</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"after dropping duplicates"</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co"># perform frequency-encoding on categorical features</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="co"># # Apply the custom data transformation pipeline to prepare the training data split</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> pd.DataFrame(</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    pipe_trans.transform(df_test), columns<span class="op">=</span>categorical_columns <span class="op">+</span> non_categorical_columns</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>)[non_categorical_columns <span class="op">+</span> categorical_columns].pipe(set_datatypes, dtypes<span class="op">=</span>dtypes_dict)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Got </span><span class="sc">{</span><span class="bu">len</span>(df_test)<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>df_test<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns after "</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"frequency-encoding categorical features"</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    display(df_test.head())</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    display(df_test.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:38:43.708...done at 2023-04-13 17:38:48.259 (4.552 seconds).
Query returned 20,180 rows
Got 20,164 rows  and 29 columnsafter dropping duplicates
Got 20,164 rows and 29 columns after frequency-encoding categorical features</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>6667770433164438858</td>
<td>1487630668</td>
<td>1</td>
<td>2017-02-20 14:44:28</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>20</td>
<td>2</td>
<td>14</td>
<td>44</td>
<td>28</td>
<td>7</td>
<td>9</td>
<td>0</td>
<td>39</td>
<td>0</td>
<td>7</td>
<td>75</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>861894924191702840</td>
<td>1486761793</td>
<td>1</td>
<td>2017-02-10 13:23:13</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>10</td>
<td>6</td>
<td>13</td>
<td>23</td>
<td>13</td>
<td>7</td>
<td>18</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>7</td>
<td>38</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>987663115799971454</td>
<td>1487812839</td>
<td>1</td>
<td>2017-02-22 17:20:39</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>22</td>
<td>4</td>
<td>17</td>
<td>20</td>
<td>39</td>
<td>4</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>4</td>
<td>21</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>7090908358039029290</td>
<td>1487412580</td>
<td>1</td>
<td>2017-02-18 02:09:40</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>18</td>
<td>7</td>
<td>2</td>
<td>9</td>
<td>40</td>
<td>6</td>
<td>9</td>
<td>0</td>
<td>12</td>
<td>0</td>
<td>6</td>
<td>540</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>other</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>294074179132707998</td>
<td>1487899413</td>
<td>1</td>
<td>2017-02-23 17:23:33</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>23</td>
<td>5</td>
<td>17</td>
<td>23</td>
<td>33</td>
<td>5</td>
<td>18</td>
<td>0</td>
<td>3</td>
<td>0</td>
<td>5</td>
<td>117</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>other</td>
<td>other</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">20159</td>
<td>171945862803080966</td>
<td>1487825038</td>
<td>1</td>
<td>2017-02-22 20:43:58</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>22</td>
<td>4</td>
<td>20</td>
<td>43</td>
<td>58</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>39</td>
<td>0</td>
<td>3</td>
<td>26</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>Safari</td>
<td>iOS</td>
<td>mobile</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20160</td>
<td>6600545612381993294</td>
<td>1487380495</td>
<td>1</td>
<td>2017-02-17 17:14:55</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>17</td>
<td>6</td>
<td>17</td>
<td>14</td>
<td>55</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>15</td>
<td>0</td>
<td>2</td>
<td>22</td>
<td>1</td>
<td>False</td>
<td>0</td>
<td>3</td>
<td>other</td>
<td>referral</td>
<td>other</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20161</td>
<td>258929636492512392</td>
<td>1487293726</td>
<td>1</td>
<td>2017-02-16 17:08:46</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>16</td>
<td>5</td>
<td>17</td>
<td>8</td>
<td>46</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>5</td>
<td>0</td>
<td>3</td>
<td>1640</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>other</td>
<td>referral</td>
<td>other</td>
<td>other</td>
<td>Android</td>
<td>mobile</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20162</td>
<td>7064613315175563493</td>
<td>1487258784</td>
<td>1</td>
<td>2017-02-16 07:26:24</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>16</td>
<td>5</td>
<td>7</td>
<td>26</td>
<td>24</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>36</td>
<td>0</td>
<td>3</td>
<td>53</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>youtube.com</td>
<td>referral</td>
<td>other</td>
<td>other</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20163</td>
<td>3684942462385225804</td>
<td>1487279963</td>
<td>1</td>
<td>2017-02-16 13:19:23</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>16</td>
<td>5</td>
<td>13</td>
<td>19</td>
<td>23</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>29</td>
<td>0</td>
<td>3</td>
<td>117</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>youtube.com</td>
<td>referral</td>
<td>other</td>
<td>other</td>
<td>Windows</td>
<td>desktop</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The start and end <code>visitStartTime</code>s match those specified by the required start (<code>test_start_date</code>) and end (<code>test_end_date</code>) dates of the test data split</p>
<div class="cell" data-tags="[]" data-execution_count="24">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df_test[<span class="st">"visitStartTime"</span>].<span class="bu">min</span>().month <span class="op">==</span> <span class="bu">int</span>(test_start_date[<span class="dv">4</span>:<span class="dv">6</span>])</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df_test[<span class="st">"visitStartTime"</span>].<span class="bu">max</span>().month <span class="op">==</span> <span class="bu">int</span>(test_end_date[<span class="dv">4</span>:<span class="dv">6</span>])</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Visit Start Times: </span><span class="sc">{</span>df_test[<span class="st">'visitStartTime'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss"> - "</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"</span><span class="sc">{</span>df_test[<span class="st">'visitStartTime'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Visit Start Times: 2017-02-01 00:00:06 - 2017-02-28 23:54:37</code></pre>
</div>
</div>
</section>
</section>
<section id="discussion-of-duplicates-during-data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="discussion-of-duplicates-during-data-preparation">Discussion of Duplicates During Data Preparation</h2>
<ol type="1">
<li><p>By splitting data for ML, at the time of training the ML model, we are assuming that we don’t yet have the validation or testing data during ML model development so we would not know if duplicates are or are not present in those data splits.</p>
<p>If such a model is performant enough to be deployed to production, the same will apply to out-of-sample (unseen) visitors’ visit data. The features that would be needed in production are the same as those that would be needed during ML development. So, when we do access the out-of-sample data in production, we again would want only the first visit per visitor so that (as was done during ML development) we can predict their propensity to make a purchase during a future visit. In order to accomplish this, when we were to get access to the unseen data in production, we could easily</p>
<ul>
<li>consider the first valid visit per visitor (i.e.&nbsp;per <code>fullvisitorid</code>)</li>
<li>create features from this visit and make a prediction (inference) of propensity to purchase during a return (or future) visit</li>
<li>for subsequent visits
<ul>
<li>check for duplicates by <code>fullvisitorid</code></li>
<li>drop any duplicated (subsequent) visits by the same <code>fullvisitorid</code> (since an inference prediction has already been made for this visitor)</li>
</ul></li>
</ul>
<p>and this workflow does not involve data leakage or <a href="https://www.investopedia.com/terms/l/lookaheadbias.asp">lookahead bias</a>.</p>
<p>For this reason, we can drop this type of duplicate in the validation and test data splits without being affected by data leakage or lookahead bias.</p></li>
</ol>
</section>
<section id="export-to-disk" class="level2">
<h2 class="anchored" data-anchor-id="export-to-disk">Export to Disk</h2>
<p>Show datatypes for all data splits</p>
<div class="cell" data-tags="[]" data-execution_count="25">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> []</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df, split <span class="kw">in</span> <span class="bu">zip</span>([df_train, df_val, df_test], [<span class="st">"train"</span>, <span class="st">"val"</span>, <span class="st">"test"</span>]):</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    dfs.append(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        df.dtypes.rename(<span class="ss">f"datatype_</span><span class="sc">{</span>split<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"column"</span>})</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>df_dtypes <span class="op">=</span> <span class="bu">reduce</span>(</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> left, right: pd.merge(left, right, on<span class="op">=</span>[<span class="st">"column"</span>], how<span class="op">=</span><span class="st">"outer"</span>), dfs</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>df_dtypes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column</th>
<th data-quarto-table-cell-role="th">datatype_train</th>
<th data-quarto-table-cell-role="th">datatype_val</th>
<th data-quarto-table-cell-role="th">datatype_test</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>fullvisitorid</td>
<td>string[python]</td>
<td>string[python]</td>
<td>string[python]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>visitId</td>
<td>string[python]</td>
<td>string[python]</td>
<td>string[python]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>visitNumber</td>
<td>Int8</td>
<td>Int8</td>
<td>Int8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>visitStartTime</td>
<td>datetime64[ns]</td>
<td>datetime64[ns]</td>
<td>datetime64[ns]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>country</td>
<td>string[python]</td>
<td>string[python]</td>
<td>string[python]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>quarter</td>
<td>Int8</td>
<td>Int8</td>
<td>Int8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>month</td>
<td>Int8</td>
<td>Int8</td>
<td>Int8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>day_of_month</td>
<td>Int8</td>
<td>Int8</td>
<td>Int8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>day_of_week</td>
<td>Int8</td>
<td>Int8</td>
<td>Int8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>hour</td>
<td>Int8</td>
<td>Int8</td>
<td>Int8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>minute</td>
<td>Int8</td>
<td>Int8</td>
<td>Int8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>second</td>
<td>Int8</td>
<td>Int8</td>
<td>Int8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>hits</td>
<td>Int16</td>
<td>Int16</td>
<td>Int16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>promos_displayed</td>
<td>Int16</td>
<td>Int16</td>
<td>Int16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>promos_clicked</td>
<td>Int16</td>
<td>Int16</td>
<td>Int16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>product_views</td>
<td>Int16</td>
<td>Int16</td>
<td>Int16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>product_clicks</td>
<td>Int16</td>
<td>Int16</td>
<td>Int16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>pageviews</td>
<td>Int16</td>
<td>Int16</td>
<td>Int16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>time_on_site</td>
<td>Int16</td>
<td>Int16</td>
<td>Int16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>added_to_cart</td>
<td>Int16</td>
<td>Int16</td>
<td>Int16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>made_purchase_on_future_visit</td>
<td>boolean</td>
<td>boolean</td>
<td>boolean</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>bounces</td>
<td>category</td>
<td>category</td>
<td>category</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>last_action</td>
<td>category</td>
<td>category</td>
<td>category</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>source</td>
<td>category</td>
<td>category</td>
<td>category</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>medium</td>
<td>category</td>
<td>category</td>
<td>category</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>channelGrouping</td>
<td>category</td>
<td>category</td>
<td>category</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>browser</td>
<td>category</td>
<td>category</td>
<td>category</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>os</td>
<td>category</td>
<td>category</td>
<td>category</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>deviceCategory</td>
<td>category</td>
<td>category</td>
<td>category</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Show info for <code>DataFrame</code> with training data</p>
<div class="cell" data-tags="[]" data-execution_count="26">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df_train.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 92551 entries, 0 to 92550
Data columns (total 29 columns):
 #   Column                         Non-Null Count  Dtype         
---  ------                         --------------  -----         
 0   fullvisitorid                  92551 non-null  string        
 1   visitId                        92551 non-null  string        
 2   visitNumber                    92551 non-null  Int8          
 3   visitStartTime                 92551 non-null  datetime64[ns]
 4   country                        92551 non-null  string        
 5   quarter                        92551 non-null  Int8          
 6   month                          92551 non-null  Int8          
 7   day_of_month                   92551 non-null  Int8          
 8   day_of_week                    92551 non-null  Int8          
 9   hour                           92551 non-null  Int8          
 10  minute                         92551 non-null  Int8          
 11  second                         92551 non-null  Int8          
 12  hits                           92551 non-null  Int16         
 13  promos_displayed               92551 non-null  Int16         
 14  promos_clicked                 92551 non-null  Int16         
 15  product_views                  92551 non-null  Int16         
 16  product_clicks                 92551 non-null  Int16         
 17  pageviews                      92551 non-null  Int16         
 18  time_on_site                   92551 non-null  Int16         
 19  added_to_cart                  92551 non-null  Int16         
 20  made_purchase_on_future_visit  92551 non-null  boolean       
 21  bounces                        92551 non-null  category      
 22  last_action                    92551 non-null  category      
 23  source                         92551 non-null  category      
 24  medium                         92551 non-null  category      
 25  channelGrouping                92551 non-null  category      
 26  browser                        92551 non-null  category      
 27  os                             92551 non-null  category      
 28  deviceCategory                 92551 non-null  category      
dtypes: Int16(8), Int8(8), boolean(1), category(8), datetime64[ns](1), string(3)
memory usage: 7.2 MB</code></pre>
</div>
</div>
<p>Show info for <code>DataFrame</code> with validation data</p>
<div class="cell" data-tags="[]" data-execution_count="27">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df_val.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 21177 entries, 0 to 21176
Data columns (total 29 columns):
 #   Column                         Non-Null Count  Dtype         
---  ------                         --------------  -----         
 0   fullvisitorid                  21177 non-null  string        
 1   visitId                        21177 non-null  string        
 2   visitNumber                    21177 non-null  Int8          
 3   visitStartTime                 21177 non-null  datetime64[ns]
 4   country                        21177 non-null  string        
 5   quarter                        21177 non-null  Int8          
 6   month                          21177 non-null  Int8          
 7   day_of_month                   21177 non-null  Int8          
 8   day_of_week                    21177 non-null  Int8          
 9   hour                           21177 non-null  Int8          
 10  minute                         21177 non-null  Int8          
 11  second                         21177 non-null  Int8          
 12  hits                           21177 non-null  Int16         
 13  promos_displayed               21177 non-null  Int16         
 14  promos_clicked                 21177 non-null  Int16         
 15  product_views                  21177 non-null  Int16         
 16  product_clicks                 21177 non-null  Int16         
 17  pageviews                      21177 non-null  Int16         
 18  time_on_site                   21177 non-null  Int16         
 19  added_to_cart                  21177 non-null  Int16         
 20  made_purchase_on_future_visit  21177 non-null  boolean       
 21  bounces                        21177 non-null  category      
 22  last_action                    21177 non-null  category      
 23  source                         21177 non-null  category      
 24  medium                         21177 non-null  category      
 25  channelGrouping                21177 non-null  category      
 26  browser                        21177 non-null  category      
 27  os                             21177 non-null  category      
 28  deviceCategory                 21177 non-null  category      
dtypes: Int16(8), Int8(8), boolean(1), category(8), datetime64[ns](1), string(3)
memory usage: 1.7 MB</code></pre>
</div>
</div>
<p>Show info for <code>DataFrame</code> with test data</p>
<div class="cell" data-tags="[]" data-execution_count="28">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df_test.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 20164 entries, 0 to 20163
Data columns (total 29 columns):
 #   Column                         Non-Null Count  Dtype         
---  ------                         --------------  -----         
 0   fullvisitorid                  20164 non-null  string        
 1   visitId                        20164 non-null  string        
 2   visitNumber                    20164 non-null  Int8          
 3   visitStartTime                 20164 non-null  datetime64[ns]
 4   country                        20164 non-null  string        
 5   quarter                        20164 non-null  Int8          
 6   month                          20164 non-null  Int8          
 7   day_of_month                   20164 non-null  Int8          
 8   day_of_week                    20164 non-null  Int8          
 9   hour                           20164 non-null  Int8          
 10  minute                         20164 non-null  Int8          
 11  second                         20164 non-null  Int8          
 12  hits                           20164 non-null  Int16         
 13  promos_displayed               20164 non-null  Int16         
 14  promos_clicked                 20164 non-null  Int16         
 15  product_views                  20164 non-null  Int16         
 16  product_clicks                 20164 non-null  Int16         
 17  pageviews                      20164 non-null  Int16         
 18  time_on_site                   20164 non-null  Int16         
 19  added_to_cart                  20164 non-null  Int16         
 20  made_purchase_on_future_visit  20164 non-null  boolean       
 21  bounces                        20164 non-null  category      
 22  last_action                    20164 non-null  category      
 23  source                         20164 non-null  category      
 24  medium                         20164 non-null  category      
 25  channelGrouping                20164 non-null  category      
 26  browser                        20164 non-null  category      
 27  os                             20164 non-null  category      
 28  deviceCategory                 20164 non-null  category      
dtypes: Int16(8), Int8(8), boolean(1), category(8), datetime64[ns](1), string(3)
memory usage: 1.6 MB</code></pre>
</div>
</div>
<p>The training data is now exported to disk</p>
<div class="cell" data-tags="[]" data-execution_count="29">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fpath_train <span class="op">=</span> os.path.join(processed_data_dir, <span class="st">"train_processed.parquet.gzip"</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>df_train.to_parquet(fpath_train, index<span class="op">=</span><span class="va">False</span>, compression<span class="op">=</span><span class="st">'gzip'</span>, engine<span class="op">=</span><span class="st">'pyarrow'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The validation data is now exported to disk</p>
<div class="cell" data-tags="[]" data-execution_count="30">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fpath_val <span class="op">=</span> os.path.join(processed_data_dir, <span class="st">"val_processed.parquet.gzip"</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>df_val.to_parquet(fpath_val, index<span class="op">=</span><span class="va">False</span>, compression<span class="op">=</span><span class="st">'gzip'</span>, engine<span class="op">=</span><span class="st">'pyarrow'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The testing data is now exported to disk</p>
<div class="cell" data-tags="[]" data-execution_count="31">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>fpath_test <span class="op">=</span> os.path.join(processed_data_dir, <span class="st">"test_processed.parquet.gzip"</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>df_test.to_parquet(fpath_test, index<span class="op">=</span><span class="va">False</span>, compression<span class="op">=</span><span class="st">'gzip'</span>, engine<span class="op">=</span><span class="st">'pyarrow'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="etl-workflow-to-transform-data" class="level2">
<h2 class="anchored" data-anchor-id="etl-workflow-to-transform-data">ETL Workflow to Transform Data</h2>
<p>We will now define an ETL workflow to perform the end-to-end transformation using Python functions that use <code>scikit-learn.Pipeline</code> and <code>pandas.pipe</code>. Such a workflow can be quickly re-used during ML development without needing to re-run all the Python code in this data transformation step and will allow the ability to change</p>
<ol type="1">
<li>start and end dates of raw data
<ul>
<li>this could be useful to add more training data if the ML model is not capturing variability in unseen data</li>
</ul></li>
<li>thresholds used when frequency-encoding categorical features
<ul>
<li>this could be useful to increase or decrease the cardinality of categorical features
<ul>
<li>increasing cardinality might help improve the predictive power of such features</li>
<li>decreasing cardinality might help improve (reduce) ML model training duration and explainability</li>
</ul></li>
</ul></li>
</ol>
<p>The ETL workflow will accept the following parameters</p>
<ol type="1">
<li>start and end date for each data split</li>
<li>dictionary with frequency encoding thresholds and categorical columns to which these thresholds must be applied
<ul>
<li>currently these thresholds are set to 5% and 10% based on the data preparation step</li>
</ul></li>
<li>columns to use when dropping duplicates
<ul>
<li>currently a single column <code>fullvisitorid</code> is used to drop duplicates, based on the data preparation step</li>
</ul></li>
<li>feature datatypes
<ul>
<li>these are neeed before and after encoding categorical features</li>
</ul></li>
<li>path to folder in which to save transformed data
<ul>
<li>this is a path to a folder on the local disk where this analysis is being run</li>
</ul></li>
</ol>
<p>The following components are defined below</p>
<ol type="1">
<li>helper functions to
<ul>
<li>create <code>scikit-learn</code> data transformation pipeline</li>
<li>clean data</li>
</ul></li>
<li>workflow functions to
<ul>
<li>extract raw data from Google BigQuery</li>
<li>transform raw data using <code>scikit-learn</code> data transformation pipeline</li>
<li>load transformed data into file in <code>data/processed</code></li>
</ul></li>
</ol>
<p>Helper functions</p>
<div class="cell" data-tags="[]" data-execution_count="32">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_data_transformation_pipeline(cols_to_group: Dict[<span class="bu">str</span>, List[<span class="bu">str</span>]]) <span class="op">-&gt;</span> Pipeline:</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create sklearn pipeline to transform cleaned data."""</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># define frequency-encoders for categorical columns that will require</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a minimum frequency for categories</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    categorical_transformer <span class="op">=</span> Pipeline(</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        steps<span class="op">=</span>[</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"enc_</span><span class="sc">{</span>(k.split(<span class="st">'_'</span>)[<span class="dv">0</span>])<span class="sc">.</span>zfill(<span class="dv">2</span>)<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>                RareLabelEncoder(</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>                    tol<span class="op">=</span><span class="bu">int</span>(k.split(<span class="st">"_"</span>)[<span class="dv">0</span>]) <span class="op">/</span> <span class="dv">100</span>,</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>                    n_categories<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>                    variables<span class="op">=</span>v,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>                    replace_with<span class="op">=</span><span class="st">"other"</span>,</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> k, v <span class="kw">in</span> cols_to_group.items()</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        transformers<span class="op">=</span>[(<span class="st">"cat"</span>, categorical_transformer, categorical_columns)],</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>        remainder<span class="op">=</span><span class="st">"passthrough"</span>,</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create overall data transformation pipeline</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    pipe <span class="op">=</span> Pipeline(steps<span class="op">=</span>[(<span class="st">"preprocessor"</span>, preprocessor)])</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pipe</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_data(</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame, datatypes_dict: Dict, subset: List[<span class="bu">str</span>]</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Perform data cleaning."""</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> (</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># set column datatypes</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>        df.pipe(set_datatypes, dtypes<span class="op">=</span>datatypes_dict)</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># drop duplicates</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>        .pipe(drop_duplicates, subset<span class="op">=</span>subset)</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Got </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>df<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns "</span> <span class="st">"after dropping duplicates"</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Workflow functions</p>
<div class="cell" data-tags="[]" data-execution_count="33">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_data(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    split_start_date: <span class="bu">str</span>,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    split_end_date: <span class="bu">str</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    train_start_date: <span class="bu">str</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    test_end_date: <span class="bu">str</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Retrieve data from Google BigQuery dataset."""</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> get_sql_query(</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>        split_start_date, split_end_date, train_start_date, test_end_date</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> run_sql_query(query, <span class="op">**</span>gcp_auth_dict, show_df<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> transform_data(</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame,</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    categorical_columns: List[<span class="bu">str</span>],</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    datatypes_dict: Dict,</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    pipe: Union[Pipeline, <span class="va">None</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> List[Union[pd.DataFrame, Pipeline]]:</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Transform features in data."""</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># clean data</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.pipe(clean_data, datatypes_dict<span class="op">=</span>datatypes_dict, subset<span class="op">=</span>[<span class="st">"fullvisitorid"</span>])</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get a list of the non-categorical columns</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    non_categorical_columns <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">list</span>(df) <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> categorical_columns]</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># train a data transformation pipeline to perform frequency-encoding on</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># categorical features in data</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - this is needed for training data split only</span></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pipe:</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=</span> pipe_trans.fit(df)</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply a trained data transformation pipeline to perform frequency-encoding on</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># categorical features in data</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - this is needed for training, validation and test data splits</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    cols_transformed <span class="op">=</span> categorical_columns <span class="op">+</span> non_categorical_columns</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(pipe_trans.transform(df), columns<span class="op">=</span>cols_transformed)[</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>        non_categorical_columns <span class="op">+</span> categorical_columns</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set datatypes after data transformation</span></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.pipe(set_datatypes, dtypes<span class="op">=</span>datatypes_dict)</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Got </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> rows and </span><span class="sc">{</span>df<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">:,}</span><span class="ss"> columns after "</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"frequency-encoding categorical features"</span></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [df, pipe]</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_data(</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame, processed_data_dir: <span class="bu">str</span>, split_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">"train"</span></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Save data to file on local disk."""</span></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>    fpath <span class="op">=</span> os.path.join(processed_data_dir, <span class="ss">f"</span><span class="sc">{</span>split_type<span class="sc">}</span><span class="ss">_processed.parquet.gzip"</span>)</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>    df.to_parquet(fpath, index<span class="op">=</span><span class="va">False</span>, compression<span class="op">=</span><span class="st">"gzip"</span>, engine<span class="op">=</span><span class="st">"pyarrow"</span>)</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Exported data to </span><span class="sc">{</span>fpath<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<p>These workflow functions also depend on the following helper functions (defined earlier in this step)</p>
<ol type="1">
<li><code>set_datatypes()</code></li>
<li><code>drop_duplicates()</code></li>
<li><code>get_sql_query()</code></li>
<li><code>run_sql_query()</code></li>
</ol>
<p>If such a workflow is to be used in future steps in the analysis (eg. ML development), then both the</p>
<ol type="1">
<li>workflow functions</li>
<li>helper functions</li>
</ol>
<p>must be defined in that step.</p>
</div>
</div>
<p>We’ll now demonstrate how this ETL workflow to retrieve and transform data gives the identical output to transformed data using the non-ETL (manual) workflow described earlier in this step.</p>
<p>First, define data transformation pipeline</p>
<div class="cell" data-tags="[]" data-execution_count="34">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> make_data_transformation_pipeline(cols_to_group)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, run ETL workflow to create training data and train the data transformation pipeline</p>
<div class="cell" data-tags="[]" data-execution_count="35">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>df_train_v2, pipe_trained <span class="op">=</span> extract_data(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    train_start_date,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    train_end_date,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    train_start_date,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    test_end_date,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>).pipe(</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    transform_data,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    categorical_columns<span class="op">=</span>categorical_columns,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    datatypes_dict<span class="op">=</span>dtypes_dict,</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    pipe<span class="op">=</span>pipe,</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>df_train_v2.pipe(load_data, processed_data_dir, <span class="st">"train"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:38:48.599...done at 2023-04-13 17:39:06.459 (17.859 seconds).
Query returned 92,859 rows
Got 92,551 rows and 29 columns after dropping duplicates
Got 92,551 rows and 29 columns after frequency-encoding categorical features
Exported data to ../data/processed/train_processed.parquet.gzip</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here, we also collect the trained data transformation pipeline. This can be directly used to transform validation and test data splits without re-training.</p>
</div>
</div>
<p>Next, run ETL workflow to create validation data, with the transformation pipeline that was trained using the training data</p>
<div class="cell" data-tags="[]" data-execution_count="36">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df_val_v2, _ <span class="op">=</span> extract_data(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    val_start_date,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    val_end_date,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    train_start_date,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    test_end_date,</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>).pipe(</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    transform_data,</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    categorical_columns<span class="op">=</span>categorical_columns,</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    datatypes_dict<span class="op">=</span>dtypes_dict,</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    pipe<span class="op">=</span>pipe_trained,</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>df_val_v2.pipe(load_data, processed_data_dir, <span class="st">"val"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:39:07.551...done at 2023-04-13 17:39:12.790 (5.240 seconds).
Query returned 21,208 rows
Got 21,177 rows and 29 columns after dropping duplicates
Got 21,177 rows and 29 columns after frequency-encoding categorical features
Exported data to ../data/processed/val_processed.parquet.gzip</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<p>Here, we do not need to collect the data transformation pipeline since it was already trained using the training data.</p>
</div>
</div>
<p>Finally, run the ETL workflow to create test data, with the transformation pipeline that was trained using the training data</p>
<div class="cell" data-tags="[]" data-execution_count="37">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>df_test_v2, _ <span class="op">=</span> extract_data(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    test_start_date,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    test_end_date,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    train_start_date,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    test_end_date,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>).pipe(</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    transform_data,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    categorical_columns<span class="op">=</span>categorical_columns,</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    datatypes_dict<span class="op">=</span>dtypes_dict,</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    pipe<span class="op">=</span>pipe_trained,</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>df_test_v2.pipe(load_data, processed_data_dir, <span class="st">"test"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:39:13.145...done at 2023-04-13 17:39:18.113 (4.968 seconds).
Query returned 20,180 rows
Got 20,164 rows and 29 columns after dropping duplicates
Got 20,164 rows and 29 columns after frequency-encoding categorical features
Exported data to ../data/processed/test_processed.parquet.gzip</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<p>Again, we do not need to collect the data transformation pipeline since it was already trained using the training data.</p>
</div>
</div>
<p>Verify that the manual and ETL approaches give the identical output for training, validation and test data splits after data transformation</p>
<div class="cell" data-tags="[]" data-execution_count="38">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df_train.equals(df_train_v2)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df_val.equals(df_val_v2)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> df_test.equals(df_test_v2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="summary-of-tasks-performed" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-tasks-performed">Summary of Tasks Performed</h2>
<p>This step performed the following</p>
<ol type="1">
<li>Overall
<ul>
<li>training, validation and test data splits were created that can be used to address the objective of training a ML model to predict a new visitor’s propensity to make a purchase from the merchandise store on the Google Marketplace during February 2017</li>
</ul></li>
<li>Data Transformation
<ul>
<li>Features in the prepared data splits were created at the visit level. Since the objective is to predict propensity to make a purchase during a future visit, features should also be at the level of visits. Based on <a href="https://sporkmarketing.com/376/what-are-visitors-unique-visitors-and-page-views-google-analytics/">Google Analytics’ definition</a>, visits were defined by the combination of the
<ul>
<li><code>fullvisitorid</code></li>
<li><code>visitId</code></li>
<li><code>visitNumber</code></li>
<li><code>visitStartTime</code></li>
</ul>
columns.</li>
</ul></li>
<li>Data Splits
<ul>
<li>the data was split by month of the year</li>
<li>new visitors in the training data, who returned to the Google Merchandise Store during the period of months covering the training data, do not need to also be in the validation or test data splits
<ul>
<li>this is not a problem since the current project’s business use-case is targeting new visitors and not the same/existing visitors</li>
</ul></li>
</ul></li>
<li>Feature Selection
<ul>
<li>The data splits were created using a subset of columns provided for visitor transactions on the store’s website. These columns were selected based on
<ul>
<li>exploratory data analysis preformed in the preceding step</li>
<li>intuition about factors that would be predictive of a new visitor’s propensity (probability) of making a purchase on a future visit to the store</li>
</ul></li>
<li>It might be best to start by training a ML model with one of the General Features (<code>time_on_site</code>, <code>hits</code>, <code>pageviews</code>) and only add more if necessary to improve performance</li>
</ul></li>
<li>Feature Processing
<ul>
<li>approaches to process features were adopted based on frequencies observed in the training data during the EDA step
<ul>
<li>categorical features were bucketed</li>
</ul></li>
<li>based on analysis in the current step
<ul>
<li><code>bounces</code> was shown i a binary column and should be treated as a categorical ML feature</li>
<li>candidates for handling class imbalance during ML training are
<ul>
<li>undersampling</li>
<li>no changes</li>
<li>SMOTE</li>
</ul></li>
</ul></li>
</ul></li>
<li>Defined ETL workflow
<ul>
<li>this supports quickly changing parameters of the data transformation pipeline in each data split during future steps</li>
</ul></li>
</ol>
</section>
<section id="summary-of-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-assumptions">Summary of Assumptions</h2>
<p>None.</p>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<p>None.</p>
</section>
<section id="next-step" class="level2">
<h2 class="anchored" data-anchor-id="next-step">Next Step</h2>
<p>The next step will develop a baseline model using the transformed data splits.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.quarto\.org\/custom");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="../../../notebooks/03-eda/notebooks/03_eda.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Explore Data</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../notebooks/05-development/notebooks/05_development.html" class="pagination-link">
        <span class="nav-page-text">Baseline</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<script src="../../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>