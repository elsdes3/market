<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine Learning Project - Baseline Model Development</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../notebooks/07-create-audience/notebooks/07_create_audience.html" rel="next">
<link href="../../../notebooks/04-transform/notebooks/04_transform.html" rel="prev">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Machine Learning Project</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../notebooks/05-development/notebooks/05_development.html">Baseline</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../../images/lorip_square.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../references/Scope.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scope</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/01-get-data/notebooks/01_get_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Get Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-prepare/notebooks/02_prepare.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prepare Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/03-eda/notebooks/03_eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Explore Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/04-transform/notebooks/04_transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transform Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/05-development/notebooks/05_development.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Baseline</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/07-create-audience/notebooks/07_create_audience.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create Audience</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about" id="toc-about" class="nav-link active" data-scroll-target="#about">About</a>
  <ul class="collapse">
  <li><a href="#objective" id="toc-objective" class="nav-link" data-scroll-target="#objective">Objective</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#baseline-model-requirements" id="toc-baseline-model-requirements" class="nav-link" data-scroll-target="#baseline-model-requirements">Baseline Model Requirements</a></li>
  <li><a href="#baseline-model-choices" id="toc-baseline-model-choices" class="nav-link" data-scroll-target="#baseline-model-choices">Baseline Model Choices</a></li>
  <li><a href="#overall-approach" id="toc-overall-approach" class="nav-link" data-scroll-target="#overall-approach">Overall Approach</a></li>
  <li><a href="#evaluation-metrics" id="toc-evaluation-metrics" class="nav-link" data-scroll-target="#evaluation-metrics">Evaluation Metrics</a></li>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions">Assumptions</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  <li><a href="#notation" id="toc-notation" class="nav-link" data-scroll-target="#notation">Notation</a></li>
  </ul></li>
  <li><a href="#user-inputs" id="toc-user-inputs" class="nav-link" data-scroll-target="#user-inputs">User Inputs</a></li>
  <li><a href="#get-data" id="toc-get-data" class="nav-link" data-scroll-target="#get-data">Get Data</a></li>
  <li><a href="#get-features-and-label" id="toc-get-features-and-label" class="nav-link" data-scroll-target="#get-features-and-label">Get Features and Label</a></li>
  <li><a href="#ml-pipelines" id="toc-ml-pipelines" class="nav-link" data-scroll-target="#ml-pipelines">ML Pipelines</a>
  <ul class="collapse">
  <li><a href="#custom-classifier" id="toc-custom-classifier" class="nav-link" data-scroll-target="#custom-classifier">Custom Classifier</a></li>
  <li><a href="#built-in-dummy-classifier" id="toc-built-in-dummy-classifier" class="nav-link" data-scroll-target="#built-in-dummy-classifier">Built-In Dummy Classifier</a></li>
  <li><a href="#handling-missing-values" id="toc-handling-missing-values" class="nav-link" data-scroll-target="#handling-missing-values">Handling Missing Values</a></li>
  <li><a href="#feature-selection" id="toc-feature-selection" class="nav-link" data-scroll-target="#feature-selection">Feature Selection</a></li>
  <li><a href="#feature-processing" id="toc-feature-processing" class="nav-link" data-scroll-target="#feature-processing">Feature Processing</a></li>
  <li><a href="#end-to-end-ml-pipelines" id="toc-end-to-end-ml-pipelines" class="nav-link" data-scroll-target="#end-to-end-ml-pipelines">End-to-End ML Pipelines</a></li>
  </ul></li>
  <li><a href="#ml-training-using-validation-data" id="toc-ml-training-using-validation-data" class="nav-link" data-scroll-target="#ml-training-using-validation-data">ML Training using Validation Data</a>
  <ul class="collapse">
  <li><a href="#splitting-data-for-validation" id="toc-splitting-data-for-validation" class="nav-link" data-scroll-target="#splitting-data-for-validation">Splitting Data for Validation</a></li>
  <li><a href="#hyperparameter-tuning" id="toc-hyperparameter-tuning" class="nav-link" data-scroll-target="#hyperparameter-tuning">HyperParameter Tuning</a></li>
  <li><a href="#metrics-for-model-scoring" id="toc-metrics-for-model-scoring" class="nav-link" data-scroll-target="#metrics-for-model-scoring">Metrics for Model Scoring</a></li>
  <li><a href="#extracting-best-baseline-model" id="toc-extracting-best-baseline-model" class="nav-link" data-scroll-target="#extracting-best-baseline-model">Extracting Best Baseline Model</a></li>
  </ul></li>
  <li><a href="#ml-evaluation" id="toc-ml-evaluation" class="nav-link" data-scroll-target="#ml-evaluation">ML Evaluation</a>
  <ul class="collapse">
  <li><a href="#make-predictions" id="toc-make-predictions" class="nav-link" data-scroll-target="#make-predictions">Make Predictions</a></li>
  <li><a href="#get-true-and-predicted-class-imbalance" id="toc-get-true-and-predicted-class-imbalance" class="nav-link" data-scroll-target="#get-true-and-predicted-class-imbalance">Get True and Predicted Class Imbalance</a></li>
  <li><a href="#score-predictions" id="toc-score-predictions" class="nav-link" data-scroll-target="#score-predictions">Score Predictions</a></li>
  <li><a href="#post-processing-of-model-evaluation" id="toc-post-processing-of-model-evaluation" class="nav-link" data-scroll-target="#post-processing-of-model-evaluation">Post-Processing of Model Evaluation</a></li>
  <li><a href="#assessing-evaluation-metrics-by-sub-category-for-all-categorical-features" id="toc-assessing-evaluation-metrics-by-sub-category-for-all-categorical-features" class="nav-link" data-scroll-target="#assessing-evaluation-metrics-by-sub-category-for-all-categorical-features">Assessing Evaluation Metrics by Sub-Category for All Categorical Features</a></li>
  <li><a href="#distribution-of-predicted-probabilities-and-resulting-class-imbalance" id="toc-distribution-of-predicted-probabilities-and-resulting-class-imbalance" class="nav-link" data-scroll-target="#distribution-of-predicted-probabilities-and-resulting-class-imbalance">Distribution of Predicted Probabilities and Resulting Class Imbalance</a></li>
  </ul></li>
  <li><a href="#export-to-disk" id="toc-export-to-disk" class="nav-link" data-scroll-target="#export-to-disk">Export to Disk</a></li>
  <li><a href="#summary-of-tasks-performed" id="toc-summary-of-tasks-performed" class="nav-link" data-scroll-target="#summary-of-tasks-performed">Summary of Tasks Performed</a></li>
  <li><a href="#key-findings" id="toc-key-findings" class="nav-link" data-scroll-target="#key-findings">Key Findings</a></li>
  <li><a href="#summary-of-assumptions" id="toc-summary-of-assumptions" class="nav-link" data-scroll-target="#summary-of-assumptions">Summary of Assumptions</a></li>
  <li><a href="#limitations-1" id="toc-limitations-1" class="nav-link" data-scroll-target="#limitations-1">Limitations</a></li>
  <li><a href="#next-step" id="toc-next-step" class="nav-link" data-scroll-target="#next-step">Next Step</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/elsdes3/market/blob/main/notebooks/05-development/notebooks/05_development.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/elsdes3/market/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Baseline Model Development</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Import Python modules</p>
<div class="cell" data-tags="[]" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, Union</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn.metrics <span class="im">as</span> skm</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> imblearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, ClassifierMixin</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.dummy <span class="im">import</span> DummyClassifier</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV, PredefinedSplit</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> FunctionTransformer</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils <span class="im">import</span> check_array, check_random_state</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils.estimator_checks <span class="im">import</span> check_estimator</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils.multiclass <span class="im">import</span> unique_labels</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils.validation <span class="im">import</span> check_X_y, check_array, check_is_fitted</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="about" class="level2">
<h2 class="anchored" data-anchor-id="about">About</h2>
<section id="objective" class="level3">
<h3 class="anchored" data-anchor-id="objective">Objective</h3>
<p>This step trains a baseline model for predicting visitors’ <a href="https://blog.hubspot.com/agency/predictive-analytics-buyhttps://blog.hubspot.com/agency/predictive-analytics-buy">propensity to make a purchase on a future visit</a> to the merchandise store on the Google Marketplace, using binary classification.</p>
<p>In ML terms, propensity is the likelihood to buy on a return visit and <a href="https://www.analyticsvidhya.com/blog/2021/06/streamlit-for-ml-web-applications-customers-propensity-to-purchase/https://www.analyticsvidhya.com/blog/2021/06/streamlit-for-ml-web-applications-customers-propensity-to-purchase/">this comes from the prediction probability</a>, which is the <a href="https://discuss.analyticsvidhya.com/t/what-is-the-difference-between-predict-and-predict-proba/67376/4https://discuss.analyticsvidhya.com/t/what-is-the-difference-between-predict-and-predict-proba/67376/4">probability that a predicted outcome belongs to one of the two known binary classes</a> (in the current case, the known classes are will or will not purchase on future visit).</p>
</section>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>Currently, three data splits with transformed data were created by the previous step</p>
<ol type="1">
<li>train</li>
<li>validation</li>
<li>test</li>
</ol>
<p>Predictive models will be developed using the training data split and validated against the validation data split. This will be used to optimize hyperparameters.</p>
<p>Based on validation scores, the best</p>
<ol type="1">
<li>model</li>
<li>features</li>
</ol>
<p>will then be</p>
<ol type="1">
<li>trained using the combined training and validation split</li>
<li>evaluated using the test split</li>
</ol>
<p>This workflow is used for</p>
<ol type="1">
<li>Baseline model development (this step)
<ul>
<li>features are not used</li>
</ul></li>
<li>Machine Learning (next step)
<ul>
<li>features will be used</li>
</ul></li>
</ol>
</section>
<section id="baseline-model-requirements" class="level3">
<h3 class="anchored" data-anchor-id="baseline-model-requirements">Baseline Model Requirements</h3>
<p>In this project, ML is used to predict visitor propensity (probability) so the chosen baseline distribution must produce a <a href="https://www.statology.org/left-skewed-vs-right-skewed/">right-skewed</a> distribution (histogram) of probabilities. This would indicate that most visitors are predicted to have close to a zero percent probability of making a purchase on a return visit, which is what we saw during EDA in a previous step.</p>
<p>With this in mind, we have the following two requirements of a suitable baseline model for predicting visitors’ propensity to make a purchase on a future visit 1. If we use a <a href="https://datascience.stackexchange.com/a/5026/17543">binary classification discrimination threshold</a> of 0.5, then a right-skewed histogram of probabilities will result in most visitors having a probablity of less than the threshold (0.5) meaning they would be classified as <em>not likely to make a purchase on a return visit to the merchandise store</em>. This would lead to a predicted class imbalance, which is what we want since we observed this class imbalance in the training data. However, just having a class imbalance is not enough. We need a strong class imbalance since approximately 5% of visitors were observed to make a purchase on a return visit. So, we need to modify the the skew (shape) of the baseline distribution that is chosen to match this expected class imbalance seen in the training data. 2. Since we require probabilities, we need to choose a distribution that can be produce floating point values in the range of 0.0 to 1.0.</p>
</section>
<section id="baseline-model-choices" class="level3">
<h3 class="anchored" data-anchor-id="baseline-model-choices">Baseline Model Choices</h3>
<p>A normal distribution histogram would have a peak in the center, which would indicate that most visitors have between a 25% and 75% chance of making a return purchase, with the peak at 50%. This would not give a strongly right-skewed histogram. In turn, this would not give a strong class imbalance. So, a normal distribution is not a suitable distribution for baseline predictions of visitors’ propensity to make a return purchase. By comparison, a <code>beta</code> distribution’s hyperparameters (<code>a</code> and <code>b</code>) can be chosen to skew the histogram so that most customers have a low probability (propensity) to make a return purchase. This is more realistic for the current use-case and we would want to choose its hyperparameters to give a class balance of close to 95%-5%. For these reasons, an appropriately shaped <code>beta</code> (skewed) distribution is a suitable baseline model for the current use-case.</p>
<p>In order to do this, we will generate randomly sampled predicted probablities (propensity scores) from the <code>beta</code> distribution (<a href="https://byjus.com/maths/probability-distribution/">1</a>, <a href="https://en.wikipedia.org/wiki/Probability_distribution">2</a>) that is <a href="https://www.cambridgemaths.org/blogs/skewed-usage-skewed-distribution/">strongly right skewed (positive skew)</a>. In Python, this can be done using</p>
<ol type="1">
<li><code>scipy</code>, under the <code>scipy.stats</code> module (see the <a href="https://byjus.com/maths/beta-distribution/"><em>beta distribution</em></a> documentation for the <code>scipy</code> package)</li>
<li><code>numpy</code>, through <code>numpy.random.beta()</code> (<a href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.beta.html">link</a>)</li>
</ol>
<p><code>sklearn</code> offers a <code>DummyClassifier</code> (<a href="https://scikit-learn.org/stable/modules/generated/sklearn.dummy.DummyClassifier.html">link</a>) that is able to randomly make predictions naively. One naive strategy to make predictions is called <code>stratified</code>, which generates predictions that are close to the class imbalance observed in the labels (<code>y</code>). This is another suitable choice here due to the imbalance obseved during data preparation. Here, the predicted probabilities are either 0s or 1s since this model makes predictions naively and it is only intended for use as a baseline.</p>
</section>
<section id="overall-approach" class="level3">
<h3 class="anchored" data-anchor-id="overall-approach">Overall Approach</h3>
<p>During baseline model developmen (or validation), the <code>a</code> and <code>b</code> hyperparameters of the <code>beta</code> distribution (baselline model) will be optimized using the validation data. Since this is a baseline model, model training is not required so ML features are not used. Instead, the predicted probabilities (propensities) will be randomly sampled from the <code>beta</code> distribution. Hyperparameter optimization is required so that the shape of the distribution is chosen to match the class imbalance seen in the validation data. During baseline model evaluation, the <code>beta</code> distribution (baseline model) with the best hyperparameters will be used to make predictions of visitors’ probabilities (propensities) of a future purchase in the test data.</p>
<p>For the built-in <code>sklearn</code> <code>DummyClassifier</code>, the optimal choice of hyperparameter is <code>stratified</code>, so no hyperparameter tuning is performed for this baseline model.</p>
</section>
<section id="evaluation-metrics" class="level3">
<h3 class="anchored" data-anchor-id="evaluation-metrics">Evaluation Metrics</h3>
<p>Due to the class imbalance, evaluation metrics can be difficult to interpret. The precision will generally be very low since there are so few minority class observations in the training data (we assume this is similar to the distribution in the validation and test splits).</p>
<p>Based on this constraint about class imbalance, we will choose the following metrics</p>
<ol type="1">
<li>F0.5-score (places more weight on precision than recall)
<ul>
<li>in the project scope, this was identified to be the primary ML metric</li>
</ul></li>
<li>Area under the precision recall curve
<ul>
<li>this is ideal for imbalanced data, where the priority is on maximizing the precision and recall of the minority class</li>
</ul></li>
<li>uplift
<ul>
<li>sort visitors in validation or test data split by predicted probability score
<ul>
<li>the predicted probability score comes from the baseline model (randomly sampled values between 0 and 1 from the beta distribution) or ML model</li>
</ul></li>
<li>divide visitors into 20 percentiles (or ventiles) based on the sorted probability score</li>
<li>calculate uplift as the ratio of the average minority class probability in the top 5% (best performing ventile) to the average minority class probability across all ventiles</li>
<li>the interpretation of <code>uplift</code> is the factor by which the baseline or ML model is more effective than a random model
<ul>
<li>a random model would draw from a normal distribution, which does not have a histogram of prediction probabilities that is correctly shaped to reflect visitor buying patterns (class balance) that we saw during EDA</li>
<li>due to this, all baseline models explored in this step will be better than a random model</li>
</ul></li>
<li>the model with the best performance will have the highest uplift</li>
</ul></li>
</ol>
</section>
<section id="assumptions" class="level3">
<h3 class="anchored" data-anchor-id="assumptions">Assumptions</h3>
<ol type="1">
<li>The class distribution (or class balance) seen in the training data (explored during EDA) is similar to the distribution in the validation and test data splits.</li>
</ol>
</section>
<section id="limitations" class="level3">
<h3 class="anchored" data-anchor-id="limitations">Limitations</h3>
<ol type="1">
<li>The definition of uplift does not make a comparison of the predicted and true class labels. Instead, it only defines ventiles based on the predicted probability. This is acceptable since uplift is meant to compare a model’s predictive power to a random model. However, this also means it is possible to have a non-zero uplift with an inaccurate model. For this reason, the other metric (area under the precision-recall curve and F0.5-score) must also be used to evaluate model performance, in addition to uplift.</li>
</ol>
</section>
<section id="notation" class="level3">
<h3 class="anchored" data-anchor-id="notation">Notation</h3>
<ol type="1">
<li>Hard predictions refer to class labels (0, 1 or <code>True</code>, <code>False</code>). Soft predictions refer to prectited probabilities (floating point values between 0 and 1).</li>
<li>To convert soft predictions to hard labels, a fixed discrimination threshold of 0.5 will be used.</li>
</ol>
</section>
</section>
<section id="user-inputs" class="level2">
<h2 class="anchored" data-anchor-id="user-inputs">User Inputs</h2>
<p>Get relative path to project root directory</p>
<div class="cell" data-tags="[]" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>PROJ_ROOT_DIR <span class="op">=</span> os.path.join(os.pardir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the different types of features in the transformed data</p>
<ol type="1">
<li>categoricals</li>
<li>numericals</li>
<li>categorical features not used in this step</li>
<li>metadata features (visit ID, visit number, etc.) for each visit</li>
<li><code>datetime</code> features not used in this step</li>
</ol>
<div class="cell" data-tags="[&quot;parameters&quot;]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deviceCategory"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bounces"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"channelGrouping"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"medium"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>numerical_features <span class="op">=</span> [</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hits"</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_displayed"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_clicked"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_views"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_clicks"</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pageviews"</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"time_on_site"</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>categorical_features_unused <span class="op">=</span> [<span class="st">"last_action"</span>]</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>metadata_features_unused <span class="op">=</span> [</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fullvisitorid"</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitId"</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitNumber"</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitStartTime"</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>datetime_features_unused <span class="op">=</span> [</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quarter"</span>,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month"</span>,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_month"</span>,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_week"</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour"</span>,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minute"</span>,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"second"</span>,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get path to <code>data/processed</code> in which the transformed data splits (training, validation and test) produced by the (preceding) data transformation step were exported</p>
<div class="cell" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"data"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>processed_data_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"data"</span>, <span class="st">"processed"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>models_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"models"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define a Python helper function to change probabilities into labels, using a user-specified discrimination threshold</p>
<div class="cell" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert_soft_to_hard_labels(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    y_pred_proba: pd.Series, disc_threshold: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert probabilities to labels."""</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> (y_pred_proba <span class="op">&gt;</span> disc_threshold).astype(<span class="bu">int</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below is a helper function to calculate the uplift based on ventiles. The approach used is as follows</p>
<ol type="1">
<li>calculate the average predicted probablity (visitor propensity to purchase on future visit) per ventiles</li>
<li>extract the average predicted probablity of the top ventile</li>
<li>get the average predicted probability across all ventiles</li>
<li>take the ratio of 2. and 3. above to get the uplift</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_uplift_score_using_ventiles(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame, num_quantiles: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate uplift score using ventiles."""</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. get average probability score of minority class for all ventiles</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    df_class_1_avg_score_by_ventile <span class="op">=</span> (</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        df.query(<span class="st">"true == True"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"ventile"</span>], as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        .agg({<span class="st">"pred_proba"</span>: <span class="st">"mean"</span>})</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"pred_proba"</span>: <span class="st">"avg_score"</span>})</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. get average probability score of minority class for top ventile</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (numerator of uplift formula)</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    df_class_1_avg_score_top_ventile <span class="op">=</span> df_class_1_avg_score_by_ventile.query(</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"ventile == </span><span class="sc">{</span>num_quantiles<span class="op">-</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> df_class_1_avg_score_top_ventile.empty:</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        avg_score_top_ventile <span class="op">=</span> df_class_1_avg_score_top_ventile[<span class="st">"avg_score"</span>].squeeze()</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        avg_score_top_ventile <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. get average probability score of minority class for all ventiles</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (denominator of uplift formula)</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    avg_score_all_ventiles <span class="op">=</span> df.query(<span class="st">"true == True"</span>)[<span class="st">"pred_proba"</span>].mean()</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. use ratio to calculate uplift score</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    uplift_score <span class="op">=</span> avg_score_top_ventile <span class="op">/</span> avg_score_all_ventiles</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> uplift_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A helper function is defined to retrieve the following metrics that were discussed earlier</p>
<ol type="1">
<li>area under precision recall curve</li>
<li>uplift score
<ul>
<li>this function generates ventiles and then calls <code>calculate_uplift_score_using_ventiles()</code> to calculate this metric</li>
</ul></li>
</ol>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_pr_auc(y_true, y_pred_proba, sample_weights) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""."""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    precision, recall, _ <span class="op">=</span> skm.precision_recall_curve(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        y_true, y_pred_proba, pos_label<span class="op">=</span><span class="dv">1</span>, sample_weight<span class="op">=</span>sample_weights</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    auc_score <span class="op">=</span> skm.auc(recall, precision)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> auc_score</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_uplift_score(</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    y_true: np.ndarray, y_pred_proba: np.ndarray, num_ventiles: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Assign ventiles to predicted probabilities and get uplift."""</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create DataFrame with reverse-sorted ventiles</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> (</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># create DataFrame from true labels and predicted probabilities</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame(</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            <span class="bu">zip</span>(<span class="op">*</span>[y_true, y_pred_proba]),</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>[<span class="st">"true"</span>, <span class="st">"pred_proba"</span>],</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert soft predictions to hard labels</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        .assign(pred<span class="op">=</span><span class="kw">lambda</span> df: (df[<span class="st">"pred_proba"</span>] <span class="op">&gt;</span> <span class="fl">0.5</span>).astype(<span class="bu">int</span>))</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># assign ventile</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>            ventile<span class="op">=</span><span class="kw">lambda</span> df: pd.qcut(x<span class="op">=</span>df[<span class="st">"pred_proba"</span>], q<span class="op">=</span>num_ventiles, labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sort in descending order of predicted probability</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        .sort_values(by<span class="op">=</span>[<span class="st">"pred_proba"</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate uplift score</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    uplift_score <span class="op">=</span> calculate_uplift_score_using_ventiles(df, num_ventiles)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> uplift_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>This calculation of <code>uplift</code> requires a <code>DataFrame</code> with the ventiles assigned to each visitor, based on the predicted probability (<code>pred_proba</code> column). Ventile number should be a column with the name <code>ventile</code>. For ventiles, each bin has a width of 5%. Ventiles are assigned using <code>pandas.cut()</code> with q=20 (<a href="https://pandas.pydata.org/docs/reference/api/pandas.qcut.html">link</a>), so the ventile column has values in the range of 0 to 19 where 19 corresponds to the top ventile (visitors who made a purchase on their return visit to the store who are also in the top 5% of predicted probability scores).</li>
</ol>
</div>
</div>
<p>A helper function is defined to get the following metrics</p>
<ol type="1">
<li>evaluation metrics relevant to the use-case
<ul>
<li>F0.5-score (places more weight on precision than recall)
<ul>
<li>provided by <code>sklearn</code></li>
</ul></li>
<li>Area under the precision recall curve
<ul>
<li>using custom helper function above</li>
</ul></li>
<li>uplift
<ul>
<li>using custom helper function above</li>
</ul></li>
</ul></li>
<li>other evaluation metrics that are provided by <code>sklearn</code> (for informational purposes only)
<ul>
<li>accuracy</li>
<li>balanced accuracy</li>
<li>precision</li>
<li>recall</li>
<li>F1-score (places equal weight on precision and recall)</li>
<li>F2-score (places more weight on recall than precision)</li>
<li>brier score</li>
</ul></li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_metrics(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    y_true, y_pred, y_pred_proba, average<span class="op">=</span><span class="st">"binary"</span>, zero_division<span class="op">=</span><span class="st">"warn"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">float</span>]:</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate sklearn evaluation metrics."""</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    sample_weights <span class="op">=</span> <span class="va">None</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get area under precision-recall curve</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    pr_auc_score <span class="op">=</span> get_pr_auc(y_true, y_pred_proba, sample_weights)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># assemble summary dict to compute metrics</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    metrics_dict <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># accuracy</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        accuracy<span class="op">=</span>skm.accuracy_score(y_true, y_pred),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># balanced accuracy</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        balanced_accuracy<span class="op">=</span>skm.balanced_accuracy_score(y_true, y_pred),</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># precision</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        precision<span class="op">=</span>skm.precision_score(</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>            y_true,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>            y_pred,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>            average<span class="op">=</span>average,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>            sample_weight<span class="op">=</span>sample_weights,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span>zero_division,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># recall</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        recall<span class="op">=</span>skm.recall_score(</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            y_true,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>            y_pred,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>            average<span class="op">=</span>average,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>            sample_weight<span class="op">=</span>sample_weights,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span>zero_division,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># f1</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        f1<span class="op">=</span>skm.f1_score(</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            y_true,</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>            y_pred,</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>            average<span class="op">=</span>average,</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>            sample_weight<span class="op">=</span>sample_weights,</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span>zero_division,</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># f-0.5</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        f05<span class="op">=</span>skm.fbeta_score(</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>            y_true,</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>            y_pred,</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>            beta<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>            average<span class="op">=</span>average,</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>            sample_weight<span class="op">=</span>sample_weights,</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span>zero_division,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># f2</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        f2<span class="op">=</span>skm.fbeta_score(</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>            y_true,</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>            y_pred,</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>            beta<span class="op">=</span><span class="fl">2.0</span>,</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>            average<span class="op">=</span>average,</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>            sample_weight<span class="op">=</span>sample_weights,</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span>zero_division,</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># brier score</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>        brier<span class="op">=</span>skm.brier_score_loss(</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>            y_true, y_pred, sample_weight<span class="op">=</span>sample_weights, pos_label<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># area under precision-recall curve (calculated above)</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>        pr_auc<span class="op">=</span>pr_auc_score,</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> metrics_dict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>For <code>average</code>, the value chosen is binary so that the metric is calculated and returned for the minority class (visitor made purchase on return visit to merchandise store) only.</li>
<li>sample weights are not used to calculate the metrics.</li>
</ol>
</div>
</div>
<p>Below is a wrapper function that calls the two helper functions defined above in order to calculate</p>
<ol type="1">
<li>various evaluation metrics</li>
<li>percent difference beteeen class imbalance in true and predicted data</li>
<li>metadata</li>
</ol>
<p>The four steps in this function are</p>
<ol type="1">
<li>call <code>get_metrics()</code> in order to compute metrics</li>
<li>call <code>calculate_uplift_score_using_ventiles()</code> in order to compute uplift</li>
<li>calculate the percent difference between the true and predicted class imbalance</li>
<li>get metadata
<ul>
<li>model hyperparameters
<ul>
<li>type of model (baseline or ML)</li>
</ul></li>
</ul></li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_metrics(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    y_true: pd.Series,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    y_pred: pd.Series,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    y_pred_proba: pd.Series,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    params: Dict[<span class="bu">str</span>, Union[<span class="bu">int</span>, <span class="bu">float</span>]],</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    num_quantiles: <span class="bu">int</span> <span class="op">=</span> <span class="dv">20</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    model_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">"baseline"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    average: <span class="bu">str</span> <span class="op">=</span> <span class="st">"binary"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    zero_division: <span class="bu">str</span> <span class="op">=</span> <span class="st">"warn"</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">float</span>]:</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Score predicted values against true values."""</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. standard metrics</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> get_metrics(</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        y_true,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        y_pred,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        y_pred_proba,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        average<span class="op">=</span>average,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        zero_division<span class="op">=</span>zero_division,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. uplift score</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    uplift_score <span class="op">=</span> calculate_uplift_score_using_ventiles(df, num_quantiles)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. percent difference between true and predicted class imbalance</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    scores.update(</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"uplift"</span>: uplift_score,</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"true_class_imbalance"</span>: y_true.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>            .to_frame()</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>            .transpose()</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>            .assign(class_imbalance<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="va">False</span>] <span class="op">/</span> df[<span class="va">True</span>])[<span class="st">"class_imbalance"</span>]</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>            .squeeze(),</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">"pred_class_imbalance"</span>: y_pred.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>            .to_frame()</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>            .transpose()</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>            .assign(class_imbalance<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="va">False</span>] <span class="op">/</span> df[<span class="va">True</span>])[<span class="st">"class_imbalance"</span>]</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>            .squeeze(),</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    scores.update(</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">"pct_chg_class_imbalance"</span>: <span class="dv">100</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>            <span class="op">*</span> (scores[<span class="st">"pred_class_imbalance"</span>] <span class="op">-</span> scores[<span class="st">"true_class_imbalance"</span>])</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">/</span> scores[<span class="st">"true_class_imbalance"</span>]</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. metadata</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    scores.update({<span class="st">"params"</span>: json.dumps(params), <span class="st">"model_type"</span>: model_type})</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Below is a helper function to customize the axes of a <code>matplotlib</code> plot</p>
<div class="cell" data-tags="[]" data-execution_count="11">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> customize_axis(ax) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Customize matplotlib axis properties."""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"left"</span>].set_edgecolor(<span class="st">"black"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"left"</span>].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"bottom"</span>].set_edgecolor(<span class="st">"black"</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"bottom"</span>].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"top"</span>].set_edgecolor(<span class="st">"whitesmoke"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"top"</span>].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"right"</span>].set_edgecolor(<span class="st">"whitesmoke"</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"right"</span>].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    ax.grid(which<span class="op">=</span><span class="st">"both"</span>, axis<span class="op">=</span><span class="st">"both"</span>, color<span class="op">=</span><span class="st">"gainsboro"</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-data" class="level2">
<h2 class="anchored" data-anchor-id="get-data">Get Data</h2>
<p>Load the transformed data for the training, validation and test data splits</p>
<div class="cell" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> pd.read_parquet(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    os.path.join(processed_data_dir, <span class="st">"train_processed.parquet.gzip"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>df_val <span class="op">=</span> pd.read_parquet(os.path.join(processed_data_dir, <span class="st">"val_processed.parquet.gzip"</span>))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> pd.read_parquet(</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    os.path.join(processed_data_dir, <span class="st">"test_processed.parquet.gzip"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>df_test.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>6667770433164438858</td>
<td>1487630668</td>
<td>1</td>
<td>2017-02-20 14:44:28</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>20</td>
<td>2</td>
<td>14</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>861894924191702840</td>
<td>1486761793</td>
<td>1</td>
<td>2017-02-10 13:23:13</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>10</td>
<td>6</td>
<td>13</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>987663115799971454</td>
<td>1487812839</td>
<td>1</td>
<td>2017-02-22 17:20:39</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>22</td>
<td>4</td>
<td>17</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>7090908358039029290</td>
<td>1487412580</td>
<td>1</td>
<td>2017-02-18 02:09:40</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>18</td>
<td>7</td>
<td>2</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>other</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>294074179132707998</td>
<td>1487899413</td>
<td>1</td>
<td>2017-02-23 17:23:33</td>
<td>United States</td>
<td>1</td>
<td>2</td>
<td>23</td>
<td>5</td>
<td>17</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>other</td>
<td>other</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
</tbody>
</table>

<p>5 rows × 29 columns</p>
</div>
</div>
</div>
<p>Create a new split with the combination of the training and validation data splits</p>
<div class="cell" data-tags="[]" data-execution_count="13">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_train_val <span class="op">=</span> pd.concat(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    [df_train.assign(split<span class="op">=</span><span class="st">"train"</span>), df_val.assign(split<span class="op">=</span><span class="st">"val"</span>)], ignore_index<span class="op">=</span><span class="va">True</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The <code>split</code> column is appended at the end of the training data split and it contains the string <code>'train'</code>. This is repeated for the validation split. This is done so we can filter out each of the three splits (train and validation) later.</li>
<li>The best hyperparameters will be determined by training a model on the training split and scoring its predictions on the validation split. The best hyperparameters are those for the model with the highest score on the validation split. Using the best hyperparameters, the model is then trained on the combined training and validation split (<code>df_train_val</code>) and then evaluated against the test split. For this reason, <code>df_train_val</code> has been created here.</li>
</ol>
</div>
</div>
<p>Shuffle the data in the</p>
<ol type="1">
<li>combined training and validation</li>
<li>test</li>
</ol>
<p>data splits</p>
<div class="cell" data-tags="[]" data-execution_count="14">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df_train_val <span class="op">=</span> df_train_val.sample(frac<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span><span class="dv">88</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> df_test.sample(frac<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span><span class="dv">88</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Baseline model development will be performed using this combined training and validation split. The best baseline model will be evaluated using the test data split.</p>
</section>
<section id="get-features-and-label" class="level2">
<h2 class="anchored" data-anchor-id="get-features-and-label">Get Features and Label</h2>
<p>Separate features from the target in the train and validation splits</p>
<div class="cell" data-tags="[]" data-execution_count="15">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> df_train_val.query(<span class="st">"split == 'train'"</span>).drop(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>)[numerical_features]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> df_train_val.query(<span class="st">"split == 'train'"</span>)[</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"made_purchase_on_future_visit"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>].astype(<span class="bu">int</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> df_train_val.query(<span class="st">"split == 'val'"</span>).drop(</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>)[numerical_features]</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>y_val <span class="op">=</span> df_train_val.query(<span class="st">"split == 'val'"</span>)[<span class="st">"made_purchase_on_future_visit"</span>].astype(</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">int</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Separate features from the target in the combined train-validation split</p>
<div class="cell" data-tags="[]" data-execution_count="16">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>X_train_val <span class="op">=</span> df_train_val.drop(columns<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>])[</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    numerical_features</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>y_train_val <span class="op">=</span> df_train_val[<span class="st">"made_purchase_on_future_visit"</span>].astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Separate features from the target in the test split</p>
<div class="cell" data-tags="[]" data-execution_count="17">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> df_test.drop(columns<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>])[numerical_features]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> df_test[<span class="st">"made_purchase_on_future_visit"</span>].astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ml-pipelines" class="level2">
<h2 class="anchored" data-anchor-id="ml-pipelines">ML Pipelines</h2>
<section id="custom-classifier" class="level3">
<h3 class="anchored" data-anchor-id="custom-classifier">Custom Classifier</h3>
<p>Define a <a href="https://scikit-learn.org/stable/developers/develop.html#random-numbers"><code>sklearn</code> custom estimator</a> that randomly draws samples from the <a href="https://en.wikipedia.org/wiki/Beta_distribution"><code>beta</code> distribution</a> using the <a href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.Generator.beta.html#numpy.random.Generator.beta"><code>beta</code> method</a> of a <a href="https://numpy.org/doc/stable/reference/random/generator.html#numpy.random.Generator"><code>numpy</code> random generator</a>.</p>
<div class="cell" data-tags="[]" data-execution_count="18">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BetaDistClassifier(BaseEstimator, ClassifierMixin):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Make predictions based on a continuous beta probability distribution."""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        threshold: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        a: <span class="bu">float</span> <span class="op">=</span> <span class="fl">2.31</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        b: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.627</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Initializes BetaDistClassifier.</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">            a: alpha parameter of beta distribution</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">            b: beta parameter of beta distribution</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">            threshold: classification discrimination threshold</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">            random_state: Controls randomness when sampling from beta distribution</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.random_state <span class="op">=</span> random_state</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.threshold <span class="op">=</span> threshold</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.a <span class="op">=</span> a</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.b <span class="op">=</span> b</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y):</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Fit estimator."""</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.n_features_in_ = X.shape[1]</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># self.feature_names_in_ = X.columns.to_numpy()</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check that X and y have correct shape</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        X, y <span class="op">=</span> check_X_y(X, y)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store the classes seen during fit</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.classes_ <span class="op">=</span> unique_labels(y)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X_ <span class="op">=</span> X</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.y_ <span class="op">=</span> y</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.random_state_ <span class="op">=</span> check_random_state(<span class="va">self</span>.random_state)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># set attribute for scikit-learn</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fitted_ <span class="op">=</span> <span class="va">True</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict_proba(<span class="va">self</span>, X):</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if fit has been called</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>        check_is_fitted(<span class="va">self</span>)</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Input validation</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> check_array(X)</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># randomly sample from beta distribution with specified params a and b</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>        n_samples <span class="op">=</span> X.shape[<span class="dv">0</span>]</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>        y_proba <span class="op">=</span> <span class="va">self</span>.random_state_.beta(a<span class="op">=</span><span class="va">self</span>.a, b<span class="op">=</span><span class="va">self</span>.b, size<span class="op">=</span>n_samples)</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># return 2D array for predictions per class (1st column is majority class</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># and second column is minority class)</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>        y_proba <span class="op">=</span> np.stack([<span class="dv">1</span> <span class="op">-</span> y_proba, y_proba]).T</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> y_proba</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, X):</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Predict class for X."""</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if fit has been called</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>        check_is_fitted(<span class="va">self</span>)</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Input validation</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> check_array(X)</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get class labels from predicted probabilities</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> (<span class="va">self</span>.predict_proba(X) <span class="op">&gt;</span> <span class="va">self</span>.threshold).astype(<span class="bu">int</span>)[:, <span class="dv">1</span>]</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> y</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_params(<span class="va">self</span>, deep<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get parameters for this estimator."""</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">"a"</span>: <span class="va">self</span>.a,</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>            <span class="st">"b"</span>: <span class="va">self</span>.b,</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>            <span class="st">"threshold"</span>: <span class="va">self</span>.threshold,</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>            <span class="st">"random_state"</span>: <span class="va">self</span>.random_state,</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_params(<span class="va">self</span>, <span class="op">**</span>parameters):</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Set the parameters of this estimator."""</span></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> parameter, value <span class="kw">in</span> parameters.items():</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>            <span class="bu">setattr</span>(<span class="va">self</span>, parameter, value)</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-tags="[]" data-execution_count="19">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>clf_beta <span class="op">=</span> BetaDistClassifier(a<span class="op">=</span><span class="fl">0.25</span>, b<span class="op">=</span><span class="fl">2.371</span>, random_state<span class="op">=</span><span class="dv">88</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="built-in-dummy-classifier" class="level3">
<h3 class="anchored" data-anchor-id="built-in-dummy-classifier">Built-In Dummy Classifier</h3>
<p>Define the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.dummy.DummyClassifier.html"><code>sklearn</code> built-in <code>DummyClassifier</code></a> with <code>stratified</code> sampling to replicate the class-imbalance observed in the training data</p>
<div class="cell" data-tags="[]" data-execution_count="20">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>clf_dummy <span class="op">=</span> DummyClassifier(strategy<span class="op">=</span><span class="st">"stratified"</span>, random_state<span class="op">=</span><span class="dv">88</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="handling-missing-values" class="level3">
<h3 class="anchored" data-anchor-id="handling-missing-values">Handling Missing Values</h3>
<p>Missing values are not present in this dataset. See the discussion in the data transformation step for more details.</p>
</section>
<section id="feature-selection" class="level3">
<h3 class="anchored" data-anchor-id="feature-selection">Feature Selection</h3>
<p>Features are not used in a baseline model.</p>
</section>
<section id="feature-processing" class="level3">
<h3 class="anchored" data-anchor-id="feature-processing">Feature Processing</h3>
<p>Features are not used in a baseline model. With this in mind, encoding categorical features or scaling numerical features is not required for a baseline model.</p>
</section>
<section id="end-to-end-ml-pipelines" class="level3">
<h3 class="anchored" data-anchor-id="end-to-end-ml-pipelines">End-to-End ML Pipelines</h3>
<p>Define ML pipelines for all baseline models (classifiers) to be compared in this step</p>
<div class="cell" data-tags="[]" data-execution_count="21">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>pipe_beta <span class="op">=</span> Pipeline(steps<span class="op">=</span>[(<span class="st">"clf"</span>, clf_beta)])</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>pipe_dummy <span class="op">=</span> Pipeline(steps<span class="op">=</span>[(<span class="st">"clf"</span>, clf_dummy)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="ml-training-using-validation-data" class="level2">
<h2 class="anchored" data-anchor-id="ml-training-using-validation-data">ML Training using Validation Data</h2>
<section id="splitting-data-for-validation" class="level3">
<h3 class="anchored" data-anchor-id="splitting-data-for-validation">Splitting Data for Validation</h3>
<p>Hyper-parameter tuning is performed for the <code>DummyClassifier</code> and <code>BetaDistClassifier</code> using <code>GridSearchCV</code>. This will be done using the validation data without performing cross-validation. This can be performed using the <code>PredefinedSplit</code> from <code>sklearn</code> (<a href="https://stackoverflow.com/a/70155766/4057186">link</a>).</p>
<p>This is used below to split the combined training and validation data</p>
<div class="cell" data-tags="[]" data-execution_count="22">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>split_index <span class="op">=</span> [<span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> <span class="bu">len</span>(df_train_val.query(<span class="st">"split == 'train'"</span>)) <span class="op">+</span> [<span class="dv">0</span>] <span class="op">*</span> <span class="bu">len</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    df_train_val.query(<span class="st">"split == 'val'"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>pds <span class="op">=</span> PredefinedSplit(test_fold<span class="op">=</span>split_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>By using this <code>PredefinedSplit</code>, we get the following benefits
<ul>
<li>the baseline models are trained on the training data split, which is obtained using the <code>split == 'train'</code> filter</li>
<li>the class imbalance used in the <code>strategy='stratified'</code> comes from this training data split only without retrieving any observations from the validation data</li>
<li>we can use native <code>scikit-learn</code> modules, such as <code>GridSearchCV</code>, with <code>cv=PredefinedSplit(...)</code>, to optimize the hyperparameters of the baseline models
<ul>
<li>this means we do not need to write manual <code>for</code> loops to iterate over all the hyperparameter combinations to be checked for the baseline models, train (using the training split) and evaluate (using the validation split) each model inside each iteration and then gather the results at the end; instead, we can use <code>GridSearchCV</code> with the desired hyperparameter grid and gather the grid search scores at the end</li>
</ul></li>
</ul></li>
</ol>
</div>
</div>
</section>
<section id="hyperparameter-tuning" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameter-tuning">HyperParameter Tuning</h3>
<p>Define the hyperparameter grids to be scored for both baseline models</p>
<div class="cell" data-tags="[]" data-execution_count="23">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>param_grid_beta <span class="op">=</span> {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"clf__a"</span>: np.linspace(<span class="fl">0.2</span>, <span class="fl">0.4</span>, num<span class="op">=</span><span class="dv">8</span>),</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"clf__b"</span>: np.linspace(<span class="fl">2.2</span>, <span class="fl">2.6</span>, num<span class="op">=</span><span class="dv">8</span>),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>param_grid_dummy <span class="op">=</span> {<span class="st">"clf__strategy"</span>: [<span class="st">"stratified"</span>]}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="metrics-for-model-scoring" class="level3">
<h3 class="anchored" data-anchor-id="metrics-for-model-scoring">Metrics for Model Scoring</h3>
<p>Define the following custom metrics to be used during hyperparameter tuning</p>
<ol type="1">
<li>F0.5-score</li>
<li>precision</li>
<li>brier score</li>
<li>uplift, using ventiles</li>
<li>area under precision-recall curve</li>
</ol>
<p>The two metrics that are relevant to this use-case are the F-0.5 score and the uplift score. The primary metric will be the F-0.5 score. The hyperparameters that give the best (highest) score for the primary metric will be chosen as the best hyperparameters.</p>
<p>A dictionary of <code>sklearn</code> custom scorers is defined below so we can use these metrics with <code>GridSearchCV</code></p>
<div class="cell" data-tags="[]" data-execution_count="24">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>scoring <span class="op">=</span> {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"f05"</span>: skm.make_scorer(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>        skm.fbeta_score,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        beta<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        average<span class="op">=</span><span class="st">"binary"</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        sample_weight<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        zero_division<span class="op">=</span><span class="st">"warn"</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"precision"</span>: skm.make_scorer(</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        skm.precision_score,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        average<span class="op">=</span><span class="st">"binary"</span>,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        sample_weight<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        zero_division<span class="op">=</span><span class="st">"warn"</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"precision"</span>: skm.make_scorer(</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        skm.precision_score,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        average<span class="op">=</span><span class="st">"binary"</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        sample_weight<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        zero_division<span class="op">=</span><span class="st">"warn"</span>,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"brier"</span>: skm.make_scorer(</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        skm.brier_score_loss,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        sample_weight<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        pos_label<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prauc"</span>: skm.make_scorer(get_pr_auc, sample_weights<span class="op">=</span><span class="va">None</span>),</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"uplift"</span>: skm.make_scorer(get_uplift_score, num_ventiles<span class="op">=</span><span class="dv">20</span>, needs_proba<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the columns produced by <code>GridSearchCV</code> under the <code>.cv_results_</code> attribute that are to be kept</p>
<ol type="1">
<li><code>clf</code>
<ul>
<li>name of model (for this step, the modle name will be baseline)</li>
</ul></li>
<li><code>mean_fit_time</code>
<ul>
<li>training duration</li>
</ul></li>
<li><code>mean_score_time</code>
<ul>
<li>scoring duration</li>
</ul></li>
<li><code>params</code>
<ul>
<li>hyperparameters used</li>
</ul></li>
<li><code>mean_test_f05</code>
<ul>
<li>F0.5-score on the test split</li>
</ul></li>
<li><code>mean_test_precision</code>
<ul>
<li>precision on the test split</li>
</ul></li>
<li><code>mean_test_prauc</code>
<ul>
<li>area under the precision-recall curve on the test split</li>
</ul></li>
<li><code>mean_test_brier</code>
<ul>
<li>Brier score on the test split</li>
</ul></li>
<li><code>mean_test_uplift</code>
<ul>
<li>uplift on the test split</li>
</ul></li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="25">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>gs_cols <span class="op">=</span> [</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"clf"</span>,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean_fit_time"</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean_score_time"</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"params"</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean_test_f05"</span>,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean_test_precision"</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean_test_prauc"</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean_test_brier"</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean_test_uplift"</span>,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Perform hyperparameter tuning using <code>GridSearchCV</code> for the custom <code>beta</code> baseline models</p>
<div class="cell" data-tags="[]" data-execution_count="26">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>gs <span class="op">=</span> GridSearchCV(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    estimator<span class="op">=</span>pipe_beta,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    cv<span class="op">=</span>pds,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    param_grid<span class="op">=</span>param_grid_beta,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    refit<span class="op">=</span><span class="st">"f05"</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    return_train_score<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    scoring<span class="op">=</span>scoring,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    n_jobs<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> gs.fit(X_train_val, y_train_val)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>df_validation_scores_beta <span class="op">=</span> pd.DataFrame(gs.cv_results_).assign(</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    clf<span class="op">=</span><span class="bu">type</span>(pipe_beta.named_steps[<span class="st">"clf"</span>]).<span class="va">__name__</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>)[gs_cols]</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    display(df_validation_scores_beta.head(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">clf</th>
<th data-quarto-table-cell-role="th">mean_fit_time</th>
<th data-quarto-table-cell-role="th">mean_score_time</th>
<th data-quarto-table-cell-role="th">params</th>
<th data-quarto-table-cell-role="th">mean_test_f05</th>
<th data-quarto-table-cell-role="th">mean_test_precision</th>
<th data-quarto-table-cell-role="th">mean_test_prauc</th>
<th data-quarto-table-cell-role="th">mean_test_brier</th>
<th data-quarto-table-cell-role="th">mean_test_uplift</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>BetaDistClassifier</td>
<td>0.010880</td>
<td>0.034319</td>
<td>{'clf__a': 0.2, 'clf__b': 2.2}</td>
<td>0.026617</td>
<td>0.027894</td>
<td>0.045713</td>
<td>0.073948</td>
<td>6.838147</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>BetaDistClassifier</td>
<td>0.008813</td>
<td>0.030943</td>
<td>{'clf__a': 0.2, 'clf__b': 2.257142857142857}</td>
<td>0.027956</td>
<td>0.029762</td>
<td>0.046647</td>
<td>0.071823</td>
<td>7.024176</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>BetaDistClassifier</td>
<td>0.008540</td>
<td>0.030084</td>
<td>{'clf__a': 0.2, 'clf__b': 2.3142857142857145}</td>
<td>0.034833</td>
<td>0.037559</td>
<td>0.052701</td>
<td>0.069887</td>
<td>7.733085</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>BetaDistClassifier</td>
<td>0.008369</td>
<td>0.029315</td>
<td>{'clf__a': 0.2, 'clf__b': 2.3714285714285714}</td>
<td>0.028710</td>
<td>0.031405</td>
<td>0.046930</td>
<td>0.068754</td>
<td>6.817600</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>BetaDistClassifier</td>
<td>0.008818</td>
<td>0.032537</td>
<td>{'clf__a': 0.2, 'clf__b': 2.428571428571429}</td>
<td>0.030054</td>
<td>0.033451</td>
<td>0.047953</td>
<td>0.067007</td>
<td>7.884862</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>BetaDistClassifier</td>
<td>0.009425</td>
<td>0.032975</td>
<td>{'clf__a': 0.2, 'clf__b': 2.4857142857142858}</td>
<td>0.039409</td>
<td>0.044527</td>
<td>0.056185</td>
<td>0.065165</td>
<td>7.229893</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>BetaDistClassifier</td>
<td>0.008515</td>
<td>0.033642</td>
<td>{'clf__a': 0.2, 'clf__b': 2.5428571428571427}</td>
<td>0.030896</td>
<td>0.035573</td>
<td>0.048475</td>
<td>0.064173</td>
<td>7.274676</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>BetaDistClassifier</td>
<td>0.008695</td>
<td>0.033321</td>
<td>{'clf__a': 0.2, 'clf__b': 2.6}</td>
<td>0.032040</td>
<td>0.037500</td>
<td>0.049438</td>
<td>0.062946</td>
<td>6.529846</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>BetaDistClassifier</td>
<td>0.009925</td>
<td>0.033463</td>
<td>{'clf__a': 0.2285714285714286, 'clf__b': 2.2}</td>
<td>0.044928</td>
<td>0.045509</td>
<td>0.064219</td>
<td>0.077820</td>
<td>6.849453</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>BetaDistClassifier</td>
<td>0.010001</td>
<td>0.033034</td>
<td>{'clf__a': 0.2285714285714286, 'clf__b': 2.257...</td>
<td>0.036169</td>
<td>0.037179</td>
<td>0.055205</td>
<td>0.076073</td>
<td>6.416212</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Perform hyperparameter tuning using <code>GridSearchCV</code> for the built-in <code>DummyClassifier</code> baseline model</p>
<div class="cell" data-tags="[]" data-execution_count="27">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>gs <span class="op">=</span> GridSearchCV(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    estimator<span class="op">=</span>pipe_dummy,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    cv<span class="op">=</span>pds,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    param_grid<span class="op">=</span>param_grid_dummy,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    refit<span class="op">=</span><span class="st">"f05"</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    return_train_score<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    scoring<span class="op">=</span>{k: v <span class="cf">for</span> k, v <span class="kw">in</span> scoring.items() <span class="cf">if</span> k <span class="kw">not</span> <span class="kw">in</span> [<span class="st">"uplift"</span>]},</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    n_jobs<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> gs.fit(X_train_val, y_train_val)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>df_validation_scores_dummy <span class="op">=</span> (</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame(gs.cv_results_)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    .assign(mean_test_uplift<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    .assign(clf<span class="op">=</span><span class="bu">type</span>(pipe_dummy.named_steps[<span class="st">"clf"</span>]).<span class="va">__name__</span>)[gs_cols]</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    .sort_values(by<span class="op">=</span>[<span class="st">"mean_test_f05"</span>], ascending<span class="op">=</span><span class="va">False</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    display(df_validation_scores_dummy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">clf</th>
<th data-quarto-table-cell-role="th">mean_fit_time</th>
<th data-quarto-table-cell-role="th">mean_score_time</th>
<th data-quarto-table-cell-role="th">params</th>
<th data-quarto-table-cell-role="th">mean_test_f05</th>
<th data-quarto-table-cell-role="th">mean_test_precision</th>
<th data-quarto-table-cell-role="th">mean_test_prauc</th>
<th data-quarto-table-cell-role="th">mean_test_brier</th>
<th data-quarto-table-cell-role="th">mean_test_uplift</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>DummyClassifier</td>
<td>0.007559</td>
<td>0.011686</td>
<td>{'clf__strategy': 'stratified'}</td>
<td>0.0309</td>
<td>0.031034</td>
<td>0.051055</td>
<td>0.080512</td>
<td>None</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Combine validation scores for both baseline models</p>
<div class="cell" data-tags="[]" data-execution_count="28">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df_validation_scores <span class="op">=</span> (</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    pd.concat([df_validation_scores_dummy, df_validation_scores_beta])</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>        rank<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"mean_test_f05"</span>]</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        .rank(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        .astype(<span class="bu">int</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        .astype(pd.Int8Dtype())</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    .sort_values(by<span class="op">=</span>[<span class="st">"rank"</span>], ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>df_validation_scores.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">clf</th>
<th data-quarto-table-cell-role="th">mean_fit_time</th>
<th data-quarto-table-cell-role="th">mean_score_time</th>
<th data-quarto-table-cell-role="th">params</th>
<th data-quarto-table-cell-role="th">mean_test_f05</th>
<th data-quarto-table-cell-role="th">mean_test_precision</th>
<th data-quarto-table-cell-role="th">mean_test_prauc</th>
<th data-quarto-table-cell-role="th">mean_test_brier</th>
<th data-quarto-table-cell-role="th">mean_test_uplift</th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">34</td>
<td>BetaDistClassifier</td>
<td>0.008669</td>
<td>0.030887</td>
<td>{'clf__a': 0.3142857142857143, 'clf__b': 2.314...</td>
<td>0.062536</td>
<td>0.060353</td>
<td>0.086189</td>
<td>0.086698</td>
<td>5.298005</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">57</td>
<td>BetaDistClassifier</td>
<td>0.008666</td>
<td>0.030218</td>
<td>{'clf__a': 0.4, 'clf__b': 2.257142857142857}</td>
<td>0.058876</td>
<td>0.054296</td>
<td>0.090704</td>
<td>0.103225</td>
<td>4.793266</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">58</td>
<td>BetaDistClassifier</td>
<td>0.008338</td>
<td>0.030452</td>
<td>{'clf__a': 0.4, 'clf__b': 2.3142857142857145}</td>
<td>0.057165</td>
<td>0.053130</td>
<td>0.086888</td>
<td>0.099967</td>
<td>4.434738</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>BetaDistClassifier</td>
<td>0.008352</td>
<td>0.029666</td>
<td>{'clf__a': 0.2571428571428572, 'clf__b': 2.371...</td>
<td>0.056139</td>
<td>0.057357</td>
<td>0.074454</td>
<td>0.075506</td>
<td>5.901735</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>BetaDistClassifier</td>
<td>0.008467</td>
<td>0.032691</td>
<td>{'clf__a': 0.2285714285714286, 'clf__b': 2.542...</td>
<td>0.054529</td>
<td>0.059701</td>
<td>0.070238</td>
<td>0.067054</td>
<td>7.923363</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">18</td>
<td>BetaDistClassifier</td>
<td>0.008350</td>
<td>0.029694</td>
<td>{'clf__a': 0.2571428571428572, 'clf__b': 2.314...</td>
<td>0.054135</td>
<td>0.054461</td>
<td>0.073545</td>
<td>0.078292</td>
<td>6.089055</td>
<td>6</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">56</td>
<td>BetaDistClassifier</td>
<td>0.009725</td>
<td>0.034417</td>
<td>{'clf__a': 0.4, 'clf__b': 2.2}</td>
<td>0.052780</td>
<td>0.048263</td>
<td>0.085532</td>
<td>0.108278</td>
<td>4.414328</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>BetaDistClassifier</td>
<td>0.008387</td>
<td>0.029809</td>
<td>{'clf__a': 0.2571428571428572, 'clf__b': 2.6}</td>
<td>0.052423</td>
<td>0.056061</td>
<td>0.068956</td>
<td>0.069651</td>
<td>6.181383</td>
<td>8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>BetaDistClassifier</td>
<td>0.008796</td>
<td>0.030543</td>
<td>{'clf__a': 0.2857142857142857, 'clf__b': 2.542...</td>
<td>0.052122</td>
<td>0.053503</td>
<td>0.070372</td>
<td>0.075081</td>
<td>5.883619</td>
<td>9</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">48</td>
<td>BetaDistClassifier</td>
<td>0.008621</td>
<td>0.031746</td>
<td>{'clf__a': 0.37142857142857144, 'clf__b': 2.2}</td>
<td>0.051341</td>
<td>0.047551</td>
<td>0.080866</td>
<td>0.102186</td>
<td>4.436388</td>
<td>10</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The scores on the training split are returned by <code>GridSearchCV</code> and they would appear as column names with the prefix <code>mean_train_</code>. These training scores are not used to choose the best hyperparameter. Only the scores on the validation split are used for making this choice.</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The combination that best matches the observed class balance in the validation split does not have the highest <code>uplift</code> score.</li>
</ol>
</div>
</div>
</section>
<section id="extracting-best-baseline-model" class="level3">
<h3 class="anchored" data-anchor-id="extracting-best-baseline-model">Extracting Best Baseline Model</h3>
<p>Get the best hyperparameters and evaluation scores for both baseline models</p>
<div class="cell" data-tags="[]" data-execution_count="29">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df_validation_scores_best <span class="op">=</span> (</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    df_validation_scores.groupby(<span class="st">"clf"</span>, as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    .first()</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    .sort_values(by<span class="op">=</span>[<span class="st">"mean_test_f05"</span>], ascending<span class="op">=</span><span class="va">False</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>df_validation_scores_best</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">clf</th>
<th data-quarto-table-cell-role="th">mean_fit_time</th>
<th data-quarto-table-cell-role="th">mean_score_time</th>
<th data-quarto-table-cell-role="th">params</th>
<th data-quarto-table-cell-role="th">mean_test_f05</th>
<th data-quarto-table-cell-role="th">mean_test_precision</th>
<th data-quarto-table-cell-role="th">mean_test_prauc</th>
<th data-quarto-table-cell-role="th">mean_test_brier</th>
<th data-quarto-table-cell-role="th">mean_test_uplift</th>
<th data-quarto-table-cell-role="th">rank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>BetaDistClassifier</td>
<td>0.008669</td>
<td>0.030887</td>
<td>{'clf__a': 0.3142857142857143, 'clf__b': 2.314...</td>
<td>0.062536</td>
<td>0.060353</td>
<td>0.086189</td>
<td>0.086698</td>
<td>5.298005</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>DummyClassifier</td>
<td>0.007559</td>
<td>0.011686</td>
<td>{'clf__strategy': 'stratified'}</td>
<td>0.030900</td>
<td>0.031034</td>
<td>0.051055</td>
<td>0.080512</td>
<td>None</td>
<td>57</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Finally, we’ll extract the hyperparameters of the best baseline model</p>
<div class="cell" data-tags="[]" data-execution_count="30">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>best_hyperparameters_baseline <span class="op">=</span> df_validation_scores_best.query(<span class="st">"rank == 1"</span>)[</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"params"</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>].squeeze()</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>best_hyperparameters_baseline <span class="op">=</span> {</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    k.replace(<span class="st">"clf__"</span>, <span class="st">""</span>): v <span class="cf">for</span> k, v <span class="kw">in</span> best_hyperparameters_baseline.items()</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>best_hyperparameters_baseline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>{'a': 0.3142857142857143, 'b': 2.3142857142857145}</code></pre>
</div>
</div>
</section>
</section>
<section id="ml-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="ml-evaluation">ML Evaluation</h2>
<p>The baseline model with the best hyperparameters is now used to make predictions on the test split and on the combined train and validation split.</p>
<section id="make-predictions" class="level3">
<h3 class="anchored" data-anchor-id="make-predictions">Make Predictions</h3>
<p>We’ll define a new pipeline with the best <code>beta</code> baseline model found from above and use the best hyperparameters</p>
<div class="cell" data-tags="[]" data-execution_count="31">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>pipe <span class="op">=</span> Pipeline(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"clf"</span>, BetaDistClassifier(random_state<span class="op">=</span><span class="dv">88</span>, <span class="op">**</span>best_hyperparameters_baseline))</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll train the best baseline model using the combined training and validation data split</p>
<div class="cell" data-tags="[]" data-execution_count="32">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> pipe.fit(X_train_val, y_train_val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We’ll now make predictions on the</p>
<ol type="1">
<li>combined training and validation split</li>
<li>test split</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="33">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># combined training and validation</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>y_train_val_pred_proba <span class="op">=</span> pd.Series(</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    pipe.predict_proba(X_train_val)[:, <span class="dv">1</span>:].flatten(), index<span class="op">=</span>X_train_val.index</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>y_train_val_pred <span class="op">=</span> convert_soft_to_hard_labels(y_train_val_pred_proba, <span class="fl">0.5</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># test</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>y_test_pred_proba <span class="op">=</span> pd.Series(</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    pipe.predict_proba(X_test)[:, <span class="dv">1</span>:].flatten(), index<span class="op">=</span>X_test.index</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>y_test_pred <span class="op">=</span> convert_soft_to_hard_labels(y_test_pred_proba, <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-true-and-predicted-class-imbalance" class="level3">
<h3 class="anchored" data-anchor-id="get-true-and-predicted-class-imbalance">Get True and Predicted Class Imbalance</h3>
<p>Next, calculate the true and predicted class imbalance for all observations (visitors) in the</p>
<ol type="1">
<li>combined train and validation data split</li>
<li>test data split</li>
</ol>
<p>A helper function is defined to calculate the percent change in class imbalance</p>
<div class="cell" data-tags="[]" data-execution_count="34">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_class_imbalance(y_true: pd.Series, y_pred: pd.Series) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Get percent difference between true and predicted labels."""</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    true_class_imbalance <span class="op">=</span> y_true.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    pred_class_imbalance <span class="op">=</span> y_pred.value_counts(normalize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    true_class_ratio <span class="op">=</span> true_class_imbalance[<span class="dv">0</span>] <span class="op">/</span> true_class_imbalance[<span class="dv">1</span>]</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    pred_class_ratio <span class="op">=</span> pred_class_imbalance[<span class="dv">0</span>] <span class="op">/</span> pred_class_imbalance[<span class="dv">1</span>]</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    pct_chng_class_imbalance <span class="op">=</span> (</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>        <span class="dv">100</span> <span class="op">*</span> (pred_class_ratio <span class="op">-</span> true_class_ratio) <span class="op">/</span> true_class_ratio</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [pct_chng_class_imbalance, true_class_ratio, pred_class_ratio]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Calculate true and predicted class imbalance for both splits</p>
<div class="cell" data-tags="[]" data-execution_count="35">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    pct_chng_class_imbalance_train_val,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    true_class_ratio_train_val,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    pred_class_ratio_train_val,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">=</span> get_class_imbalance(y_train_val, y_train_val_pred)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    pct_chng_class_imbalance_test,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    true_class_ratio_test,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    pred_class_ratio_test,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>) <span class="op">=</span> get_class_imbalance(y_test, y_test_pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="score-predictions" class="level3">
<h3 class="anchored" data-anchor-id="score-predictions">Score Predictions</h3>
<p>Finally, evaluate the predictions on both splits by scoring them using all the metrics described earlier</p>
<div class="cell" data-tags="[]" data-execution_count="36">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_eval_scores(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    y_true: pd.Series,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    y_pred: pd.Series,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    y_pred_proba: pd.Series,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    true_class_ratio: <span class="bu">float</span>,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    pred_class_ratio: <span class="bu">float</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    pct_chng_class_imbalance: <span class="bu">float</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    model_type: <span class="bu">str</span> <span class="op">=</span> <span class="st">"baseline"</span>,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    split: <span class="bu">str</span> <span class="op">=</span> <span class="st">"test"</span>,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Get evaluation scores and metadata for predictions."""</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    evaluation_scores <span class="op">=</span> get_metrics(y_true, y_pred, y_pred_proba)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    evaluation_scores.update({<span class="st">"uplift"</span>: get_uplift_score(y_true, y_pred_proba, <span class="dv">20</span>)})</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    df_evaluation_scores <span class="op">=</span> (</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># metrics</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame.from_dict(evaluation_scores, orient<span class="op">=</span><span class="st">"index"</span>)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>        .transpose()</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># model type</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>        .assign(model_type<span class="op">=</span>model_type)</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># best hyperparameters</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>        .assign(params<span class="op">=</span>json.dumps(best_hyperparameters_baseline))</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># true class imbalance in test data split</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>        .assign(true_class_imbalance<span class="op">=</span>true_class_ratio)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># predicted class imbalance in test data split</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>        .assign(pred_class_imbalance<span class="op">=</span>pred_class_ratio)</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># percent change between true and predicted class imbalance in test data split</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>        .assign(pct_chg_class_imbalance<span class="op">=</span>pct_chng_class_imbalance)</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>        .transpose()</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"name"</span>, <span class="dv">0</span>: <span class="ss">f"value_</span><span class="sc">{</span>split<span class="sc">}</span><span class="ss">"</span>})</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>            col_type<span class="op">=</span><span class="kw">lambda</span> df: pd.Series(</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>                [<span class="st">"metric"</span>] <span class="op">*</span> <span class="bu">len</span>(evaluation_scores) <span class="op">+</span> [<span class="st">"metadata"</span>] <span class="op">*</span> <span class="dv">5</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_evaluation_scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Scoring is performed for the test split and then for the combined train and validation split</p>
<div class="cell" data-tags="[]" data-execution_count="37">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test split</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>df_evaluation_scores_test <span class="op">=</span> get_eval_scores(</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    y_test,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    y_test_pred,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    y_test_pred_proba,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    true_class_ratio_test,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    pred_class_ratio_test,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    pct_chng_class_imbalance_test,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"baseline"</span>,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"test"</span>,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># combined train and validation split</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>df_evaluation_scores_train_val <span class="op">=</span> get_eval_scores(</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    y_train_val,</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    y_train_val_pred,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    y_train_val_pred_proba,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    true_class_ratio_train_val,</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    pred_class_ratio_train_val,</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    pct_chng_class_imbalance_train_val,</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"baseline"</span>,</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"train+val"</span>,</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The evaluation scores from both splits are now combined and shown below</p>
<div class="cell" data-tags="[]" data-execution_count="38">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_evaluation_scores <span class="op">=</span> df_evaluation_scores_train_val.merge(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    df_evaluation_scores_test, on<span class="op">=</span>[<span class="st">"name"</span>, <span class="st">"col_type"</span>], how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>col <span class="op">=</span> df_evaluation_scores.pop(<span class="st">"col_type"</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>df_evaluation_scores.insert(<span class="dv">0</span>, col.name, col)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>df_evaluation_scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">col_type</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">value_train+val</th>
<th data-quarto-table-cell-role="th">value_test</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>metric</td>
<td>accuracy</td>
<td>0.909574</td>
<td>0.930123</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>metric</td>
<td>balanced_accuracy</td>
<td>0.50005</td>
<td>0.499137</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>metric</td>
<td>precision</td>
<td>0.043799</td>
<td>0.022267</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>metric</td>
<td>recall</td>
<td>0.051287</td>
<td>0.047312</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>metric</td>
<td>f1</td>
<td>0.047248</td>
<td>0.030282</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>metric</td>
<td>f05</td>
<td>0.045117</td>
<td>0.024904</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>metric</td>
<td>f2</td>
<td>0.049592</td>
<td>0.038624</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>metric</td>
<td>brier</td>
<td>0.090426</td>
<td>0.069877</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>metric</td>
<td>pr_auc</td>
<td>0.043641</td>
<td>0.022853</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>metric</td>
<td>uplift</td>
<td>5.37144</td>
<td>5.665812</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>metadata</td>
<td>model_type</td>
<td>baseline</td>
<td>baseline</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>metadata</td>
<td>params</td>
<td>{"a": 0.3142857142857143, "b": 2.3142857142857...</td>
<td>{"a": 0.3142857142857143, "b": 2.3142857142857...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>metadata</td>
<td>true_class_imbalance</td>
<td>21.873693</td>
<td>42.363441</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>metadata</td>
<td>pred_class_imbalance</td>
<td>18.534181</td>
<td>19.408907</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>metadata</td>
<td>pct_chg_class_imbalance</td>
<td>-15.267253</td>
<td>-54.184772</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>According to the ML metrics (<code>f05</code>, <code>pr_auc</code>, <code>relevant</code>, <code>brier</code>), the baseline model is overfitting since the scores on the combined train and validation data are better than the scores on the test split. By comparison, the <code>uplift</code> is relatively unchanged.</li>
</ol>
</div>
</div>
</section>
<section id="post-processing-of-model-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="post-processing-of-model-evaluation">Post-Processing of Model Evaluation</h3>
<p>The true class imbalance of the training, validation, test and combined train and validation data splits is shown below</p>
<div class="cell" data-tags="[]" data-execution_count="39">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>df_true_class_imbalance <span class="op">=</span> pd.concat(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>            (<span class="dv">100</span> <span class="op">*</span> y.value_counts(normalize<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>            .to_frame()</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>            .merge(</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>                y.value_counts(normalize<span class="op">=</span><span class="va">False</span>).rename(<span class="st">"number"</span>).to_frame(),</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>                left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>                right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>            .reset_index()</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>            .astype({<span class="st">"made_purchase_on_future_visit"</span>: pd.BooleanDtype()})</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>            .assign(split<span class="op">=</span>split_name)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> y, split_name <span class="kw">in</span> <span class="bu">zip</span>(</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>            [y_train, y_val, y_train_val, y_test], [<span class="st">"train"</span>, <span class="st">"val"</span>, <span class="st">"train+val"</span>, <span class="st">"test"</span>]</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>df_true_class_imbalance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">proportion</th>
<th data-quarto-table-cell-role="th">number</th>
<th data-quarto-table-cell-role="th">split</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>95.407937</td>
<td>88301</td>
<td>train</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>4.592063</td>
<td>4250</td>
<td>train</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>96.590641</td>
<td>20455</td>
<td>val</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>3.409359</td>
<td>722</td>
<td>val</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>95.628165</td>
<td>108756</td>
<td>train+val</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>4.371835</td>
<td>4972</td>
<td>train+val</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>97.693910</td>
<td>19699</td>
<td>test</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>2.306090</td>
<td>465</td>
<td>test</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>With such a strong class imbalance, even small changes to the imbalance requires changes in the baseline model hyperparameters. The best baseline model effectively replicated the imbalance of the validation data but it does not generalize to changes in the class imbalance (as is seen in the test data). The poor generalizability is seen in the worse (lower) ML metrics during model evaluation compared to model validation with the best hyperparameters. The baseline model has no input features to learn changes in the underlying features (attributes about visits) between the validation and test data splits. Although it has adequately predicted the validation split labels during hyperparameter tuning, it did not gained any knowledge that generalizes into the test split. This is the limitation of a baseline model.</li>
</ol>
</div>
</div>
</section>
<section id="assessing-evaluation-metrics-by-sub-category-for-all-categorical-features" class="level3">
<h3 class="anchored" data-anchor-id="assessing-evaluation-metrics-by-sub-category-for-all-categorical-features">Assessing Evaluation Metrics by Sub-Category for All Categorical Features</h3>
<p>Next, the test split with the predicted - labels - probabilities - ventiles</p>
<p>is extracted from the predictions made with the best pipeline above</p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>features_to_use <span class="op">=</span> (</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    metadata_features_unused</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> datetime_features_unused</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> categorical_features</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> categorical_features_unused</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>df_test_preds <span class="op">=</span> df_test[features_to_use].merge(</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        X_test.assign(true<span class="op">=</span>y_test)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>        .assign(pred<span class="op">=</span>y_test_pred)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        .assign(pred_proba<span class="op">=</span><span class="kw">lambda</span> df: y_test_pred_proba)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        .astype({<span class="st">"pred"</span>: pd.BooleanDtype(), <span class="st">"pred_proba"</span>: pd.Float32Dtype()})</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>df_test_preds.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">true</th>
<th data-quarto-table-cell-role="th">pred</th>
<th data-quarto-table-cell-role="th">pred_proba</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">11418</td>
<td>603429985440546214</td>
<td>1486177788</td>
<td>1</td>
<td>2017-02-03 19:09:48</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>6</td>
<td>19</td>
<td>9</td>
<td>...</td>
<td>1</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>False</td>
<td>0.000842</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9000</td>
<td>076259998157345549</td>
<td>1486014909</td>
<td>1</td>
<td>2017-02-01 21:55:09</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>4</td>
<td>21</td>
<td>55</td>
<td>...</td>
<td>1</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>False</td>
<td>0.051213</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">15579</td>
<td>5388501648007496068</td>
<td>1487815734</td>
<td>1</td>
<td>2017-02-22 18:08:54</td>
<td>1</td>
<td>2</td>
<td>22</td>
<td>4</td>
<td>18</td>
<td>8</td>
<td>...</td>
<td>6</td>
<td>9</td>
<td>0</td>
<td>60</td>
<td>0</td>
<td>6</td>
<td>142</td>
<td>0</td>
<td>False</td>
<td>0.042726</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">14130</td>
<td>9626632850454813772</td>
<td>1486040405</td>
<td>1</td>
<td>2017-02-02 05:00:05</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>5</td>
<td>5</td>
<td>0</td>
<td>...</td>
<td>1</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>False</td>
<td>0.000014</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20054</td>
<td>4450994244177849748</td>
<td>1486402724</td>
<td>1</td>
<td>2017-02-06 09:38:44</td>
<td>1</td>
<td>2</td>
<td>6</td>
<td>2</td>
<td>9</td>
<td>38</td>
<td>...</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>12</td>
<td>1</td>
<td>2</td>
<td>23</td>
<td>0</td>
<td>False</td>
<td>0.0</td>
</tr>
</tbody>
</table>

<p>5 rows × 27 columns</p>
</div>
</div>
</div>
<p>For all categorical features in the transformed data of the test split, get the sub-categories occurring with a frequency of at least 10% or higher. A list is also created that stores these popular sub-categories for each categorical feature so that the test data split can be filtered using this list before calculating metrics.</p>
<p>This is done below</p>
<div class="cell" data-tags="[]" data-execution_count="41">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>most_frequenct_sub_categories <span class="op">=</span> []</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> categorical_features:</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get most popular sub-categories</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    df_top_sub_cats_test <span class="op">=</span> (</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">100</span> <span class="op">*</span> df_test_preds[c].value_counts(normalize<span class="op">=</span><span class="va">True</span>).rename(<span class="st">"fraction"</span>))</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: c})</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>        .astype({c: pd.BooleanDtype() <span class="cf">if</span> c <span class="kw">in</span> [<span class="st">"bounces"</span>] <span class="cf">else</span> pd.StringDtype()})</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">"fraction &gt;= 10"</span>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    display(df_top_sub_cats_test)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create list of popular sub-categories for each category</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    most_frequenct_sub_categories.append(</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"feature"</span>: c, <span class="st">"top_sub_cats"</span>: df_top_sub_cats_test[c].tolist()}</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">fraction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>desktop</td>
<td>69.252133</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>mobile</td>
<td>26.765523</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">fraction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>64.773854</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>35.226146</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">fraction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Organic Search</td>
<td>45.586193</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Direct</td>
<td>24.697481</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>other</td>
<td>16.251736</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Referral</td>
<td>13.464590</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">fraction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>organic</td>
<td>45.586193</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>(none)</td>
<td>24.697481</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>referral</td>
<td>21.860742</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">fraction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>google</td>
<td>50.976989</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>(direct)</td>
<td>24.697481</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The list of popular sub-categories is shown below for all categorical features</p>
<div class="cell" data-tags="[]" data-execution_count="42">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>most_frequenct_sub_categories</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>[{'feature': 'deviceCategory', 'top_sub_cats': ['desktop', 'mobile']},
 {'feature': 'bounces', 'top_sub_cats': [False, True]},
 {'feature': 'channelGrouping',
  'top_sub_cats': ['Organic Search', 'Direct', 'other', 'Referral']},
 {'feature': 'medium', 'top_sub_cats': ['organic', '(none)', 'referral']},
 {'feature': 'source', 'top_sub_cats': ['google', '(direct)']}]</code></pre>
</div>
</div>
<p>Finally, we will iterate over all sub-categories and - calculate metrics for each selected sub-category - get metadata (number of observations) for each category and selected sub-category</p>
<div class="cell" data-tags="[]" data-execution_count="43">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>scores_records <span class="op">=</span> []</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sub_cat_record <span class="kw">in</span> most_frequenct_sub_categories:</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    top_sub_cats <span class="op">=</span> sub_cat_record[<span class="st">"top_sub_cats"</span>]</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    df_top_sub_cats <span class="op">=</span> df_test_preds.query(</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>sub_cat_record[<span class="st">'feature'</span>]<span class="sc">}</span><span class="ss">.isin(@top_sub_cats)"</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> sub_category <span class="kw">in</span> sub_cat_record[<span class="st">"top_sub_cats"</span>]:</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>        sub_category_filter <span class="op">=</span> (</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"'</span><span class="sc">{</span>sub_category<span class="sc">}</span><span class="ss">'"</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> sub_cat_record[<span class="st">"feature"</span>] <span class="op">!=</span> <span class="st">"bounces"</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> sub_category</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        df_sub_cat <span class="op">=</span> df_test_preds.query(</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span>sub_cat_record[<span class="st">'feature'</span>]<span class="sc">}</span><span class="ss"> == </span><span class="sc">{</span>sub_category_filter<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>            pct_chng_class_imbalance_test,</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>            true_class_ratio_test,</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>            pred_class_ratio_test,</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">=</span> get_class_imbalance(df_sub_cat[<span class="st">"true"</span>], df_sub_cat[<span class="st">"pred"</span>])</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> get_metrics(</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>            df_sub_cat[<span class="st">"true"</span>],</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>            df_sub_cat[<span class="st">"pred"</span>],</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>            df_sub_cat[<span class="st">"pred_proba"</span>],</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>        scores.update(</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"uplift"</span>: get_uplift_score(</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>                    df_sub_cat[<span class="st">"true"</span>],</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>                    df_sub_cat[<span class="st">"pred_proba"</span>],</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">20</span>,</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># add metadata</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>        scores.update(</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">"model_type"</span>: <span class="st">"baseline"</span>,</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">"feature"</span>: sub_cat_record[<span class="st">"feature"</span>],</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sub_category"</span>: sub_category,</span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">"observations_by_subcat"</span>: <span class="bu">len</span>(df_sub_cat),</span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">"observations_by_cat"</span>: <span class="bu">len</span>(df_top_sub_cats),</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">"true_class_imbalance"</span>: true_class_ratio_test,</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>                <span class="st">"pred_class_imbalance"</span>: pred_class_ratio_test,</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">"pct_chg_class_imbalance"</span>: pct_chng_class_imbalance_test,</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(</span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Got scoring metrics for sub-category: </span><span class="sc">{</span>sub_category<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"in feature: </span><span class="sc">{</span>sub_cat_record[<span class="st">'feature'</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>        scores_records.append(scores)</span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>df_scores_eval_sub_cats <span class="op">=</span> pd.DataFrame.from_records(scores_records)</span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a><span class="co"># add ranks</span></span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>df_scores_eval_sub_cats <span class="op">=</span> df_scores_eval_sub_cats.assign(</span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>    rank_uplift<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"uplift"</span>]</span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>    .rank(method<span class="op">=</span><span class="st">"dense"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>    .astype(pd.Int8Dtype()),</span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>    rank_uplift_by_feature<span class="op">=</span><span class="kw">lambda</span> df: df.groupby(<span class="st">"feature"</span>)[<span class="st">"uplift"</span>]</span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>    .transform(<span class="st">"rank"</span>)</span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a>    .astype(pd.Int8Dtype()),</span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>    display(</span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a>        df_scores_eval_sub_cats.drop(</span>
<span id="cb44-67"><a href="#cb44-67" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>[<span class="st">"accuracy"</span>, <span class="st">"balanced_accuracy"</span>, <span class="st">"f1"</span>, <span class="st">"f1"</span>, <span class="st">"uplift"</span>]</span>
<span id="cb44-68"><a href="#cb44-68" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-69"><a href="#cb44-69" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Got scoring metrics for sub-category: desktop in feature: deviceCategory
Got scoring metrics for sub-category: mobile in feature: deviceCategory
Got scoring metrics for sub-category: False in feature: bounces
Got scoring metrics for sub-category: True in feature: bounces
Got scoring metrics for sub-category: Organic Search in feature: channelGrouping
Got scoring metrics for sub-category: Direct in feature: channelGrouping
Got scoring metrics for sub-category: other in feature: channelGrouping
Got scoring metrics for sub-category: Referral in feature: channelGrouping
Got scoring metrics for sub-category: organic in feature: medium
Got scoring metrics for sub-category: (none) in feature: medium
Got scoring metrics for sub-category: referral in feature: medium
Got scoring metrics for sub-category: google in feature: source
Got scoring metrics for sub-category: (direct) in feature: source</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">precision</th>
<th data-quarto-table-cell-role="th">recall</th>
<th data-quarto-table-cell-role="th">f05</th>
<th data-quarto-table-cell-role="th">f2</th>
<th data-quarto-table-cell-role="th">brier</th>
<th data-quarto-table-cell-role="th">pr_auc</th>
<th data-quarto-table-cell-role="th">model_type</th>
<th data-quarto-table-cell-role="th">feature</th>
<th data-quarto-table-cell-role="th">sub_category</th>
<th data-quarto-table-cell-role="th">observations_by_subcat</th>
<th data-quarto-table-cell-role="th">observations_by_cat</th>
<th data-quarto-table-cell-role="th">true_class_imbalance</th>
<th data-quarto-table-cell-role="th">pred_class_imbalance</th>
<th data-quarto-table-cell-role="th">pct_chg_class_imbalance</th>
<th data-quarto-table-cell-role="th">rank_uplift</th>
<th data-quarto-table-cell-role="th">rank_uplift_by_feature</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.032258</td>
<td>0.047191</td>
<td>0.034438</td>
<td>0.043192</td>
<td>0.075480</td>
<td>0.031606</td>
<td>baseline</td>
<td>deviceCategory</td>
<td>desktop</td>
<td>13964</td>
<td>19361</td>
<td>30.379775</td>
<td>20.450077</td>
<td>-32.685227</td>
<td>5</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.003448</td>
<td>0.055556</td>
<td>0.004244</td>
<td>0.013812</td>
<td>0.056698</td>
<td>0.007547</td>
<td>baseline</td>
<td>deviceCategory</td>
<td>mobile</td>
<td>5397</td>
<td>19361</td>
<td>298.833333</td>
<td>17.610345</td>
<td>-94.106968</td>
<td>1</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.032457</td>
<td>0.049180</td>
<td>0.034826</td>
<td>0.044586</td>
<td>0.079014</td>
<td>0.032066</td>
<td>baseline</td>
<td>bounces</td>
<td>False</td>
<td>13061</td>
<td>20164</td>
<td>29.587822</td>
<td>19.187017</td>
<td>-35.152317</td>
<td>4</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.002933</td>
<td>0.026316</td>
<td>0.003566</td>
<td>0.010142</td>
<td>0.053076</td>
<td>0.006567</td>
<td>baseline</td>
<td>bounces</td>
<td>True</td>
<td>7103</td>
<td>20164</td>
<td>185.921053</td>
<td>19.829912</td>
<td>-89.334230</td>
<td>3</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.009980</td>
<td>0.065789</td>
<td>0.012019</td>
<td>0.031056</td>
<td>0.061684</td>
<td>0.010267</td>
<td>baseline</td>
<td>channelGrouping</td>
<td>Organic Search</td>
<td>9192</td>
<td>20164</td>
<td>119.947368</td>
<td>17.347305</td>
<td>-85.537569</td>
<td>7</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.048673</td>
<td>0.057292</td>
<td>0.050182</td>
<td>0.055332</td>
<td>0.079518</td>
<td>0.041645</td>
<td>baseline</td>
<td>channelGrouping</td>
<td>Direct</td>
<td>4980</td>
<td>20164</td>
<td>24.937500</td>
<td>21.035398</td>
<td>-15.647526</td>
<td>8</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.045468</td>
<td>0.003316</td>
<td>baseline</td>
<td>channelGrouping</td>
<td>other</td>
<td>3277</td>
<td>20164</td>
<td>296.909091</td>
<td>22.746377</td>
<td>-92.338942</td>
<td>9</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>0.048780</td>
<td>0.032258</td>
<td>0.044248</td>
<td>0.034602</td>
<td>0.109392</td>
<td>0.060657</td>
<td>baseline</td>
<td>channelGrouping</td>
<td>Referral</td>
<td>2715</td>
<td>20164</td>
<td>13.596774</td>
<td>21.073171</td>
<td>54.986546</td>
<td>2</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>0.009980</td>
<td>0.065789</td>
<td>0.012019</td>
<td>0.031056</td>
<td>0.061684</td>
<td>0.010267</td>
<td>baseline</td>
<td>medium</td>
<td>organic</td>
<td>9192</td>
<td>18580</td>
<td>119.947368</td>
<td>17.347305</td>
<td>-85.537569</td>
<td>7</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>0.048673</td>
<td>0.057292</td>
<td>0.050182</td>
<td>0.055332</td>
<td>0.079518</td>
<td>0.041645</td>
<td>baseline</td>
<td>medium</td>
<td>(none)</td>
<td>4980</td>
<td>18580</td>
<td>24.937500</td>
<td>21.035398</td>
<td>-15.647526</td>
<td>8</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>0.029557</td>
<td>0.032258</td>
<td>0.030060</td>
<td>0.031679</td>
<td>0.085526</td>
<td>0.037183</td>
<td>baseline</td>
<td>medium</td>
<td>referral</td>
<td>4408</td>
<td>18580</td>
<td>22.698925</td>
<td>20.714286</td>
<td>-8.743317</td>
<td>2</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>0.009259</td>
<td>0.062500</td>
<td>0.011161</td>
<td>0.029070</td>
<td>0.059344</td>
<td>0.009514</td>
<td>baseline</td>
<td>source</td>
<td>google</td>
<td>10279</td>
<td>15259</td>
<td>127.487500</td>
<td>18.035185</td>
<td>-85.853370</td>
<td>6</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>0.048673</td>
<td>0.057292</td>
<td>0.050182</td>
<td>0.055332</td>
<td>0.079518</td>
<td>0.041645</td>
<td>baseline</td>
<td>source</td>
<td>(direct)</td>
<td>4980</td>
<td>15259</td>
<td>24.937500</td>
<td>21.035398</td>
<td>-15.647526</td>
<td>8</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The true average class imbalance ratio is in the range of 20 to 25 (or, 20:1 to 25:1). There are six sub-categories in the <code>true_class_imbalance</code> column, out of a total of 13 that were selected, that have a true class-imbalance ratio of more than 100 and that is outside this range. By comparison, the predicted class imbalance stays in the range of approximately 19 to 22. As we saw earlier, this baseline model has not learnt from inputs (features) so it is largely insensitive to changes in features and is the primary reason for this discrepancy in ranges.</li>
<li>By reading through the rows of the <code>precision</code>, <code>pr_auc</code>, <code>f05</code>, <code>precision</code> and <code>feature</code> columns, we can say that based on these two metrics, the model’s performance is qualitatively worse than the average across all selected sub-categories for the following
<ul>
<li><code>deviceCategory == 'mobile'</code></li>
<li><code>bounces == 'True'</code></li>
<li><code>channelGrouping == 'other'</code></li>
<li><code>medium == 'organic'</code></li>
<li><code>source == 'google'</code></li>
</ul>
These are also five of the six sub-categories mentioned in 1. above that show a significant change in true class imbalance relative to the average true class imbalance. This further re-inforces the need for a model that can learn from features to better handle differences in the class imbalance between training and unseen data.</li>
</ol>
</div>
</div>
</section>
<section id="distribution-of-predicted-probabilities-and-resulting-class-imbalance" class="level3">
<h3 class="anchored" data-anchor-id="distribution-of-predicted-probabilities-and-resulting-class-imbalance">Distribution of Predicted Probabilities and Resulting Class Imbalance</h3>
<p>As mentioned at the start of this step, we have chosen the <code>beta</code> distribution to represent predicted probabilities (visitor propensities) of a baseline model for the current use-case since it 1. provides floating point values in the range of 0 to 1 (this would match the range of values covered by probabilities, namely 0.0 to 1.0 or 0% to 100%) 2. can be reshaped to achieve the class imbalance seen in return visitor purchases on the Google marketplace</p>
<p>During hyperparameter optimization, we partly used the class imbalance ratio to determine if the chosen <code>beta</code> distribution hyperparameters were an appopriate match to the validation data. Now, we will show the histogram of the baseline model’s probabilities (sampled from the <code>beta</code> distribution with the best hyperparameters) for visitors in the test data split.</p>
<p>This is shown below</p>
<div class="cell" data-tags="[]" data-execution_count="44">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> ax.hist(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    df_test_preds[<span class="st">"pred_proba"</span>],</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    density<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    bins<span class="op">=</span><span class="st">"auto"</span>,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"red"</span>,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    histtype<span class="op">=</span><span class="st">"stepfilled"</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.25</span>,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">"baseline"</span>,</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    zorder<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>ax.set_xlim([<span class="dv">0</span>, <span class="dv">1</span>])</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>ax.set_title(</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Distribution of Baseline Model's Sampled Probabilities"</span>,</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Sampled Probabilities"</span>)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Frequency"</span>)</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>customize_axis(ax)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="05_development_files/figure-html/cell-45-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>There could be other distributions that can be used as a baseline model for the current use-case, but they were not explored in this version of the analysis.</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>As expected, the distribution is strongly right skewed with most probabilities being less than 10%. Also the range of sampled values produced by the <code>beta</code> distribution covers a range of 0.0 to 1.0. Both of these observations meet the requirements of a suitable baseline model that were discussed earlier.</li>
</ol>
</div>
</div>
</section>
</section>
<section id="export-to-disk" class="level2">
<h2 class="anchored" data-anchor-id="export-to-disk">Export to Disk</h2>
<p>The scores from the baseline model evaluation section above will now be exported to disk so that ML model performance (in the next step) can be compared to the baseline performance found here.</p>
<p>Define datatypes for the <code>DataFrame</code> with the overall model evaluation scores</p>
<div class="cell" data-tags="[]" data-execution_count="45">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>dtypes_dict_scores <span class="op">=</span> {</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"accuracy"</span>: pd.Float32Dtype(),</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"balanced_accuracy"</span>: pd.Float32Dtype(),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"precision"</span>: pd.Float32Dtype(),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"recall"</span>: pd.Float32Dtype(),</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"f1"</span>: pd.Float32Dtype(),</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"f05"</span>: pd.Float32Dtype(),</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"f2"</span>: pd.Float32Dtype(),</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"brier"</span>: pd.Float32Dtype(),</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pr_auc"</span>: pd.Float32Dtype(),</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"uplift"</span>: pd.Float32Dtype(),</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"model_type"</span>: pd.StringDtype(),</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"params"</span>: pd.StringDtype(),</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"true_class_imbalance"</span>: pd.Float32Dtype(),</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pred_class_imbalance"</span>: pd.Float32Dtype(),</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pct_chg_class_imbalance"</span>: pd.Float32Dtype(),</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define datatypes for the <code>DataFrame</code> with the model evaluation scores by sub-category</p>
<div class="cell" data-tags="[]" data-execution_count="46">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>dtypes_dict_scores_by_sub_category <span class="op">=</span> {</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"accuracy"</span>: pd.Float32Dtype(),</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"balanced_accuracy"</span>: pd.Float32Dtype(),</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"precision"</span>: pd.Float32Dtype(),</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"recall"</span>: pd.Float32Dtype(),</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"f1"</span>: pd.Float32Dtype(),</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"f05"</span>: pd.Float32Dtype(),</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"f2"</span>: pd.Float32Dtype(),</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"brier"</span>: pd.Float32Dtype(),</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pr_auc"</span>: pd.Float32Dtype(),</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"uplift"</span>: pd.Float32Dtype(),</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"model_type"</span>: pd.StringDtype(),</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"feature"</span>: pd.StringDtype(),</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sub_category"</span>: pd.StringDtype(),</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"observations_by_subcat"</span>: pd.Int16Dtype(),</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"observations_by_cat"</span>: pd.StringDtype(),</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"true_class_imbalance"</span>: pd.Float32Dtype(),</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pred_class_imbalance"</span>: pd.Float32Dtype(),</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pct_chg_class_imbalance"</span>: pd.Float32Dtype(),</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rank_uplift"</span>: pd.Int8Dtype(),</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rank_uplift_by_feature"</span>: pd.Int8Dtype(),</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define datatypes for the <code>DataFrame</code> with the model predictions for all observations in the test split</p>
<div class="cell" data-tags="[]" data-execution_count="47">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>dtypes_dict_predictions <span class="op">=</span> {</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"true"</span>: pd.Int8Dtype(),</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bounces"</span>: pd.Int8Dtype(),</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_action"</span>: pd.Int8Dtype(),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Export overall evaluation scores</p>
<div class="cell" data-tags="[]" data-execution_count="48">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    df_evaluation_scores[[<span class="st">"name"</span>, <span class="st">"value_test"</span>]]</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    .set_index(<span class="st">"name"</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    .transpose()</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    .astype(dtypes_dict_scores)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    .to_parquet(</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>        os.path.join(models_dir, <span class="st">"baseline_scores_overall_test.parquet.gzip"</span>),</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>        engine<span class="op">=</span><span class="st">"pyarrow"</span>,</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>        compression<span class="op">=</span><span class="st">"gzip"</span>,</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Export evaluation scores by sub-category for the popular sub-categories in the categorical features</p>
<div class="cell" data-tags="[]" data-execution_count="49">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    df_scores_eval_sub_cats.astype(dtypes_dict_scores_by_sub_category).to_parquet(</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>        os.path.join(models_dir, <span class="st">"baseline_scores_by_sub_category_test.parquet.gzip"</span>),</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        engine<span class="op">=</span><span class="st">"pyarrow"</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        compression<span class="op">=</span><span class="st">"gzip"</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Export predicted probabilities for the test split</p>
<div class="cell" data-tags="[]" data-execution_count="50">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    df_test_preds.astype(dtypes_dict_predictions).to_parquet(</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>        os.path.join(models_dir, <span class="st">"predictions_test.parquet.gzip"</span>),</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>        engine<span class="op">=</span><span class="st">"pyarrow"</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        compression<span class="op">=</span><span class="st">"gzip"</span>,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="summary-of-tasks-performed" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-tasks-performed">Summary of Tasks Performed</h2>
<p>This step trained a baseline model to predict visitor propensity to make a purchase during their next visit during January 2017.</p>
<p>The steps performed were 1. choose an appropriate baseline model to model prediction probabilities (predicted visitor propensities) - the <code>beta</code> distribution was chosen since <a href="https://www.sciencedirect.com/topics/mathematics/beta-distribution">it randomly samples values between 0 and 1</a>, which is required for the current use-case 2. model validation - optimize hyperparameters of the baseline model - uses validation data split - determines best hyperparameters 3. model evaluation - uses model with best hyperparameters to make predictions on data that has not been seen during ML model development - uses test data split - post-processing - assesses model’s performance across the most popular sub-categories in all categorical features in the transformed data from the test data split</p>
</section>
<section id="key-findings" class="level2">
<h2 class="anchored" data-anchor-id="key-findings">Key Findings</h2>
<ol type="1">
<li>The baseline model cannot generalize since it does not use features. It cannot handle changes in class imbalance seen between model validation and model evaluation.
<ul>
<li>input features will likely be key to improving on this performance using a ML model</li>
</ul></li>
<li>Several evaluation metrics are more sentitive to changes in sub-category than to changes in baseline model hyperparameters
<ul>
<li>model performance should be compared to ML model performance for each of the popular sub-categories</li>
<li>this further re-inforces the finding from 1. above</li>
</ul></li>
</ol>
</section>
<section id="summary-of-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-assumptions">Summary of Assumptions</h2>
<ol type="1">
<li>It is assumed that the class imbalance can be adequately represented by the <code>beta</code> distribution. The parameters of this distribution are modified during model validation in order to capture the class-imbalance seen in the validation data split.</li>
<li>The top three sub-categories are considered for evaluating baseline model performance since these occurred in at least 10% of all observations (visits) per category.</li>
</ol>
</section>
<section id="limitations-1" class="level2">
<h2 class="anchored" data-anchor-id="limitations-1">Limitations</h2>
<ol type="1">
<li>A single choice of skewed distribution (<code>beta</code>) was used to represent the baseline model. This was chosen since it can sample values in the range of 0 to 1, which is the range of prediction probabilities that we want for a binary classification model.</li>
<li>For the <code>uplift</code> evaluation metric, ventiles (20 bins) were used. However, other binning approaches (deciles, which would give 10 bins) were not explored.</li>
<li>The definition of <code>uplift</code> does not make a comparison of the predicted and true class labels. Instead, it only defines ventiles based on the predicted probability. This is acceptable since uplift is meant to compare a model’s predictive power to a random model. However, this also means it is possible to have a non-zero uplift with an inaccurate model. For this reason, the other metric (area under the precision-recall curve) must also be used to evaluate model performance, in addition to <code>uplift</code>.</li>
<li>The baseline model does not learn from features so its hyperparameters were only chosen based on its ability to match the class imbalance seen in the validation data split. This does not generalize to unseen data with a different class imbalance, but this is adequate for a baseline model.</li>
</ol>
</section>
<section id="next-step" class="level2">
<h2 class="anchored" data-anchor-id="next-step">Next Step</h2>
<p>The next step in the analysis will repeat the analysis in this step, but with a machine learning model used in place of the baseline visitor propensity (binary classifier) model used here. A ML model that is able to deliver value to the business user for this project should outperform the evaluation scores reported here for the baseline model.</p>
<p>Since the end-to-end ML development workflow is very similar to the workflow shown here, comments will only be included in that step for new steps, such as feature engineering, feature transformation, etc., that were not necessary for a baseline model.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.quarto\.org\/custom");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="../../../notebooks/04-transform/notebooks/04_transform.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Transform Data</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../notebooks/07-create-audience/notebooks/07_create_audience.html" class="pagination-link">
        <span class="nav-page-text">Create Audience</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<script src="../../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>