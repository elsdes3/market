<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine Learning Project - About</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Machine Learning Project</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">About</li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../../images/lorip_square.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../references/Scope.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scope</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/01-get-data/notebooks/01_get_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Get Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-prepare/notebooks/02_prepare.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prepare Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/03-eda/notebooks/03_eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Explore Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/04-transform/notebooks/04_transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transform Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/05-development/notebooks/05_development.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Baseline</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/07-create-audience/notebooks/07_create_audience.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create Audience</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#objective" id="toc-objective" class="nav-link active" data-scroll-target="#objective">Objective</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#evaluation-metrics" id="toc-evaluation-metrics" class="nav-link" data-scroll-target="#evaluation-metrics">Evaluation Metrics</a></li>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions">Assumptions</a></li>
  <li><a href="#notation" id="toc-notation" class="nav-link" data-scroll-target="#notation">Notation</a></li>
  <li><a href="#user-inputs" id="toc-user-inputs" class="nav-link" data-scroll-target="#user-inputs">User Inputs</a></li>
  <li><a href="#get-data" id="toc-get-data" class="nav-link" data-scroll-target="#get-data">Get Data</a></li>
  <li><a href="#get-features-and-label" id="toc-get-features-and-label" class="nav-link" data-scroll-target="#get-features-and-label">Get Features and Label</a></li>
  <li><a href="#resampling-due-to-class-imbalance" id="toc-resampling-due-to-class-imbalance" class="nav-link" data-scroll-target="#resampling-due-to-class-imbalance">Resampling Due to Class Imbalance</a></li>
  <li><a href="#feature-processing" id="toc-feature-processing" class="nav-link" data-scroll-target="#feature-processing">Feature Processing</a>
  <ul class="collapse">
  <li><a href="#handling-missing-values" id="toc-handling-missing-values" class="nav-link" data-scroll-target="#handling-missing-values">Handling Missing Values</a></li>
  <li><a href="#feature-selection" id="toc-feature-selection" class="nav-link" data-scroll-target="#feature-selection">Feature Selection</a></li>
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">Feature Engineering</a></li>
  <li><a href="#feature-processing-for-model-development-using-training-and-validation-data" id="toc-feature-processing-for-model-development-using-training-and-validation-data" class="nav-link" data-scroll-target="#feature-processing-for-model-development-using-training-and-validation-data">Feature Processing for Model Development Using Training and Validation Data</a></li>
  <li><a href="#feature-processing-for-model-evaluation-using-training-validation-and-testing-data" id="toc-feature-processing-for-model-evaluation-using-training-validation-and-testing-data" class="nav-link" data-scroll-target="#feature-processing-for-model-evaluation-using-training-validation-and-testing-data">Feature Processing for Model Evaluation Using Training + Validation and Testing Data</a></li>
  </ul></li>
  <li><a href="#ml-training-using-validation-data" id="toc-ml-training-using-validation-data" class="nav-link" data-scroll-target="#ml-training-using-validation-data">ML Training using Validation Data</a>
  <ul class="collapse">
  <li><a href="#logisticregression" id="toc-logisticregression" class="nav-link" data-scroll-target="#logisticregression"><code>LogisticRegression</code></a></li>
  <li><a href="#randomforestclassifier" id="toc-randomforestclassifier" class="nav-link" data-scroll-target="#randomforestclassifier"><code>RandomForestClassifier</code></a></li>
  <li><a href="#gradientboostingclassifier" id="toc-gradientboostingclassifier" class="nav-link" data-scroll-target="#gradientboostingclassifier"><code>GradientBoostingClassifier</code></a></li>
  <li><a href="#extracting-best-ml-model" id="toc-extracting-best-ml-model" class="nav-link" data-scroll-target="#extracting-best-ml-model">Extracting Best ML Model</a></li>
  </ul></li>
  <li><a href="#ml-evaluation" id="toc-ml-evaluation" class="nav-link" data-scroll-target="#ml-evaluation">ML Evaluation</a>
  <ul class="collapse">
  <li><a href="#make-and-score-predictions" id="toc-make-and-score-predictions" class="nav-link" data-scroll-target="#make-and-score-predictions">Make and Score Predictions</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/elsdes3/market/blob/main/notebooks/05-development/notebooks/06_dev_v2.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/elsdes3/market/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">About</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell" data-tags="[]" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, Union</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sklearn.metrics <span class="im">as</span> skm</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> imblearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> imblearn.under_sampling <span class="im">import</span> RandomUnderSampler</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> GradientBoostingClassifier, RandomForestClassifier</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># from sklearn.model_selection import GridSearchCV, PredefinedSplit</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> MinMaxScaler, OneHotEncoder</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="objective" class="level3">
<h3 class="anchored" data-anchor-id="objective">Objective</h3>
<p>This step trains a ML model for predicting visitors’ propensity to make a purchase on a future visit to the merchandise store.</p>
</section>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>Same as for baseline model development.</p>
</section>
<section id="evaluation-metrics" class="level3">
<h3 class="anchored" data-anchor-id="evaluation-metrics">Evaluation Metrics</h3>
<p>Same as for baseline model development.</p>
</section>
<section id="assumptions" class="level3">
<h3 class="anchored" data-anchor-id="assumptions">Assumptions</h3>
<p>Same as for baseline model development.</p>
</section>
<section id="notation" class="level3">
<h3 class="anchored" data-anchor-id="notation">Notation</h3>
<p>Same as for baseline model development.</p>
</section>
<section id="user-inputs" class="level2">
<h2 class="anchored" data-anchor-id="user-inputs">User Inputs</h2>
<p>Get relative path to project root directory</p>
<div class="cell" data-tags="[]" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>PROJ_ROOT_DIR <span class="op">=</span> os.path.join(os.pardir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the different types of features in the transformed data</p>
<ol type="1">
<li>categoricals</li>
<li>numericals</li>
<li>categorical features not used in this step</li>
<li>metadata features (visit ID, visit number, etc.) for each visit</li>
<li><code>datetime</code> features not used in this step</li>
</ol>
<div class="cell" data-tags="[&quot;parameters&quot;]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deviceCategory"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bounces"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"channelGrouping"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"medium"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>numerical_features <span class="op">=</span> [</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hits"</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_displayed"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_clicked"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_views"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_clicks"</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pageviews"</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"time_on_site"</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>categorical_features_numerical <span class="op">=</span> [<span class="st">"last_action"</span>]</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>metadata_features_unused <span class="op">=</span> [</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fullvisitorid"</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitId"</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitNumber"</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitStartTime"</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>datetime_features_unused <span class="op">=</span> [</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quarter"</span>,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month"</span>,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_month"</span>,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_week"</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour"</span>,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minute"</span>,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"second"</span>,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get path to <code>data/processed</code> in which the transformed data splits (training, validation and test) produced by the (preceding) data transformation step were exported</p>
<div class="cell" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"data"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>processed_data_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"data"</span>, <span class="st">"processed"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>models_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"models"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define a Python helper function to change probabilities into labels, using a user-specified discrimination threshold</p>
<div class="cell" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert_soft_to_hard_labels(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    y_pred_proba: pd.Series, disc_threshold: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert probabilities to labels."""</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> (y_pred_proba <span class="op">&gt;</span> disc_threshold).astype(<span class="bu">int</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A helper function is defined to retrieve the area under precision recall curve</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_pr_auc(y_true, y_pred_proba, sample_weights) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""."""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    precision, recall, _ <span class="op">=</span> skm.precision_recall_curve(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        y_true, y_pred_proba, pos_label<span class="op">=</span><span class="dv">1</span>, sample_weight<span class="op">=</span>sample_weights</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    auc_score <span class="op">=</span> skm.auc(recall, precision)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> auc_score</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A helper function is defined to get the same metrics used in development of the baseline model, without including uplift due to the difficulties we had in using that metric with the baseline model</p>
<div class="cell" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_metrics(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    y_true,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    y_pred,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    y_pred_proba,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    ds_factor: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    average<span class="op">=</span><span class="st">"binary"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    zero_division<span class="op">=</span><span class="st">"warn"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, <span class="bu">float</span>]:</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate sklearn evaluation metrics."""</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ds_factor <span class="op">!=</span> <span class="fl">1.0</span>:</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        sample_weights <span class="op">=</span> get_sample_weight(y_pred, ds_factor)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        sample_weights <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get area under precision-recall curve</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    pr_auc_score <span class="op">=</span> get_pr_auc(y_true, y_pred_proba, sample_weights)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># assemble summary dict to compute metrics</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    metrics_dict <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># accuracy</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        accuracy<span class="op">=</span>skm.accuracy_score(y_true, y_pred, sample_weight<span class="op">=</span>sample_weights),</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># balanced accuracy</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        balanced_accuracy<span class="op">=</span>skm.balanced_accuracy_score(</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>            y_true, y_pred, sample_weight<span class="op">=</span>sample_weights</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># precision</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        precision<span class="op">=</span>skm.precision_score(</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>            y_true,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>            y_pred,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>            average<span class="op">=</span>average,</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>            sample_weight<span class="op">=</span>sample_weights,</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span>zero_division,</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># recall</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        recall<span class="op">=</span>skm.recall_score(</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>            y_true,</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>            y_pred,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>            average<span class="op">=</span>average,</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>            sample_weight<span class="op">=</span>sample_weights,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span>zero_division,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># f1</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>        f1<span class="op">=</span>skm.f1_score(</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>            y_true,</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>            y_pred,</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>            average<span class="op">=</span>average,</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>            sample_weight<span class="op">=</span>sample_weights,</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span>zero_division,</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># f-0.5</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>        f05<span class="op">=</span>skm.fbeta_score(</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>            y_true,</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>            y_pred,</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>            beta<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>            average<span class="op">=</span>average,</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>            sample_weight<span class="op">=</span>sample_weights,</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span>zero_division,</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># f2</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>        f2<span class="op">=</span>skm.fbeta_score(</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>            y_true,</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>            y_pred,</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>            beta<span class="op">=</span><span class="fl">2.0</span>,</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>            average<span class="op">=</span>average,</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>            sample_weight<span class="op">=</span>sample_weights,</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>            zero_division<span class="op">=</span>zero_division,</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># brier score</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>        brier<span class="op">=</span>skm.brier_score_loss(</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>            y_true, y_pred, sample_weight<span class="op">=</span>sample_weights, pos_label<span class="op">=</span><span class="dv">1</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># area under precision-recall curve (calculated above)</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>        pr_auc<span class="op">=</span>pr_auc_score,</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> metrics_dict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>For <code>average</code>, the value chosen is binary so that the metric is calculated and returned for the minority class (visitor made purchase on return visit to merchandise store) only.</li>
<li>sample weights are not used to calculate the metrics.</li>
</ol>
</div>
</div>
<p>Below is a helper function to customize the axes of a <code>matplotlib</code> plot</p>
<div class="cell" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> customize_axis(ax) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Customize matplotlib axis properties."""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"left"</span>].set_edgecolor(<span class="st">"black"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"left"</span>].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"bottom"</span>].set_edgecolor(<span class="st">"black"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"bottom"</span>].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"top"</span>].set_edgecolor(<span class="st">"whitesmoke"</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"top"</span>].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"right"</span>].set_edgecolor(<span class="st">"whitesmoke"</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"right"</span>].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    ax.grid(which<span class="op">=</span><span class="st">"both"</span>, axis<span class="op">=</span><span class="st">"both"</span>, color<span class="op">=</span><span class="st">"gainsboro"</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-data" class="level2">
<h2 class="anchored" data-anchor-id="get-data">Get Data</h2>
<p>Load the transformed data for the training, validation and test data splits</p>
<div class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> pd.read_parquet(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    os.path.join(processed_data_dir, <span class="st">"train_processed.parquet.gzip"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>).astype({<span class="st">"bounces"</span>: pd.CategoricalDtype()})</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>df_val <span class="op">=</span> pd.read_parquet(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    os.path.join(processed_data_dir, <span class="st">"val_processed.parquet.gzip"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>).astype({<span class="st">"bounces"</span>: pd.CategoricalDtype()})</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> pd.read_parquet(</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    os.path.join(processed_data_dir, <span class="st">"test_processed.parquet.gzip"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>).astype({<span class="st">"bounces"</span>: pd.CategoricalDtype()})</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>df_train.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>4180680121446408775</td>
<td>1476943855</td>
<td>1</td>
<td>2016-10-19 23:10:55</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>19</td>
<td>4</td>
<td>23</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>3072592563711482446</td>
<td>1476880065</td>
<td>1</td>
<td>2016-10-19 05:27:45</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>19</td>
<td>4</td>
<td>5</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1687301606877489412</td>
<td>1477794145</td>
<td>1</td>
<td>2016-10-29 19:22:25</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>29</td>
<td>7</td>
<td>19</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>youtube.com</td>
<td>referral</td>
<td>other</td>
<td>other</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>796191439564725883</td>
<td>1473279331</td>
<td>1</td>
<td>2016-09-07 13:15:31</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>7</td>
<td>4</td>
<td>13</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>9194147359170837949</td>
<td>1478035636</td>
<td>1</td>
<td>2016-11-01 14:27:16</td>
<td>United States</td>
<td>4</td>
<td>11</td>
<td>1</td>
<td>3</td>
<td>14</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>youtube.com</td>
<td>referral</td>
<td>other</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
</tr>
</tbody>
</table>

<p>5 rows × 29 columns</p>
</div>
</div>
</div>
<p>We need categorical features to be numeric for convenience (eg. checking for collinearity). So, we will use the <code>.cat.categories</code> attribute of <code>pandas.CategoricalDtype()</code> columns to create mapper dict that maps each unique category (string) in these columns to an integer.</p>
<p>Map strings in categorical columns in copy of training data, using the <code>.cat.categories attribute</code></p>
<div class="cell" data-tags="[]" data-execution_count="11">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>cat_mapper_dicts_train <span class="op">=</span> []</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat_col <span class="kw">in</span> categorical_features:</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    cat_mapper_dict <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">zip</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>            df_train[cat_col].cat.categories.tolist(),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">range</span>(df_train[cat_col].nunique()),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    df_train[cat_col] <span class="op">=</span> df_train[cat_col].<span class="bu">map</span>(cat_mapper_dict)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    cat_mapper_dicts_train.append({cat_col: cat_mapper_dict})</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>df_train[categorical_features].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>0</td>
<td>3</td>
<td>3</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1</td>
<td>0</td>
<td>3</td>
<td>3</td>
<td>4</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The categorical columns now contain integers instead of strings.</li>
</ol>
</div>
</div>
<p>Map strings in categorical columns in copy of validation data, using the <code>.cat.categories attribute</code></p>
<div class="cell" data-tags="[]" data-execution_count="12">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>cat_mapper_dicts_val <span class="op">=</span> []</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat_col <span class="kw">in</span> categorical_features:</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    cat_mapper_dict <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">zip</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>            df_val[cat_col].cat.categories.tolist(),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">range</span>(df_val[cat_col].nunique()),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    df_val[cat_col] <span class="op">=</span> df_val[cat_col].<span class="bu">map</span>(cat_mapper_dict)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    cat_mapper_dicts_val.append({cat_col: cat_mapper_dict})</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>df_val[categorical_features].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Map strings in categorical columns in copy of test data, using the <code>.cat.categories attribute</code></p>
<div class="cell" data-tags="[]" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>cat_mapper_dicts_test <span class="op">=</span> []</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat_col <span class="kw">in</span> categorical_features:</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    cat_mapper_dict <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">zip</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>            df_test[cat_col].cat.categories.tolist(),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">range</span>(df_test[cat_col].nunique()),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    df_test[cat_col] <span class="op">=</span> df_test[cat_col].<span class="bu">map</span>(cat_mapper_dict)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    cat_mapper_dicts_test.append({cat_col: cat_mapper_dict})</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>df_test[categorical_features].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>0</td>
<td>3</td>
<td>2</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Show the mapper dictionary that has been created for each categorical column in the training data</p>
<div class="cell" data-tags="[]" data-execution_count="14">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cat_mapper_dicts_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>[{'deviceCategory': {'desktop': 0, 'mobile': 1, 'tablet': 2}},
 {'bounces': {0: 0, 1: 1}},
 {'channelGrouping': {'Direct': 0,
   'Organic Search': 1,
   'Referral': 2,
   'other': 3}},
 {'medium': {'(none)': 0, 'organic': 1, 'other': 2, 'referral': 3}},
 {'source': {'(direct)': 0,
   'google': 1,
   'mall.googleplex.com': 2,
   'other': 3,
   'youtube.com': 4}}]</code></pre>
</div>
</div>
<p>Show the mapper dictionary that has been created for each categorical column in the validation data</p>
<div class="cell" data-tags="[]" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>cat_mapper_dicts_val</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>[{'deviceCategory': {'desktop': 0, 'mobile': 1, 'tablet': 2}},
 {'bounces': {0: 0, 1: 1}},
 {'channelGrouping': {'Direct': 0,
   'Organic Search': 1,
   'Referral': 2,
   'other': 3}},
 {'medium': {'(none)': 0, 'organic': 1, 'other': 2, 'referral': 3}},
 {'source': {'(direct)': 0,
   'google': 1,
   'mall.googleplex.com': 2,
   'other': 3,
   'youtube.com': 4}}]</code></pre>
</div>
</div>
<p>Show the mapper dictionary that has been created for each categorical column in the test data</p>
<div class="cell" data-tags="[]" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>cat_mapper_dicts_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>[{'deviceCategory': {'desktop': 0, 'mobile': 1, 'tablet': 2}},
 {'bounces': {0: 0, 1: 1}},
 {'channelGrouping': {'Direct': 0,
   'Organic Search': 1,
   'Referral': 2,
   'other': 3}},
 {'medium': {'(none)': 0, 'organic': 1, 'other': 2, 'referral': 3}},
 {'source': {'(direct)': 0,
   'google': 1,
   'mall.googleplex.com': 2,
   'other': 3,
   'youtube.com': 4}}]</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<p>1.The categorical columns now contain integers instead of strings.</p>
</div>
</div>
<p>We’ll also select the necessary columns (numericals, categoricals and label) that will be used for ML model development</p>
<div class="cell" data-tags="[]" data-execution_count="17">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>cols_to_use <span class="op">=</span> numerical_features <span class="op">+</span> categorical_features <span class="op">+</span> [<span class="st">"last_action"</span>]</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>label <span class="op">=</span> <span class="st">"made_purchase_on_future_visit"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><code>last_action</code> is a categorical but is already present in the transformed data as an integer, so it does not need to be encoded.</li>
<li><code>made_purchase_on_future_visit</code> is the label column and it is a <code>boolean</code>, so it does not need to be encoded.</li>
</ol>
</div>
</div>
<p>Get features from the transformed data splits</p>
<div class="cell" data-tags="[]" data-execution_count="18">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>features_used <span class="op">=</span> (</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    numerical_features</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> categorical_features</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> [<span class="st">"last_action"</span>, <span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>features_used</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>['hits',
 'promos_displayed',
 'promos_clicked',
 'product_views',
 'product_clicks',
 'pageviews',
 'time_on_site',
 'deviceCategory',
 'bounces',
 'channelGrouping',
 'medium',
 'source',
 'last_action',
 'made_purchase_on_future_visit']</code></pre>
</div>
</div>
<div class="cell" data-tags="[]" data-execution_count="19">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df_train <span class="op">=</span> df_train[features_used].copy()</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>df_val <span class="op">=</span> df_val[features_used].copy()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> df_test[features_used].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Create a new split with the combination of the training and validation data splits</p>
<div class="cell" data-tags="[]" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df_train_val <span class="op">=</span> pd.concat(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    [df_train.assign(split<span class="op">=</span><span class="st">"train"</span>), df_val.assign(split<span class="op">=</span><span class="st">"val"</span>)], ignore_index<span class="op">=</span><span class="va">True</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Shuffle the data in the</p>
<ol type="1">
<li>combined training and validation</li>
<li>test</li>
</ol>
<p>data splits</p>
<div class="cell" data-tags="[]" data-execution_count="21">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df_train_val <span class="op">=</span> df_train_val.sample(frac<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span><span class="dv">88</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>df_test <span class="op">=</span> df_test.sample(frac<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span><span class="dv">88</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-features-and-label" class="level2">
<h2 class="anchored" data-anchor-id="get-features-and-label">Get Features and Label</h2>
<p>Separate features from the target in the train and validation splits</p>
<div class="cell" data-tags="[]" data-execution_count="22">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> df_train_val.query(<span class="st">"split == 'train'"</span>).drop(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>, <span class="st">"split"</span>]</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> df_train_val.query(<span class="st">"split == 'train'"</span>)[</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"made_purchase_on_future_visit"</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>].astype(<span class="bu">int</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> df_train_val.query(<span class="st">"split == 'val'"</span>).drop(</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>, <span class="st">"split"</span>]</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>y_val <span class="op">=</span> df_train_val.query(<span class="st">"split == 'val'"</span>)[<span class="st">"made_purchase_on_future_visit"</span>].astype(</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">int</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Separate features from the target in the combined train-validation split</p>
<div class="cell" data-tags="[]" data-execution_count="23">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>X_train_val <span class="op">=</span> df_train_val.drop(columns<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>, <span class="st">"split"</span>])</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>y_train_val <span class="op">=</span> df_train_val[<span class="st">"made_purchase_on_future_visit"</span>].astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Separate features from the target in the test split</p>
<div class="cell" data-tags="[]" data-execution_count="24">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> df_test.drop(columns<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>])</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> df_test[<span class="st">"made_purchase_on_future_visit"</span>].astype(<span class="bu">int</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="resampling-due-to-class-imbalance" class="level2">
<h2 class="anchored" data-anchor-id="resampling-due-to-class-imbalance">Resampling Due to Class Imbalance</h2>
<p>Due to the class imbalance, we will undersample the majority class using <code>imblearn.RandomUnderSampler()</code>. To compensate for this, when evaluating predictions against this resampled data, we will apply a weighting factor.</p>
<p>The following order is used for resampling and data splitting/preprocessing</p>
<ol type="1">
<li>Resampling is done after splitting the data (<a href="https://towardsdatascience.com/4-tips-for-advanced-feature-engineering-and-preprocessing-ec11575c09ea">link</a>)</li>
<li>Normalizing numerical features will be performed after resampling (<a href="https://datascience.stackexchange.com/a/71519/17543">1</a>, <a href="https://stats.stackexchange.com/a/363325/144450">2</a>)</li>
</ol>
<p>Resampling will be performed as follows</p>
<ol type="1">
<li>ML model development (selecting best model using training and validation splits)
<ul>
<li>undersample majority class in training data
<ul>
<li>do not make predictions against undersampled validation data</li>
<li>no evaluation necessary</li>
</ul></li>
<li>do not undersample majority class in validataion data
<ul>
<li>make predictions against original data</li>
<li>evaluate without using sample weights</li>
</ul></li>
</ul></li>
<li>ML model evaluation (evaluating performance of best model using combined training + validation and test splits)
<ul>
<li>undersample majority class in combined training and validation data
<ul>
<li>make predictions against undersampled combined training and validation data</li>
<li>evaluate using sample weights</li>
</ul></li>
<li>do not undersample majority class in test data
<ul>
<li>make predictions against original data</li>
<li>evaluate without using sample weights</li>
</ul></li>
</ul></li>
</ol>
<p>Below is a helper function to get the sample weights based on a downsampling factor. The downsampling factor is multiplied by the value of the label (0 or 1). For the majority class, this gives a weight greater than 1. For the minority class, this gives a weight of zero, so we have replaced zeros by a sample weight of 1 (<a href="https://stackoverflow.com/a/34477381/4057186">1</a>, <a href="https://stackoverflow.com/a/71686189/4057186">2</a>).</p>
<p>This is shown below</p>
<div class="cell" data-tags="[]" data-execution_count="25">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_sample_weight(y: pd.Series, ds_factor: <span class="bu">float</span>) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""."""</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    y_name <span class="op">=</span> y.name</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    sample_weight <span class="op">=</span> y.to_frame().assign(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        sample_weight<span class="op">=</span><span class="kw">lambda</span> df: ((df[y_name] <span class="op">==</span> <span class="dv">0</span>) <span class="op">*</span> ds_factor).replace(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    )[<span class="st">"sample_weight"</span>]</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sample_weight</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We will undersample using a sampling strategy with a ratio of 10:1 (or 1/10). In the original training data, the ratio is approximately 19:1, as we saw in earlier steps in the analysis.</p>
<p>A <code>RandomUnderSampler</code> object is defined below with this sampling strategy</p>
<div class="cell" data-tags="[]" data-execution_count="26">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>us <span class="op">=</span> RandomUnderSampler(sampling_strategy<span class="op">=</span><span class="dv">1</span> <span class="op">/</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Downsample the training data</p>
<div class="cell" data-tags="[]" data-execution_count="27">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>X_train_us, y_train_us <span class="op">=</span> us.fit_resample(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Calculate the downsampling factor for the training split, as the ratio of the class imbalance after downsampling to before downsampling</p>
<div class="cell" data-tags="[]" data-execution_count="28">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>ds_factor_train <span class="op">=</span> (y_train_us.value_counts().loc[<span class="dv">1</span>] <span class="op">/</span> <span class="bu">len</span>(y_train_us)) <span class="op">/</span> (</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    y_train.value_counts().loc[<span class="dv">1</span>] <span class="op">/</span> <span class="bu">len</span>(y_train)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ds_factor_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>1.9797005347593584</code></pre>
</div>
</div>
<p>Downsample the combined training and validation data</p>
<div class="cell" data-tags="[]" data-execution_count="29">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>X_train_val_us, y_train_val_us <span class="op">=</span> us.fit_resample(X_train_val, y_train_val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Calculate the downsampling factor for the combined training and validation split</p>
<div class="cell" data-tags="[]" data-execution_count="30">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>ds_factor_train_val <span class="op">=</span> (y_train_val_us.value_counts().loc[<span class="dv">1</span>] <span class="op">/</span> <span class="bu">len</span>(y_train_val_us)) <span class="op">/</span> (</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    y_train_val.value_counts().loc[<span class="dv">1</span>] <span class="op">/</span> <span class="bu">len</span>(y_train_val)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ds_factor_train_val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>2.0794266071820378</code></pre>
</div>
</div>
<p>Combine features and label in all splits</p>
<div class="cell" data-tags="[]" data-execution_count="31">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_train_combo <span class="op">=</span> pd.concat([X_train_us, y_train_us], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>df_train_val_combo <span class="op">=</span> pd.concat([X_train_val_us, y_train_val_us], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>df_val_combo <span class="op">=</span> pd.concat([X_val, y_val], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>df_test_combo <span class="op">=</span> pd.concat([X_test, y_test], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-tags="[]" data-execution_count="32">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from sklearn.datasets import make_classification</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># X, y = make_classification(n_samples=10000, weights=[0.95], flip_y=0)</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># X = pd.DataFrame(X)</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># y = pd.Series(y, name="true")</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># us = RandomUnderSampler(sampling_strategy=1 / 10)</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># X_us, y_us = us.fit_resample(X, y)</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ds_factor = (y_us.value_counts().loc[1] / len(y_us)) / (</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     y.value_counts().loc[1] / len(y)</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co"># print(ds_factor)</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># display(pd.Series(y).value_counts(normalize=False).reset_index())</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># display(pd.Series(y_us).value_counts(normalize=False).reset_index())</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_weight = get_sample_weight(y_us, ds_factor)</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co"># sample_weight</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="feature-processing" class="level2">
<h2 class="anchored" data-anchor-id="feature-processing">Feature Processing</h2>
<section id="handling-missing-values" class="level3">
<h3 class="anchored" data-anchor-id="handling-missing-values">Handling Missing Values</h3>
<p>Missing values are not present in this dataset. See the discussion in the data transformation step for more details.</p>
</section>
<section id="feature-selection" class="level3">
<h3 class="anchored" data-anchor-id="feature-selection">Feature Selection</h3>
<p>We’ll be starting with <code>LogisticRegression</code> as one of the classifiers and <a href="https://stats.stackexchange.com/a/583034/144450">this type of model cannot handle multi-collinearity between the features</a>. We will also briefly explore tree-based models, <a href="https://datascience.stackexchange.com/a/12597/17543">which can handle multi-collinearity</a>.</p>
<p>Multi-collinear features makes it difficult to interpret model’s coefficients (<a href="https://www.tandfonline.com/doi/abs/10.1080/09720502.2010.10700699?journalCode=tjim20">1</a>, <a href="https://towardsdatascience.com/how-to-avoid-multicollinearity-in-categorical-data-46eb39d9cd0d">2</a>). This is a functionality we would like to provide to the non-technical marketing team (our client for this use-case), so we must remove multi-collinear features from the transformed data.</p>
<p>Genreally, a correlation coefficient between two features of 0.7 or higher is considered as high (features are highly correlated), while a value between 0.5 and 0.7 is moderate (<a href="https://www.andrews.edu/~calkins/math/edrm611/edrm05.htm">1</a>, <a href="https://www.westga.edu/academics/research/vrc/assets/docs/scatterplots_and_correlation_notes.pdf">2</a>). With this in mind, we will perform feature selection based on the inter-correlation between features. To do this, we will select features that are not correlated to each other (correlation coefficient less than 0.7) and drop those that are correlated.</p>
<p>Now, we’ll show the collinearity between all numerical and categorical features</p>
<div class="cell" data-tags="[]" data-execution_count="33">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_corr <span class="op">=</span> df_train_combo.corr()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>display(df_corr.drop(columns<span class="op">=</span>[label]).reset_index().rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"column"</span>}))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">last_action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>hits</td>
<td>1.000000</td>
<td>0.425154</td>
<td>0.256029</td>
<td>0.741211</td>
<td>0.850766</td>
<td>0.978625</td>
<td>0.695130</td>
<td>-0.083687</td>
<td>-0.336675</td>
<td>-0.034544</td>
<td>0.006787</td>
<td>-0.067510</td>
<td>0.628891</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>promos_displayed</td>
<td>0.425154</td>
<td>1.000000</td>
<td>0.468511</td>
<td>0.351822</td>
<td>0.203214</td>
<td>0.461329</td>
<td>0.311545</td>
<td>0.060296</td>
<td>-0.346872</td>
<td>0.109316</td>
<td>0.147608</td>
<td>0.084445</td>
<td>0.191881</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>promos_clicked</td>
<td>0.256029</td>
<td>0.468511</td>
<td>1.000000</td>
<td>0.249248</td>
<td>0.143384</td>
<td>0.226558</td>
<td>0.151693</td>
<td>0.140353</td>
<td>-0.195905</td>
<td>0.032478</td>
<td>0.025247</td>
<td>0.014748</td>
<td>0.055101</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>product_views</td>
<td>0.741211</td>
<td>0.351822</td>
<td>0.249248</td>
<td>1.000000</td>
<td>0.569276</td>
<td>0.768100</td>
<td>0.541920</td>
<td>-0.049836</td>
<td>-0.321524</td>
<td>-0.004231</td>
<td>0.027643</td>
<td>-0.049050</td>
<td>0.366684</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>product_clicks</td>
<td>0.850766</td>
<td>0.203214</td>
<td>0.143384</td>
<td>0.569276</td>
<td>1.000000</td>
<td>0.769769</td>
<td>0.509737</td>
<td>-0.078034</td>
<td>-0.206580</td>
<td>-0.028872</td>
<td>0.001468</td>
<td>-0.048425</td>
<td>0.475594</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>pageviews</td>
<td>0.978625</td>
<td>0.461329</td>
<td>0.226558</td>
<td>0.768100</td>
<td>0.769769</td>
<td>1.000000</td>
<td>0.726083</td>
<td>-0.092507</td>
<td>-0.367559</td>
<td>-0.035407</td>
<td>0.009079</td>
<td>-0.073315</td>
<td>0.650406</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>time_on_site</td>
<td>0.695130</td>
<td>0.311545</td>
<td>0.151693</td>
<td>0.541920</td>
<td>0.509737</td>
<td>0.726083</td>
<td>1.000000</td>
<td>-0.067342</td>
<td>-0.302213</td>
<td>-0.035426</td>
<td>-0.002836</td>
<td>-0.053534</td>
<td>0.517734</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>deviceCategory</td>
<td>-0.083687</td>
<td>0.060296</td>
<td>0.140353</td>
<td>-0.049836</td>
<td>-0.078034</td>
<td>-0.092507</td>
<td>-0.067342</td>
<td>1.000000</td>
<td>0.080355</td>
<td>-0.115435</td>
<td>-0.202138</td>
<td>-0.177784</td>
<td>-0.136658</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>bounces</td>
<td>-0.336675</td>
<td>-0.346872</td>
<td>-0.195905</td>
<td>-0.321524</td>
<td>-0.206580</td>
<td>-0.367559</td>
<td>-0.302213</td>
<td>0.080355</td>
<td>1.000000</td>
<td>-0.039249</td>
<td>-0.093395</td>
<td>0.008584</td>
<td>-0.349636</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>channelGrouping</td>
<td>-0.034544</td>
<td>0.109316</td>
<td>0.032478</td>
<td>-0.004231</td>
<td>-0.028872</td>
<td>-0.035407</td>
<td>-0.035426</td>
<td>-0.115435</td>
<td>-0.039249</td>
<td>1.000000</td>
<td>0.895975</td>
<td>0.843234</td>
<td>-0.111663</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>medium</td>
<td>0.006787</td>
<td>0.147608</td>
<td>0.025247</td>
<td>0.027643</td>
<td>0.001468</td>
<td>0.009079</td>
<td>-0.002836</td>
<td>-0.202138</td>
<td>-0.093395</td>
<td>0.895975</td>
<td>1.000000</td>
<td>0.880383</td>
<td>-0.048375</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>source</td>
<td>-0.067510</td>
<td>0.084445</td>
<td>0.014748</td>
<td>-0.049050</td>
<td>-0.048425</td>
<td>-0.073315</td>
<td>-0.053534</td>
<td>-0.177784</td>
<td>0.008584</td>
<td>0.843234</td>
<td>0.880383</td>
<td>1.000000</td>
<td>-0.115659</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>last_action</td>
<td>0.628891</td>
<td>0.191881</td>
<td>0.055101</td>
<td>0.366684</td>
<td>0.475594</td>
<td>0.650406</td>
<td>0.517734</td>
<td>-0.136658</td>
<td>-0.349636</td>
<td>-0.111663</td>
<td>-0.048375</td>
<td>-0.115659</td>
<td>1.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>made_purchase_on_future_visit</td>
<td>0.183496</td>
<td>0.042753</td>
<td>-0.026077</td>
<td>0.089781</td>
<td>0.136235</td>
<td>0.190842</td>
<td>0.165611</td>
<td>-0.150901</td>
<td>-0.134556</td>
<td>-0.047167</td>
<td>0.037071</td>
<td>-0.028219</td>
<td>0.293250</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Unfortunately, several attributes that were extracted from the raw visits data are correlated to each other.</li>
<li>The following numerical features demonstrate multi-collinearity
<ul>
<li><code>product_views</code></li>
<li><code>product_clicks</code></li>
<li><code>hits</code></li>
<li><code>time_on_site</code></li>
</ul></li>
<li>The following categorical features demonstrate multi-collinearity
<ul>
<li><code>channelGrouping</code></li>
<li><code>medium</code></li>
</ul>
We also noted the correlation between <code>channelGrouping</code> and <code>medium</code> in the EDA step of the analysis.</li>
</ol>
</div>
</div>
<p>Based on these observations, we’ll create a list of features to be dropped</p>
<div class="cell" data-tags="[]" data-execution_count="34">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>cols_to_drop <span class="op">=</span> [</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"channelGrouping"</span>,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"medium"</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hits"</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_views"</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_clicks"</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"time_on_site"</span>,</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Showing the correlations after dropping these features</p>
<div class="cell" data-tags="[]" data-execution_count="35">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    df_train_combo.drop(columns<span class="op">=</span>cols_to_drop <span class="op">+</span> [label])</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    .corr()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"column"</span>})</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">last_action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>promos_displayed</td>
<td>1.000000</td>
<td>0.468511</td>
<td>0.461329</td>
<td>0.060296</td>
<td>-0.346872</td>
<td>0.084445</td>
<td>0.191881</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>promos_clicked</td>
<td>0.468511</td>
<td>1.000000</td>
<td>0.226558</td>
<td>0.140353</td>
<td>-0.195905</td>
<td>0.014748</td>
<td>0.055101</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>pageviews</td>
<td>0.461329</td>
<td>0.226558</td>
<td>1.000000</td>
<td>-0.092507</td>
<td>-0.367559</td>
<td>-0.073315</td>
<td>0.650406</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>deviceCategory</td>
<td>0.060296</td>
<td>0.140353</td>
<td>-0.092507</td>
<td>1.000000</td>
<td>0.080355</td>
<td>-0.177784</td>
<td>-0.136658</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>bounces</td>
<td>-0.346872</td>
<td>-0.195905</td>
<td>-0.367559</td>
<td>0.080355</td>
<td>1.000000</td>
<td>0.008584</td>
<td>-0.349636</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>source</td>
<td>0.084445</td>
<td>0.014748</td>
<td>-0.073315</td>
<td>-0.177784</td>
<td>0.008584</td>
<td>1.000000</td>
<td>-0.115659</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>last_action</td>
<td>0.191881</td>
<td>0.055101</td>
<td>0.650406</td>
<td>-0.136658</td>
<td>-0.349636</td>
<td>-0.115659</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The remaining features are moderately (<code>last_action</code> and <code>pageviews</code>) or weakly (all ther combinations) correlated to each other.</li>
</ol>
</div>
</div>
<p>Finally, we’ll show the correlation between the selected features and the label</p>
<div class="cell" data-tags="[]" data-execution_count="36">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>display(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    df_train_combo.drop(columns<span class="op">=</span>cols_to_drop)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    .corr()[[<span class="st">"made_purchase_on_future_visit"</span>]]</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"column"</span>})</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    .query(<span class="ss">f"column != '</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">'"</span>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>promos_displayed</td>
<td>0.042753</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>promos_clicked</td>
<td>-0.026077</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>pageviews</td>
<td>0.190842</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>deviceCategory</td>
<td>-0.150901</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>bounces</td>
<td>-0.134556</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>source</td>
<td>-0.028219</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>last_action</td>
<td>0.293250</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The remaining features are weakly correlated to the label (<code>made_purchase_on_future_visit</code>), with <code>last_action</code>, <code>pageviews</code> and <code>promos_displayed</code> showing the highest correlation.</li>
</ol>
</div>
</div>
</section>
<section id="feature-engineering" class="level3">
<h3 class="anchored" data-anchor-id="feature-engineering">Feature Engineering</h3>
<p>For each numerical feature, we’ll extract three new features as the ratio to the mean. For <code>pageviews</code>, this will give</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[<span class="st">'pageviews'</span>] <span class="op">/</span> df[<span class="st">'pageviews'</span>].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The intuition behind this transformation is that visitors with a higher-than-average number of pages viewed on their first visit have a higher likelihood of making a purchase on a return visit.</p>
<p>A custom <code>sklearn</code> transformer is used to define this below</p>
<div class="cell" data-tags="[]" data-execution_count="37">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AboveAveragePagePromoEngager(BaseEstimator, TransformerMixin):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        above_avg_pageviews <span class="op">=</span> (</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span> <span class="cf">if</span> X[<span class="st">"pageviews"</span>].mean() <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> X[<span class="st">"pageviews"</span>] <span class="op">/</span> X[<span class="st">"pageviews"</span>].mean()</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        above_avg_promos_clicked <span class="op">=</span> (</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> X[<span class="st">"promos_clicked"</span>].mean() <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> X[<span class="st">"promos_clicked"</span>] <span class="op">/</span> X[<span class="st">"promos_clicked"</span>].mean()</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>        above_avg_promos_displayed <span class="op">=</span> (</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> X[<span class="st">"promos_displayed"</span>].mean() <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> X[<span class="st">"promos_displayed"</span>] <span class="op">/</span> X[<span class="st">"promos_displayed"</span>].mean()</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> (</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>            X.assign(above_avg_pageviews<span class="op">=</span><span class="kw">lambda</span> df: above_avg_pageviews)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>            .assign(above_avg_promos_clicked<span class="op">=</span><span class="kw">lambda</span> df: above_avg_promos_clicked)</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>            .assign(above_avg_promos_displayed<span class="op">=</span><span class="kw">lambda</span> df: above_avg_promos_displayed)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> X</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="feature-processing-for-model-development-using-training-and-validation-data" class="level3">
<h3 class="anchored" data-anchor-id="feature-processing-for-model-development-using-training-and-validation-data">Feature Processing for Model Development Using Training and Validation Data</h3>
<p>An overall feature processing pipeline is now defined to process the selected features.</p>
<p>Get the names of the features after selecting (non-correlated) features</p>
<div class="cell" data-tags="[]" data-execution_count="38">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>numerical_features_after_dropping <span class="op">=</span> [</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    c <span class="cf">for</span> c <span class="kw">in</span> numerical_features <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> cols_to_drop</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>categorical_features_after_dropping <span class="op">=</span> [</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    c <span class="cf">for</span> c <span class="kw">in</span> categorical_features <span class="op">+</span> [<span class="st">"last_action"</span>] <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> cols_to_drop</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A preprocessor is defined to perform the following</p>
<ol type="1">
<li>normalize all numerical features (using <code>MinMaxScaler</code>)</li>
<li>dummy encoding for all categorical features (using <code>OneHotEncoder</code>)
<ul>
<li>similar to one-hot encoding, but with <a href="https://datascience.stackexchange.com/a/98173/17543">one less category per categorical feature</a></li>
</ul></li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="39">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>numeric_transformer <span class="op">=</span> Pipeline(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[(<span class="st">"aboveavg"</span>, AboveAveragePagePromoEngager()), (<span class="st">"scaler"</span>, MinMaxScaler())]</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>categorical_transformer <span class="op">=</span> Pipeline(</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[(<span class="st">"encoder"</span>, OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">"ignore"</span>, dtype<span class="op">=</span><span class="bu">int</span>, drop<span class="op">=</span><span class="st">"first"</span>))]</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"num"</span>, numeric_transformer, numerical_features_after_dropping),</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"cat"</span>, categorical_transformer, categorical_features_after_dropping),</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The feature processing pipeline is now defined</p>
<div class="cell" data-tags="[]" data-execution_count="40">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>pipe_trans <span class="op">=</span> Pipeline(steps<span class="op">=</span>[(<span class="st">"preprocessor"</span>, preprocessor)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Train the pipeline on the undersampled training data</p>
<div class="cell" data-tags="[]" data-execution_count="41">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> pipe_trans.fit(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    X_train_us[numerical_features_after_dropping <span class="op">+</span> categorical_features_after_dropping]</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Extract the processed categorical feature names from the trained processing pipeline</p>
<div class="cell" data-tags="[]" data-execution_count="42">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>categoricals_processed <span class="op">=</span> (</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    pipe_trans.named_steps[<span class="st">"preprocessor"</span>]</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    .named_transformers_[<span class="st">"cat"</span>]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    .get_feature_names_out(categorical_features_after_dropping)</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    .tolist()</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>categoricals_processed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>['deviceCategory_1',
 'deviceCategory_2',
 'bounces_1',
 'source_1',
 'source_2',
 'source_3',
 'source_4',
 'last_action_1',
 'last_action_2',
 'last_action_3',
 'last_action_4',
 'last_action_5',
 'last_action_6']</code></pre>
</div>
</div>
<p>Extract all processed feature names</p>
<div class="cell" data-tags="[]" data-execution_count="43">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>features_processed <span class="op">=</span> (</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    numerical_features_after_dropping</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> [<span class="ss">f"above_avg_</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c <span class="kw">in</span> numerical_features_after_dropping]</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> categoricals_processed</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>features_processed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>['promos_displayed',
 'promos_clicked',
 'pageviews',
 'above_avg_promos_displayed',
 'above_avg_promos_clicked',
 'above_avg_pageviews',
 'deviceCategory_1',
 'deviceCategory_2',
 'bounces_1',
 'source_1',
 'source_2',
 'source_3',
 'source_4',
 'last_action_1',
 'last_action_2',
 'last_action_3',
 'last_action_4',
 'last_action_5',
 'last_action_6']</code></pre>
</div>
</div>
<p>Create a datatype mapping dictionary to change the dummy-encoded categorical features to integers in the processed data</p>
<div class="cell" data-tags="[]" data-execution_count="44">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>categoricals_processed_dtypes <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">zip</span>(categoricals_processed, [pd.Int8Dtype() <span class="cf">for</span> _ <span class="kw">in</span> categoricals_processed])</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>categoricals_processed_dtypes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>{'deviceCategory_1': Int8Dtype(),
 'deviceCategory_2': Int8Dtype(),
 'bounces_1': Int8Dtype(),
 'source_1': Int8Dtype(),
 'source_2': Int8Dtype(),
 'source_3': Int8Dtype(),
 'source_4': Int8Dtype(),
 'last_action_1': Int8Dtype(),
 'last_action_2': Int8Dtype(),
 'last_action_3': Int8Dtype(),
 'last_action_4': Int8Dtype(),
 'last_action_5': Int8Dtype(),
 'last_action_6': Int8Dtype()}</code></pre>
</div>
</div>
<p>Process the features in the undersampled training data</p>
<div class="cell" data-tags="[]" data-execution_count="45">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>X_train_trans <span class="op">=</span> pd.DataFrame(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    pipe_trans.transform(</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>        X_train_us[</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>            numerical_features_after_dropping <span class="op">+</span> categorical_features_after_dropping</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>features_processed,</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>).astype(categoricals_processed_dtypes)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>display(X_train_trans.head())</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>display(X_train_trans.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">above_avg_promos_displayed</th>
<th data-quarto-table-cell-role="th">above_avg_promos_clicked</th>
<th data-quarto-table-cell-role="th">above_avg_pageviews</th>
<th data-quarto-table-cell-role="th">deviceCategory_1</th>
<th data-quarto-table-cell-role="th">deviceCategory_2</th>
<th data-quarto-table-cell-role="th">bounces_1</th>
<th data-quarto-table-cell-role="th">source_1</th>
<th data-quarto-table-cell-role="th">source_2</th>
<th data-quarto-table-cell-role="th">source_3</th>
<th data-quarto-table-cell-role="th">source_4</th>
<th data-quarto-table-cell-role="th">last_action_1</th>
<th data-quarto-table-cell-role="th">last_action_2</th>
<th data-quarto-table-cell-role="th">last_action_3</th>
<th data-quarto-table-cell-role="th">last_action_4</th>
<th data-quarto-table-cell-role="th">last_action_5</th>
<th data-quarto-table-cell-role="th">last_action_6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.011765</td>
<td>0.000000</td>
<td>0.044177</td>
<td>0.044177</td>
<td>0.000000</td>
<td>0.011765</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.023529</td>
<td>0.000000</td>
<td>0.008032</td>
<td>0.008032</td>
<td>0.000000</td>
<td>0.023529</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.047059</td>
<td>0.029412</td>
<td>0.044177</td>
<td>0.044177</td>
<td>0.029412</td>
<td>0.047059</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.011765</td>
<td>0.029412</td>
<td>0.016064</td>
<td>0.016064</td>
<td>0.029412</td>
<td>0.011765</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.011765</td>
<td>0.000000</td>
<td>0.048193</td>
<td>0.048193</td>
<td>0.000000</td>
<td>0.011765</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">above_avg_promos_displayed</th>
<th data-quarto-table-cell-role="th">above_avg_promos_clicked</th>
<th data-quarto-table-cell-role="th">above_avg_pageviews</th>
<th data-quarto-table-cell-role="th">deviceCategory_1</th>
<th data-quarto-table-cell-role="th">deviceCategory_2</th>
<th data-quarto-table-cell-role="th">bounces_1</th>
<th data-quarto-table-cell-role="th">source_1</th>
<th data-quarto-table-cell-role="th">source_2</th>
<th data-quarto-table-cell-role="th">source_3</th>
<th data-quarto-table-cell-role="th">source_4</th>
<th data-quarto-table-cell-role="th">last_action_1</th>
<th data-quarto-table-cell-role="th">last_action_2</th>
<th data-quarto-table-cell-role="th">last_action_3</th>
<th data-quarto-table-cell-role="th">last_action_4</th>
<th data-quarto-table-cell-role="th">last_action_5</th>
<th data-quarto-table-cell-role="th">last_action_6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">46745</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.040161</td>
<td>0.040161</td>
<td>0.0</td>
<td>0.011765</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">46746</td>
<td>0.023529</td>
<td>0.0</td>
<td>0.068273</td>
<td>0.068273</td>
<td>0.0</td>
<td>0.023529</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">46747</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.012048</td>
<td>0.012048</td>
<td>0.0</td>
<td>0.000000</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">46748</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.076305</td>
<td>0.076305</td>
<td>0.0</td>
<td>0.011765</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">46749</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.028112</td>
<td>0.028112</td>
<td>0.0</td>
<td>0.011765</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Process the features in the validation data, using the preprocessing pipeline that was trained on the undersampled training data</p>
<div class="cell" data-tags="[]" data-execution_count="46">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>X_val_trans <span class="op">=</span> pd.DataFrame(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    pipe_trans.transform(</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>        X_val[numerical_features_after_dropping <span class="op">+</span> categorical_features_after_dropping]</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>features_processed,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>).astype(categoricals_processed_dtypes)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>display(X_val_trans.head())</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>display(X_val_trans.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">above_avg_promos_displayed</th>
<th data-quarto-table-cell-role="th">above_avg_promos_clicked</th>
<th data-quarto-table-cell-role="th">above_avg_pageviews</th>
<th data-quarto-table-cell-role="th">deviceCategory_1</th>
<th data-quarto-table-cell-role="th">deviceCategory_2</th>
<th data-quarto-table-cell-role="th">bounces_1</th>
<th data-quarto-table-cell-role="th">source_1</th>
<th data-quarto-table-cell-role="th">source_2</th>
<th data-quarto-table-cell-role="th">source_3</th>
<th data-quarto-table-cell-role="th">source_4</th>
<th data-quarto-table-cell-role="th">last_action_1</th>
<th data-quarto-table-cell-role="th">last_action_2</th>
<th data-quarto-table-cell-role="th">last_action_3</th>
<th data-quarto-table-cell-role="th">last_action_4</th>
<th data-quarto-table-cell-role="th">last_action_5</th>
<th data-quarto-table-cell-role="th">last_action_6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.016064</td>
<td>0.018231</td>
<td>0.0</td>
<td>0.014848</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.035294</td>
<td>0.0</td>
<td>0.064257</td>
<td>0.072923</td>
<td>0.0</td>
<td>0.044543</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.004558</td>
<td>0.0</td>
<td>0.014848</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.008032</td>
<td>0.009115</td>
<td>0.0</td>
<td>0.000000</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.016064</td>
<td>0.018231</td>
<td>0.0</td>
<td>0.014848</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">above_avg_promos_displayed</th>
<th data-quarto-table-cell-role="th">above_avg_promos_clicked</th>
<th data-quarto-table-cell-role="th">above_avg_pageviews</th>
<th data-quarto-table-cell-role="th">deviceCategory_1</th>
<th data-quarto-table-cell-role="th">deviceCategory_2</th>
<th data-quarto-table-cell-role="th">bounces_1</th>
<th data-quarto-table-cell-role="th">source_1</th>
<th data-quarto-table-cell-role="th">source_2</th>
<th data-quarto-table-cell-role="th">source_3</th>
<th data-quarto-table-cell-role="th">source_4</th>
<th data-quarto-table-cell-role="th">last_action_1</th>
<th data-quarto-table-cell-role="th">last_action_2</th>
<th data-quarto-table-cell-role="th">last_action_3</th>
<th data-quarto-table-cell-role="th">last_action_4</th>
<th data-quarto-table-cell-role="th">last_action_5</th>
<th data-quarto-table-cell-role="th">last_action_6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">21172</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.172691</td>
<td>0.195981</td>
<td>0.0</td>
<td>0.014848</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21173</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.008032</td>
<td>0.009115</td>
<td>0.0</td>
<td>0.014848</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">21174</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.004558</td>
<td>0.0</td>
<td>0.000000</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21175</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.004558</td>
<td>0.0</td>
<td>0.000000</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">21176</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.004558</td>
<td>0.0</td>
<td>0.014848</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="feature-processing-for-model-evaluation-using-training-validation-and-testing-data" class="level3">
<h3 class="anchored" data-anchor-id="feature-processing-for-model-evaluation-using-training-validation-and-testing-data">Feature Processing for Model Evaluation Using Training + Validation and Testing Data</h3>
<p>Train the pipeline on the undersampled combined training and validation data</p>
<div class="cell" data-tags="[]" data-execution_count="47">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> pipe_trans.fit(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    X_train_val_us[</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>        numerical_features_after_dropping <span class="op">+</span> categorical_features_after_dropping</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Extract the processed categorical feature names from the trained processing pipeline</p>
<div class="cell" data-tags="[]" data-execution_count="48">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>categoricals_processed_train_val <span class="op">=</span> (</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    pipe_trans.named_steps[<span class="st">"preprocessor"</span>]</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    .named_transformers_[<span class="st">"cat"</span>]</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    .get_feature_names_out(categorical_features_after_dropping)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    .tolist()</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>categoricals_processed_train_val</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>['deviceCategory_1',
 'deviceCategory_2',
 'bounces_1',
 'source_1',
 'source_2',
 'source_3',
 'source_4',
 'last_action_1',
 'last_action_2',
 'last_action_3',
 'last_action_4',
 'last_action_5',
 'last_action_6']</code></pre>
</div>
</div>
<p>Extract all processed feature names</p>
<div class="cell" data-tags="[]" data-execution_count="49">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>features_processed_train_val <span class="op">=</span> (</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    numerical_features_after_dropping</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> [<span class="ss">f"above_avg_</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> c <span class="kw">in</span> numerical_features_after_dropping]</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> categoricals_processed_train_val</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>features_processed_train_val</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>['promos_displayed',
 'promos_clicked',
 'pageviews',
 'above_avg_promos_displayed',
 'above_avg_promos_clicked',
 'above_avg_pageviews',
 'deviceCategory_1',
 'deviceCategory_2',
 'bounces_1',
 'source_1',
 'source_2',
 'source_3',
 'source_4',
 'last_action_1',
 'last_action_2',
 'last_action_3',
 'last_action_4',
 'last_action_5',
 'last_action_6']</code></pre>
</div>
</div>
<p>Create a datatype mapping dictionary to change the dummy-encoded categorical features to integers in the processed data</p>
<div class="cell" data-tags="[]" data-execution_count="50">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>categoricals_processed_dtypes_train_val <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">zip</span>(</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>        categoricals_processed_train_val,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>        [pd.Int8Dtype() <span class="cf">for</span> _ <span class="kw">in</span> categoricals_processed_train_val],</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>categoricals_processed_dtypes_train_val</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>{'deviceCategory_1': Int8Dtype(),
 'deviceCategory_2': Int8Dtype(),
 'bounces_1': Int8Dtype(),
 'source_1': Int8Dtype(),
 'source_2': Int8Dtype(),
 'source_3': Int8Dtype(),
 'source_4': Int8Dtype(),
 'last_action_1': Int8Dtype(),
 'last_action_2': Int8Dtype(),
 'last_action_3': Int8Dtype(),
 'last_action_4': Int8Dtype(),
 'last_action_5': Int8Dtype(),
 'last_action_6': Int8Dtype()}</code></pre>
</div>
</div>
<p>Process the features in the undersampled combined training and validation data</p>
<div class="cell" data-tags="[]" data-execution_count="51">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>X_train_val_trans <span class="op">=</span> pd.DataFrame(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    pipe_trans.transform(</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>        X_train_val_us[</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>            numerical_features_after_dropping <span class="op">+</span> categorical_features_after_dropping</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>features_processed,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>).astype(categoricals_processed_dtypes)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>display(X_train_val_trans.head())</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>display(X_train_val_trans.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">above_avg_promos_displayed</th>
<th data-quarto-table-cell-role="th">above_avg_promos_clicked</th>
<th data-quarto-table-cell-role="th">above_avg_pageviews</th>
<th data-quarto-table-cell-role="th">deviceCategory_1</th>
<th data-quarto-table-cell-role="th">deviceCategory_2</th>
<th data-quarto-table-cell-role="th">bounces_1</th>
<th data-quarto-table-cell-role="th">source_1</th>
<th data-quarto-table-cell-role="th">source_2</th>
<th data-quarto-table-cell-role="th">source_3</th>
<th data-quarto-table-cell-role="th">source_4</th>
<th data-quarto-table-cell-role="th">last_action_1</th>
<th data-quarto-table-cell-role="th">last_action_2</th>
<th data-quarto-table-cell-role="th">last_action_3</th>
<th data-quarto-table-cell-role="th">last_action_4</th>
<th data-quarto-table-cell-role="th">last_action_5</th>
<th data-quarto-table-cell-role="th">last_action_6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.004016</td>
<td>0.0</td>
<td>0.000000</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.004016</td>
<td>0.0</td>
<td>0.000000</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.004016</td>
<td>0.0</td>
<td>0.000000</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.004016</td>
<td>0.0</td>
<td>0.000000</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.012048</td>
<td>0.012048</td>
<td>0.0</td>
<td>0.011765</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">above_avg_promos_displayed</th>
<th data-quarto-table-cell-role="th">above_avg_promos_clicked</th>
<th data-quarto-table-cell-role="th">above_avg_pageviews</th>
<th data-quarto-table-cell-role="th">deviceCategory_1</th>
<th data-quarto-table-cell-role="th">deviceCategory_2</th>
<th data-quarto-table-cell-role="th">bounces_1</th>
<th data-quarto-table-cell-role="th">source_1</th>
<th data-quarto-table-cell-role="th">source_2</th>
<th data-quarto-table-cell-role="th">source_3</th>
<th data-quarto-table-cell-role="th">source_4</th>
<th data-quarto-table-cell-role="th">last_action_1</th>
<th data-quarto-table-cell-role="th">last_action_2</th>
<th data-quarto-table-cell-role="th">last_action_3</th>
<th data-quarto-table-cell-role="th">last_action_4</th>
<th data-quarto-table-cell-role="th">last_action_5</th>
<th data-quarto-table-cell-role="th">last_action_6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">54687</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.012048</td>
<td>0.012048</td>
<td>0.0</td>
<td>0.000000</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">54688</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.076305</td>
<td>0.076305</td>
<td>0.0</td>
<td>0.011765</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">54689</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.028112</td>
<td>0.028112</td>
<td>0.0</td>
<td>0.011765</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">54690</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.064257</td>
<td>0.064257</td>
<td>0.0</td>
<td>0.011765</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">54691</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.172691</td>
<td>0.172691</td>
<td>0.0</td>
<td>0.011765</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Process the features in the test data, using the preprocessing pipeline that was trained on the undersampled combined training and validation data</p>
<div class="cell" data-tags="[]" data-execution_count="52">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>X_test_trans <span class="op">=</span> pd.DataFrame(</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    pipe_trans.transform(</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>        X_test[numerical_features_after_dropping <span class="op">+</span> categorical_features_after_dropping]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>features_processed,</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>).astype(categoricals_processed_dtypes)</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>display(X_test_trans.head())</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>display(X_test_trans.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">above_avg_promos_displayed</th>
<th data-quarto-table-cell-role="th">above_avg_promos_clicked</th>
<th data-quarto-table-cell-role="th">above_avg_pageviews</th>
<th data-quarto-table-cell-role="th">deviceCategory_1</th>
<th data-quarto-table-cell-role="th">deviceCategory_2</th>
<th data-quarto-table-cell-role="th">bounces_1</th>
<th data-quarto-table-cell-role="th">source_1</th>
<th data-quarto-table-cell-role="th">source_2</th>
<th data-quarto-table-cell-role="th">source_3</th>
<th data-quarto-table-cell-role="th">source_4</th>
<th data-quarto-table-cell-role="th">last_action_1</th>
<th data-quarto-table-cell-role="th">last_action_2</th>
<th data-quarto-table-cell-role="th">last_action_3</th>
<th data-quarto-table-cell-role="th">last_action_4</th>
<th data-quarto-table-cell-role="th">last_action_5</th>
<th data-quarto-table-cell-role="th">last_action_6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.005009</td>
<td>0.0</td>
<td>0.014548</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.005009</td>
<td>0.0</td>
<td>0.014548</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.024096</td>
<td>0.030056</td>
<td>0.0</td>
<td>0.014548</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.005009</td>
<td>0.0</td>
<td>0.014548</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.008032</td>
<td>0.010019</td>
<td>0.0</td>
<td>0.000000</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">above_avg_promos_displayed</th>
<th data-quarto-table-cell-role="th">above_avg_promos_clicked</th>
<th data-quarto-table-cell-role="th">above_avg_pageviews</th>
<th data-quarto-table-cell-role="th">deviceCategory_1</th>
<th data-quarto-table-cell-role="th">deviceCategory_2</th>
<th data-quarto-table-cell-role="th">bounces_1</th>
<th data-quarto-table-cell-role="th">source_1</th>
<th data-quarto-table-cell-role="th">source_2</th>
<th data-quarto-table-cell-role="th">source_3</th>
<th data-quarto-table-cell-role="th">source_4</th>
<th data-quarto-table-cell-role="th">last_action_1</th>
<th data-quarto-table-cell-role="th">last_action_2</th>
<th data-quarto-table-cell-role="th">last_action_3</th>
<th data-quarto-table-cell-role="th">last_action_4</th>
<th data-quarto-table-cell-role="th">last_action_5</th>
<th data-quarto-table-cell-role="th">last_action_6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">20159</td>
<td>0.023529</td>
<td>0.0</td>
<td>0.020080</td>
<td>0.025047</td>
<td>0.0</td>
<td>0.029097</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20160</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.005009</td>
<td>0.0</td>
<td>0.000000</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20161</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.008032</td>
<td>0.010019</td>
<td>0.0</td>
<td>0.000000</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20162</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.005009</td>
<td>0.0</td>
<td>0.000000</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20163</td>
<td>0.011765</td>
<td>0.0</td>
<td>0.004016</td>
<td>0.005009</td>
<td>0.0</td>
<td>0.014548</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Verify that there are no missing values in the transformed training data</p>
<div class="cell" data-tags="[]" data-execution_count="53">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> (X_train_trans.isna().<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span>).<span class="bu">all</span>()</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>X_train_trans.isna().<span class="bu">sum</span>().reset_index().rename(</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"missing"</span>, <span class="st">"index"</span>: <span class="st">"transformed_feature"</span>}</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="53">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">transformed_feature</th>
<th data-quarto-table-cell-role="th">missing</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>promos_displayed</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>promos_clicked</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>pageviews</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>above_avg_promos_displayed</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>above_avg_promos_clicked</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>above_avg_pageviews</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>deviceCategory_1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>deviceCategory_2</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>bounces_1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>source_1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>source_2</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>source_3</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>source_4</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>last_action_1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>last_action_2</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>last_action_3</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>last_action_4</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>last_action_5</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>last_action_6</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Verify that there are no missing values in the transformed combined training and validation data</p>
<div class="cell" data-tags="[]" data-execution_count="54">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> (X_train_val_trans.isna().<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span>).<span class="bu">all</span>()</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>X_train_val_trans.isna().<span class="bu">sum</span>().reset_index().rename(</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"missing"</span>, <span class="st">"index"</span>: <span class="st">"transformed_feature"</span>}</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="54">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">transformed_feature</th>
<th data-quarto-table-cell-role="th">missing</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>promos_displayed</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>promos_clicked</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>pageviews</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>above_avg_promos_displayed</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>above_avg_promos_clicked</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>above_avg_pageviews</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>deviceCategory_1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>deviceCategory_2</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>bounces_1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>source_1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>source_2</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>source_3</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>source_4</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>last_action_1</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>last_action_2</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>last_action_3</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>last_action_4</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>last_action_5</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>last_action_6</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The processed training data has no missing values so our feature processing pipeline has not produced errors when transforming the data. In order to avoid data leakage/lookahead bias, we will assume this is also the case with the validation split.</li>
<li>The same is true for the combined training and validation split after transformation using the feature processing pipeline. Here, we will assume this is also the case with the test split.</li>
</ol>
</div>
</div>
</section>
</section>
<section id="ml-training-using-validation-data" class="level2">
<h2 class="anchored" data-anchor-id="ml-training-using-validation-data">ML Training using Validation Data</h2>
<p>Define ML pipelines to be compared in this step</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>pipe_lr <span class="op">=</span> Pipeline([(<span class="st">'clf'</span>, LogisticRegresion())])</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>pipe_rf <span class="op">=</span> Pipeline([(<span class="st">'clf'</span>, RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">500</span>))])</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>pipe_gb <span class="op">=</span> Pipeline([(<span class="st">'clf'</span>, GradientBoostingClassifier(n_estimators<span class="op">=</span><span class="dv">200</span>))])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="logisticregression" class="level3">
<h3 class="anchored" data-anchor-id="logisticregression"><code>LogisticRegression</code></h3>
<p>Train using undersampled training data</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> pipe_lr.fit(X_train_us_trans, y_train_us)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Make predictions on validation data</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>y_val_pred <span class="op">=</span> pipe_lr.predict(X_val_trans)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>y_val_pred_proba <span class="op">=</span> pipe_lr.predict_proba(X_val_trans)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Evaluate predictions on the validation data</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>scores_lr <span class="op">=</span> get_metrics(</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    y_val,</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    y_val_pred,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    y_val_pred_proba,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    ds_factor<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    sample_weights<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    average<span class="op">=</span><span class="st">"binary"</span>,</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    zero_division<span class="op">=</span><span class="st">"warn"</span>,</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>df_scores_lr <span class="op">=</span> pd.DataFrame.from_records([scores_lr]).assign(model_type<span class="op">=</span><span class="st">'lr'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="randomforestclassifier" class="level3">
<h3 class="anchored" data-anchor-id="randomforestclassifier"><code>RandomForestClassifier</code></h3>
<p>Repeat for <code>RandomForestClassifier</code></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># train</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> pipe_rf.fit(X_train_us_trans, y_train_us)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co"># predict</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>y_val_pred <span class="op">=</span> pipe_rf.predict(X_val_trans)</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>y_val_pred_proba <span class="op">=</span> pipe_rf.predict_proba(X_val_trans)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluate</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>scores_rf <span class="op">=</span> get_metrics(</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    y_val,</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    y_val_pred,</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    y_val_pred_proba,</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    ds_factor<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>    sample_weights<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    average<span class="op">=</span><span class="st">"binary"</span>,</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    zero_division<span class="op">=</span><span class="st">"warn"</span>,</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>df_scores_rf <span class="op">=</span> pd.DataFrame.from_records([scores_rf]).assign(model_type<span class="op">=</span><span class="st">'rf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="gradientboostingclassifier" class="level3">
<h3 class="anchored" data-anchor-id="gradientboostingclassifier"><code>GradientBoostingClassifier</code></h3>
<p>Repeat for <code>GradientBoostingClassifier</code></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># train</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> pipe_gb.fit(X_train_us_trans, y_train_us)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># predict</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>y_val_pred <span class="op">=</span> pipe_gb.predict(X_val_trans)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>y_val_pred_proba <span class="op">=</span> pipe_gb.predict_proba(X_val_trans)</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluate</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>scores_gb <span class="op">=</span> get_metrics(</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    y_val,</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    y_val_pred,</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    y_val_pred_proba,</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    ds_factor<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    sample_weights<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>    average<span class="op">=</span><span class="st">"binary"</span>,</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>    zero_division<span class="op">=</span><span class="st">"warn"</span>,</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>df_scores_gb <span class="op">=</span> pd.DataFrame.from_records([scores_gb]).assign(model_type<span class="op">=</span><span class="st">'rf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="extracting-best-ml-model" class="level3">
<h3 class="anchored" data-anchor-id="extracting-best-ml-model">Extracting Best ML Model</h3>
<p>Combine validation scores for all models and rank the models based on the validation split scores</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>df_validation_scores <span class="op">=</span> (</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    pd.concat([df_scores_lr, df_scores_rf, df_scores_gb])</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>        rank<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"f05"</span>]</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>        .rank(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>        .astype(<span class="bu">int</span>)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>        .astype(pd.Int8Dtype())</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    .sort_values(by<span class="op">=</span>[<span class="st">"rank"</span>], ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>df_validation_scores</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we’ll extract the best ML model</p>
<div class="cell" data-tags="[]">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>df_validation_scores.query(<span class="st">"rank == 1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="ml-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="ml-evaluation">ML Evaluation</h2>
<p>The best ML model is now used to make predictions on the test split and on the combined train and validation split. Recall that the combined train and validation split has been undersampled. The test split has not been undersampled.</p>
<section id="make-and-score-predictions" class="level3">
<h3 class="anchored" data-anchor-id="make-and-score-predictions">Make and Score Predictions</h3>
<p>Repeat training and evaluation using the best model found above and evaluate the predictions on both splits</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>pipe_best <span class="op">=</span> Pipeline([(<span class="st">'clf'</span>, RandomForestClassifier(n_estimators<span class="op">=</span><span class="dv">500</span>))])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># train</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> pipe_best.fit(X_train_val_us_trans, y_train_val_us)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co"># predict</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>y_test_pred <span class="op">=</span> pipe_best.predict(X_test_trans)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>y_test_pred_proba <span class="op">=</span> pipe_gb.predict_proba(X_test_trans)</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluate</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>scores_train_val <span class="op">=</span> get_metrics(</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    y_train_val_us,</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    y_train_val_us_pred,</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>    y_train_val_us_proba,</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    ds_factor<span class="op">=</span>ds_factor,</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    average<span class="op">=</span><span class="st">"binary"</span>,</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>    zero_division<span class="op">=</span><span class="st">"warn"</span>,</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>scores_test <span class="op">=</span> get_metrics(</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>    y_test,</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    y_test_pred,</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>    y_test_proba,</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>    ds_factor<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>    average<span class="op">=</span><span class="st">"binary"</span>,</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>    zero_division<span class="op">=</span><span class="st">"warn"</span>,</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The evaluation scores from both splits are now combined and shown below</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>df_scores_eval <span class="op">=</span> pd.concat(</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame.from_records([scores_train_val]).assign(split<span class="op">=</span><span class="st">'train+val'</span>),</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>        pd.DataFrame.from_records([scores_test]).assign(split<span class="op">=</span><span class="st">'test'</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>df_scores_eval</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>…</li>
</ol>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.quarto\.org\/custom");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->



<script src="../../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>