<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine Learning Project - Exploratory Data Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../notebooks/04-transform/notebooks/04_transform.html" rel="next">
<link href="../../../notebooks/02-prepare/notebooks/02_prepare.html" rel="prev">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Machine Learning Project</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../notebooks/03-eda/notebooks/03_eda.html">Explore Data</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      <img src="../../../images/lorip_square.jpg" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../references/Scope.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scope</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/01-get-data/notebooks/01_get_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Get Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/02-prepare/notebooks/02_prepare.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prepare Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/03-eda/notebooks/03_eda.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Explore Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/04-transform/notebooks/04_transform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transform Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/05-development/notebooks/05_development.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Baseline</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../notebooks/07-create-audience/notebooks/07_create_audience.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create Audience</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about" id="toc-about" class="nav-link active" data-scroll-target="#about">About</a>
  <ul class="collapse">
  <li><a href="#objectives" id="toc-objectives" class="nav-link" data-scroll-target="#objectives">Objectives</a></li>
  <li><a href="#discussion-of-study-period-for-this-project" id="toc-discussion-of-study-period-for-this-project" class="nav-link" data-scroll-target="#discussion-of-study-period-for-this-project">Discussion of Study Period for This Project</a></li>
  <li><a href="#data-selection-for-eda" id="toc-data-selection-for-eda" class="nav-link" data-scroll-target="#data-selection-for-eda">Data Selection for EDA</a></li>
  <li><a href="#business-questions-for-eda" id="toc-business-questions-for-eda" class="nav-link" data-scroll-target="#business-questions-for-eda">Business Questions for EDA</a></li>
  </ul></li>
  <li><a href="#user-inputs" id="toc-user-inputs" class="nav-link" data-scroll-target="#user-inputs">User Inputs</a></li>
  <li><a href="#get-and-prepare-data" id="toc-get-and-prepare-data" class="nav-link" data-scroll-target="#get-and-prepare-data">Get and Prepare Data</a></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">Exploratory Data Analysis</a></li>
  <li><a href="#key-findings" id="toc-key-findings" class="nav-link" data-scroll-target="#key-findings">Key Findings</a></li>
  <li><a href="#summary-of-assumptions" id="toc-summary-of-assumptions" class="nav-link" data-scroll-target="#summary-of-assumptions">Summary of Assumptions</a></li>
  <li><a href="#summary-of-tasks-performed" id="toc-summary-of-tasks-performed" class="nav-link" data-scroll-target="#summary-of-tasks-performed">Summary of Tasks Performed</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  <li><a href="#next-step" id="toc-next-step" class="nav-link" data-scroll-target="#next-step">Next Step</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/elsdes3/market/blob/main/notebooks/03-eda/notebooks/03_eda.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/elsdes3/market/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Exploratory Data Analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Import Python modules</p>
<div class="cell" data-tags="[]" data-execution_count="2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> calendar <span class="im">import</span> day_name, month_name</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Tuple, Union</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytz</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> feature_engine.encoding <span class="im">import</span> RareLabelEncoder</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.oauth2 <span class="im">import</span> service_account</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> FunctionTransformer</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="about" class="level2">
<h2 class="anchored" data-anchor-id="about">About</h2>
<p>This step of the analysis explores the visit data for the Google Merchandise store on the Google Marketplace, based on learnings from the data preparation step.</p>
<section id="objectives" class="level3">
<h3 class="anchored" data-anchor-id="objectives">Objectives</h3>
<p>The goals of this step in the analysis are the following</p>
<ol type="1">
<li>explore the prepared data to look for any underlying patterns that can be captured through features that might help ML modeling</li>
<li>observe the class imbalance of the labels (<code>y</code>) to get a sense of any resampling techniques that could aid the performance of a ML model</li>
</ol>
</section>
<section id="discussion-of-study-period-for-this-project" class="level3">
<h3 class="anchored" data-anchor-id="discussion-of-study-period-for-this-project">Discussion of Study Period for This Project</h3>
<p>Same as for data preparation.</p>
</section>
<section id="data-selection-for-eda" class="level3">
<h3 class="anchored" data-anchor-id="data-selection-for-eda">Data Selection for EDA</h3>
<p>With the above in mind, EDA in this step will cover the training data.</p>
</section>
<section id="business-questions-for-eda" class="level3">
<h3 class="anchored" data-anchor-id="business-questions-for-eda">Business Questions for EDA</h3>
<p>We will explore this dataset by answering the following (non-exhaustive) set of business-relevant questions</p>
<ol type="1">
<li>For <a href="https://www.megalytic.com/blog/understanding-google-analytics-channels">high-level channel</a>, and the <a href="https://www.propellernet.co.uk/what-is-the-difference-between-source-medium-in-google-analytics/">more fine-graned traffic source and traffic medium</a>, get the correlation between the numerical attributes of visits and total visit revenue. Across all of these groupings of sources of web traffic arriving at the merchandise store, comment on the strongest and weakest correlations to revenue.</li>
<li>Which channels were responsible for the most first-visitors with a purchase on their return visit? Show this comparison on a chart by channel.</li>
<li>Is there any one web-browser that return purchasers used on their first visit?</li>
<li>Do visitors who make a purchase on their return visit to the store have a preference for the type of device they are using (desktop, mobile, etc.)?</li>
<li>Which traffic sources were responsible for the most return purchasers on weekdays and weekends?</li>
<li>Show the fraction of visitors who did make a purchase on their return visit to the merchandise store by month and day of the month.</li>
<li>Show the fraction of visitors who made a purchase on their return visit to the merchandise store by month and day of the week.</li>
<li>Show the breakdown of total revenue earned by visitors who are return purchasers and those that are not return purchasers.</li>
</ol>
</section>
</section>
<section id="user-inputs" class="level2">
<h2 class="anchored" data-anchor-id="user-inputs">User Inputs</h2>
<p>Get relative path to project root directory</p>
<div class="cell" data-tags="[]" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>PROJ_ROOT_DIR <span class="op">=</span> os.path.join(os.pardir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define the following</p>
<ol type="1">
<li>train data start date</li>
<li>train data end date</li>
<li>test data end date</li>
<li>list of categorical features to be used</li>
<li>dictionary of columns to be frequency-encoded and minimum frequency thresholds to be used
<ul>
<li>thresholds are 5% or 10%, based on our findings from the data preparation step7. list of categorical features to be used</li>
</ul></li>
<li>dictionary of columns to be frequency-encoded and minimum frequency thresholds to be used
<ul>
<li>thresholds are 5% or 10%, based on our findings from the data preparation step</li>
</ul></li>
</ol>
<div class="cell" data-tags="[&quot;parameters&quot;]" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>train_start_date <span class="op">=</span> <span class="st">"20160901"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>train_end_date <span class="op">=</span> <span class="st">"20161231"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>test_end_date <span class="op">=</span> <span class="st">"20170228"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># categorical column names</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>categorical_columns <span class="op">=</span> [</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bounces"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_action"</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"medium"</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"channelGrouping"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"browser"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os"</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deviceCategory"</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># categorical columns to be grouped</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>cols_to_group <span class="op">=</span> {</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"5_pct"</span>: [<span class="st">"source"</span>, <span class="st">"browser"</span>],</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"10_pct"</span>: [<span class="st">"os"</span>, <span class="st">"channelGrouping"</span>, <span class="st">"medium"</span>],</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Retrieve credentials for <code>bigquery</code> client</p>
<div class="cell" data-tags="[]" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Google Cloud PROJECT ID</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>gcp_project_id <span class="op">=</span> os.environ[<span class="st">"GCP_PROJECT_ID"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get filepath to Google Cloud Service Account JSON key</p>
<div class="cell" data-tags="[]" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>raw_data_dir <span class="op">=</span> os.path.join(PROJ_ROOT_DIR, <span class="st">"data"</span>, <span class="st">"raw"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>gcp_creds_fpath <span class="op">=</span> glob(os.path.join(raw_data_dir, <span class="st">"*.json"</span>))[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Authenticate <code>bigquery</code> client and get dictionary with credentials</p>
<div class="cell" data-tags="[]" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>gcp_credentials <span class="op">=</span> service_account.Credentials.from_service_account_file(gcp_creds_fpath)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>gcp_auth_dict <span class="op">=</span> <span class="bu">dict</span>(gcp_project_id<span class="op">=</span>gcp_project_id, gcp_creds<span class="op">=</span>gcp_credentials)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create a mapping between action type integer and label, in order to get meaningful names from the <code>action_type</code> column</p>
<div class="cell" data-tags="[]" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>mapper <span class="op">=</span> {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>: <span class="st">"Click through of product lists"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>: <span class="st">"Product detail views"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>: <span class="st">"Add product(s) to cart"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span>: <span class="st">"Remove product(s) from cart"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span>: <span class="st">"Check out"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">6</span>: <span class="st">"Completed purchase"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="dv">7</span>: <span class="st">"Refund of purchase"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">8</span>: <span class="st">"Checkout options"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>: <span class="st">"Unknown"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define a dictionary to change datatypes of prepared data (this was originally developed in the data preparation step)</p>
<div class="cell" data-tags="[]" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>dtypes_dict <span class="op">=</span> {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fullvisitorid"</span>: pd.StringDtype(),</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitId"</span>: pd.StringDtype(),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"visitNumber"</span>: pd.Int8Dtype(),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"country"</span>: pd.StringDtype(),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quarter"</span>: pd.Int8Dtype(),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month"</span>: pd.Int8Dtype(),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_month"</span>: pd.Int8Dtype(),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_week"</span>: pd.Int8Dtype(),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour"</span>: pd.Int8Dtype(),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minute"</span>: pd.Int8Dtype(),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"second"</span>: pd.Int8Dtype(),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"medium"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"channelGrouping"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hits"</span>: pd.Int16Dtype(),</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bounces"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"last_action"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_detail_views"</span>: pd.Int16Dtype(),</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_displayed"</span>: pd.Int16Dtype(),</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"promos_clicked"</span>: pd.Int16Dtype(),</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_views"</span>: pd.Int16Dtype(),</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_clicks"</span>: pd.Int16Dtype(),</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pageviews"</span>: pd.Int16Dtype(),</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"transact_revenue"</span>: pd.Float32Dtype(),</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"time_on_site"</span>: pd.Int16Dtype(),</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"browser"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"os"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"added_to_cart"</span>: pd.Int16Dtype(),</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deviceCategory"</span>: pd.CategoricalDtype(),  <span class="co">#</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Define a Python helper functions to perform the following</p>
<ol type="1">
<li>execute a SQL query using Google BigQuery</li>
<li>set column datatypes of a <code>pandas.DataFrame</code></li>
<li>drop duplicates based on a list of columns in a <code>pandas.DataFrame</code></li>
<li>customize the axes of a <code>matplotlib</code> plot</li>
<li>plot a <a href="https://stackoverflow.com/a/35234137/4057186">faceted bar chart using <code>seaborn</code></a></li>
<li>plot a heatmap using <code>seaborn</code></li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_sql_query(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    query: <span class="bu">str</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    gcp_project_id: <span class="bu">str</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    gcp_creds: os.PathLike,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    show_dtypes: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    show_info: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    show_df: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Run query on BigQuery and return results as pandas.DataFrame."""</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> datetime.now(pytz.timezone(<span class="st">"US/Eastern"</span>))</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    start_time_str <span class="op">=</span> start_time.strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S.</span><span class="sc">%f</span><span class="st">"</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Query execution start time = </span><span class="sc">{</span>start_time_str[:<span class="op">-</span><span class="dv">3</span>]<span class="sc">}</span><span class="ss">..."</span>, end<span class="op">=</span><span class="st">""</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_gbq(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        query,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        project_id<span class="op">=</span>gcp_project_id,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        credentials<span class="op">=</span>gcp_creds,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        dialect<span class="op">=</span><span class="st">"standard"</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># configuration is optional, since default for query caching is True</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        configuration<span class="op">=</span>{<span class="st">"query"</span>: {<span class="st">"useQueryCache"</span>: <span class="va">True</span>}},</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># use_bqstorage_api=True,</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    end_time <span class="op">=</span> datetime.now(pytz.timezone(<span class="st">"US/Eastern"</span>))</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    end_time_str <span class="op">=</span> end_time.strftime(<span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S.</span><span class="sc">%f</span><span class="st">"</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    duration <span class="op">=</span> end_time <span class="op">-</span> start_time</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    duration <span class="op">=</span> duration.seconds <span class="op">+</span> (duration.microseconds <span class="op">/</span> <span class="dv">1_000_000</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"done at </span><span class="sc">{</span>end_time_str[:<span class="op">-</span><span class="dv">3</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>duration<span class="sc">:.3f}</span><span class="ss"> seconds)."</span>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Query returned </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> rows"</span>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_df:</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>            display(df)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_dtypes:</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        display(df.dtypes.rename(<span class="st">"dtype"</span>).to_frame().transpose())</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> show_info:</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        df.info()</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_datatypes(df: pd.DataFrame, dtypes: Dict) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Set datatypes in a DataFrame using a dictionary."""</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.astype(dtypes)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> drop_duplicates(df: pd.DataFrame, subset: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Drop duplicates based on a list of columns in a DataFrame."""</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>subset, keep<span class="op">=</span><span class="st">"first"</span>)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> customize_splines(ax: plt.axis, edgecolor: <span class="bu">str</span> <span class="op">=</span> <span class="st">"grey"</span>) <span class="op">-&gt;</span> plt.axis:</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Customize matplotlib axis properties."""</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"left"</span>].set_edgecolor(edgecolor)</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"left"</span>].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"bottom"</span>].set_edgecolor(edgecolor)</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"bottom"</span>].set_linewidth(<span class="fl">1.5</span>)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"top"</span>].set_edgecolor(<span class="va">None</span>)</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    ax.spines[<span class="st">"right"</span>].set_edgecolor(<span class="va">None</span>)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>        top<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        bottom<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        left<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        right<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>        labelleft<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>        labelbottom<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_faceted_grouped_bar_chart(</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    data: pd.DataFrame,</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>    xvar: <span class="bu">str</span>,</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>    yvar: <span class="bu">str</span>,</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>    zvar: <span class="bu">str</span>,</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    color_by_col: <span class="bu">str</span>,</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    colors: List[<span class="bu">str</span>],</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>    xvar_type: <span class="bu">str</span>,</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    high_corr_categories: List[<span class="bu">str</span>],</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>    bar_order: List[<span class="bu">str</span>],</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot faceted grouped bar chart."""</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> sns.FacetGrid(</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>        data,</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>        row<span class="op">=</span>zvar,</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>        hue<span class="op">=</span>color_by_col,</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>        palette<span class="op">=</span>colors,</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>        sharey<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>        sharex<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>        aspect<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>    g.<span class="bu">map</span>(sns.barplot, xvar, yvar, order<span class="op">=</span>bar_order)</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>    g.fig.tight_layout(h_pad<span class="op">=-</span><span class="dv">2</span>)</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># flatten axes into a 1-d array</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> g.axes.flatten()</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># iterate through the axes</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes):</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>        zvar_attr <span class="op">=</span> ax.get_title().split(<span class="st">" = "</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>        z_value_min <span class="op">=</span> data.query(<span class="ss">f"</span><span class="sc">{</span>zvar<span class="sc">}</span><span class="ss"> == '</span><span class="sc">{</span>zvar_attr<span class="sc">}</span><span class="ss">'"</span>)[yvar].<span class="bu">min</span>()</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="va">None</span>)</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>        ax.set_ylabel(zvar_attr.title().replace(<span class="st">"_"</span>, <span class="st">" "</span>), fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>        ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>        ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>        ax.tick_params(size<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> customize_splines(ax, <span class="va">None</span>)</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> z_value_min <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>            ax.axhline(<span class="dv">0</span>, ls<span class="op">=</span><span class="st">"--"</span>, c<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>        ax.set_title(<span class="va">None</span>)</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>        ptitle <span class="op">=</span> (</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Highest correlation to revenue is for "</span></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(high_corr_categories)<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>xvar_type<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>            ax.set_title(ptitle, fontweight<span class="op">=</span><span class="st">"bold"</span>, loc<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(bar_order)):</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>            ax.set_xticklabels([])</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_heatmap(</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>    data: pd.DataFrame,</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>    ytitle: <span class="bu">str</span>,</span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>    ptitle: <span class="bu">str</span>,</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>    cbar_params: Union[Dict[<span class="bu">str</span>, <span class="bu">float</span>], <span class="bu">bool</span>] <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>    annot_kws: Union[Dict[<span class="bu">str</span>, <span class="bu">int</span>], <span class="bu">bool</span>] <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>    fig_size: Tuple[<span class="bu">int</span>] <span class="op">=</span> (<span class="dv">10</span>, <span class="dv">12</span>),</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot a 2D heatmap using seaborn."""</span></span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>fig_size)</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> sns.heatmap(</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>        data,</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>        cmap<span class="op">=</span><span class="st">"YlOrRd"</span>,</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>        cbar<span class="op">=</span><span class="va">True</span> <span class="cf">if</span> cbar_params <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>        cbar_kws<span class="op">=</span>cbar_params <span class="cf">if</span> cbar_params <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>        annot<span class="op">=</span><span class="va">True</span> <span class="cf">if</span> annot_kws <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>        annot_kws<span class="op">=</span>annot_kws <span class="cf">if</span> annot_kws <span class="cf">else</span> <span class="va">None</span>,</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels(ax.get_yticklabels(), rotation<span class="op">=</span><span class="dv">0</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels(ax.get_xticklabels(), fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="va">None</span>)</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(ytitle, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cbar_params:</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>        cbar <span class="op">=</span> ax.collections[<span class="dv">0</span>].colorbar</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>        cbar.ax.tick_params(size<span class="op">=</span><span class="dv">0</span>, labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(size<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>    ax.set_title(</span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>        ptitle,</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>        loc<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">11</span>,</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>        fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-and-prepare-data" class="level2">
<h2 class="anchored" data-anchor-id="get-and-prepare-data">Get and Prepare Data</h2>
<p>Data will be prepared for EDA based on our learnings from the data preparation step 1. SQL to get the following for visitors who made a return (future) visit to the merchandise store during the months to be included in the training data split - attributes of their first visit - these are candidate features (<code>X</code>) for use in ML development - one visitor is present per row - forward-looking label (<code>y</code>) that indicates if each visitor made a purchase on a return visit to the store - one visitor is present per row 2. drop duplicates by <code>fullvisitorid</code> 3. set column datatypes for all columns</p>
<p>These three steps are enclosed into a <code>pandas.pipeline</code> (<a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.pipe.html">link</a>), which is defined below</p>
<div class="cell" data-tags="[]" data-execution_count="11">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ss">        WITH</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ss">        -- Step 1. get visitors with a purchase on a future visit</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="ss">        next_visit_purchasers AS (</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ss">             SELECT fullvisitorid,</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="ss">                    IF(COUNTIF(totals.transactions &gt; 0 AND totals.newVisits IS NULL) &gt; 0, True, False) AS made_purchase_on_future_visit</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="ss">             FROM `data-to-insights.ecommerce.web_analytics`</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="ss">             WHERE date BETWEEN '</span><span class="sc">{</span>train_start_date<span class="sc">}</span><span class="ss">' AND '</span><span class="sc">{</span>test_end_date<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="ss">             AND geoNetwork.country = 'United States'</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="ss">             GROUP BY fullvisitorid</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="ss">        ),</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="ss">        -- Steps 2. and 3. get attributes of the first visit</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="ss">        first_visit_attributes AS (</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="ss">            SELECT -- =========== GEOSPATIAL AND TEMPORAL ATTRIBUTES OF VISIT ===========</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="ss">                   geoNetwork.country,</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(QUARTER FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS quarter,</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(MONTH FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS month,</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(DAY FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS day_of_month,</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(DAYOFWEEK FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS day_of_week,</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(HOUR FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS hour,</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(MINUTE FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS minute,</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="ss">                   EXTRACT(SECOND FROM DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific')) AS second,</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== VISIT AND VISITOR METADATA ===========</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="ss">                   fullvisitorid,</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitId,</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitNumber,</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="ss">                   DATETIME(TIMESTAMP(TIMESTAMP_SECONDS(visitStartTime)), 'US/Pacific') AS visitStartTime,</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== SOURCE OF SITE TRAFFIC ===========</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- source of the traffic from which the visit was initiated</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="ss">                   trafficSource.source,</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- medium of the traffic from which the visit was initiated</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="ss">                   trafficSource.medium,</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- referring channel connected to visit</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="ss">                   channelGrouping,</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== VISITOR ACTIVITY ===========</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- total number of hits</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="ss">                   (CASE WHEN totals.hits &gt; 0 THEN totals.hits ELSE 0 END) AS hits,</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- number of bounces</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="ss">                   (CASE WHEN totals.bounces &gt; 0 THEN totals.bounces ELSE 0 END) AS bounces,</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- action performed during first visit</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="ss">                   CAST(h.eCommerceAction.action_type AS INT64) AS action_type,</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- page views</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="ss">                   IFNULL(totals.pageviews, 0) AS pageviews,</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- total revenue</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="ss">                   totals.totalTransactionRevenue / 1000000 AS transact_revenue,</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- time on the website</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="ss">                   IFNULL(totals.timeOnSite, 0) AS time_on_site,</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- whether add-to-cart was performed during visit</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a><span class="ss">                   (CASE WHEN CAST(h.eCommerceAction.action_type AS INT64) = 3 THEN 1 ELSE 0 END) AS added_to_cart,</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a><span class="ss">                   (CASE WHEN CAST(h.eCommerceAction.action_type AS INT64) = 2 THEN 1 ELSE 0 END) AS product_details_viewed,</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== VISITOR DEVICES ===========</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- user's browser</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.browser,</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- user's operating system</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.operatingSystem AS os,</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- user's type of device</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a><span class="ss">                   device.deviceCategory,</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== PROMOTION ===========</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a><span class="ss">                   h.promotion,</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a><span class="ss">                   h.promotionActionInfo AS pa_info,</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== PRODUCT ===========</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a><span class="ss">                   h.product,</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- =========== ML LABEL (DEPENDENT VARIABLE) ===========</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a><span class="ss">                   made_purchase_on_future_visit</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a><span class="ss">            FROM `data-to-insights.ecommerce.web_analytics`,</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a><span class="ss">            UNNEST(hits) AS h</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a><span class="ss">            INNER JOIN next_visit_purchasers USING (fullvisitorid)</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a><span class="ss">            WHERE date BETWEEN '</span><span class="sc">{</span>train_start_date<span class="sc">}</span><span class="ss">' AND '</span><span class="sc">{</span>train_end_date<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a><span class="ss">            AND geoNetwork.country = 'United States'</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="ss">            AND totals.newVisits = 1</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a><span class="ss">        ),</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a><span class="ss">        -- Step 4. get aggregated features (attributes) per visit</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a><span class="ss">        visit_attributes AS (</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a><span class="ss">            SELECT fullvisitorid,</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitId,</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitNumber,</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a><span class="ss">                   visitStartTime,</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a><span class="ss">                   country,</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a><span class="ss">                   quarter,</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a><span class="ss">                   month,</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a><span class="ss">                   day_of_month,</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a><span class="ss">                   day_of_week,</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a><span class="ss">                   hour,</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a><span class="ss">                   minute,</span></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a><span class="ss">                   second,</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a><span class="ss">                   source,</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a><span class="ss">                   medium,</span></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a><span class="ss">                   channelGrouping,</span></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a><span class="ss">                   hits,</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a><span class="ss">                   bounces,</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- get the last action performed during the first visit</span></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- (this indicates where the visitor left off at the end of their visit)</span></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a><span class="ss">                   MAX(action_type) AS last_action,</span></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- get number of products whose details were viewed</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a><span class="ss">                   SUM(product_details_viewed) AS product_detail_views,</span></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- get number of promotions displayed and clicked during the first visit</span></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a><span class="ss">                   COUNT(CASE WHEN pa_info IS NOT NULL THEN pa_info.promoIsView ELSE NULL END) AS promos_displayed,</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a><span class="ss">                   COUNT(CASE WHEN pa_info IS NOT NULL THEN pa_info.promoIsClick ELSE NULL END) AS promos_clicked,</span></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a><span class="ss">                   -- get number of products displayed and clicked during the first visit</span></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a><span class="ss">                   COUNT(CASE WHEN pu.isImpression IS NULL THEN NULL ELSE 1 END) AS product_views,</span></span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a><span class="ss">                   COUNT(CASE WHEN pu.isClick IS NULL THEN NULL ELSE 1 END) AS product_clicks,</span></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a><span class="ss">                   pageviews,</span></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a><span class="ss">                   transact_revenue,</span></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a><span class="ss">                   time_on_site,</span></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a><span class="ss">                   browser,</span></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a><span class="ss">                   os,</span></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a><span class="ss">                   deviceCategory,</span></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a><span class="ss">                   SUM(added_to_cart) AS added_to_cart,</span></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a><span class="ss">                   made_purchase_on_future_visit,</span></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a><span class="ss">            FROM first_visit_attributes</span></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a><span class="ss">            LEFT JOIN UNNEST(promotion) as p</span></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a><span class="ss">            LEFT JOIN UNNEST(product) as pu</span></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a><span class="ss">            GROUP BY fullvisitorid,</span></span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a><span class="ss">                     visitId,</span></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a><span class="ss">                     visitNumber,</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a><span class="ss">                     visitStartTime,</span></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a><span class="ss">                     country,</span></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a><span class="ss">                     quarter,</span></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a><span class="ss">                     month,</span></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a><span class="ss">                     day_of_month,</span></span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a><span class="ss">                     day_of_week,</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a><span class="ss">                     hour,</span></span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a><span class="ss">                     minute,</span></span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a><span class="ss">                     second,</span></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a><span class="ss">                     source,</span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a><span class="ss">                     medium,</span></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a><span class="ss">                     channelGrouping,</span></span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a><span class="ss">                     hits,</span></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a><span class="ss">                     bounces,</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a><span class="ss">                     pageviews,</span></span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a><span class="ss">                     transact_revenue,</span></span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a><span class="ss">                     time_on_site,</span></span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a><span class="ss">                     browser,</span></span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a><span class="ss">                     os,</span></span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a><span class="ss">                     deviceCategory,</span></span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a><span class="ss">                     made_purchase_on_future_visit</span></span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a><span class="ss">        )</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a><span class="ss">        SELECT *</span></span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a><span class="ss">        FROM visit_attributes</span></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> (</span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>    run_sql_query(query, <span class="op">**</span>gcp_auth_dict, show_df<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>    .pipe(set_datatypes, dtypes<span class="op">=</span>dtypes_dict)</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>    .pipe(drop_duplicates, subset<span class="op">=</span>[<span class="st">"fullvisitorid"</span>])</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_columns"</span>, <span class="va">None</span>):</span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>    display(df.head())</span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>    display(df.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Query execution start time = 2023-04-13 17:13:46.242...done at 2023-04-13 17:14:07.031 (20.788 seconds).
Query returned 92,859 rows</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">product_detail_views</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">transact_revenue</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>8163735676529750721</td>
<td>1481176805</td>
<td>1</td>
<td>2016-12-07 22:00:05</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>7</td>
<td>4</td>
<td>22</td>
<td>0</td>
<td>5</td>
<td>google</td>
<td>cpc</td>
<td>Paid Search</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>5</td>
<td>&lt;NA&gt;</td>
<td>109</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0897634596694862660</td>
<td>1475199828</td>
<td>1</td>
<td>2016-09-29 18:43:48</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>29</td>
<td>5</td>
<td>18</td>
<td>43</td>
<td>48</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>21</td>
<td>0</td>
<td>2</td>
<td>2</td>
<td>9</td>
<td>0</td>
<td>90</td>
<td>2</td>
<td>19</td>
<td>&lt;NA&gt;</td>
<td>467</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3891893273235584028</td>
<td>1478844153</td>
<td>1</td>
<td>2016-11-10 22:02:33</td>
<td>United States</td>
<td>4</td>
<td>11</td>
<td>10</td>
<td>5</td>
<td>22</td>
<td>2</td>
<td>33</td>
<td>youtube.com</td>
<td>referral</td>
<td>Social</td>
<td>11</td>
<td>0</td>
<td>2</td>
<td>1</td>
<td>18</td>
<td>0</td>
<td>36</td>
<td>1</td>
<td>10</td>
<td>&lt;NA&gt;</td>
<td>1003</td>
<td>Safari (in-app)</td>
<td>iOS</td>
<td>tablet</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6952706734234495703</td>
<td>1480581075</td>
<td>1</td>
<td>2016-12-01 00:31:15</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>1</td>
<td>5</td>
<td>0</td>
<td>31</td>
<td>15</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>27</td>
<td>1</td>
<td>24</td>
<td>0</td>
<td>8</td>
<td>&lt;NA&gt;</td>
<td>141</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3008949133172215443</td>
<td>1475213353</td>
<td>1</td>
<td>2016-09-29 22:29:13</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>29</td>
<td>5</td>
<td>22</td>
<td>29</td>
<td>13</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>14</td>
<td>0</td>
<td>2</td>
<td>3</td>
<td>9</td>
<td>0</td>
<td>24</td>
<td>3</td>
<td>11</td>
<td>&lt;NA&gt;</td>
<td>229</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">minute</th>
<th data-quarto-table-cell-role="th">second</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">hits</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">product_detail_views</th>
<th data-quarto-table-cell-role="th">promos_displayed</th>
<th data-quarto-table-cell-role="th">promos_clicked</th>
<th data-quarto-table-cell-role="th">product_views</th>
<th data-quarto-table-cell-role="th">product_clicks</th>
<th data-quarto-table-cell-role="th">pageviews</th>
<th data-quarto-table-cell-role="th">transact_revenue</th>
<th data-quarto-table-cell-role="th">time_on_site</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">92854</td>
<td>1446285229092173706</td>
<td>1478190491</td>
<td>1</td>
<td>2016-11-03 09:28:11</td>
<td>United States</td>
<td>4</td>
<td>11</td>
<td>3</td>
<td>5</td>
<td>9</td>
<td>28</td>
<td>11</td>
<td>(direct)</td>
<td>(none)</td>
<td>Direct</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>29</td>
<td>0</td>
<td>3</td>
<td>&lt;NA&gt;</td>
<td>224</td>
<td>Chrome</td>
<td>Chrome OS</td>
<td>desktop</td>
<td>0</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">92855</td>
<td>927804845306410814</td>
<td>1482181118</td>
<td>1</td>
<td>2016-12-19 12:58:38</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>19</td>
<td>2</td>
<td>12</td>
<td>58</td>
<td>38</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>32</td>
<td>0</td>
<td>3</td>
<td>&lt;NA&gt;</td>
<td>83</td>
<td>Chrome</td>
<td>Linux</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92856</td>
<td>8969674851394509099</td>
<td>1482941116</td>
<td>1</td>
<td>2016-12-28 08:05:16</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>28</td>
<td>4</td>
<td>8</td>
<td>5</td>
<td>16</td>
<td>youtube.com</td>
<td>referral</td>
<td>Social</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>28</td>
<td>0</td>
<td>3</td>
<td>&lt;NA&gt;</td>
<td>85</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">92857</td>
<td>0486118040507415508</td>
<td>1477164641</td>
<td>1</td>
<td>2016-10-22 12:30:41</td>
<td>United States</td>
<td>4</td>
<td>10</td>
<td>22</td>
<td>7</td>
<td>12</td>
<td>30</td>
<td>41</td>
<td>t.co</td>
<td>referral</td>
<td>Social</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>28</td>
<td>0</td>
<td>3</td>
<td>&lt;NA&gt;</td>
<td>78</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">92858</td>
<td>9088496055778533168</td>
<td>1482668980</td>
<td>1</td>
<td>2016-12-25 04:29:40</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>25</td>
<td>1</td>
<td>4</td>
<td>29</td>
<td>40</td>
<td>youtube.com</td>
<td>referral</td>
<td>Social</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>36</td>
<td>0</td>
<td>3</td>
<td>&lt;NA&gt;</td>
<td>69</td>
<td>Chrome</td>
<td>Linux</td>
<td>desktop</td>
<td>0</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Get a list of the non-categorical columns</p>
<div class="cell" data-tags="[]" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>non_categorical_columns <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> <span class="bu">list</span>(df) <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> categorical_columns]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Show the number of unique values in all categorical columns</p>
<div class="cell" data-tags="[]" data-execution_count="13">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df_nunique <span class="op">=</span> pd.DataFrame.from_records(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    [{<span class="st">"column"</span>: c, <span class="st">"num_unique_values"</span>: df[c].nunique()} <span class="cf">for</span> c <span class="kw">in</span> categorical_columns]</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>df_nunique</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column</th>
<th data-quarto-table-cell-role="th">num_unique_values</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>bounces</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>last_action</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>source</td>
<td>116</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>medium</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>channelGrouping</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>browser</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>os</td>
<td>15</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>deviceCategory</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Define a custom data transformation pipeline to handle the categorical columns. In the data preparation step, this was done using <code>pandas.value_counts()</code> to drop in frequently occurring values based on two thresholds for minimum wanted frequency 5% and 10%. Here, we will define a custom <code>scikit-learn.pipeline</code> that performs the same encoding using the <code>feature-engine</code> <a href="https://pypi.org/project/feature-engine/">library</a>, which provides a <code>RareLabelEncoder</code> that accepts a threshold as the parameter <code>tol</code>. Two such encoders are defined below with the required thresholds and they are then placed into a <code>scikit-learn.pipeline</code> to transform the data</p>
<div class="cell" data-tags="[]" data-execution_count="14">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>encoder_05 <span class="op">=</span> RareLabelEncoder(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    tol<span class="op">=</span><span class="fl">0.05</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    n_categories<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    variables<span class="op">=</span>[v <span class="cf">for</span> k, v <span class="kw">in</span> cols_to_group.items() <span class="cf">if</span> <span class="st">"5"</span> <span class="kw">in</span> k][<span class="dv">0</span>],</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    replace_with<span class="op">=</span><span class="st">"other"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>encoder_10 <span class="op">=</span> RareLabelEncoder(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    tol<span class="op">=</span><span class="fl">0.10</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    n_categories<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    variables<span class="op">=</span>[v <span class="cf">for</span> k, v <span class="kw">in</span> cols_to_group.items() <span class="cf">if</span> <span class="st">"10"</span> <span class="kw">in</span> k][<span class="dv">0</span>],</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    replace_with<span class="op">=</span><span class="st">"other"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>categorical_transformer <span class="op">=</span> Pipeline(</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    steps<span class="op">=</span>[(<span class="st">"enc_05"</span>, encoder_05), (<span class="st">"enc_10"</span>, encoder_10)]</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    transformers<span class="op">=</span>[(<span class="st">"cat"</span>, categorical_transformer, categorical_columns)],</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    remainder<span class="op">=</span><span class="st">"passthrough"</span>,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>pipe_trans <span class="op">=</span> Pipeline(steps<span class="op">=</span>[(<span class="st">"preprocessor"</span>, preprocessor)])</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>pipe_trans</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<style>#sk-container-id-1 {color: black;background-color: white;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[('preprocessor',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('cat',
                                                  Pipeline(steps=[('enc_05',
                                                                   RareLabelEncoder(n_categories=2,
                                                                                    replace_with='other',
                                                                                    variables=['source',
                                                                                               'browser'])),
                                                                  ('enc_10',
                                                                   RareLabelEncoder(n_categories=2,
                                                                                    replace_with='other',
                                                                                    tol=0.1,
                                                                                    variables=['os',
                                                                                               'channelGrouping',
                                                                                               'medium']))]),
                                                  ['bounces', 'last_action',
                                                   'source', 'medium',
                                                   'channelGrouping', 'browser',
                                                   'os',
                                                   'deviceCategory'])]))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox"><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">Pipeline</label><div class="sk-toggleable__content"><pre>Pipeline(steps=[('preprocessor',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('cat',
                                                  Pipeline(steps=[('enc_05',
                                                                   RareLabelEncoder(n_categories=2,
                                                                                    replace_with='other',
                                                                                    variables=['source',
                                                                                               'browser'])),
                                                                  ('enc_10',
                                                                   RareLabelEncoder(n_categories=2,
                                                                                    replace_with='other',
                                                                                    tol=0.1,
                                                                                    variables=['os',
                                                                                               'channelGrouping',
                                                                                               'medium']))]),
                                                  ['bounces', 'last_action',
                                                   'source', 'medium',
                                                   'channelGrouping', 'browser',
                                                   'os',
                                                   'deviceCategory'])]))])</pre></div></div></div><div class="sk-serial"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox"><label for="sk-estimator-id-2" class="sk-toggleable__label sk-toggleable__label-arrow">preprocessor: ColumnTransformer</label><div class="sk-toggleable__content"><pre>ColumnTransformer(remainder='passthrough',
                  transformers=[('cat',
                                 Pipeline(steps=[('enc_05',
                                                  RareLabelEncoder(n_categories=2,
                                                                   replace_with='other',
                                                                   variables=['source',
                                                                              'browser'])),
                                                 ('enc_10',
                                                  RareLabelEncoder(n_categories=2,
                                                                   replace_with='other',
                                                                   tol=0.1,
                                                                   variables=['os',
                                                                              'channelGrouping',
                                                                              'medium']))]),
                                 ['bounces', 'last_action', 'source', 'medium',
                                  'channelGrouping', 'browser', 'os',
                                  'deviceCategory'])])</pre></div></div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox"><label for="sk-estimator-id-3" class="sk-toggleable__label sk-toggleable__label-arrow">cat</label><div class="sk-toggleable__content"><pre>['bounces', 'last_action', 'source', 'medium', 'channelGrouping', 'browser', 'os', 'deviceCategory']</pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-4" type="checkbox"><label for="sk-estimator-id-4" class="sk-toggleable__label sk-toggleable__label-arrow">RareLabelEncoder</label><div class="sk-toggleable__content"><pre>RareLabelEncoder(n_categories=2, replace_with='other',
                 variables=['source', 'browser'])</pre></div></div></div><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-5" type="checkbox"><label for="sk-estimator-id-5" class="sk-toggleable__label sk-toggleable__label-arrow">RareLabelEncoder</label><div class="sk-toggleable__content"><pre>RareLabelEncoder(n_categories=2, replace_with='other', tol=0.1,
                 variables=['os', 'channelGrouping', 'medium'])</pre></div></div></div></div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-6" type="checkbox"><label for="sk-estimator-id-6" class="sk-toggleable__label sk-toggleable__label-arrow">remainder</label><div class="sk-toggleable__content"><pre></pre></div></div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-7" type="checkbox"><label for="sk-estimator-id-7" class="sk-toggleable__label sk-toggleable__label-arrow">passthrough</label><div class="sk-toggleable__content"><pre>passthrough</pre></div></div></div></div></div></div></div></div></div></div></div></div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The datatype of the categorical columns is set as <code>pd.CategoricalDtype()</code> in the datatypes dictionary <code>dtypes_dict</code> earlier. This was set as <code>pd.StringDtype()</code> during the data preparation step. Here, this change is necessary since the <code>RareLabelEncoder()</code> transformer expects to see these categrical columns appear as categories and not just as strings.</li>
</ol>
</div>
</div>
<p>Apply the custom data transformation pipeline to prepare the training data split for EDA</p>
<div class="cell" data-tags="[]" data-execution_count="15">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> pipe_trans.fit(df)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    pipe_trans.transform(df), columns<span class="op">=</span>categorical_columns <span class="op">+</span> non_categorical_columns</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>)[non_categorical_columns <span class="op">+</span> categorical_columns].pipe(set_datatypes, dtypes<span class="op">=</span>dtypes_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The cardinality of the columns before and after grouping is shown below</p>
<div class="cell" data-tags="[]" data-execution_count="16">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df_nunique.merge(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    pd.DataFrame.from_records(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">"column"</span>: c,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">"column_grouped"</span>: c,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                <span class="st">"num_unique_values_after_grouping"</span>: df[c].nunique(),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> c <span class="kw">in</span> categorical_columns</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    ).assign(column_grouped<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"column_grouped"</span>] <span class="op">!=</span> df[<span class="st">"column"</span>]),</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"column"</span>],</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column</th>
<th data-quarto-table-cell-role="th">num_unique_values</th>
<th data-quarto-table-cell-role="th">column_grouped</th>
<th data-quarto-table-cell-role="th">num_unique_values_after_grouping</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>bounces</td>
<td>2</td>
<td>False</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>last_action</td>
<td>7</td>
<td>False</td>
<td>7</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>source</td>
<td>116</td>
<td>False</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>medium</td>
<td>7</td>
<td>False</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>channelGrouping</td>
<td>8</td>
<td>False</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>browser</td>
<td>26</td>
<td>False</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>os</td>
<td>15</td>
<td>False</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>deviceCategory</td>
<td>3</td>
<td>False</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>This is identical to the output seen during the data preparation step in the <strong>Handling Categorical Columns</strong> sub-section.</li>
</ol>
</div>
</div>
<p>The category distributions (frequencies) after grouping are shown below for all categorical columns (including those that were grouped)</p>
<div class="cell" data-tags="[]" data-execution_count="17">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dfs_cats_groups <span class="op">=</span> []</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> categorical_columns:</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get fraction of unique values</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    df_frequencies <span class="op">=</span> (</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        df[c]</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        .value_counts()</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"number_of_visitors"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        .to_frame()</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        .merge(</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>            (</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                df[c].value_counts(normalize<span class="op">=</span><span class="va">True</span>).rename(<span class="st">"fraction_of_visitors"</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>            ).to_frame(),</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>            left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>            right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># map unique values for last_action and bounces to get meaningful names</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="op">==</span> <span class="st">"last_action"</span>:</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        df_frequencies.index <span class="op">=</span> df_frequencies.index.<span class="bu">map</span>(mapper)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="op">==</span> <span class="st">"bounces"</span>:</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        df_frequencies.index <span class="op">=</span> df_frequencies.index.<span class="bu">map</span>({<span class="dv">0</span>: <span class="va">False</span>, <span class="dv">1</span>: <span class="va">True</span>})</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get running total of fraction (cumulative sum)</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    df_frequencies <span class="op">=</span> (</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        df_frequencies.sort_values(by<span class="op">=</span>[<span class="st">"fraction_of_visitors"</span>])</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        .assign(</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>            cumulative_fraction_of_visitors<span class="op">=</span><span class="kw">lambda</span> df: df[</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fraction_of_visitors"</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>            ].cumsum(),</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>            column_name<span class="op">=</span>c,</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        .sort_values(by<span class="op">=</span>[<span class="st">"fraction_of_visitors"</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename columns</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    df_frequencies <span class="op">=</span> df_frequencies.reset_index().rename(columns<span class="op">=</span>{c: <span class="st">"column_value"</span>})</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    dfs_cats_groups.append(df_frequencies)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>df_frequencies_grouped <span class="op">=</span> pd.concat(dfs_cats_groups, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>col <span class="op">=</span> df_frequencies_grouped.pop(<span class="st">"column_name"</span>)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>df_frequencies_grouped.insert(<span class="dv">0</span>, col.name, col)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_rows"</span>, <span class="va">None</span>):</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    display(df_frequencies_grouped)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">column_name</th>
<th data-quarto-table-cell-role="th">column_value</th>
<th data-quarto-table-cell-role="th">number_of_visitors</th>
<th data-quarto-table-cell-role="th">fraction_of_visitors</th>
<th data-quarto-table-cell-role="th">cumulative_fraction_of_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>bounces</td>
<td>False</td>
<td>65505</td>
<td>70.777193</td>
<td>100.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>bounces</td>
<td>True</td>
<td>27046</td>
<td>29.222807</td>
<td>29.222807</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>last_action</td>
<td>Unknown</td>
<td>67511</td>
<td>72.944647</td>
<td>100.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>last_action</td>
<td>Product detail views</td>
<td>14731</td>
<td>15.916630</td>
<td>27.055353</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>last_action</td>
<td>Add product(s) to cart</td>
<td>4655</td>
<td>5.029659</td>
<td>11.138724</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>last_action</td>
<td>Completed purchase</td>
<td>3097</td>
<td>3.346263</td>
<td>6.109064</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>last_action</td>
<td>Check out</td>
<td>1635</td>
<td>1.766594</td>
<td>2.762801</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>last_action</td>
<td>Remove product(s) from cart</td>
<td>881</td>
<td>0.951908</td>
<td>0.996207</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>last_action</td>
<td>Click through of product lists</td>
<td>41</td>
<td>0.044300</td>
<td>0.044300</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>source</td>
<td>google</td>
<td>43484</td>
<td>46.983825</td>
<td>100.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>source</td>
<td>(direct)</td>
<td>21532</td>
<td>23.265011</td>
<td>53.016175</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>source</td>
<td>mall.googleplex.com</td>
<td>11777</td>
<td>12.724876</td>
<td>29.751164</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>source</td>
<td>youtube.com</td>
<td>8021</td>
<td>8.666573</td>
<td>17.026288</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>source</td>
<td>other</td>
<td>7737</td>
<td>8.359715</td>
<td>8.359715</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>medium</td>
<td>organic</td>
<td>38584</td>
<td>41.689447</td>
<td>100.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>medium</td>
<td>referral</td>
<td>25086</td>
<td>27.105056</td>
<td>58.310553</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>medium</td>
<td>(none)</td>
<td>21532</td>
<td>23.265011</td>
<td>31.205498</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>medium</td>
<td>other</td>
<td>7349</td>
<td>7.940487</td>
<td>7.940487</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>channelGrouping</td>
<td>Organic Search</td>
<td>38584</td>
<td>41.689447</td>
<td>100.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>channelGrouping</td>
<td>Direct</td>
<td>21532</td>
<td>23.265011</td>
<td>58.310553</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>channelGrouping</td>
<td>other</td>
<td>16275</td>
<td>17.584899</td>
<td>35.045542</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>channelGrouping</td>
<td>Referral</td>
<td>16160</td>
<td>17.460643</td>
<td>17.460643</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>browser</td>
<td>Chrome</td>
<td>69002</td>
<td>74.555650</td>
<td>100.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>browser</td>
<td>Safari</td>
<td>15294</td>
<td>16.524943</td>
<td>25.444350</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>browser</td>
<td>other</td>
<td>8255</td>
<td>8.919407</td>
<td>8.919407</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>os</td>
<td>Macintosh</td>
<td>30610</td>
<td>33.073657</td>
<td>100.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>os</td>
<td>Windows</td>
<td>25588</td>
<td>27.647459</td>
<td>66.926343</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>os</td>
<td>iOS</td>
<td>13500</td>
<td>14.586552</td>
<td>39.278884</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>os</td>
<td>Android</td>
<td>11486</td>
<td>12.410455</td>
<td>24.692332</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>os</td>
<td>other</td>
<td>11367</td>
<td>12.281877</td>
<td>12.281877</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>deviceCategory</td>
<td>desktop</td>
<td>67355</td>
<td>72.776091</td>
<td>100.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>deviceCategory</td>
<td>mobile</td>
<td>21790</td>
<td>23.543776</td>
<td>27.223909</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">32</td>
<td>deviceCategory</td>
<td>tablet</td>
<td>3406</td>
<td>3.680133</td>
<td>3.680133</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>This is identical to the output seen in <code>df_frequencies_grouped</code> during the data preparation step in the <strong>Handling Categorical Columns</strong> sub-section.</li>
</ol>
</div>
</div>
<p>The training data split is now prepared and ready for use in EDA.</p>
</section>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory Data Analysis</h2>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>We will interchangeably refer to each row in the data that was prepared above as visits or visitors. Since duplicates by <code>fullvisitorid</code> have been dropped, each row represents a unique visitor.</li>
<li>For the rest of this step (EDA), we will only use the training data as mentioned earlier in order to avoid data leakage or lookahead bias.</li>
<li>We will interchangeably refer to each visitor who made a purchase on a return visit as a return purchaser.</li>
</ol>
</div>
</div>
<p>The first few rows of the prepared training data are shown below</p>
<div class="cell" data-tags="[]" data-execution_count="18">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">"display.max_rows"</span>, <span class="va">None</span>):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    display(df.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">visitId</th>
<th data-quarto-table-cell-role="th">visitNumber</th>
<th data-quarto-table-cell-role="th">visitStartTime</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">quarter</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">added_to_cart</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">bounces</th>
<th data-quarto-table-cell-role="th">last_action</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">os</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>8163735676529750721</td>
<td>1481176805</td>
<td>1</td>
<td>2016-12-07 22:00:05</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>7</td>
<td>4</td>
<td>22</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>other</td>
<td>other</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0897634596694862660</td>
<td>1475199828</td>
<td>1</td>
<td>2016-09-29 18:43:48</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>29</td>
<td>5</td>
<td>18</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>2</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Windows</td>
<td>desktop</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3891893273235584028</td>
<td>1478844153</td>
<td>1</td>
<td>2016-11-10 22:02:33</td>
<td>United States</td>
<td>4</td>
<td>11</td>
<td>10</td>
<td>5</td>
<td>22</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>2</td>
<td>youtube.com</td>
<td>referral</td>
<td>other</td>
<td>other</td>
<td>iOS</td>
<td>tablet</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6952706734234495703</td>
<td>1480581075</td>
<td>1</td>
<td>2016-12-01 00:31:15</td>
<td>United States</td>
<td>4</td>
<td>12</td>
<td>1</td>
<td>5</td>
<td>0</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>0</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Android</td>
<td>mobile</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3008949133172215443</td>
<td>1475213353</td>
<td>1</td>
<td>2016-09-29 22:29:13</td>
<td>United States</td>
<td>3</td>
<td>9</td>
<td>29</td>
<td>5</td>
<td>22</td>
<td>...</td>
<td>0</td>
<td>False</td>
<td>0</td>
<td>2</td>
<td>google</td>
<td>organic</td>
<td>Organic Search</td>
<td>Chrome</td>
<td>Macintosh</td>
<td>desktop</td>
</tr>
</tbody>
</table>

<p>5 rows × 31 columns</p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>For the categorical columns, only the frequency-encoded versions are present in the prepared data.</li>
</ol>
</div>
</div>
<p><strong>Question 1. For high-level channel, and the more fine-grained traffic source and traffic medium, get the correlation between the numerical attributes of visits and total visit revenue. Across all of these groupings of sources of web traffic arriving at the merchandise store, comment on the strongest and weakest correlations to revenue.</strong></p>
<p>At the time of the first visit, we know whether the visitor will make a purchase during a return (or future) visit to the merchandise store. This is in the <code>made_purchase_on_future_visit</code> column. But, we have not extracted the visit revenue that was earned during that future visit, since we have only extracted its outcome. So, we will assume that this question is referring to visit revenue earned during the first visit since the columns (including <code>totals.transact_revenue</code>) are only retrieved for visitors’ first visits.</p>
<p>Due to the high cardinality of channel and traffic source, this question will be answered for the grouped version of these columns. The following helper function will <a href="https://stackoverflow.com/a/74492236/4057186">get this correlation</a> and will be re-used for all three traffic-related columns</p>
<div class="cell" data-tags="[]" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_revenue_corr_by_attribute(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame, categorical_col: <span class="bu">str</span>, numerical_cols: List[<span class="bu">str</span>]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Get correlation between numerical attrs and revenue for categorical attribute."""</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get distribution of categorical column</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    df_frequencies <span class="op">=</span> df[categorical_col].value_counts(normalize<span class="op">=</span><span class="va">True</span>).reset_index()</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get correlation within groupby</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    df_corr <span class="op">=</span> (</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        df.groupby(  <span class="co"># .query(f"{categorical_col}.isin(@popular_categories)")</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>            [categorical_col, <span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        )[numerical_cols <span class="op">+</span> [<span class="st">"transact_revenue"</span>]]</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        .corr()</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        .reset_index()[</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">"level_2"</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                <span class="st">"transact_revenue"</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>                categorical_col,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">"made_purchase_on_future_visit"</span>,</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># rename columns after reset_index</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"level_2"</span>: <span class="st">"first_visit_attribute"</span>})</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get correlation to revenue only</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">"first_visit_attribute != 'transact_revenue'"</span>)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># reshape data from tidy to untidy format</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>        .pivot(</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>            index<span class="op">=</span>[<span class="st">"first_visit_attribute"</span>, categorical_col],</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>],</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>            values<span class="op">=</span>[<span class="st">"transact_revenue"</span>],</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># flatten columns in untidy data</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    df_corr.columns <span class="op">=</span> [</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"_"</span>.join([<span class="bu">str</span>(sl) <span class="cf">for</span> sl <span class="kw">in</span> c]).rstrip(<span class="st">"_"</span>)</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> df_corr.columns.to_flat_index().tolist()</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename columns in untidy data and merge with frequencies to show distribution</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># side-by-side with distribution</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    df_corr <span class="op">=</span> (</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        df_corr.rename(</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>{</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">"transact_revenue_False"</span>: <span class="st">"corr_to_1st_visit_revenue_if_no_return_purchase"</span>,</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>                <span class="st">"transact_revenue_True"</span>: <span class="st">"corr_to_1st_visit_revenue_if_return_purchase"</span>,</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># merge with frequencies</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>        .merge(df_frequencies, on<span class="op">=</span>[categorical_col], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># sort for display purposes only</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>        .sort_values(</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>            by<span class="op">=</span>[<span class="st">"first_visit_attribute"</span>, <span class="st">"proportion"</span>],</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>            ascending<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>],</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_corr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following are the numerical columns that can be used to explore correlations with revenue</p>
<ol type="1">
<li><code>added_to_cart</code></li>
<li><code>hits</code></li>
<li><code>pageviews</code></li>
<li><code>product_detail_views</code></li>
<li><code>time_on_site</code></li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="20">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>numerical_cols <span class="op">=</span> [</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"added_to_cart"</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hits"</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pageviews"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"product_detail_views"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"time_on_site"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The correlations to revenue are first shown by the channel. Channel is a high-level grouping of the source of visitor traffic reaching a website. The default channel groupings used in Google Analytics tracking data are available <a href="https://support.google.com/analytics/answer/3297892?hl=en">here</a>. We will assume that the default-level groupings are being tracked by the Google merchandise store’s analytics tracking implementation.</p>
<p>These correlations for channels are shown below</p>
<div class="cell" data-tags="[]" data-execution_count="21">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>high_corr_categories <span class="op">=</span> [<span class="st">"Direct"</span>, <span class="st">"Referral"</span>]</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>df_corr_chn <span class="op">=</span> get_revenue_corr_by_attribute(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    df, <span class="st">"channelGrouping"</span>, numerical_cols</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>).assign(is_direct_referral<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"channelGrouping"</span>].isin(high_corr_categories))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>df_corr_chn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">first_visit_attribute</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">corr_to_1st_visit_revenue_if_no_return_purchase</th>
<th data-quarto-table-cell-role="th">corr_to_1st_visit_revenue_if_return_purchase</th>
<th data-quarto-table-cell-role="th">proportion</th>
<th data-quarto-table-cell-role="th">is_direct_referral</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>added_to_cart</td>
<td>Organic Search</td>
<td>0.458533</td>
<td>0.176038</td>
<td>0.416894</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>added_to_cart</td>
<td>Direct</td>
<td>0.285505</td>
<td>0.446968</td>
<td>0.232650</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>added_to_cart</td>
<td>other</td>
<td>0.234132</td>
<td>0.311722</td>
<td>0.175849</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>added_to_cart</td>
<td>Referral</td>
<td>0.193194</td>
<td>0.362088</td>
<td>0.174606</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>hits</td>
<td>Organic Search</td>
<td>0.435456</td>
<td>0.117423</td>
<td>0.416894</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>hits</td>
<td>Direct</td>
<td>0.201733</td>
<td>0.450512</td>
<td>0.232650</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>hits</td>
<td>other</td>
<td>0.231565</td>
<td>-0.065063</td>
<td>0.175849</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>hits</td>
<td>Referral</td>
<td>0.053901</td>
<td>0.440263</td>
<td>0.174606</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9</td>
<td>pageviews</td>
<td>Organic Search</td>
<td>0.429098</td>
<td>0.124916</td>
<td>0.416894</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8</td>
<td>pageviews</td>
<td>Direct</td>
<td>0.195127</td>
<td>0.451882</td>
<td>0.232650</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">11</td>
<td>pageviews</td>
<td>other</td>
<td>0.198325</td>
<td>-0.099826</td>
<td>0.175849</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10</td>
<td>pageviews</td>
<td>Referral</td>
<td>0.042360</td>
<td>0.437380</td>
<td>0.174606</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">13</td>
<td>product_detail_views</td>
<td>Organic Search</td>
<td>0.406835</td>
<td>0.078438</td>
<td>0.416894</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>product_detail_views</td>
<td>Direct</td>
<td>0.208041</td>
<td>0.420964</td>
<td>0.232650</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">15</td>
<td>product_detail_views</td>
<td>other</td>
<td>0.304971</td>
<td>0.022729</td>
<td>0.175849</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">14</td>
<td>product_detail_views</td>
<td>Referral</td>
<td>0.070961</td>
<td>0.411491</td>
<td>0.174606</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17</td>
<td>time_on_site</td>
<td>Organic Search</td>
<td>0.292286</td>
<td>-0.107737</td>
<td>0.416894</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">16</td>
<td>time_on_site</td>
<td>Direct</td>
<td>0.100158</td>
<td>0.233914</td>
<td>0.232650</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">19</td>
<td>time_on_site</td>
<td>other</td>
<td>0.101952</td>
<td>-0.322572</td>
<td>0.175849</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">18</td>
<td>time_on_site</td>
<td>Referral</td>
<td>0.030110</td>
<td>0.524343</td>
<td>0.174606</td>
<td>True</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>A plot of these correlations to revenue is shown below for return purchasers (<code>corr_to_1st_visit_revenue_if_return_purchase</code>)</p>
<div class="cell" data-tags="[]" data-execution_count="22">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>plot_faceted_grouped_bar_chart(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_corr_chn,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    xvar<span class="op">=</span><span class="st">"channelGrouping"</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    yvar<span class="op">=</span><span class="st">"corr_to_1st_visit_revenue_if_return_purchase"</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    zvar<span class="op">=</span><span class="st">"first_visit_attribute"</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    xvar_type<span class="op">=</span><span class="st">"channel groupings"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    color_by_col<span class="op">=</span><span class="st">"is_direct_referral"</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[<span class="st">"lightgrey"</span>, <span class="st">"red"</span>, <span class="st">"lightgrey"</span>, <span class="st">"red"</span>],</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    bar_order<span class="op">=</span>[<span class="st">"Organic Search"</span>, <span class="st">"Direct"</span>, <span class="st">"other"</span>, <span class="st">"Referral"</span>],</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    high_corr_categories<span class="op">=</span>high_corr_categories,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03_eda_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>For the high-level channel groupings of (visitor) traffic source, direct and referral-based traffic are responsible for the highest correlation to revenue earned during the first visit by return purchasers (see the <code>corr_to_1st_visit_revenue_if_return_purchase</code> column). Combined, these two sources account for approximately 40% of all web traffic (first-time visitors) to the merchandise store’s site.</li>
<li>Among all the selected numerical attributes of first-time visitors’ visits to the store, the time spent on the site by first-time visitors reaching the store through referrals, and who later returned to make a purchase, (see <code>first_visit_attribute = time_on_site</code>) is most strongly correlated to visit revenue earned.</li>
</ol>
</div>
</div>
<p>The correlations are now similarly shown by the more fine-grained traffic source column</p>
<div class="cell" data-tags="[]" data-execution_count="23">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>high_corr_categories <span class="op">=</span> [<span class="st">"other"</span>, <span class="st">"mall.googleplex.com"</span>]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>df_corr_source <span class="op">=</span> get_revenue_corr_by_attribute(df, <span class="st">"source"</span>, numerical_cols).assign(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    is_other_gmail<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"source"</span>].isin(high_corr_categories)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>df_corr_source</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">first_visit_attribute</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">corr_to_1st_visit_revenue_if_no_return_purchase</th>
<th data-quarto-table-cell-role="th">corr_to_1st_visit_revenue_if_return_purchase</th>
<th data-quarto-table-cell-role="th">proportion</th>
<th data-quarto-table-cell-role="th">is_other_gmail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>added_to_cart</td>
<td>google</td>
<td>0.420374</td>
<td>0.210653</td>
<td>0.469838</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>added_to_cart</td>
<td>(direct)</td>
<td>0.285505</td>
<td>0.446968</td>
<td>0.232650</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>added_to_cart</td>
<td>mall.googleplex.com</td>
<td>0.327064</td>
<td>0.476184</td>
<td>0.127249</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>added_to_cart</td>
<td>youtube.com</td>
<td>NaN</td>
<td>NaN</td>
<td>0.086666</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>added_to_cart</td>
<td>other</td>
<td>0.105265</td>
<td>0.486743</td>
<td>0.083597</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>hits</td>
<td>google</td>
<td>0.395722</td>
<td>0.027843</td>
<td>0.469838</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>hits</td>
<td>(direct)</td>
<td>0.201733</td>
<td>0.450512</td>
<td>0.232650</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>hits</td>
<td>mall.googleplex.com</td>
<td>0.181825</td>
<td>0.679037</td>
<td>0.127249</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9</td>
<td>hits</td>
<td>youtube.com</td>
<td>NaN</td>
<td>NaN</td>
<td>0.086666</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8</td>
<td>hits</td>
<td>other</td>
<td>0.112838</td>
<td>0.470637</td>
<td>0.083597</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">11</td>
<td>pageviews</td>
<td>google</td>
<td>0.385043</td>
<td>0.018214</td>
<td>0.469838</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10</td>
<td>pageviews</td>
<td>(direct)</td>
<td>0.195127</td>
<td>0.451882</td>
<td>0.232650</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>pageviews</td>
<td>mall.googleplex.com</td>
<td>0.168270</td>
<td>0.669607</td>
<td>0.127249</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">14</td>
<td>pageviews</td>
<td>youtube.com</td>
<td>NaN</td>
<td>NaN</td>
<td>0.086666</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">13</td>
<td>pageviews</td>
<td>other</td>
<td>0.112363</td>
<td>0.465942</td>
<td>0.083597</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">16</td>
<td>product_detail_views</td>
<td>google</td>
<td>0.387735</td>
<td>0.043626</td>
<td>0.469838</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">15</td>
<td>product_detail_views</td>
<td>(direct)</td>
<td>0.208041</td>
<td>0.420964</td>
<td>0.232650</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>product_detail_views</td>
<td>mall.googleplex.com</td>
<td>0.169645</td>
<td>0.630595</td>
<td>0.127249</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">19</td>
<td>product_detail_views</td>
<td>youtube.com</td>
<td>NaN</td>
<td>NaN</td>
<td>0.086666</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">18</td>
<td>product_detail_views</td>
<td>other</td>
<td>0.200577</td>
<td>0.472184</td>
<td>0.083597</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">21</td>
<td>time_on_site</td>
<td>google</td>
<td>0.248978</td>
<td>-0.205277</td>
<td>0.469838</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">20</td>
<td>time_on_site</td>
<td>(direct)</td>
<td>0.100158</td>
<td>0.233914</td>
<td>0.232650</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>time_on_site</td>
<td>mall.googleplex.com</td>
<td>0.063821</td>
<td>0.636119</td>
<td>0.127249</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">24</td>
<td>time_on_site</td>
<td>youtube.com</td>
<td>NaN</td>
<td>NaN</td>
<td>0.086666</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">23</td>
<td>time_on_site</td>
<td>other</td>
<td>0.131011</td>
<td>0.556708</td>
<td>0.083597</td>
<td>True</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><a href="https://support.google.com/analytics/answer/1033173?hl=en&amp;ref_topic=6010089">Traffic source</a> is the domain through which visitors reach the store’s website (<a href="https://www.wholewhale.com/tips/source-vs-medium-google-analytics/">link</a>).</li>
<li>Direct traffic source indicates a visitor entered the url of the store into the search bar on a browser and so <em>directly</em> accessed the store’s site (<a href="https://www.megalytic.com/blog/understanding-direct-traffic-in-google-analytics">link</a>).</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Direct traffic sources again appear as one of the highest correlations (see the <code>corr_to_1st_visit_revenue_if_return_purchase</code> column) to first-visit revenue earned by return purchasers for all the numerical columns (<code>pageviews</code>, <code>hits</code>, etc.), but
<ul>
<li>gmail</li>
<li><code>other</code> (less frequent)</li>
</ul>
traffic sources have a stronger correlation to revenue.</li>
<li>A Google search (through the Google search engine, or <code>source = google</code>) during the first visit consistently has the weakest correlation to revenue earned during that visit for all numerical columns.</li>
<li>Correlations to revenue are stronger at this more granular level (by traffic source) than by the high-level channel groupings. For example, compare correlations in <code>corr_to_1st_visit_revenue_if_return_purchase</code> for <code>first_visit_attribute = hits</code> in <code>df_corr_chn</code> to the same in <code>df_corr_source</code>.</li>
</ol>
</div>
</div>
<p>This is finally repeated using the same helper function for the traffic medium column</p>
<div class="cell" data-tags="[]" data-execution_count="24">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>high_corr_categories <span class="op">=</span> [<span class="st">"referral"</span>, <span class="st">"(none)"</span>]</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>df_corr_medium <span class="op">=</span> get_revenue_corr_by_attribute(df, <span class="st">"medium"</span>, numerical_cols).assign(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    is_none_referral<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"medium"</span>].isin(high_corr_categories)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>df_corr_medium</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">first_visit_attribute</th>
<th data-quarto-table-cell-role="th">medium</th>
<th data-quarto-table-cell-role="th">corr_to_1st_visit_revenue_if_no_return_purchase</th>
<th data-quarto-table-cell-role="th">corr_to_1st_visit_revenue_if_return_purchase</th>
<th data-quarto-table-cell-role="th">proportion</th>
<th data-quarto-table-cell-role="th">is_none_referral</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>added_to_cart</td>
<td>organic</td>
<td>0.458533</td>
<td>0.176038</td>
<td>0.416894</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>added_to_cart</td>
<td>referral</td>
<td>0.191701</td>
<td>0.361836</td>
<td>0.271051</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>added_to_cart</td>
<td>(none)</td>
<td>0.285505</td>
<td>0.446968</td>
<td>0.232650</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>added_to_cart</td>
<td>other</td>
<td>0.262166</td>
<td>0.315144</td>
<td>0.079405</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>hits</td>
<td>organic</td>
<td>0.435456</td>
<td>0.117423</td>
<td>0.416894</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>hits</td>
<td>referral</td>
<td>0.054482</td>
<td>0.439544</td>
<td>0.271051</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>hits</td>
<td>(none)</td>
<td>0.201733</td>
<td>0.450512</td>
<td>0.232650</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>hits</td>
<td>other</td>
<td>0.261931</td>
<td>-0.064471</td>
<td>0.079405</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">9</td>
<td>pageviews</td>
<td>organic</td>
<td>0.429098</td>
<td>0.124916</td>
<td>0.416894</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>pageviews</td>
<td>referral</td>
<td>0.042913</td>
<td>0.436655</td>
<td>0.271051</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>pageviews</td>
<td>(none)</td>
<td>0.195127</td>
<td>0.451882</td>
<td>0.232650</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10</td>
<td>pageviews</td>
<td>other</td>
<td>0.228142</td>
<td>-0.099564</td>
<td>0.079405</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">13</td>
<td>product_detail_views</td>
<td>organic</td>
<td>0.406835</td>
<td>0.078438</td>
<td>0.416894</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>product_detail_views</td>
<td>referral</td>
<td>0.072927</td>
<td>0.411055</td>
<td>0.271051</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>product_detail_views</td>
<td>(none)</td>
<td>0.208041</td>
<td>0.420964</td>
<td>0.232650</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">14</td>
<td>product_detail_views</td>
<td>other</td>
<td>0.324045</td>
<td>0.024184</td>
<td>0.079405</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17</td>
<td>time_on_site</td>
<td>organic</td>
<td>0.292286</td>
<td>-0.107737</td>
<td>0.416894</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>time_on_site</td>
<td>referral</td>
<td>0.035118</td>
<td>0.524371</td>
<td>0.271051</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>time_on_site</td>
<td>(none)</td>
<td>0.100158</td>
<td>0.233914</td>
<td>0.232650</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">18</td>
<td>time_on_site</td>
<td>other</td>
<td>0.063565</td>
<td>-0.322501</td>
<td>0.079405</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>A plot of these correlations to revenue is shown below for return purchasers (<code>corr_to_1st_visit_revenue_if_return_purchase</code>)</p>
<div class="cell" data-tags="[]" data-execution_count="25">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>plot_faceted_grouped_bar_chart(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>df_corr_medium,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    xvar<span class="op">=</span><span class="st">"medium"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    yvar<span class="op">=</span><span class="st">"corr_to_1st_visit_revenue_if_return_purchase"</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    zvar<span class="op">=</span><span class="st">"first_visit_attribute"</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    xvar_type<span class="op">=</span><span class="st">"medium groupings"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    color_by_col<span class="op">=</span><span class="st">"is_none_referral"</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    colors<span class="op">=</span>[<span class="st">"lightgrey"</span>, <span class="st">"red"</span>, <span class="st">"red"</span>, <span class="st">"lightgrey"</span>],</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    bar_order<span class="op">=</span>[<span class="st">"organic"</span>, <span class="st">"referral"</span>, <span class="st">"(none)"</span>, <span class="st">"other"</span>],</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    high_corr_categories<span class="op">=</span>high_corr_categories,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03_eda_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Traffic medium reflects the type of traffic source that reaches the store’s website (<a href="https://www.wholewhale.com/tips/source-vs-medium-google-analytics/">link</a>).</li>
<li>Traffic medium is a more higher-level grouping of visitor traffic than traffic source.</li>
<li><code>(none)</code> refers to traffic that originates from sources which tracking information is not available. Some reasons (<a href="https://odd.dog/blog/how-to-determine-what-google-analytics-directnone-traffic-is-from/">1</a>, <a href="https://www.datadrivenu.com/direct-none-traffic-source-google-analytics/">2</a>) for this occurrence include a
<ul>
<li>visitor directly entering the url into a browser</li>
<li>visitor clicking a browser bookmark</li>
<li>visitor clicks a link in a PDF document</li>
<li>etc.</li>
</ul></li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Again referrals appear as one of the strongest correlations to first-visit revenue. Unknown mediums give the second strongest correlation to revenue.</li>
<li>Correlations to revenue are weaker for this aggregation of traffic than by the lower-level traffic source grouping.</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Overall Observations for Correlations to Revenue Based on Groupings by Traffic">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Overall Observations for Correlations to Revenue Based on Groupings by Traffic
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Revenue earned during a first visit to the merchandise store is most strongly correlated to numerical attributes of the first visit for referral-based or direct/unknown traffic sources.</li>
<li>Attributes of visitors reaching the site through a Google search have the weakest correlation to first-visit revenue earned.</li>
<li>hits and pageviews are correlated to eachother. These two attributes are also correlated to product detail views, although this is weaker than the correlation between hits and pageviews. We can see the inter-correlation between these three columns from the similar
<ul>
<li>values in the respective <code>DataFrames</code> (<code>df_corr_chn</code>, <code>df_corr_source</code> and <code>df_corr_medium</code>)</li>
<li>bar relative heights in the charts</li>
</ul></li>
</ol>
</div>
</div>
<p><strong>Question 2. Which channels were responsible for the most first-time visitors with a purchase on their return visit? Show this comparison on a chart by channel.</strong></p>
<div class="cell" data-tags="[]" data-execution_count="26">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df_agg_by_channel <span class="op">=</span> (</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># groupby and count fullvisitorid</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">"made_purchase_on_future_visit"</span>, <span class="st">"channelGrouping"</span>], as_index<span class="op">=</span><span class="va">False</span>)[</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fullvisitorid"</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    .count()</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"fullvisitorid"</span>: <span class="st">"num_visitors"</span>})</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LEFT JOIN with frequency counts by outcome (whether purchase was made or not)</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        .value_counts()</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"total_visitors"</span>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        .reset_index(),</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"made_purchase_on_future_visit"</span>,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate fraction from count</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    .assign(frac_visitors<span class="op">=</span><span class="kw">lambda</span> df: <span class="dv">100</span> <span class="op">*</span> df[<span class="st">"num_visitors"</span>] <span class="op">/</span> df[<span class="st">"total_visitors"</span>])</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ORDER BY for display purposes only</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    .sort_values(by<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>, <span class="st">"num_visitors"</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>df_agg_by_channel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">channelGrouping</th>
<th data-quarto-table-cell-role="th">num_visitors</th>
<th data-quarto-table-cell-role="th">total_visitors</th>
<th data-quarto-table-cell-role="th">frac_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>True</td>
<td>Referral</td>
<td>1842</td>
<td>4250</td>
<td>43.341176</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>True</td>
<td>Direct</td>
<td>1642</td>
<td>4250</td>
<td>38.635294</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>True</td>
<td>Organic Search</td>
<td>579</td>
<td>4250</td>
<td>13.623529</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>True</td>
<td>other</td>
<td>187</td>
<td>4250</td>
<td>4.400000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>False</td>
<td>Organic Search</td>
<td>38005</td>
<td>88301</td>
<td>43.040283</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>Direct</td>
<td>19890</td>
<td>88301</td>
<td>22.525226</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>False</td>
<td>other</td>
<td>16088</td>
<td>88301</td>
<td>18.219499</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>False</td>
<td>Referral</td>
<td>14318</td>
<td>88301</td>
<td>16.214992</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>A plot showing the fraction of return purchasers by channel (<code>frac_visitors</code>) is shown below</p>
<div class="cell" data-tags="[]" data-execution_count="27">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">11</span>, <span class="dv">4</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> plt.GridSpec(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> fig.add_subplot(grid[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, c <span class="kw">in</span> <span class="bu">zip</span>([ax1], [<span class="va">True</span>]):</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> df_agg_by_channel.query(<span class="ss">f"made_purchase_on_future_visit == </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    sns.barplot(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>data[<span class="st">"channelGrouping"</span>],</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span>data[<span class="st">"frac_visitors"</span>],</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        palette<span class="op">=</span>[<span class="st">"red"</span>, <span class="st">"lightgrey"</span>, <span class="st">"red"</span>, <span class="st">"lightgrey"</span>],</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="va">None</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="va">None</span>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(size<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    ax.axhline(<span class="dv">0</span>, ls<span class="op">=</span><span class="st">"--"</span>, c<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    ax.set_title(</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Direct and Referrals dominate Google Search as most "</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"popular channel used by return purchasers"</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>        loc<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>        fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">11</span>,</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> customize_splines(ax, <span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03_eda_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>(From the table <code>df_agg_by_channel</code>) Organic Search (Google search engine) and direct arrivals are the two dominant sources of first-time visitors to the site who do not make a purchase on a return visit.</li>
<li>(From the chart) By comparison, when visitors who do make a purchase on their return visit reach the site, they are reaching the store through referrals (eg. NYTimes.com, etc.) or by directly entering the URL directly into their browser search bar. Organic search accounts for a relatively smaller fraction of such return purchasers.</li>
</ol>
</div>
</div>
<p><strong>Question 3. Is there any one web-browser that return purchasers used on their first visit?</strong></p>
<div class="cell" data-tags="[]" data-execution_count="28">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df_agg_by_browser <span class="op">=</span> (</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># groupby and count fullvisitorid</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">"made_purchase_on_future_visit"</span>, <span class="st">"browser"</span>], as_index<span class="op">=</span><span class="va">False</span>)[</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fullvisitorid"</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    .count()</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"fullvisitorid"</span>: <span class="st">"num_visitors"</span>})</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LEFT JOIN with frequency counts by outcome (whether purchase was made or not)</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        .value_counts()</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"total_visitors"</span>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        .reset_index(),</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"made_purchase_on_future_visit"</span>,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate fraction from count</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    .assign(frac_visitors<span class="op">=</span><span class="kw">lambda</span> df: <span class="dv">100</span> <span class="op">*</span> df[<span class="st">"num_visitors"</span>] <span class="op">/</span> df[<span class="st">"total_visitors"</span>])</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ORDER BY for display purposes only</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    .sort_values(by<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>, <span class="st">"num_visitors"</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>df_agg_by_browser</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">browser</th>
<th data-quarto-table-cell-role="th">num_visitors</th>
<th data-quarto-table-cell-role="th">total_visitors</th>
<th data-quarto-table-cell-role="th">frac_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>True</td>
<td>Chrome</td>
<td>4102</td>
<td>4250</td>
<td>96.517647</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>True</td>
<td>Safari</td>
<td>95</td>
<td>4250</td>
<td>2.235294</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>True</td>
<td>other</td>
<td>53</td>
<td>4250</td>
<td>1.247059</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>Chrome</td>
<td>64900</td>
<td>88301</td>
<td>73.498601</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>False</td>
<td>Safari</td>
<td>15199</td>
<td>88301</td>
<td>17.212716</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>False</td>
<td>other</td>
<td>8202</td>
<td>88301</td>
<td>9.288683</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>A plot showing the fraction of return purchasers by web browser (<code>frac_visitors</code>) is shown below</p>
<div class="cell" data-tags="[]" data-execution_count="29">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> plt.GridSpec(<span class="dv">2</span>, <span class="dv">1</span>, hspace<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> fig.add_subplot(grid[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> fig.add_subplot(grid[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, c <span class="kw">in</span> <span class="bu">zip</span>([ax1, ax2], [<span class="va">True</span>, <span class="va">False</span>]):</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> df_agg_by_browser.query(<span class="ss">f"made_purchase_on_future_visit == </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    sns.barplot(</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>data[<span class="st">"browser"</span>],</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span>data[<span class="st">"frac_visitors"</span>],</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        palette<span class="op">=</span>[<span class="st">"red"</span>, <span class="st">"lightgrey"</span>, <span class="st">"lightgrey"</span>],</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="va">None</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="va">None</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(size<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    ax.axhline(<span class="dv">0</span>, ls<span class="op">=</span><span class="st">"--"</span>, c<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c:</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        ax.set_title(</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Chrome was more predominant among return purchasers"</span>,</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>            loc<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>            fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>        ax.set_xticklabels([])</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> customize_splines(ax, <span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03_eda_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Google Chrome is the dominant browser used during the first visit by visitors who return to make a future purchase.</li>
<li>There are more first-time visitors that access the store using Safari using that visit who don’t make a purchase on their return visit, but even in this case Chrome is more frequently used.</li>
</ol>
</div>
</div>
<p><strong>Question 4. Do visitors who make a purchase on their return visit to the store have a preference for the type of device (desktop, mobile, etc.) they are using during their first visit?</strong></p>
<div class="cell" data-tags="[]" data-execution_count="30">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df_agg_by_device <span class="op">=</span> (</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># groupby and count fullvisitorid</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">"made_purchase_on_future_visit"</span>, <span class="st">"deviceCategory"</span>], as_index<span class="op">=</span><span class="va">False</span>)[</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fullvisitorid"</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    .count()</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"fullvisitorid"</span>: <span class="st">"num_visitors"</span>})</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LEFT JOIN with frequency counts by outcome (whether purchase was made or not)</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        .value_counts()</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"total_visitors"</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        .reset_index(),</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"made_purchase_on_future_visit"</span>,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate fraction from count</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    .assign(frac_visitors<span class="op">=</span><span class="kw">lambda</span> df: <span class="dv">100</span> <span class="op">*</span> df[<span class="st">"num_visitors"</span>] <span class="op">/</span> df[<span class="st">"total_visitors"</span>])</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ORDER BY for display purposes only</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    .sort_values(by<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>, <span class="st">"num_visitors"</span>], ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>df_agg_by_device</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">deviceCategory</th>
<th data-quarto-table-cell-role="th">num_visitors</th>
<th data-quarto-table-cell-role="th">total_visitors</th>
<th data-quarto-table-cell-role="th">frac_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>True</td>
<td>desktop</td>
<td>4091</td>
<td>4250</td>
<td>96.258824</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>True</td>
<td>mobile</td>
<td>131</td>
<td>4250</td>
<td>3.082353</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>True</td>
<td>tablet</td>
<td>28</td>
<td>4250</td>
<td>0.658824</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>False</td>
<td>desktop</td>
<td>63264</td>
<td>88301</td>
<td>71.645848</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>False</td>
<td>mobile</td>
<td>21659</td>
<td>88301</td>
<td>24.528601</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>False</td>
<td>tablet</td>
<td>3378</td>
<td>88301</td>
<td>3.825551</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>A plot showing the fraction of return purchasers by type of computing device (<code>frac_visitors</code>) is shown below</p>
<div class="cell" data-tags="[]" data-execution_count="31">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> plt.GridSpec(<span class="dv">2</span>, <span class="dv">1</span>, hspace<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> fig.add_subplot(grid[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> fig.add_subplot(grid[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, c <span class="kw">in</span> <span class="bu">zip</span>([ax1, ax2], [<span class="va">True</span>, <span class="va">False</span>]):</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> df_agg_by_device.query(<span class="ss">f"made_purchase_on_future_visit == </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    sns.barplot(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>data[<span class="st">"deviceCategory"</span>],</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span>data[<span class="st">"frac_visitors"</span>],</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        palette<span class="op">=</span>[<span class="st">"red"</span>, <span class="st">"lightgrey"</span>, <span class="st">"lightgrey"</span>],</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="va">None</span>)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="va">None</span>)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(size<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    ax.axhline(<span class="dv">0</span>, ls<span class="op">=</span><span class="st">"--"</span>, c<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c:</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        ax.set_title(</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Desktops were more predominant among return purchasers"</span>,</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>            loc<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>            fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        ax.set_xticklabels([])</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> customize_splines(ax, <span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03_eda_files/figure-html/cell-32-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Notes">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Notes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>This dataset was from 2016-2017. As use of mobile phones grown since then, these numbers may have changed in favor of increased use of mobile devices (even if desktop remains the dominant type of device being currently used).</li>
</ol>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>There are relatively more visitors whow use their mobile phones for their initial visit and who don’t make a return purchase than those that do return to make a purchase. Nonetheless, regardless of whether a future purchase is made, first-time visitors are overwhelmingly accessing the store’s website from their desktops.</li>
</ol>
</div>
</div>
<p><strong>Question 5. Which traffic sources were responsible for the most return purchasers on weekdays and weekends?</strong></p>
<p>The following columns will be used for the questions involving <code>datetime</code> attributes</p>
<ol type="1">
<li><code>fullvisitorid</code></li>
<li><code>month</code> (1 - 12)</li>
<li><code>day_of_month</code> (1 - 31)</li>
<li><code>day_of_week</code> (1 - 7)</li>
<li><code>hour</code></li>
<li><code>source</code> (traffic source after grouping)</li>
<li><code>made_purchase_on_future_visit</code> (ML label column, <code>y</code>)</li>
</ol>
<div class="cell" data-tags="[]" data-execution_count="32">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>datetime_label_cols <span class="op">=</span> [</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fullvisitorid"</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"month"</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_month"</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"day_of_week"</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hour"</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"made_purchase_on_future_visit"</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Show the <code>fullvisitorid</code>, <code>datetime</code> and ML label (<code>y</code>) columns from the prepared data</p>
<div class="cell" data-tags="[]" data-execution_count="33">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df[datetime_label_cols].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>8163735676529750721</td>
<td>12</td>
<td>7</td>
<td>4</td>
<td>22</td>
<td>google</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0897634596694862660</td>
<td>9</td>
<td>29</td>
<td>5</td>
<td>18</td>
<td>google</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3891893273235584028</td>
<td>11</td>
<td>10</td>
<td>5</td>
<td>22</td>
<td>youtube.com</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6952706734234495703</td>
<td>12</td>
<td>1</td>
<td>5</td>
<td>0</td>
<td>google</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3008949133172215443</td>
<td>9</td>
<td>29</td>
<td>5</td>
<td>22</td>
<td>google</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Definie mapping dictionaries to change month and day of week from integers to strings (month name and day name)</p>
<div class="cell" data-tags="[]" data-execution_count="34">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>month_mapper <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">12</span> <span class="op">+</span> <span class="dv">1</span>), month_name[<span class="dv">1</span>:]))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>day_mapper <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">7</span> <span class="op">+</span> <span class="dv">1</span>), [day_name[<span class="op">-</span><span class="dv">1</span>]] <span class="op">+</span> day_name[:<span class="op">-</span><span class="dv">1</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Apply these mapping dictionaries to the prepared data to get new columns with the <code>_name</code> suffix and append a column to indicate if the day of the week is a weekday or weekend</p>
<div class="cell" data-tags="[]" data-execution_count="35">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>df_datetime <span class="op">=</span> (</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># map month to month name</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    df.assign(month_name<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"month"</span>].<span class="bu">map</span>(month_mapper))</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># map day of week to day name</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    .assign(day_name<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"day_of_week"</span>].<span class="bu">map</span>(day_mapper))</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># map day of week to weekend check (boolean column)</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    .assign(is_weekend<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"day_of_week"</span>].isin([<span class="dv">1</span>, <span class="dv">7</span>]))</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>df_datetime[</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    datetime_label_cols[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> [<span class="st">"month_name"</span>, <span class="st">"is_weekend"</span>, <span class="st">"day_name"</span>]</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> [datetime_label_cols[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fullvisitorid</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">hour</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">month_name</th>
<th data-quarto-table-cell-role="th">is_weekend</th>
<th data-quarto-table-cell-role="th">day_name</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>8163735676529750721</td>
<td>12</td>
<td>7</td>
<td>4</td>
<td>22</td>
<td>google</td>
<td>December</td>
<td>False</td>
<td>Wednesday</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0897634596694862660</td>
<td>9</td>
<td>29</td>
<td>5</td>
<td>18</td>
<td>google</td>
<td>September</td>
<td>False</td>
<td>Thursday</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3891893273235584028</td>
<td>11</td>
<td>10</td>
<td>5</td>
<td>22</td>
<td>youtube.com</td>
<td>November</td>
<td>False</td>
<td>Thursday</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6952706734234495703</td>
<td>12</td>
<td>1</td>
<td>5</td>
<td>0</td>
<td>google</td>
<td>December</td>
<td>False</td>
<td>Thursday</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3008949133172215443</td>
<td>9</td>
<td>29</td>
<td>5</td>
<td>22</td>
<td>google</td>
<td>September</td>
<td>False</td>
<td>Thursday</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Perform the <code>GROUP BY</code> over</p>
<ol type="1">
<li>traffic source</li>
<li><code>is_weekend</code></li>
<li>whether return purchase was made</li>
</ol>
<p>and get fraction of visitors</p>
<div class="cell" data-tags="[]" data-execution_count="36">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_datetime_agg_source <span class="op">=</span> (</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># groupby and count fullvisitorid</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    df_datetime.groupby(</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"source"</span>, <span class="st">"is_weekend"</span>, <span class="st">"made_purchase_on_future_visit"</span>],</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>        as_index<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    .agg({<span class="st">"fullvisitorid"</span>: <span class="st">"count"</span>})</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"fullvisitorid"</span>: <span class="st">"num_visitors"</span>})</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    .sort_values(by<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>, <span class="st">"source"</span>])</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LEFT JOIN with frequency counts by outcome (whether purchase was made or not)</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"made_purchase_on_future_visit"</span>]</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        .value_counts()</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        .rename(<span class="st">"total_visitors"</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>        .reset_index(),</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"made_purchase_on_future_visit"</span>,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate fraction from count</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    .assign(frac_visitors<span class="op">=</span><span class="kw">lambda</span> df: <span class="dv">100</span> <span class="op">*</span> df[<span class="st">"num_visitors"</span>] <span class="op">/</span> df[<span class="st">"total_visitors"</span>])</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>df_datetime_agg_source</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">is_weekend</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">num_visitors</th>
<th data-quarto-table-cell-role="th">total_visitors</th>
<th data-quarto-table-cell-role="th">frac_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>(direct)</td>
<td>False</td>
<td>False</td>
<td>16261</td>
<td>88301</td>
<td>18.415420</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>(direct)</td>
<td>True</td>
<td>False</td>
<td>3629</td>
<td>88301</td>
<td>4.109806</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>google</td>
<td>False</td>
<td>False</td>
<td>32535</td>
<td>88301</td>
<td>36.845562</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>google</td>
<td>True</td>
<td>False</td>
<td>10254</td>
<td>88301</td>
<td>11.612553</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>mall.googleplex.com</td>
<td>False</td>
<td>False</td>
<td>9349</td>
<td>88301</td>
<td>10.587649</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>mall.googleplex.com</td>
<td>True</td>
<td>False</td>
<td>1149</td>
<td>88301</td>
<td>1.301231</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>other</td>
<td>False</td>
<td>False</td>
<td>5957</td>
<td>88301</td>
<td>6.746243</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>other</td>
<td>True</td>
<td>False</td>
<td>1149</td>
<td>88301</td>
<td>1.301231</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>youtube.com</td>
<td>False</td>
<td>False</td>
<td>5913</td>
<td>88301</td>
<td>6.696413</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>youtube.com</td>
<td>True</td>
<td>False</td>
<td>2105</td>
<td>88301</td>
<td>2.383891</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>(direct)</td>
<td>False</td>
<td>True</td>
<td>1346</td>
<td>4250</td>
<td>31.670588</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>(direct)</td>
<td>True</td>
<td>True</td>
<td>296</td>
<td>4250</td>
<td>6.964706</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>google</td>
<td>False</td>
<td>True</td>
<td>562</td>
<td>4250</td>
<td>13.223529</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>google</td>
<td>True</td>
<td>True</td>
<td>133</td>
<td>4250</td>
<td>3.129412</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>mall.googleplex.com</td>
<td>False</td>
<td>True</td>
<td>1120</td>
<td>4250</td>
<td>26.352941</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>mall.googleplex.com</td>
<td>True</td>
<td>True</td>
<td>159</td>
<td>4250</td>
<td>3.741176</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>other</td>
<td>False</td>
<td>True</td>
<td>508</td>
<td>4250</td>
<td>11.952941</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>other</td>
<td>True</td>
<td>True</td>
<td>123</td>
<td>4250</td>
<td>2.894118</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>youtube.com</td>
<td>False</td>
<td>True</td>
<td>2</td>
<td>4250</td>
<td>0.047059</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>youtube.com</td>
<td>True</td>
<td>True</td>
<td>1</td>
<td>4250</td>
<td>0.023529</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>A heatmap is shown below for return purchasers (<code>frac_visitors</code>) and similarly for visitors who did not make a purchase on a return visit</p>
<div class="cell" data-tags="[]" data-execution_count="37">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> plt.GridSpec(<span class="dv">2</span>, <span class="dv">1</span>, hspace<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> fig.add_subplot(grid[<span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> fig.add_subplot(grid[<span class="dv">1</span>, <span class="dv">0</span>])</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, c, ptitle_substr, source <span class="kw">in</span> <span class="bu">zip</span>(</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    [ax1, ax2],</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    [<span class="va">True</span>, <span class="va">False</span>],</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"returning purchasers"</span>, <span class="st">"returning non-purchasers"</span>],</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"direct access"</span>, <span class="st">"Google Search"</span>],</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> (</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># filter</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>            df_datetime_agg_source.query(</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"made_purchase_on_future_visit == </span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>            ).assign(</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>                is_weekend<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"is_weekend"</span>].<span class="bu">map</span>(</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>                    {<span class="va">False</span>: <span class="st">"weekday"</span>, <span class="va">True</span>: <span class="st">"weekend"</span>}</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># reshape for heatmap</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        .pivot(</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>            index<span class="op">=</span><span class="st">"source"</span>,</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span><span class="st">"is_weekend"</span>,</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>            values<span class="op">=</span><span class="st">"frac_visitors"</span>,</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>        .astype(<span class="bu">float</span>)</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>        .transpose()</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot heatmap</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> sns.heatmap(data, cmap<span class="op">=</span><span class="st">"YlOrRd"</span>, cbar_kws<span class="op">=</span>{<span class="st">"pad"</span>: <span class="fl">0.01</span>}, linewidth<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># customize heatmap</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="va">None</span>)</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="va">None</span>)</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.set_tick_params(labelsize<span class="op">=</span><span class="dv">12</span>, rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>    ax.set_title(</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Most </span><span class="sc">{</span>ptitle_substr<span class="sc">}</span><span class="ss"> access the site through </span><span class="sc">{</span>source<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>        loc<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>        fontweight<span class="op">=</span><span class="st">"bold"</span>,</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>    cbar <span class="op">=</span> ax.collections[<span class="dv">0</span>].colorbar</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>    cbar.ax.tick_params(size<span class="op">=</span><span class="dv">0</span>, labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c:</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>        ax.set_xticklabels([])</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>    ax.tick_params(size<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03_eda_files/figure-html/cell-38-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Direct channels and referrals were the found earlier to be the dominant channels used by return purchasers (<code>made_purchase_on_future_visit = True</code>). So it is not surprising that the same two sources are the dominant ones bringing return purchasers to the site on weekedays and weekends in the top subplot. Among referrals, Gmail is the dominant referral source bringing return purchasers to the store.</li>
</ol>
</div>
</div>
<p><strong>Question 6. Show the fraction of visitors who did make a purchase on their return visit to the merchandise store by month and day of the month.</strong></p>
<div class="cell" data-tags="[]" data-execution_count="38">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_agg <span class="op">=</span> df.groupby([<span class="st">"month"</span>, <span class="st">"day_of_month"</span>], as_index<span class="op">=</span><span class="va">False</span>).agg(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"made_purchase_on_future_visit"</span>: [<span class="st">"sum"</span>], <span class="st">"fullvisitorid"</span>: <span class="st">"count"</span>}</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>df_agg.columns <span class="op">=</span> [<span class="st">"_"</span>.join(c).rstrip(<span class="st">"_"</span>) <span class="cf">for</span> c <span class="kw">in</span> df_agg.columns.to_flat_index()]</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>df_agg <span class="op">=</span> df_agg.rename(</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"made_purchase_on_future_visit_sum"</span>: <span class="st">"return_purchasers"</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fullvisitorid_count"</span>: <span class="st">"return_visitors"</span>,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>).assign(</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    frac_return_purchasers<span class="op">=</span><span class="kw">lambda</span> df: <span class="dv">100</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> df[<span class="st">"return_purchasers"</span>]</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> df[<span class="st">"return_visitors"</span>]</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>display(df_agg.head())</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>display(df_agg.tail())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">return_purchasers</th>
<th data-quarto-table-cell-role="th">return_visitors</th>
<th data-quarto-table-cell-role="th">frac_return_purchasers</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>9</td>
<td>1</td>
<td>21</td>
<td>719</td>
<td>2.920723</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>9</td>
<td>2</td>
<td>16</td>
<td>637</td>
<td>2.511774</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>9</td>
<td>3</td>
<td>3</td>
<td>387</td>
<td>0.775194</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>9</td>
<td>4</td>
<td>7</td>
<td>349</td>
<td>2.005731</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>9</td>
<td>5</td>
<td>10</td>
<td>468</td>
<td>2.136752</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">return_purchasers</th>
<th data-quarto-table-cell-role="th">return_visitors</th>
<th data-quarto-table-cell-role="th">frac_return_purchasers</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">117</td>
<td>12</td>
<td>27</td>
<td>35</td>
<td>666</td>
<td>5.255255</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">118</td>
<td>12</td>
<td>28</td>
<td>29</td>
<td>578</td>
<td>5.017301</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">119</td>
<td>12</td>
<td>29</td>
<td>23</td>
<td>578</td>
<td>3.979239</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">120</td>
<td>12</td>
<td>30</td>
<td>12</td>
<td>456</td>
<td>2.631579</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">121</td>
<td>12</td>
<td>31</td>
<td>14</td>
<td>411</td>
<td>3.406326</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Reshape into untidy data for heatmap</p>
<div class="cell" data-tags="[]" data-execution_count="39">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> (</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    df_agg.query(<span class="st">"month &gt;= 9"</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    .assign(month_name<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"month"</span>].<span class="bu">map</span>(month_mapper))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"day_of_month"</span>, columns<span class="op">=</span><span class="st">"month_name"</span>, values<span class="op">=</span><span class="st">"frac_return_purchasers"</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    .astype(<span class="bu">float</span>)[month_name[<span class="dv">1</span>:][<span class="op">-</span><span class="dv">4</span>:]]</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>data.reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">month_name</th>
<th data-quarto-table-cell-role="th">day_of_month</th>
<th data-quarto-table-cell-role="th">September</th>
<th data-quarto-table-cell-role="th">October</th>
<th data-quarto-table-cell-role="th">November</th>
<th data-quarto-table-cell-role="th">December</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>2.920723</td>
<td>1.856764</td>
<td>6.064690</td>
<td>5.893358</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>2.511774</td>
<td>1.927711</td>
<td>6.045340</td>
<td>5.807814</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>0.775194</td>
<td>3.901734</td>
<td>5.628743</td>
<td>4.012346</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>2.005731</td>
<td>2.795031</td>
<td>5.248619</td>
<td>5.641749</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>2.136752</td>
<td>3.342884</td>
<td>6.525912</td>
<td>8.067227</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>6</td>
<td>1.804511</td>
<td>2.080624</td>
<td>5.765766</td>
<td>5.980066</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>7</td>
<td>2.857143</td>
<td>2.524038</td>
<td>8.717949</td>
<td>6.422925</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>8</td>
<td>2.374302</td>
<td>2.448211</td>
<td>4.845815</td>
<td>4.978541</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>9</td>
<td>3.392330</td>
<td>1.498127</td>
<td>6.774194</td>
<td>6.532181</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>10</td>
<td>2.375297</td>
<td>4.490291</td>
<td>6.464380</td>
<td>4.417178</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>11</td>
<td>1.179245</td>
<td>2.747909</td>
<td>8.038147</td>
<td>6.019656</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>12</td>
<td>2.797203</td>
<td>4.750594</td>
<td>3.267974</td>
<td>5.974395</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>13</td>
<td>3.738318</td>
<td>3.864169</td>
<td>6.109980</td>
<td>6.043046</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>14</td>
<td>3.096774</td>
<td>4.405874</td>
<td>5.542725</td>
<td>4.382826</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>15</td>
<td>2.914573</td>
<td>0.946970</td>
<td>5.823068</td>
<td>5.307263</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>16</td>
<td>2.834008</td>
<td>1.828154</td>
<td>6.195652</td>
<td>4.173765</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>17</td>
<td>1.295337</td>
<td>4.599212</td>
<td>8.187773</td>
<td>3.623188</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>18</td>
<td>3.053435</td>
<td>3.345725</td>
<td>6.415094</td>
<td>3.136763</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>19</td>
<td>4.657534</td>
<td>2.613480</td>
<td>5.871886</td>
<td>5.152225</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>20</td>
<td>4.194858</td>
<td>2.334152</td>
<td>6.370370</td>
<td>3.604359</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>21</td>
<td>3.364738</td>
<td>2.610114</td>
<td>6.418219</td>
<td>3.607666</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>22</td>
<td>2.368866</td>
<td>1.893939</td>
<td>6.991261</td>
<td>4.244694</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>23</td>
<td>2.184874</td>
<td>2.119461</td>
<td>8.542141</td>
<td>2.597403</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>24</td>
<td>1.262626</td>
<td>2.680653</td>
<td>6.099111</td>
<td>3.608247</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>25</td>
<td>1.576577</td>
<td>2.882483</td>
<td>6.596859</td>
<td>1.969365</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>26</td>
<td>5.117566</td>
<td>5.383848</td>
<td>8.543417</td>
<td>4.149378</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>27</td>
<td>2.538787</td>
<td>3.942652</td>
<td>6.285714</td>
<td>5.255255</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>28</td>
<td>3.389831</td>
<td>5.096419</td>
<td>9.018891</td>
<td>5.017301</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>29</td>
<td>1.655172</td>
<td>4.022989</td>
<td>8.114200</td>
<td>3.979239</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>30</td>
<td>2.398801</td>
<td>3.287197</td>
<td>6.719717</td>
<td>2.631579</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>31</td>
<td>NaN</td>
<td>5.555556</td>
<td>NaN</td>
<td>3.406326</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Show heatmap</p>
<div class="cell" data-tags="[]" data-execution_count="40">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>show_heatmap(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Day of Month"</span>,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="sc">% o</span><span class="st">f return purchasers was higher in November 2016 than neighbouring months"</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"pad"</span>: <span class="fl">0.01</span>},</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    fig_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">12</span>),</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03_eda_files/figure-html/cell-41-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The fraction of daily visitors who made a purchase on their return visit to the store (or, <em>return purchasers</em>) peaked during November 2016 before dropping in December. This trend not only implies seasonality in bulk buying trends at the store but also, the higher fraction before Christmas and the New Year festivities is critical to the store’s strategic planning.</li>
</ol>
</div>
</div>
<p><strong>Question 7. Show the fraction of visitors who made a purchase on their return visit to the merchandise store by month and day of the week.</strong></p>
<p>Aggregate to get number of</p>
<ul>
<li>visitors</li>
<li>channels</li>
</ul>
<p>used by visitors who did and did not make purchase on a return visit</p>
<div class="cell" data-tags="[]" data-execution_count="41">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df_agg <span class="op">=</span> df.groupby(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"month"</span>, <span class="st">"day_of_week"</span>, <span class="st">"made_purchase_on_future_visit"</span>], as_index<span class="op">=</span><span class="va">False</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>).agg({<span class="st">"fullvisitorid"</span>: <span class="st">"count"</span>, <span class="st">"channelGrouping"</span>: <span class="st">"nunique"</span>})</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>df_agg <span class="op">=</span> df_agg.rename(</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="st">"channelGrouping"</span>: <span class="st">"num_channels"</span>, <span class="st">"fullvisitorid"</span>: <span class="st">"return_visitors"</span>}</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>df_agg.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">return_visitors</th>
<th data-quarto-table-cell-role="th">num_channels</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>9</td>
<td>1</td>
<td>False</td>
<td>1579</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>9</td>
<td>1</td>
<td>True</td>
<td>31</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>9</td>
<td>2</td>
<td>False</td>
<td>2535</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>9</td>
<td>2</td>
<td>True</td>
<td>101</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>9</td>
<td>3</td>
<td>False</td>
<td>2670</td>
<td>4</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Pivot the data so that the number of visitors who did and did not make a return purchase are shown as separate columns (repeat for number of channels used by visitors who did and did not make a return purchase)</p>
<div class="cell" data-tags="[]" data-execution_count="42">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df_agg_untidy <span class="op">=</span> df_agg.pivot(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span>[<span class="st">"month"</span>, <span class="st">"day_of_week"</span>],</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"made_purchase_on_future_visit"</span>],</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    values<span class="op">=</span>[<span class="st">"return_visitors"</span>, <span class="st">"num_channels"</span>],</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>).reset_index()</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>df_agg_untidy.columns <span class="op">=</span> [</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"_"</span>.join([<span class="bu">str</span>(c) <span class="cf">for</span> c <span class="kw">in</span> c_list]).rstrip(<span class="st">"_"</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> c_list <span class="kw">in</span> df_agg_untidy.columns.to_flat_index()</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>df_agg_untidy.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">return_visitors_False</th>
<th data-quarto-table-cell-role="th">return_visitors_True</th>
<th data-quarto-table-cell-role="th">num_channels_False</th>
<th data-quarto-table-cell-role="th">num_channels_True</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>9</td>
<td>1</td>
<td>1579</td>
<td>31</td>
<td>4</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>9</td>
<td>2</td>
<td>2535</td>
<td>101</td>
<td>4</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>9</td>
<td>3</td>
<td>2670</td>
<td>85</td>
<td>4</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>9</td>
<td>4</td>
<td>2867</td>
<td>94</td>
<td>4</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>9</td>
<td>5</td>
<td>3653</td>
<td>93</td>
<td>4</td>
<td>4</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Get total number of visitors and channels</p>
<div class="cell" data-tags="[]" data-execution_count="43">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>df_agg_untidy[<span class="st">"num_channels"</span>] <span class="op">=</span> (</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    df_agg_untidy[<span class="st">"num_channels_False"</span>] <span class="op">+</span> df_agg_untidy[<span class="st">"num_channels_True"</span>]</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>df_agg_untidy[<span class="st">"return_visitors"</span>] <span class="op">=</span> (</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    df_agg_untidy[<span class="st">"return_visitors_False"</span>] <span class="op">+</span> df_agg_untidy[<span class="st">"return_visitors_True"</span>]</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>df_agg_untidy.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">return_visitors_False</th>
<th data-quarto-table-cell-role="th">return_visitors_True</th>
<th data-quarto-table-cell-role="th">num_channels_False</th>
<th data-quarto-table-cell-role="th">num_channels_True</th>
<th data-quarto-table-cell-role="th">num_channels</th>
<th data-quarto-table-cell-role="th">return_visitors</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>9</td>
<td>1</td>
<td>1579</td>
<td>31</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>1610</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>9</td>
<td>2</td>
<td>2535</td>
<td>101</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>2636</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>9</td>
<td>3</td>
<td>2670</td>
<td>85</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>2755</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>9</td>
<td>4</td>
<td>2867</td>
<td>94</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>2961</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>9</td>
<td>5</td>
<td>3653</td>
<td>93</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>3746</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Convert number of visitors and channels into fractions of visitors and channels</p>
<div class="cell" data-tags="[]" data-execution_count="44">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>df_agg_untidy[<span class="st">"frac_channels_used_by_return_purchasers"</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> (</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    df_agg_untidy[<span class="st">"num_channels_True"</span>] <span class="op">/</span> df_agg_untidy[<span class="st">"num_channels"</span>]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>df_agg_untidy[<span class="st">"frac_return_purchasers"</span>] <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> (</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    df_agg_untidy[<span class="st">"return_visitors_True"</span>] <span class="op">/</span> df_agg_untidy[<span class="st">"return_visitors"</span>]</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>df_agg_untidy.sample(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">return_visitors_False</th>
<th data-quarto-table-cell-role="th">return_visitors_True</th>
<th data-quarto-table-cell-role="th">num_channels_False</th>
<th data-quarto-table-cell-role="th">num_channels_True</th>
<th data-quarto-table-cell-role="th">num_channels</th>
<th data-quarto-table-cell-role="th">return_visitors</th>
<th data-quarto-table-cell-role="th">frac_channels_used_by_return_purchasers</th>
<th data-quarto-table-cell-role="th">frac_return_purchasers</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>11</td>
<td>5</td>
<td>3077</td>
<td>219</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>3296</td>
<td>50.0</td>
<td>6.644417</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>10</td>
<td>6</td>
<td>2813</td>
<td>107</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>2920</td>
<td>50.0</td>
<td>3.664384</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25</td>
<td>12</td>
<td>5</td>
<td>4452</td>
<td>235</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>4687</td>
<td>50.0</td>
<td>5.013868</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">24</td>
<td>12</td>
<td>4</td>
<td>3420</td>
<td>175</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>3595</td>
<td>50.0</td>
<td>4.867872</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>12</td>
<td>2</td>
<td>4093</td>
<td>266</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>4359</td>
<td>50.0</td>
<td>6.102317</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Melt data to get back to <code>GROUP BY</code> format, and only keep columns with fractions (drop columns with numbers)</p>
<div class="cell" data-tags="[]" data-execution_count="45">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df_agg_tidy <span class="op">=</span> df_agg_untidy.melt(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    id_vars<span class="op">=</span>[<span class="st">"month"</span>, <span class="st">"day_of_week"</span>],</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    value_vars<span class="op">=</span>[<span class="st">"frac_channels_used_by_return_purchasers"</span>, <span class="st">"frac_return_purchasers"</span>],</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>df_agg_tidy.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day_of_week</th>
<th data-quarto-table-cell-role="th">variable</th>
<th data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>9</td>
<td>1</td>
<td>frac_channels_used_by_return_purchasers</td>
<td>50.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>9</td>
<td>2</td>
<td>frac_channels_used_by_return_purchasers</td>
<td>50.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>9</td>
<td>3</td>
<td>frac_channels_used_by_return_purchasers</td>
<td>50.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>9</td>
<td>4</td>
<td>frac_channels_used_by_return_purchasers</td>
<td>50.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>9</td>
<td>5</td>
<td>frac_channels_used_by_return_purchasers</td>
<td>50.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Reshape into untidy data for heatmap</p>
<div class="cell" data-tags="[]" data-execution_count="46">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> (</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    df_agg_tidy.query(<span class="st">"month &gt;= 9"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"variable == 'frac_return_purchasers'"</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    .assign(day_name<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"day_of_week"</span>].<span class="bu">map</span>(day_mapper))</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    .assign(month_name<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"month"</span>].<span class="bu">map</span>(month_mapper))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"day_name"</span>, columns<span class="op">=</span><span class="st">"month_name"</span>, values<span class="op">=</span><span class="st">"value"</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    .loc[<span class="bu">list</span>(day_name)][month_name[<span class="dv">1</span>:][<span class="op">-</span><span class="dv">4</span>:]]</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">month_name</th>
<th data-quarto-table-cell-role="th">September</th>
<th data-quarto-table-cell-role="th">October</th>
<th data-quarto-table-cell-role="th">November</th>
<th data-quarto-table-cell-role="th">December</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">day_name</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Monday</td>
<td>3.831563</td>
<td>4.208624</td>
<td>7.665178</td>
<td>6.102317</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Tuesday</td>
<td>3.085299</td>
<td>2.921231</td>
<td>6.609712</td>
<td>5.221260</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Wednesday</td>
<td>3.174603</td>
<td>4.089527</td>
<td>6.861616</td>
<td>4.867872</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Thursday</td>
<td>2.482648</td>
<td>3.084911</td>
<td>6.644417</td>
<td>5.013868</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Friday</td>
<td>2.682339</td>
<td>3.664384</td>
<td>6.577307</td>
<td>4.763050</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Saturday</td>
<td>1.446541</td>
<td>2.252615</td>
<td>6.338652</td>
<td>3.883495</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Sunday</td>
<td>1.925466</td>
<td>2.159661</td>
<td>6.163328</td>
<td>4.429240</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Show heatmap</p>
<div class="cell" data-tags="[]" data-execution_count="47">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>show_heatmap(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">None</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="sc">% o</span><span class="st">f return purchasers was consistently lower on weekends than weekdays"</span>,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">False</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    annot_kws<span class="op">=</span>{<span class="st">"size"</span>: <span class="dv">14</span>},</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    fig_size<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">4</span>),</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="03_eda_files/figure-html/cell-48-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>The pool of visitors who are return purchasers shows weak evidence of following the structure of the work week since the fraction of return purchasers dropped on weekends (Saturday and Sunday) compared to weekedays.</li>
</ol>
</div>
</div>
<p><strong>Question 8. Show the breakdown of total revenue earned by visitors who are return purchasers and those that are not return purchasers.</strong></p>
<div class="cell" data-tags="[]" data-execution_count="48">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>df.groupby([<span class="st">"made_purchase_on_future_visit"</span>])[</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"transact_revenue"</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>].<span class="bu">sum</span>().reset_index().assign(</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    total_first_visit_revenue<span class="op">=</span><span class="kw">lambda</span> df: df[<span class="st">"transact_revenue"</span>].<span class="bu">sum</span>()</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>).assign(</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    frac_transact_revenue<span class="op">=</span><span class="kw">lambda</span> df: <span class="dv">100</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> df[<span class="st">"transact_revenue"</span>]</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> df[<span class="st">"total_first_visit_revenue"</span>]</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>).query(</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"made_purchase_on_future_visit == True"</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="48">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">made_purchase_on_future_visit</th>
<th data-quarto-table-cell-role="th">transact_revenue</th>
<th data-quarto-table-cell-role="th">total_first_visit_revenue</th>
<th data-quarto-table-cell-role="th">frac_transact_revenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>True</td>
<td>90105.070312</td>
<td>485441.625</td>
<td>18.561464</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Observations">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Observations
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Return purchasers account for nearly 20% of total revenue earned during the first visit.</li>
</ol>
</div>
</div>
</section>
<section id="key-findings" class="level2">
<h2 class="anchored" data-anchor-id="key-findings">Key Findings</h2>
<ol type="1">
<li>Products and promotions on the store’s website are not being viewed or clicked often by first-time visitors to the site.</li>
<li>During the months covered by the training data, only
<ul>
<li>10% of all visitors to the store added a product to their shopping cart during their first visit</li>
<li>4% of all first-time visitors to the store made a purchase on a return visit</li>
</ul></li>
<li>Correlations between numerical attributes of visitors’ first visits and revenue earned during the first visit
<ul>
<li>grouping traffic by channel
<ul>
<li>direct traffic and referrals account for approximately 40% of all return purchasers and are responsible for the highest correlation to revenue earned during the first visit by visitors who returned to make a purchase during a return (future) visit.</li>
</ul></li>
<li>grouping visitor traffic by source
<ul>
<li>gmail and the combined <code>other</code> (less frequently used) traffic sources show the highest correlation to revenue. Direct sources ranks third.</li>
<li>correlations are stronger at the source level (more granular) than at the channel or traffic medium level (both of which are higher-level groupings of traffic sources)</li>
<li>some of the columns namely hits, pageviews and products with detail views are correlated to eachother, so one or more of these features should be excluded during ML development</li>
</ul></li>
</ul></li>
<li>Google Chrome is the dominant browser used during the first visit of visitors who return to make a future purchase.</li>
<li>For those visitors that do return and make a future purchase, they are predominantly doing so by accessing the store’s site from a desktop computer.</li>
<li>By traffic source, direct channels and referrals are the dominant sources bringing return purchasers to the site on both weekedays and weekends.</li>
<li>Return purchasers peaked during November 2016 before dropping in December.</li>
<li>Return purchasers were higher in number on weekdays than on weekends.</li>
</ol>
</section>
<section id="summary-of-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-assumptions">Summary of Assumptions</h2>
<p>None.</p>
</section>
<section id="summary-of-tasks-performed" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-tasks-performed">Summary of Tasks Performed</h2>
<p>This step has performed non-exhaustive EDA for insights into the prepared data.</p>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<ol type="1">
<li>Limited EDA has been performed. For columns for which we have not performed EDA, we will be relying on our intuition to determine whether they will be useful as ML features.</li>
</ol>
</section>
<section id="next-step" class="level2">
<h2 class="anchored" data-anchor-id="next-step">Next Step</h2>
<p>The next step will transform the raw data in this dataset, in order to prepare it for machine learning, as follows</p>
<ol type="1">
<li>extract the attributes of each visit that were recommended in this step</li>
<li>drop duplicates by <code>fullvisitorid</code></li>
<li>handle high-cardinality categorical columns</li>
</ol>
<p>This will be done separately for training, validation and test data splits. As with the (current) EDA step, we will again use the learnings from data preparation in order to avoid preparing data for ML development that suffers from data leakage/lookahead bias.</p>
<p>The data will first be split into training, validation and test splits before 1. dropping duplicates 2. creating a lookup table using the training data to create category groupings for the categorical features - as shown in this step, these groupings are used to address the issue of high-cardinality categorical features during ML model development</p>
<hr>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.quarto\.org\/custom");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
<nav class="page-navigation column-body">
  <div class="nav-page nav-page-previous">
      <a href="../../../notebooks/02-prepare/notebooks/02_prepare.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Prepare Data</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../notebooks/04-transform/notebooks/04_transform.html" class="pagination-link">
        <span class="nav-page-text">Transform Data</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<script src="../../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>